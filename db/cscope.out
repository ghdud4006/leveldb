cscope 15 $HOME/AnalDatabase/leveldb/db               0000456635
	@autocompact_test.cc

5 
	~"g‹¡/g‹¡.h
"

6 
	~"db/db_im¶.h
"

7 
	~"Ëv–db/ÿche.h
"

8 
	~"Ëv–db/db.h
"

9 
	~"ut/‹¡ut.h
"

11 
Çme¥aû
 
	gËv–db
 {

13 şas 
	cAutoCom·ùTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

14 
public
:

15 
AutoCom·ùTe¡
() {

16 
dbÇme_
 = 
‹¡šg
::
TempDœ
() + "autocompact_test";

17 
	gtšy_ÿche_
 = 
NewLRUCache
(100);

18 
	gİtiÚs_
.
	gblock_ÿche
 = 
tšy_ÿche_
;

19 
De¡royDB
(
dbÇme_
, 
İtiÚs_
);

20 
	gİtiÚs_
.
	gü—‹_if_missšg
 = 
Œue
;

21 
	gİtiÚs_
.
	gcom´essiÚ
 = 
kNoCom´essiÚ
;

22 
EXPECT_LEVELDB_OK
(
DB
::
O³n
(
İtiÚs_
, 
dbÇme_
, &
db_
));

25 ~
AutoCom·ùTe¡
() {

26 
d–‘e
 
	gdb_
;

27 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

28 
d–‘e
 
	gtšy_ÿche_
;

31 
	g¡d
::
¡ršg
 
Key
(
i
) {

32 
buf
[100];

33 
¢´štf
(
buf
, (buf), "key%06d", 
i
);

34  
	g¡d
::
¡ršg
(
buf
);

37 
ušt64_t
 
Size
(cÚ¡ 
Sliû
& 
¡¬t
, cÚ¡ Sliû& 
lim™
) {

38 
Rªge
 
r
(
¡¬t
, 
lim™
);

39 
ušt64_t
 
	gsize
;

40 
	gdb_
->
G‘Aµroxim©eSizes
(&
r
, 1, &
size
);

41  
	gsize
;

44 
DoR—ds
(
n
);

46 
	g´iv©e
:

47 
¡d
::
¡ršg
 
dbÇme_
;

48 
Cache
* 
	gtšy_ÿche_
;

49 
O±iÚs
 
	gİtiÚs_
;

50 
DB
* 
	gdb_
;

53 cÚ¡ 
	gkV®ueSize
 = 200 * 1024;

54 cÚ¡ 
	gkTÙ®Size
 = 100 * 1024 * 1024;

55 cÚ¡ 
	gkCouÁ
 = 
kTÙ®Size
 / 
kV®ueSize
;

59 
	gAutoCom·ùTe¡
::
	$DoR—ds
(
n
) {

60 
¡d
::
¡ršg
 
	`v®ue
(
kV®ueSize
, 'x');

61 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

64 
i
 = 0; i < 
kCouÁ
; i++) {

65 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
	`Key
(
i
), 
v®ue
));

67 
	`ASSERT_LEVELDB_OK
(
dbi
->
	`TEST_Com·ùMemTabË
());

70 
i
 = 0; i < 
kCouÁ
; i++) {

71 
	`ASSERT_LEVELDB_OK
(
db_
->
	`D–‘e
(
	`Wr™eO±iÚs
(), 
	`Key
(
i
)));

73 
	`ASSERT_LEVELDB_OK
(
dbi
->
	`TEST_Com·ùMemTabË
());

76 cÚ¡ 
št64_t
 
š™Ÿl_size
 = 
	`Size
(
	`Key
(0), Key(
n
));

77 cÚ¡ 
št64_t
 
š™Ÿl_Ùh”_size
 = 
	`Size
(
	`Key
(
n
), Key(
kCouÁ
));

80 
¡d
::
¡ršg
 
lim™_key
 = 
	`Key
(
n
);

81 
»ad
 = 0; 
Œue
;„ead++) {

82 
	`ASSERT_LT
(
»ad
, 100) << "Takingoo†ongo compact";

83 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

84 
™”
->
	`S“kToFœ¡
();

85 
™”
->
	`V®id
(è&& i‹r->
	`key
().
	`ToSŒšg
(è< 
lim™_key
; i‹r->
	`Next
()) {

88 
d–‘e
 
™”
;

90 
Env
::
	`DeçuÉ
()->
	`SË•FÜMiüo£cÚds
(1000000);

91 
ušt64_t
 
size
 = 
	`Size
(
	`Key
(0), Key(
n
));

92 
	`årštf
(
¡d”r
, "™” %3d => %7.3àMB [Ùh” %7.3àMB]\n", 
»ad
 + 1,

93 
size
 / 1048576.0, 
	`Size
(
	`Key
(
n
), Key(
kCouÁ
)) / 1048576.0);

94 ià(
size
 <ğ
š™Ÿl_size
 / 10) {

101 cÚ¡ 
št64_t
 
fš®_Ùh”_size
 = 
	`Size
(
	`Key
(
n
), Key(
kCouÁ
));

102 
	`ASSERT_LE
(
fš®_Ùh”_size
, 
š™Ÿl_Ùh”_size
 + 1048576);

103 
	`ASSERT_GE
(
fš®_Ùh”_size
, 
š™Ÿl_Ùh”_size
 / 5 - 1048576);

104 
	}
}

106 
	$TEST_F
(
AutoCom·ùTe¡
, 
R—dAÎ
è{ 
	`DoR—ds
(
kCouÁ
); 
	}
}

108 
	$TEST_F
(
AutoCom·ùTe¡
, 
R—dH®f
è{ 
	`DoR—ds
(
kCouÁ
 / 2); 
	}
}

112 
	$maš
(
¬gc
, ** 
¬gv
) {

113 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

114  
	`RUN_ALL_TESTS
();

115 
	}
}

	@builder.cc

5 
	~"db/bud”.h
"

7 
	~"db/dbfÜm©.h
"

8 
	~"db/f’ame.h
"

9 
	~"db/bË_ÿche.h
"

10 
	~"db/v”siÚ_ed™.h
"

11 
	~"Ëv–db/db.h
"

12 
	~"Ëv–db/’v.h
"

13 
	~"Ëv–db/™”©Ü.h
"

15 
Çme¥aû
 
	gËv–db
 {

17 
Stus
 
BudTabË
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, 
Env
* 
’v
, cÚ¡ 
O±iÚs
& 
İtiÚs
,

18 
TabËCache
* 
bË_ÿche
, 
I‹¿tÜ
* 
™”
, 
FeM‘aD©a
* 
m‘a
) {

19 
Stus
 
	gs
;

20 
	gm‘a
->
	gfe_size
 = 0;

21 
	g™”
->
S“kToFœ¡
();

23 
	g¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme
, 
m‘a
->
numb”
);

24 ià(
	g™”
->
V®id
()) {

25 
Wr™abËFe
* 
	gfe
;

26 
	gs
 = 
’v
->
NewWr™abËFe
(
âame
, &
fe
);

27 ià(!
	gs
.
ok
()) {

28  
	gs
;

31 
TabËBud”
* 
	gbud”
 = 
Ãw
 TabËBud”(
İtiÚs
, 
fe
);

32 
	gm‘a
->
	gsm®Ë¡
.
DecodeFrom
(
™”
->
key
());

33 ; 
	g™”
->
V®id
(); i‹r->
Next
()) {

34 
Sliû
 
	gkey
 = 
™”
->
key
();

35 
	gm‘a
->
	gÏrge¡
.
DecodeFrom
(
key
);

36 
	gbud”
->
Add
(
key
, 
™”
->
v®ue
());

40 
	gs
 = 
bud”
->
Fšish
();

41 ià(
	gs
.
ok
()) {

42 
	gm‘a
->
	gfe_size
 = 
bud”
->
FeSize
();

43 
as£¹
(
m‘a
->
fe_size
 > 0);

45 
d–‘e
 
	gbud”
;

48 ià(
	gs
.
ok
()) {

49 
	gs
 = 
fe
->
Sync
();

51 ià(
	gs
.
ok
()) {

52 
	gs
 = 
fe
->
Clo£
();

54 
d–‘e
 
	gfe
;

55 
	gfe
 = 
nuÎ±r
;

57 ià(
	gs
.
ok
()) {

59 
I‹¿tÜ
* 
	g™
 = 
bË_ÿche
->
NewI‹¿tÜ
(
R—dO±iÚs
(), 
m‘a
->
numb”
,

60 
m‘a
->
fe_size
);

61 
	gs
 = 
™
->
¡©us
();

62 
d–‘e
 
	g™
;

67 ià(!
	g™”
->
¡©us
().
ok
()) {

68 
	gs
 = 
™”
->
¡©us
();

71 ià(
	gs
.
ok
(è&& 
	gm‘a
->
	gfe_size
 > 0) {

74 
	g’v
->
RemoveFe
(
âame
);

76  
	gs
;

	@builder.h

5 #iâdeà
STORAGE_LEVELDB_DB_BUILDER_H_


6 
	#STORAGE_LEVELDB_DB_BUILDER_H_


	)

8 
	~"Ëv–db/¡©us.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
	gO±iÚs
;

13 
	gFeM‘aD©a
;

15 
şass
 
	gEnv
;

16 
şass
 
	gI‹¿tÜ
;

17 
şass
 
	gTabËCache
;

18 
şass
 
	gV”siÚEd™
;

25 
Stus
 
BudTabË
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, 
Env
* 
’v
, cÚ¡ 
O±iÚs
& 
İtiÚs
,

26 
TabËCache
* 
bË_ÿche
, 
I‹¿tÜ
* 
™”
, 
FeM‘aD©a
* 
m‘a
);

	@c.cc

5 
	~"Ëv–db/c.h
"

7 
	~<c¡dšt
>

8 
	~<c¡dlib
>

10 
	~"Ëv–db/ÿche.h
"

11 
	~"Ëv–db/com·¿tÜ.h
"

12 
	~"Ëv–db/db.h
"

13 
	~"Ëv–db/’v.h
"

14 
	~"Ëv–db/f‹r_pŞicy.h
"

15 
	~"Ëv–db/™”©Ü.h
"

16 
	~"Ëv–db/İtiÚs.h
"

17 
	~"Ëv–db/¡©us.h
"

18 
	~"Ëv–db/wr™e_b©ch.h
"

20 
usšg
 
	gËv–db
::
Cache
;

21 
usšg
 
	gËv–db
::
Com·¿tÜ
;

22 
usšg
 
	gËv–db
::
Com´essiÚTy³
;

23 
usšg
 
	gËv–db
::
DB
;

24 
usšg
 
	gËv–db
::
Env
;

25 
usšg
 
	gËv–db
::
FeLock
;

26 
usšg
 
	gËv–db
::
F‹rPŞicy
;

27 
usšg
 
	gËv–db
::
I‹¿tÜ
;

28 
usšg
 
	gËv–db
::
kMajÜV”siÚ
;

29 
usšg
 
	gËv–db
::
kMšÜV”siÚ
;

30 
usšg
 
	gËv–db
::
Logg”
;

31 
usšg
 
	gËv–db
::
NewBloomF‹rPŞicy
;

32 
usšg
 
	gËv–db
::
NewLRUCache
;

33 
usšg
 
	gËv–db
::
O±iÚs
;

34 
usšg
 
	gËv–db
::
RªdomAcûssFe
;

35 
usšg
 
	gËv–db
::
Rªge
;

36 
usšg
 
	gËv–db
::
R—dO±iÚs
;

37 
usšg
 
	gËv–db
::
Sequ’tŸlFe
;

38 
usšg
 
	gËv–db
::
Sliû
;

39 
usšg
 
	gËv–db
::
SÇpshÙ
;

40 
usšg
 
	gËv–db
::
Stus
;

41 
usšg
 
	gËv–db
::
Wr™abËFe
;

42 
usšg
 
	gËv–db
::
Wr™eB©ch
;

43 
usšg
 
	gËv–db
::
Wr™eO±iÚs
;

47 
	sËv–db_t
 {

48 
DB
* 
»p
;

50 
	sËv–db_™”©Ü_t
 {

51 
I‹¿tÜ
* 
»p
;

53 
	sËv–db_wr™eb©ch_t
 {

54 
Wr™eB©ch
 
»p
;

56 
	sËv–db_¢­shÙ_t
 {

57 cÚ¡ 
SÇpshÙ
* 
»p
;

59 
	sËv–db_»adİtiÚs_t
 {

60 
R—dO±iÚs
 
»p
;

62 
	sËv–db_wr™eİtiÚs_t
 {

63 
Wr™eO±iÚs
 
»p
;

65 
	sËv–db_İtiÚs_t
 {

66 
O±iÚs
 
»p
;

68 
	sËv–db_ÿche_t
 {

69 
Cache
* 
»p
;

71 
	sËv–db_£qfe_t
 {

72 
Sequ’tŸlFe
* 
»p
;

74 
	sËv–db_¿ndomfe_t
 {

75 
RªdomAcûssFe
* 
»p
;

77 
	sËv–db_wr™abËfe_t
 {

78 
Wr™abËFe
* 
»p
;

80 
	sËv–db_logg”_t
 {

81 
Logg”
* 
»p
;

83 
	sËv–db_f–ock_t
 {

84 
FeLock
* 
»p
;

87 
Ëv–db_com·¿tÜ_t
 : 
public
 
Com·¿tÜ
 {

88 ~
Ëv–db_com·¿tÜ_t
(è
ov”ride
 { (*
de¡ruùÜ_
)(
¡©e_
); }

90 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
ècÚ¡ 
ov”ride
 {

91  (*
com·»_
)(
¡©e_
, 
a
.
d©a
(),‡.
size
(), 
b
.data(), b.size());

94 cÚ¡ * 
Name
(ècÚ¡ 
ov”ride
 {  (*
Çme_
)(
¡©e_
); }

97 
FšdShÜ‹¡S•¬©Ü
(
¡d
::
¡ršg
*, cÚ¡ 
Sliû
&ècÚ¡ 
ov”ride
 {}

98 
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
ècÚ¡ 
ov”ride
 {}

100 * 
¡©e_
;

101 (*
de¡ruùÜ_
)(*);

102 (*
com·»_
)(*, cÚ¡ * 
a
, 
size_t
 
®’
, cÚ¡ * 
b
,

103 
size_t
 
bËn
);

104 cÚ¡ * (*
Çme_
)(*);

107 
Ëv–db_f‹½Şicy_t
 : 
public
 
F‹rPŞicy
 {

108 ~
Ëv–db_f‹½Şicy_t
(è
ov”ride
 { (*
de¡ruùÜ_
)(
¡©e_
); }

110 cÚ¡ * 
Name
(ècÚ¡ 
ov”ride
 {  (*
Çme_
)(
¡©e_
); }

112 
C»©eF‹r
(cÚ¡ 
Sliû
* 
keys
, 
n
, 
¡d
::
¡ršg
* 
d¡
ècÚ¡ 
ov”ride
 {

113 
¡d
::
veùÜ
<cÚ¡ *> 
key_poš‹rs
(
n
);

114 
¡d
::
veùÜ
<
size_t
> 
key_sizes
(
n
);

115 
i
 = 0; i < 
n
; i++) {

116 
key_poš‹rs
[
i
] = 
keys
[i].
d©a
();

117 
key_sizes
[
i
] = 
keys
[i].
size
();

119 
size_t
 
Ën
;

120 * 
f‹r
 = (*
ü—‹_
)(
¡©e_
, &
key_poš‹rs
[0], &
key_sizes
[0], 
n
, &
Ën
);

121 
d¡
->
­³nd
(
f‹r
, 
Ën
);

122 
ä“
(
f‹r
);

125 
boŞ
 
KeyMayM©ch
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
f‹r
ècÚ¡ 
ov”ride
 {

126  (*
key_m©ch_
)(
¡©e_
, 
key
.
d©a
(), key.
size
(), 
f‹r
.data(),

127 
f‹r
.
size
());

130 * 
¡©e_
;

131 (*
de¡ruùÜ_
)(*);

132 cÚ¡ * (*
Çme_
)(*);

133 * (*
ü—‹_
)(*, cÚ¡ * cÚ¡* 
key_¬¿y
,

134 cÚ¡ 
size_t
* 
key_Ëngth_¬¿y
, 
num_keys
,

135 
size_t
* 
f‹r_Ëngth
);

136 
ušt8_t
 (*
key_m©ch_
)(*, cÚ¡ * 
key
, 
size_t
 
Ëngth
,

137 cÚ¡ * 
f‹r
, 
size_t
 
f‹r_Ëngth
);

140 
	sËv–db_’v_t
 {

141 
Env
* 
»p
;

142 
boŞ
 
is_deçuÉ
;

145 
boŞ
 
SaveE¼Ü
(** 
”½Œ
, cÚ¡ 
Stus
& 
s
) {

146 
as£¹
(
”½Œ
 !ğ
nuÎ±r
);

147 ià(
s
.
ok
()) {

148  
çl£
;

149 } ià(*
”½Œ
 =ğ
nuÎ±r
) {

150 *
”½Œ
 = 
¡rdup
(
s
.
ToSŒšg
().
c_¡r
());

153 
ä“
(*
”½Œ
);

154 *
”½Œ
 = 
¡rdup
(
s
.
ToSŒšg
().
c_¡r
());

156  
Œue
;

159 * 
CİySŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

160 * 
»suÉ
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
((è* 
¡r
.
size
()));

161 
memıy
(
»suÉ
, 
¡r
.
d©a
(), (è* sŒ.
size
());

162  
»suÉ
;

165 
Ëv–db_t
* 
Ëv–db_İ’
(cÚ¡ 
Ëv–db_İtiÚs_t
* 
İtiÚs
, cÚ¡ * 
Çme
,

166 ** 
”½Œ
) {

167 
DB
* 
db
;

168 ià(
SaveE¼Ü
(
”½Œ
, 
DB
::
O³n
(
İtiÚs
->
»p
, 
¡d
::
¡ršg
(
Çme
), &
db
))) {

169  
nuÎ±r
;

171 
Ëv–db_t
* 
»suÉ
 = 
Ãw
†eveldb_t;

172 
»suÉ
->
»p
 = 
db
;

173  
»suÉ
;

176 
Ëv–db_şo£
(
Ëv–db_t
* 
db
) {

177 
d–‘e
 
db
->
»p
;

178 
d–‘e
 
db
;

181 
Ëv–db_put
(
Ëv–db_t
* 
db
, cÚ¡ 
Ëv–db_wr™eİtiÚs_t
* 
İtiÚs
,

182 cÚ¡ * 
key
, 
size_t
 
keyËn
, cÚ¡ * 
v®
, size_ˆ
v®Ën
,

183 ** 
”½Œ
) {

184 
SaveE¼Ü
(
”½Œ
,

185 
db
->
»p
->
Put
(
İtiÚs
->»p, 
Sliû
(
key
, 
keyËn
), Sliû(
v®
, 
v®Ën
)));

188 
Ëv–db_d–‘e
(
Ëv–db_t
* 
db
, cÚ¡ 
Ëv–db_wr™eİtiÚs_t
* 
İtiÚs
,

189 cÚ¡ * 
key
, 
size_t
 
keyËn
, ** 
”½Œ
) {

190 
SaveE¼Ü
(
”½Œ
, 
db
->
»p
->
D–‘e
(
İtiÚs
->»p, 
Sliû
(
key
, 
keyËn
)));

193 
Ëv–db_wr™e
(
Ëv–db_t
* 
db
, cÚ¡ 
Ëv–db_wr™eİtiÚs_t
* 
İtiÚs
,

194 
Ëv–db_wr™eb©ch_t
* 
b©ch
, ** 
”½Œ
) {

195 
SaveE¼Ü
(
”½Œ
, 
db
->
»p
->
Wr™e
(
İtiÚs
->»p, &
b©ch
->rep));

198 * 
Ëv–db_g‘
(
Ëv–db_t
* 
db
, cÚ¡ 
Ëv–db_»adİtiÚs_t
* 
İtiÚs
,

199 cÚ¡ * 
key
, 
size_t
 
keyËn
, size_t* 
v®Ën
,

200 ** 
”½Œ
) {

201 * 
»suÉ
 = 
nuÎ±r
;

202 
¡d
::
¡ršg
 
tmp
;

203 
Stus
 
s
 = 
db
->
»p
->
G‘
(
İtiÚs
->»p, 
Sliû
(
key
, 
keyËn
), &
tmp
);

204 ià(
s
.
ok
()) {

205 *
v®Ën
 = 
tmp
.
size
();

206 
»suÉ
 = 
CİySŒšg
(
tmp
);

208 *
v®Ën
 = 0;

209 ià(!
s
.
IsNÙFound
()) {

210 
SaveE¼Ü
(
”½Œ
, 
s
);

213  
»suÉ
;

216 
Ëv–db_™”©Ü_t
* 
Ëv–db_ü—‹_™”©Ü
(

217 
Ëv–db_t
* 
db
, cÚ¡ 
Ëv–db_»adİtiÚs_t
* 
İtiÚs
) {

218 
Ëv–db_™”©Ü_t
* 
»suÉ
 = 
Ãw
†eveldb_iterator_t;

219 
»suÉ
->
»p
 = 
db
->»p->
NewI‹¿tÜ
(
İtiÚs
->rep);

220  
»suÉ
;

223 cÚ¡ 
Ëv–db_¢­shÙ_t
* 
Ëv–db_ü—‹_¢­shÙ
(
Ëv–db_t
* 
db
) {

224 
Ëv–db_¢­shÙ_t
* 
»suÉ
 = 
Ãw
†eveldb_snapshot_t;

225 
»suÉ
->
»p
 = 
db
->»p->
G‘SÇpshÙ
();

226  
»suÉ
;

229 
Ëv–db_»Ëa£_¢­shÙ
(
Ëv–db_t
* 
db
,

230 cÚ¡ 
Ëv–db_¢­shÙ_t
* 
¢­shÙ
) {

231 
db
->
»p
->
R–—£SÇpshÙ
(
¢­shÙ
->rep);

232 
d–‘e
 
¢­shÙ
;

235 * 
Ëv–db_´İ”ty_v®ue
(
Ëv–db_t
* 
db
, cÚ¡ * 
´İÇme
) {

236 
¡d
::
¡ršg
 
tmp
;

237 ià(
db
->
»p
->
G‘Prİ”ty
(
Sliû
(
´İÇme
), &
tmp
)) {

239  
¡rdup
(
tmp
.
c_¡r
());

241  
nuÎ±r
;

245 
Ëv–db_­´oxim©e_sizes
(
Ëv–db_t
* 
db
, 
num_¿nges
,

246 cÚ¡ * cÚ¡* 
¿nge_¡¬t_key
,

247 cÚ¡ 
size_t
* 
¿nge_¡¬t_key_Ën
,

248 cÚ¡ * cÚ¡* 
¿nge_lim™_key
,

249 cÚ¡ 
size_t
* 
¿nge_lim™_key_Ën
,

250 
ušt64_t
* 
sizes
) {

251 
Rªge
* 
¿nges
 = 
Ãw
 Rªge[
num_¿nges
];

252 
i
 = 0; i < 
num_¿nges
; i++) {

253 
¿nges
[
i
].
¡¬t
 = 
Sliû
(
¿nge_¡¬t_key
[i], 
¿nge_¡¬t_key_Ën
[i]);

254 
¿nges
[
i
].
lim™
 = 
Sliû
(
¿nge_lim™_key
[i], 
¿nge_lim™_key_Ën
[i]);

256 
db
->
»p
->
G‘Aµroxim©eSizes
(
¿nges
, 
num_¿nges
, 
sizes
);

257 
d–‘e
[] 
¿nges
;

260 
Ëv–db_com·ù_¿nge
(
Ëv–db_t
* 
db
, cÚ¡ * 
¡¬t_key
,

261 
size_t
 
¡¬t_key_Ën
, cÚ¡ * 
lim™_key
,

262 
size_t
 
lim™_key_Ën
) {

263 
Sliû
 
a
, 
b
;

264 
db
->
»p
->
Com·ùRªge
(

266 (
¡¬t_key
 ? (
a
 = 
Sliû
(¡¬t_key, 
¡¬t_key_Ën
), &aè: 
nuÎ±r
),

267 (
lim™_key
 ? (
b
 = 
Sliû
Öim™_key, 
lim™_key_Ën
), &bè: 
nuÎ±r
));

270 
Ëv–db_de¡roy_db
(cÚ¡ 
Ëv–db_İtiÚs_t
* 
İtiÚs
, cÚ¡ * 
Çme
,

271 ** 
”½Œ
) {

272 
SaveE¼Ü
(
”½Œ
, 
De¡royDB
(
Çme
, 
İtiÚs
->
»p
));

275 
Ëv–db_»·œ_db
(cÚ¡ 
Ëv–db_İtiÚs_t
* 
İtiÚs
, cÚ¡ * 
Çme
,

276 ** 
”½Œ
) {

277 
SaveE¼Ü
(
”½Œ
, 
R•aœDB
(
Çme
, 
İtiÚs
->
»p
));

280 
Ëv–db_™”_de¡roy
(
Ëv–db_™”©Ü_t
* 
™”
) {

281 
d–‘e
 
™”
->
»p
;

282 
d–‘e
 
™”
;

285 
ušt8_t
 
Ëv–db_™”_v®id
(cÚ¡ 
Ëv–db_™”©Ü_t
* 
™”
) {

286  
™”
->
»p
->
V®id
();

289 
Ëv–db_™”_£ek_to_fœ¡
(
Ëv–db_™”©Ü_t
* 
™”
) {

290 
™”
->
»p
->
S“kToFœ¡
();

293 
Ëv–db_™”_£ek_to_Ï¡
(
Ëv–db_™”©Ü_t
* 
™”
) {

294 
™”
->
»p
->
S“kToLa¡
();

297 
Ëv–db_™”_£ek
(
Ëv–db_™”©Ü_t
* 
™”
, cÚ¡ * 
k
, 
size_t
 
kËn
) {

298 
™”
->
»p
->
S“k
(
Sliû
(
k
, 
kËn
));

301 
Ëv–db_™”_Ãxt
(
Ëv–db_™”©Ü_t
* 
™”
è{ i‹r->
»p
->
Next
(); }

303 
Ëv–db_™”_´ev
(
Ëv–db_™”©Ü_t
* 
™”
è{ i‹r->
»p
->
P»v
(); }

305 cÚ¡ * 
Ëv–db_™”_key
(cÚ¡ 
Ëv–db_™”©Ü_t
* 
™”
, 
size_t
* 
kËn
) {

306 
Sliû
 
s
 = 
™”
->
»p
->
key
();

307 *
kËn
 = 
s
.
size
();

308  
s
.
d©a
();

311 cÚ¡ * 
Ëv–db_™”_v®ue
(cÚ¡ 
Ëv–db_™”©Ü_t
* 
™”
, 
size_t
* 
vËn
) {

312 
Sliû
 
s
 = 
™”
->
»p
->
v®ue
();

313 *
vËn
 = 
s
.
size
();

314  
s
.
d©a
();

317 
Ëv–db_™”_g‘_”rÜ
(cÚ¡ 
Ëv–db_™”©Ü_t
* 
™”
, ** 
”½Œ
) {

318 
SaveE¼Ü
(
”½Œ
, 
™”
->
»p
->
¡©us
());

321 
Ëv–db_wr™eb©ch_t
* 
Ëv–db_wr™eb©ch_ü—‹
() {

322  
Ãw
 
Ëv–db_wr™eb©ch_t
;

325 
Ëv–db_wr™eb©ch_de¡roy
(
Ëv–db_wr™eb©ch_t
* 
b
è{ 
d–‘e
 b; }

327 
Ëv–db_wr™eb©ch_ş—r
(
Ëv–db_wr™eb©ch_t
* 
b
è{ b->
»p
.
CË¬
(); }

329 
Ëv–db_wr™eb©ch_put
(
Ëv–db_wr™eb©ch_t
* 
b
, cÚ¡ * 
key
,

330 
size_t
 
kËn
, cÚ¡ * 
v®
, size_ˆ
vËn
) {

331 
b
->
»p
.
Put
(
Sliû
(
key
, 
kËn
), Sliû(
v®
, 
vËn
));

334 
Ëv–db_wr™eb©ch_d–‘e
(
Ëv–db_wr™eb©ch_t
* 
b
, cÚ¡ * 
key
,

335 
size_t
 
kËn
) {

336 
b
->
»p
.
D–‘e
(
Sliû
(
key
, 
kËn
));

339 
Ëv–db_wr™eb©ch_™”©e
(cÚ¡ 
Ëv–db_wr™eb©ch_t
* 
b
, * 
¡©e
,

340 (*
put
)(*, cÚ¡ * 
k
, 
size_t
 
kËn
,

341 cÚ¡ * 
v
, 
size_t
 
vËn
),

342 (*
d–‘ed
)(*, cÚ¡ * 
k
,

343 
size_t
 
kËn
)) {

344 şas 
	cH
 : 
public
 
Wr™eB©ch
::
HªdËr
 {

345 
public
:

346 * 
¡©e_
;

347 (*
put_
)(*, cÚ¡ * 
k
, 
size_t
 
kËn
, cÚ¡ * 
v
, size_ˆ
vËn
);

348 (*
d–‘ed_
)(*, cÚ¡ * 
k
, 
size_t
 
kËn
);

349 
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
è
ov”ride
 {

350 (*
put_
)(
¡©e_
, 
key
.
d©a
(), key.
size
(), 
v®ue
.data(), value.size());

352 
D–‘e
(cÚ¡ 
Sliû
& 
key
è
ov”ride
 {

353 (*
d–‘ed_
)(
¡©e_
, 
key
.
d©a
(), key.
size
());

356 
H
 
hªdËr
;

357 
hªdËr
.
¡©e_
 = 
¡©e
;

358 
hªdËr
.
put_
 = 
put
;

359 
hªdËr
.
d–‘ed_
 = 
d–‘ed
;

360 
b
->
»p
.
I‹¿‹
(&
hªdËr
);

363 
	$Ëv–db_wr™eb©ch_­³nd
(
Ëv–db_wr™eb©ch_t
* 
de¡š©iÚ
,

364 cÚ¡ 
Ëv–db_wr™eb©ch_t
* 
sourû
) {

365 
de¡š©iÚ
->
»p
.
	`Aµ’d
(
sourû
->rep);

366 
	}
}

368 
Ëv–db_İtiÚs_t
* 
	$Ëv–db_İtiÚs_ü—‹
(è{  
Ãw
 
Ëv–db_İtiÚs_t
; 
	}
}

370 
	$Ëv–db_İtiÚs_de¡roy
(
Ëv–db_İtiÚs_t
* 
İtiÚs
è{ 
d–‘e
 o±iÚs; 
	}
}

372 
	$Ëv–db_İtiÚs_£t_com·¿tÜ
(
Ëv–db_İtiÚs_t
* 
İt
,

373 
Ëv–db_com·¿tÜ_t
* 
cmp
) {

374 
İt
->
»p
.
com·¿tÜ
 = 
cmp
;

375 
	}
}

377 
	$Ëv–db_İtiÚs_£t_f‹r_pŞicy
(
Ëv–db_İtiÚs_t
* 
İt
,

378 
Ëv–db_f‹½Şicy_t
* 
pŞicy
) {

379 
İt
->
»p
.
f‹r_pŞicy
 = 
pŞicy
;

380 
	}
}

382 
	$Ëv–db_İtiÚs_£t_ü—‹_if_missšg
(
Ëv–db_İtiÚs_t
* 
İt
, 
ušt8_t
 
v
) {

383 
İt
->
»p
.
ü—‹_if_missšg
 = 
v
;

384 
	}
}

386 
	$Ëv–db_İtiÚs_£t_”rÜ_if_exi¡s
(
Ëv–db_İtiÚs_t
* 
İt
, 
ušt8_t
 
v
) {

387 
İt
->
»p
.
”rÜ_if_exi¡s
 = 
v
;

388 
	}
}

390 
	$Ëv–db_İtiÚs_£t_·¿noid_checks
(
Ëv–db_İtiÚs_t
* 
İt
, 
ušt8_t
 
v
) {

391 
İt
->
»p
.
·¿noid_checks
 = 
v
;

392 
	}
}

394 
	$Ëv–db_İtiÚs_£t_’v
(
Ëv–db_İtiÚs_t
* 
İt
, 
Ëv–db_’v_t
* 
’v
) {

395 
İt
->
»p
.
’v
 = (’v ?ƒnv->»°: 
nuÎ±r
);

396 
	}
}

398 
	$Ëv–db_İtiÚs_£t_šfo_log
(
Ëv–db_İtiÚs_t
* 
İt
, 
Ëv–db_logg”_t
* 
l
) {

399 
İt
->
»p
.
šfo_log
 = (
l
 ?†->»°: 
nuÎ±r
);

400 
	}
}

402 
	$Ëv–db_İtiÚs_£t_wr™e_bufãr_size
(
Ëv–db_İtiÚs_t
* 
İt
, 
size_t
 
s
) {

403 
İt
->
»p
.
wr™e_bufãr_size
 = 
s
;

404 
	}
}

406 
	$Ëv–db_İtiÚs_£t_max_İ’_fes
(
Ëv–db_İtiÚs_t
* 
İt
, 
n
) {

407 
İt
->
»p
.
max_İ’_fes
 = 
n
;

408 
	}
}

410 
	$Ëv–db_İtiÚs_£t_ÿche
(
Ëv–db_İtiÚs_t
* 
İt
, 
Ëv–db_ÿche_t
* 
c
) {

411 
İt
->
»p
.
block_ÿche
 = 
c
->rep;

412 
	}
}

414 
	$Ëv–db_İtiÚs_£t_block_size
(
Ëv–db_İtiÚs_t
* 
İt
, 
size_t
 
s
) {

415 
İt
->
»p
.
block_size
 = 
s
;

416 
	}
}

418 
	$Ëv–db_İtiÚs_£t_block_»¡¬t_š‹rv®
(
Ëv–db_İtiÚs_t
* 
İt
, 
n
) {

419 
İt
->
»p
.
block_»¡¬t_š‹rv®
 = 
n
;

420 
	}
}

422 
	$Ëv–db_İtiÚs_£t_max_fe_size
(
Ëv–db_İtiÚs_t
* 
İt
, 
size_t
 
s
) {

423 
İt
->
»p
.
max_fe_size
 = 
s
;

424 
	}
}

426 
	$Ëv–db_İtiÚs_£t_com´essiÚ
(
Ëv–db_İtiÚs_t
* 
İt
, 
t
) {

427 
İt
->
»p
.
com´essiÚ
 = 
¡©ic_ÿ¡
<
Com´essiÚTy³
>(
t
);

428 
	}
}

430 
Ëv–db_com·¿tÜ_t
* 
	$Ëv–db_com·¿tÜ_ü—‹
(

431 * 
¡©e
, (*
de¡ruùÜ
)(*),

432 (*
com·»
)(*, cÚ¡ * 
a
, 
size_t
 
®’
, cÚ¡ * 
b
,

433 
size_t
 
bËn
),

434 cÚ¡ * (*
Çme
)(*)) {

435 
Ëv–db_com·¿tÜ_t
* 
»suÉ
 = 
Ãw
†eveldb_comparator_t;

436 
»suÉ
->
¡©e_
 = 
¡©e
;

437 
»suÉ
->
de¡ruùÜ_
 = 
de¡ruùÜ
;

438 
»suÉ
->
com·»_
 = 
com·»
;

439 
»suÉ
->
Çme_
 = 
Çme
;

440  
»suÉ
;

441 
	}
}

443 
	$Ëv–db_com·¿tÜ_de¡roy
(
Ëv–db_com·¿tÜ_t
* 
cmp
è{ 
d–‘e
 cmp; 
	}
}

445 
Ëv–db_f‹½Şicy_t
* 
	$Ëv–db_f‹½Şicy_ü—‹
(

446 * 
¡©e
, (*
de¡ruùÜ
)(*),

447 * (*
ü—‹_f‹r
)(*, cÚ¡ * cÚ¡* 
key_¬¿y
,

448 cÚ¡ 
size_t
* 
key_Ëngth_¬¿y
, 
num_keys
,

449 
size_t
* 
f‹r_Ëngth
),

450 
	$ušt8_t
 (*
key_may_m©ch
)(*, cÚ¡ * 
key
, 
size_t
 
Ëngth
,

451 cÚ¡ * 
f‹r
, 
size_t
 
f‹r_Ëngth
),

452 cÚ¡ * (*
Çme
)(*)) {

453 
Ëv–db_f‹½Şicy_t
* 
»suÉ
 = 
Ãw
†eveldb_filterpolicy_t;

454 
»suÉ
->
¡©e_
 = 
¡©e
;

455 
»suÉ
->
de¡ruùÜ_
 = 
de¡ruùÜ
;

456 
»suÉ
->
ü—‹_
 = 
ü—‹_f‹r
;

457 
»suÉ
->
key_m©ch_
 = 
key_may_m©ch
;

458 
»suÉ
->
Çme_
 = 
Çme
;

459  
»suÉ
;

460 
	}
}

462 
	$Ëv–db_f‹½Şicy_de¡roy
(
Ëv–db_f‹½Şicy_t
* 
f‹r
) {

463 
d–‘e
 
f‹r
;

464 
	}
}

466 
Ëv–db_f‹½Şicy_t
* 
	$Ëv–db_f‹½Şicy_ü—‹_bloom
(
b™s_³r_key
) {

470 
W¿µ”
 : 
public
 
Ëv–db_f‹½Şicy_t
 {

471 
	`DoNÙhšg
(*) {}

473 ~
	`W¿µ”
(è{ 
d–‘e
 
»p_
; }

474 cÚ¡ * 
	`Name
(ècÚ¡ {  
»p_
->Name(); }

475 
	`C»©eF‹r
(cÚ¡ 
Sliû
* 
keys
, 
n
, 
¡d
::
¡ršg
* 
d¡
) const {

476  
»p_
->
	`C»©eF‹r
(
keys
, 
n
, 
d¡
);

478 
boŞ
 
	`KeyMayM©ch
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
f‹r
) const {

479  
»p_
->
	`KeyMayM©ch
(
key
, 
f‹r
);

482 cÚ¡ 
F‹rPŞicy
* 
»p_
;

484 
W¿µ”
* 
w¿µ”
 = 
Ãw
 Wrapper;

485 
w¿µ”
->
»p_
 = 
	`NewBloomF‹rPŞicy
(
b™s_³r_key
);

486 
w¿µ”
->
¡©e_
 = 
nuÎ±r
;

487 
w¿µ”
->
de¡ruùÜ_
 = &
W¿µ”
::
DoNÙhšg
;

488  
w¿µ”
;

489 
	}
}

491 
Ëv–db_»adİtiÚs_t
* 
	$Ëv–db_»adİtiÚs_ü—‹
() {

492  
Ãw
 
Ëv–db_»adİtiÚs_t
;

493 
	}
}

495 
	$Ëv–db_»adİtiÚs_de¡roy
(
Ëv–db_»adİtiÚs_t
* 
İt
è{ 
d–‘e
 o±; 
	}
}

497 
	$Ëv–db_»adİtiÚs_£t_v”ify_checksums
(
Ëv–db_»adİtiÚs_t
* 
İt
,

498 
ušt8_t
 
v
) {

499 
İt
->
»p
.
v”ify_checksums
 = 
v
;

500 
	}
}

502 
	$Ëv–db_»adİtiÚs_£t_fl_ÿche
(
Ëv–db_»adİtiÚs_t
* 
İt
, 
ušt8_t
 
v
) {

503 
İt
->
»p
.
fl_ÿche
 = 
v
;

504 
	}
}

506 
	$Ëv–db_»adİtiÚs_£t_¢­shÙ
(
Ëv–db_»adİtiÚs_t
* 
İt
,

507 cÚ¡ 
Ëv–db_¢­shÙ_t
* 
¢­
) {

508 
İt
->
»p
.
¢­shÙ
 = (
¢­
 ? sÇp->»°: 
nuÎ±r
);

509 
	}
}

511 
Ëv–db_wr™eİtiÚs_t
* 
	$Ëv–db_wr™eİtiÚs_ü—‹
() {

512  
Ãw
 
Ëv–db_wr™eİtiÚs_t
;

513 
	}
}

515 
	$Ëv–db_wr™eİtiÚs_de¡roy
(
Ëv–db_wr™eİtiÚs_t
* 
İt
è{ 
d–‘e
 o±; 
	}
}

517 
	$Ëv–db_wr™eİtiÚs_£t_sync
(
Ëv–db_wr™eİtiÚs_t
* 
İt
, 
ušt8_t
 
v
) {

518 
İt
->
»p
.
sync
 = 
v
;

519 
	}
}

521 
Ëv–db_ÿche_t
* 
	$Ëv–db_ÿche_ü—‹_Ìu
(
size_t
 
ÿ·c™y
) {

522 
Ëv–db_ÿche_t
* 
c
 = 
Ãw
†eveldb_cache_t;

523 
c
->
»p
 = 
	`NewLRUCache
(
ÿ·c™y
);

524  
c
;

525 
	}
}

527 
	$Ëv–db_ÿche_de¡roy
(
Ëv–db_ÿche_t
* 
ÿche
) {

528 
d–‘e
 
ÿche
->
»p
;

529 
d–‘e
 
ÿche
;

530 
	}
}

532 
Ëv–db_’v_t
* 
	$Ëv–db_ü—‹_deçuÉ_’v
() {

533 
Ëv–db_’v_t
* 
»suÉ
 = 
Ãw
†eveldb_env_t;

534 
»suÉ
->
»p
 = 
Env
::
	`DeçuÉ
();

535 
»suÉ
->
is_deçuÉ
 = 
Œue
;

536  
»suÉ
;

537 
	}
}

539 
	$Ëv–db_’v_de¡roy
(
Ëv–db_’v_t
* 
’v
) {

540 ià(!
’v
->
is_deçuÉ
è
d–‘e
ƒnv->
»p
;

541 
d–‘e
 
’v
;

542 
	}
}

544 * 
	$Ëv–db_’v_g‘_‹¡_dœeùÜy
(
Ëv–db_’v_t
* 
’v
) {

545 
¡d
::
¡ršg
 
»suÉ
;

546 ià(!
’v
->
»p
->
	`G‘Te¡DœeùÜy
(&
»suÉ
).
	`ok
()) {

547  
nuÎ±r
;

550 * 
bufãr
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
»suÉ
.
	`size
() + 1));

551 
	`memıy
(
bufãr
, 
»suÉ
.
	`d©a
(),„esuÉ.
	`size
());

552 
bufãr
[
»suÉ
.
	`size
()] = '\0';

553  
bufãr
;

554 
	}
}

556 
	$Ëv–db_ä“
(* 
±r
è{ 
	`ä“
ÕŒ); 
	}
}

558 
	$Ëv–db_majÜ_v”siÚ
(è{  
kMajÜV”siÚ
; 
	}
}

560 
	$Ëv–db_mšÜ_v”siÚ
(è{  
kMšÜV”siÚ
; 
	}
}

	@c_test.c

5 
	~"Ëv–db/c.h
"

7 
	~<¡ddef.h
>

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 cÚ¡ * 
	gpha£
 = "";

14 
	$S¹Pha£
(cÚ¡ * 
Çme
) {

15 
	`årštf
(
¡d”r
, "==ğTe¡ %s\n", 
Çme
);

16 
pha£
 = 
Çme
;

17 
	}
}

19 
	#CheckNoE¼Ü
(
”r
) \

20 ià((
”r
è!ğ
NULL
) { \

21 
	`årštf
(
¡d”r
, "%s:%d: %s: %s\n", 
__FILE__
, 
__LINE__
, 
pha£
, (
”r
)); \

22 
	`abÜt
(); \

23 }

	)

25 
	#CheckCÚd™iÚ
(
cÚd
) \

26 ià(!(
cÚd
)) { \

27 
	`årštf
(
¡d”r
, "%s:%d: %s: %s\n", 
__FILE__
, 
__LINE__
, 
pha£
, #cond); \

28 
	`abÜt
(); \

29 }

	)

31 
	$CheckEqu®
(cÚ¡ * 
ex³ùed
, cÚ¡ * 
v
, 
size_t
 
n
) {

32 ià(
ex³ùed
 =ğ
NULL
 && 
v
 == NULL) {

34 } ià(
ex³ùed
 !ğ
NULL
 && 
v
 !ğNULL && 
n
 =ğ
	`¡¾’
(expected) &&

35 
	`memcmp
(
ex³ùed
, 
v
, 
n
) == 0) {

39 
	`årštf
(
¡d”r
, "%s:ƒxpected '%s', got '%s'\n",

40 
pha£
,

41 (
ex³ùed
 ?ƒxpected : "(null)"),

42 (
v
 ? v : "(null"));

43 
	`abÜt
();

45 
	}
}

47 
	$F»e
(** 
±r
) {

48 ià(*
±r
) {

49 
	`ä“
(*
±r
);

50 *
±r
 = 
NULL
;

52 
	}
}

54 
	$CheckG‘
(

55 
Ëv–db_t
* 
db
,

56 cÚ¡ 
Ëv–db_»adİtiÚs_t
* 
İtiÚs
,

57 cÚ¡ * 
key
,

58 cÚ¡ * 
ex³ùed
) {

59 * 
”r
 = 
NULL
;

60 
size_t
 
v®_Ën
;

61 * 
v®
;

62 
v®
 = 
	`Ëv–db_g‘
(
db
, 
İtiÚs
, 
key
, 
	`¡¾’
(key), &
v®_Ën
, &
”r
);

63 
	`CheckNoE¼Ü
(
”r
);

64 
	`CheckEqu®
(
ex³ùed
, 
v®
, 
v®_Ën
);

65 
	`F»e
(&
v®
);

66 
	}
}

68 
	$CheckI‹r
(
Ëv–db_™”©Ü_t
* 
™”
,

69 cÚ¡ * 
key
, cÚ¡ * 
v®
) {

70 
size_t
 
Ën
;

71 cÚ¡ * 
¡r
;

72 
¡r
 = 
	`Ëv–db_™”_key
(
™”
, &
Ën
);

73 
	`CheckEqu®
(
key
, 
¡r
, 
Ën
);

74 
¡r
 = 
	`Ëv–db_™”_v®ue
(
™”
, &
Ën
);

75 
	`CheckEqu®
(
v®
, 
¡r
, 
Ën
);

76 
	}
}

79 
	$CheckPut
(* 
±r
,

80 cÚ¡ * 
k
, 
size_t
 
kËn
,

81 cÚ¡ * 
v
, 
size_t
 
vËn
) {

82 * 
¡©e
 = (*è
±r
;

83 
	`CheckCÚd™iÚ
(*
¡©e
 < 2);

84 *
¡©e
) {

86 
	`CheckEqu®
("b¬", 
k
, 
kËn
);

87 
	`CheckEqu®
("b", 
v
, 
vËn
);

90 
	`CheckEqu®
("box", 
k
, 
kËn
);

91 
	`CheckEqu®
("c", 
v
, 
vËn
);

94 (*
¡©e
)++;

95 
	}
}

98 
	$CheckD–
(* 
±r
, cÚ¡ * 
k
, 
size_t
 
kËn
) {

99 * 
¡©e
 = (*è
±r
;

100 
	`CheckCÚd™iÚ
(*
¡©e
 == 2);

101 
	`CheckEqu®
("b¬", 
k
, 
kËn
);

102 (*
¡©e
)++;

103 
	}
}

105 
	$CmpDe¡roy
(* 
¬g
è{ 
	}
}

107 
	$CmpCom·»
(* 
¬g
, cÚ¡ * 
a
, 
size_t
 
®’
,

108 cÚ¡ * 
b
, 
size_t
 
bËn
) {

109 
n
 = (
®’
 < 
bËn
) ?‡len : blen;

110 
r
 = 
	`memcmp
(
a
, 
b
, 
n
);

111 ià(
r
 == 0) {

112 ià(
®’
 < 
bËn
è
r
 = -1;

113 ià(
®’
 > 
bËn
è
r
 = +1;

115  
r
;

116 
	}
}

118 cÚ¡ * 
	$CmpName
(* 
¬g
) {

120 
	}
}

123 
ušt8_t
 
	gçke_f‹r_»suÉ
 = 1;

124 
	$F‹rDe¡roy
(* 
¬g
è{ 
	}
}

125 cÚ¡ * 
	$F‹rName
(* 
¬g
) {

127 
	}
}

128 * 
	$F‹rC»©e
(

129 * 
¬g
,

130 cÚ¡ * cÚ¡* 
key_¬¿y
, cÚ¡ 
size_t
* 
key_Ëngth_¬¿y
,

131 
num_keys
,

132 
size_t
* 
f‹r_Ëngth
) {

133 *
f‹r_Ëngth
 = 4;

134 * 
»suÉ
 = 
	`m®loc
(4);

135 
	`memıy
(
»suÉ
, "fake", 4);

136  
»suÉ
;

137 
	}
}

138 
ušt8_t
 
	$F‹rKeyM©ch
(* 
¬g
, cÚ¡ * 
key
, 
size_t
 
Ëngth
,

139 cÚ¡ * 
f‹r
, 
size_t
 
f‹r_Ëngth
) {

140 
	`CheckCÚd™iÚ
(
f‹r_Ëngth
 == 4);

141 
	`CheckCÚd™iÚ
(
	`memcmp
(
f‹r
, "fake", 4) == 0);

142  
çke_f‹r_»suÉ
;

143 
	}
}

145 
	$maš
(
¬gc
, ** 
¬gv
) {

146 
Ëv–db_t
* 
db
;

147 
Ëv–db_com·¿tÜ_t
* 
cmp
;

148 
Ëv–db_ÿche_t
* 
ÿche
;

149 
Ëv–db_’v_t
* 
’v
;

150 
Ëv–db_İtiÚs_t
* 
İtiÚs
;

151 
Ëv–db_»adİtiÚs_t
* 
rİtiÚs
;

152 
Ëv–db_wr™eİtiÚs_t
* 
wİtiÚs
;

153 * 
dbÇme
;

154 * 
”r
 = 
NULL
;

155 
run
 = -1;

157 
	`CheckCÚd™iÚ
(
	`Ëv–db_majÜ_v”siÚ
() >= 1);

158 
	`CheckCÚd™iÚ
(
	`Ëv–db_mšÜ_v”siÚ
() >= 1);

160 
	`S¹Pha£
("create_objects");

161 
cmp
 = 
	`Ëv–db_com·¿tÜ_ü—‹
(
NULL
, 
CmpDe¡roy
, 
CmpCom·»
, 
CmpName
);

162 
’v
 = 
	`Ëv–db_ü—‹_deçuÉ_’v
();

163 
ÿche
 = 
	`Ëv–db_ÿche_ü—‹_Ìu
(100000);

164 
dbÇme
 = 
	`Ëv–db_’v_g‘_‹¡_dœeùÜy
(
’v
);

165 
	`CheckCÚd™iÚ
(
dbÇme
 !ğ
NULL
);

167 
İtiÚs
 = 
	`Ëv–db_İtiÚs_ü—‹
();

168 
	`Ëv–db_İtiÚs_£t_com·¿tÜ
(
İtiÚs
, 
cmp
);

169 
	`Ëv–db_İtiÚs_£t_”rÜ_if_exi¡s
(
İtiÚs
, 1);

170 
	`Ëv–db_İtiÚs_£t_ÿche
(
İtiÚs
, 
ÿche
);

171 
	`Ëv–db_İtiÚs_£t_’v
(
İtiÚs
, 
’v
);

172 
	`Ëv–db_İtiÚs_£t_šfo_log
(
İtiÚs
, 
NULL
);

173 
	`Ëv–db_İtiÚs_£t_wr™e_bufãr_size
(
İtiÚs
, 100000);

174 
	`Ëv–db_İtiÚs_£t_·¿noid_checks
(
İtiÚs
, 1);

175 
	`Ëv–db_İtiÚs_£t_max_İ’_fes
(
İtiÚs
, 10);

176 
	`Ëv–db_İtiÚs_£t_block_size
(
İtiÚs
, 1024);

177 
	`Ëv–db_İtiÚs_£t_block_»¡¬t_š‹rv®
(
İtiÚs
, 8);

178 
	`Ëv–db_İtiÚs_£t_max_fe_size
(
İtiÚs
, 3 << 20);

179 
	`Ëv–db_İtiÚs_£t_com´essiÚ
(
İtiÚs
, 
Ëv–db_no_com´essiÚ
);

181 
rİtiÚs
 = 
	`Ëv–db_»adİtiÚs_ü—‹
();

182 
	`Ëv–db_»adİtiÚs_£t_v”ify_checksums
(
rİtiÚs
, 1);

183 
	`Ëv–db_»adİtiÚs_£t_fl_ÿche
(
rİtiÚs
, 0);

185 
wİtiÚs
 = 
	`Ëv–db_wr™eİtiÚs_ü—‹
();

186 
	`Ëv–db_wr™eİtiÚs_£t_sync
(
wİtiÚs
, 1);

188 
	`S¹Pha£
("destroy");

189 
	`Ëv–db_de¡roy_db
(
İtiÚs
, 
dbÇme
, &
”r
);

190 
	`F»e
(&
”r
);

192 
	`S¹Pha£
("open_error");

193 
db
 = 
	`Ëv–db_İ’
(
İtiÚs
, 
dbÇme
, &
”r
);

194 
	`CheckCÚd™iÚ
(
”r
 !ğ
NULL
);

195 
	`F»e
(&
”r
);

197 
	`S¹Pha£
("leveldb_free");

198 
db
 = 
	`Ëv–db_İ’
(
İtiÚs
, 
dbÇme
, &
”r
);

199 
	`CheckCÚd™iÚ
(
”r
 !ğ
NULL
);

200 
	`Ëv–db_ä“
(
”r
);

201 
”r
 = 
NULL
;

203 
	`S¹Pha£
("open");

204 
	`Ëv–db_İtiÚs_£t_ü—‹_if_missšg
(
İtiÚs
, 1);

205 
db
 = 
	`Ëv–db_İ’
(
İtiÚs
, 
dbÇme
, &
”r
);

206 
	`CheckNoE¼Ü
(
”r
);

207 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", 
NULL
);

209 
	`S¹Pha£
("put");

210 
	`Ëv–db_put
(
db
, 
wİtiÚs
, "foo", 3, "h–lo", 5, &
”r
);

211 
	`CheckNoE¼Ü
(
”r
);

212 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "hello");

214 
	`S¹Pha£
("compactall");

215 
	`Ëv–db_com·ù_¿nge
(
db
, 
NULL
, 0, NULL, 0);

216 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "hello");

218 
	`S¹Pha£
("compactrange");

219 
	`Ëv–db_com·ù_¿nge
(
db
, "a", 1, "z", 1);

220 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "hello");

222 
	`S¹Pha£
("writebatch");

224 
Ëv–db_wr™eb©ch_t
* 
wb
 = 
	`Ëv–db_wr™eb©ch_ü—‹
();

225 
	`Ëv–db_wr™eb©ch_put
(
wb
, "foo", 3, "a", 1);

226 
	`Ëv–db_wr™eb©ch_ş—r
(
wb
);

227 
	`Ëv–db_wr™eb©ch_put
(
wb
, "bar", 3, "b", 1);

228 
	`Ëv–db_wr™eb©ch_put
(
wb
, "box", 3, "c", 1);

230 
Ëv–db_wr™eb©ch_t
* 
wb2
 = 
	`Ëv–db_wr™eb©ch_ü—‹
();

231 
	`Ëv–db_wr™eb©ch_d–‘e
(
wb2
, "bar", 3);

232 
	`Ëv–db_wr™eb©ch_­³nd
(
wb
, 
wb2
);

233 
	`Ëv–db_wr™eb©ch_de¡roy
(
wb2
);

235 
	`Ëv–db_wr™e
(
db
, 
wİtiÚs
, 
wb
, &
”r
);

236 
	`CheckNoE¼Ü
(
”r
);

237 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "hello");

238 
	`CheckG‘
(
db
, 
rİtiÚs
, "b¬", 
NULL
);

239 
	`CheckG‘
(
db
, 
rİtiÚs
, "box", "c");

241 
pos
 = 0;

242 
	`Ëv–db_wr™eb©ch_™”©e
(
wb
, &
pos
, 
CheckPut
, 
CheckD–
);

243 
	`CheckCÚd™iÚ
(
pos
 == 3);

244 
	`Ëv–db_wr™eb©ch_de¡roy
(
wb
);

247 
	`S¹Pha£
("iter");

249 
Ëv–db_™”©Ü_t
* 
™”
 = 
	`Ëv–db_ü—‹_™”©Ü
(
db
, 
rİtiÚs
);

250 
	`CheckCÚd™iÚ
(!
	`Ëv–db_™”_v®id
(
™”
));

251 
	`Ëv–db_™”_£ek_to_fœ¡
(
™”
);

252 
	`CheckCÚd™iÚ
(
	`Ëv–db_™”_v®id
(
™”
));

253 
	`CheckI‹r
(
™”
, "box", "c");

254 
	`Ëv–db_™”_Ãxt
(
™”
);

255 
	`CheckI‹r
(
™”
, "foo", "hello");

256 
	`Ëv–db_™”_´ev
(
™”
);

257 
	`CheckI‹r
(
™”
, "box", "c");

258 
	`Ëv–db_™”_´ev
(
™”
);

259 
	`CheckCÚd™iÚ
(!
	`Ëv–db_™”_v®id
(
™”
));

260 
	`Ëv–db_™”_£ek_to_Ï¡
(
™”
);

261 
	`CheckI‹r
(
™”
, "foo", "hello");

262 
	`Ëv–db_™”_£ek
(
™”
, "b", 1);

263 
	`CheckI‹r
(
™”
, "box", "c");

264 
	`Ëv–db_™”_g‘_”rÜ
(
™”
, &
”r
);

265 
	`CheckNoE¼Ü
(
”r
);

266 
	`Ëv–db_™”_de¡roy
(
™”
);

269 
	`S¹Pha£
("approximate_sizes");

271 
i
;

272 
n
 = 20000;

273 
keybuf
[100];

274 
v®buf
[100];

275 
ušt64_t
 
sizes
[2];

276 cÚ¡ * 
¡¬t
[2] = { "a", "k00000000000000010000" };

277 
size_t
 
¡¬t_Ën
[2] = { 1, 21 };

278 cÚ¡ * 
lim™
[2] = { "k00000000000000010000", "z" };

279 
size_t
 
lim™_Ën
[2] = { 21, 1 };

280 
	`Ëv–db_wr™eİtiÚs_£t_sync
(
wİtiÚs
, 0);

281 
i
 = 0; i < 
n
; i++) {

282 
	`¢´štf
(
keybuf
, (keybuf), "k%020d", 
i
);

283 
	`¢´štf
(
v®buf
, (v®buf), "v%020d", 
i
);

284 
	`Ëv–db_put
(
db
, 
wİtiÚs
, 
keybuf
, 
	`¡¾’
(keybuf), 
v®buf
, strlen(valbuf),

285 &
”r
);

286 
	`CheckNoE¼Ü
(
”r
);

288 
	`Ëv–db_­´oxim©e_sizes
(
db
, 2, 
¡¬t
, 
¡¬t_Ën
, 
lim™
, 
lim™_Ën
, 
sizes
);

289 
	`CheckCÚd™iÚ
(
sizes
[0] > 0);

290 
	`CheckCÚd™iÚ
(
sizes
[1] > 0);

293 
	`S¹Pha£
("property");

295 * 
´İ
 = 
	`Ëv–db_´İ”ty_v®ue
(
db
, "nosuchprop");

296 
	`CheckCÚd™iÚ
(
´İ
 =ğ
NULL
);

297 
´İ
 = 
	`Ëv–db_´İ”ty_v®ue
(
db
, "leveldb.stats");

298 
	`CheckCÚd™iÚ
(
´İ
 !ğ
NULL
);

299 
	`F»e
(&
´İ
);

302 
	`S¹Pha£
("snapshot");

304 cÚ¡ 
Ëv–db_¢­shÙ_t
* 
¢­
;

305 
¢­
 = 
	`Ëv–db_ü—‹_¢­shÙ
(
db
);

306 
	`Ëv–db_d–‘e
(
db
, 
wİtiÚs
, "foo", 3, &
”r
);

307 
	`CheckNoE¼Ü
(
”r
);

308 
	`Ëv–db_»adİtiÚs_£t_¢­shÙ
(
rİtiÚs
, 
¢­
);

309 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "hello");

310 
	`Ëv–db_»adİtiÚs_£t_¢­shÙ
(
rİtiÚs
, 
NULL
);

311 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", 
NULL
);

312 
	`Ëv–db_»Ëa£_¢­shÙ
(
db
, 
¢­
);

315 
	`S¹Pha£
("repair");

317 
	`Ëv–db_şo£
(
db
);

318 
	`Ëv–db_İtiÚs_£t_ü—‹_if_missšg
(
İtiÚs
, 0);

319 
	`Ëv–db_İtiÚs_£t_”rÜ_if_exi¡s
(
İtiÚs
, 0);

320 
	`Ëv–db_»·œ_db
(
İtiÚs
, 
dbÇme
, &
”r
);

321 
	`CheckNoE¼Ü
(
”r
);

322 
db
 = 
	`Ëv–db_İ’
(
İtiÚs
, 
dbÇme
, &
”r
);

323 
	`CheckNoE¼Ü
(
”r
);

324 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", 
NULL
);

325 
	`CheckG‘
(
db
, 
rİtiÚs
, "b¬", 
NULL
);

326 
	`CheckG‘
(
db
, 
rİtiÚs
, "box", "c");

327 
	`Ëv–db_İtiÚs_£t_ü—‹_if_missšg
(
İtiÚs
, 1);

328 
	`Ëv–db_İtiÚs_£t_”rÜ_if_exi¡s
(
İtiÚs
, 1);

331 
	`S¹Pha£
("filter");

332 
run
 = 0;„un < 2;„un++) {

334 
	`CheckNoE¼Ü
(
”r
);

335 
Ëv–db_f‹½Şicy_t
* 
pŞicy
;

336 ià(
run
 == 0) {

337 
pŞicy
 = 
	`Ëv–db_f‹½Şicy_ü—‹
(

338 
NULL
, 
F‹rDe¡roy
, 
F‹rC»©e
, 
F‹rKeyM©ch
, 
F‹rName
);

340 
pŞicy
 = 
	`Ëv–db_f‹½Şicy_ü—‹_bloom
(10);

344 
	`Ëv–db_şo£
(
db
);

345 
	`Ëv–db_de¡roy_db
(
İtiÚs
, 
dbÇme
, &
”r
);

346 
	`Ëv–db_İtiÚs_£t_f‹r_pŞicy
(
İtiÚs
, 
pŞicy
);

347 
db
 = 
	`Ëv–db_İ’
(
İtiÚs
, 
dbÇme
, &
”r
);

348 
	`CheckNoE¼Ü
(
”r
);

349 
	`Ëv–db_put
(
db
, 
wİtiÚs
, "foo", 3, "foov®ue", 8, &
”r
);

350 
	`CheckNoE¼Ü
(
”r
);

351 
	`Ëv–db_put
(
db
, 
wİtiÚs
, "b¬", 3, "b¬v®ue", 8, &
”r
);

352 
	`CheckNoE¼Ü
(
”r
);

353 
	`Ëv–db_com·ù_¿nge
(
db
, 
NULL
, 0, NULL, 0);

355 
çke_f‹r_»suÉ
 = 1;

356 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "foovalue");

357 
	`CheckG‘
(
db
, 
rİtiÚs
, "bar", "barvalue");

358 ià(
pha£
 == 0) {

360 
çke_f‹r_»suÉ
 = 0;

361 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", 
NULL
);

362 
	`CheckG‘
(
db
, 
rİtiÚs
, "b¬", 
NULL
);

363 
çke_f‹r_»suÉ
 = 1;

365 
	`CheckG‘
(
db
, 
rİtiÚs
, "foo", "foovalue");

366 
	`CheckG‘
(
db
, 
rİtiÚs
, "bar", "barvalue");

368 
	`Ëv–db_İtiÚs_£t_f‹r_pŞicy
(
İtiÚs
, 
NULL
);

369 
	`Ëv–db_f‹½Şicy_de¡roy
(
pŞicy
);

372 
	`S¹Pha£
("cleanup");

373 
	`Ëv–db_şo£
(
db
);

374 
	`Ëv–db_İtiÚs_de¡roy
(
İtiÚs
);

375 
	`Ëv–db_»adİtiÚs_de¡roy
(
rİtiÚs
);

376 
	`Ëv–db_wr™eİtiÚs_de¡roy
(
wİtiÚs
);

377 
	`Ëv–db_ä“
(
dbÇme
);

378 
	`Ëv–db_ÿche_de¡roy
(
ÿche
);

379 
	`Ëv–db_com·¿tÜ_de¡roy
(
cmp
);

380 
	`Ëv–db_’v_de¡roy
(
’v
);

382 
	`årštf
(
¡d”r
, "PASS\n");

384 
	}
}

	@corruption_test.cc

5 
	~<sys/ty³s.h
>

7 
	~"g‹¡/g‹¡.h
"

8 
	~"db/db_im¶.h
"

9 
	~"db/f’ame.h
"

10 
	~"db/log_fÜm©.h
"

11 
	~"db/v”siÚ_£t.h
"

12 
	~"Ëv–db/ÿche.h
"

13 
	~"Ëv–db/db.h
"

14 
	~"Ëv–db/bË.h
"

15 
	~"Ëv–db/wr™e_b©ch.h
"

16 
	~"ut/loggšg.h
"

17 
	~"ut/‹¡ut.h
"

19 
Çme¥aû
 
	gËv–db
 {

21 cÚ¡ 
	gkV®ueSize
 = 1000;

23 şas 
	cCÜru±iÚTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

24 
public
:

25 
CÜru±iÚTe¡
()

26 : 
db_
(
nuÎ±r
),

27 
dbÇme_
("/memenv/corruption_test"),

28 
tšy_ÿche_
(
NewLRUCache
(100)) {

29 
	gİtiÚs_
.
	g’v
 = &
’v_
;

30 
	gİtiÚs_
.
	gblock_ÿche
 = 
tšy_ÿche_
;

31 
De¡royDB
(
dbÇme_
, 
İtiÚs_
);

33 
	gİtiÚs_
.
	gü—‹_if_missšg
 = 
Œue
;

34 
Reİ’
();

35 
	gİtiÚs_
.
	gü—‹_if_missšg
 = 
çl£
;

38 ~
CÜru±iÚTe¡
() {

39 
d–‘e
 
	gdb_
;

40 
d–‘e
 
	gtšy_ÿche_
;

43 
Stus
 
TryReİ’
() {

44 
d–‘e
 
	gdb_
;

45 
	gdb_
 = 
nuÎ±r
;

46  
	gDB
::
O³n
(
İtiÚs_
, 
dbÇme_
, &
db_
);

49 
Reİ’
(è{ 
ASSERT_LEVELDB_OK
(
TryReİ’
()); }

51 
R•aœDB
() {

52 
d–‘e
 
	gdb_
;

53 
	gdb_
 = 
nuÎ±r
;

54 
ASSERT_LEVELDB_OK
(::
Ëv–db
::
R•aœDB
(
dbÇme_
, 
İtiÚs_
));

57 
Bud
(
n
) {

58 
	g¡d
::
¡ršg
 
key_¥aû
, 
	gv®ue_¥aû
;

59 
Wr™eB©ch
 
	gb©ch
;

60 
	gi
 = 0; i < 
	gn
; i++) {

62 
Sliû
 
	gkey
 = 
Key
(
i
, &
key_¥aû
);

63 
	gb©ch
.
CË¬
();

64 
	gb©ch
.
Put
(
key
, 
V®ue
(
i
, &
v®ue_¥aû
));

65 
Wr™eO±iÚs
 
	gİtiÚs
;

68 ià(
	gi
 =ğ
n
 - 1) {

69 
İtiÚs
.
sync
 = 
Œue
;

71 
ASSERT_LEVELDB_OK
(
db_
->
Wr™e
(
İtiÚs
, &
b©ch
));

75 
Check
(
mš_ex³ùed
, 
max_ex³ùed
) {

76 
	gÃxt_ex³ùed
 = 0;

77 
	gmis£d
 = 0;

78 
	gbad_keys
 = 0;

79 
	gbad_v®ues
 = 0;

80 
	gcÜ»ù
 = 0;

81 
	g¡d
::
¡ršg
 
v®ue_¥aû
;

82 
I‹¿tÜ
* 
	g™”
 = 
db_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

83 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

84 
ušt64_t
 
	gkey
;

85 
Sliû
 
š
(
™”
->
key
());

86 ià(
	gš
 =ğ"" || 
š
 == "~") {

90 ià(!
CÚsumeDecim®Numb”
(&
š
, &
key
è|| !
	gš
.
em±y
() ||

91 
	gkey
 < 
	gÃxt_ex³ùed
) {

92 
	gbad_keys
++;

95 
	gmis£d
 +ğ(
key
 - 
Ãxt_ex³ùed
);

96 
	gÃxt_ex³ùed
 = 
key
 + 1;

97 ià(
	g™”
->
v®ue
(è!ğ
V®ue
(
key
, &
v®ue_¥aû
)) {

98 
	gbad_v®ues
++;

100 
	gcÜ»ù
++;

103 
d–‘e
 
	g™”
;

105 
årštf
(
¡d”r
,

107 
mš_ex³ùed
, 
max_ex³ùed
, 
cÜ»ù
, 
bad_keys
, 
bad_v®ues
, 
mis£d
);

108 
ASSERT_LE
(
mš_ex³ùed
, 
cÜ»ù
);

109 
ASSERT_GE
(
max_ex³ùed
, 
cÜ»ù
);

112 
CÜru±
(
FeTy³
 
f‘y³
, 
off£t
, 
by‹s_to_cÜru±
) {

114 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

115 
ASSERT_LEVELDB_OK
(
’v_
.
rg‘
()->
G‘Chd»n
(
dbÇme_
, &
f’ames
));

116 
ušt64_t
 
	gnumb”
;

117 
FeTy³
 
	gty³
;

118 
	g¡d
::
¡ršg
 
âame
;

119 
	gpicked_numb”
 = -1;

120 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

121 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
è&& 
	gty³
 =ğ
f‘y³
 &&

122 (
numb”
è> 
picked_numb”
) {

123 
âame
 = 
dbÇme_
 + "/" + 
f’ames
[
i
];

124 
	gpicked_numb”
 = 
numb”
;

127 
ASSERT_TRUE
(!
âame
.
em±y
()è<< 
	gf‘y³
;

129 
ušt64_t
 
	gfe_size
;

130 
ASSERT_LEVELDB_OK
(
’v_
.
rg‘
()->
G‘FeSize
(
âame
, &
fe_size
));

132 ià(
	goff£t
 < 0) {

134 ià(-
	goff£t
 > 
	gfe_size
) {

135 
	goff£t
 = 0;

137 
	goff£t
 = 
fe_size
 + 
off£t
;

140 ià(
	goff£t
 > 
	gfe_size
) {

141 
	goff£t
 = 
fe_size
;

143 ià(
	goff£t
 + 
	gby‹s_to_cÜru±
 > 
	gfe_size
) {

144 
	gby‹s_to_cÜru±
 = 
fe_size
 - 
off£t
;

148 
	g¡d
::
¡ršg
 
cÚ‹Ás
;

149 
Stus
 
	gs
 = 
R—dFeToSŒšg
(
’v_
.
rg‘
(), 
âame
, &
cÚ‹Ás
);

150 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

151 
	gi
 = 0; i < 
	gby‹s_to_cÜru±
; i++) {

152 
	gcÚ‹Ás
[
i
 + 
off£t
] ^= 0x80;

154 
	gs
 = 
Wr™eSŒšgToFe
(
’v_
.
rg‘
(), 
cÚ‹Ás
, 
âame
);

155 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

158 
Prİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

159 
¡d
::
¡ršg
 
´İ”ty
;

160 
	g»suÉ
;

161 ià(
	gdb_
->
G‘Prİ”ty
(
Çme
, &
´İ”ty
) &&

162 
ssÿnf
(
´İ”ty
.
c_¡r
(), "%d", &
»suÉ
) == 1) {

163  
»suÉ
;

170 
Sliû
 
Key
(
i
, 
¡d
::
¡ršg
* 
¡Üage
) {

171 
buf
[100];

172 
¢´štf
(
buf
, (buf), "%016d", 
i
);

173 
	g¡Üage
->
assign
(
buf
, 
¡¾’
(buf));

174  
Sliû
(*
¡Üage
);

178 
Sliû
 
V®ue
(
k
, 
¡d
::
¡ršg
* 
¡Üage
) {

179 
Rªdom
 
r
(
k
);

180  
	g‹¡
::
RªdomSŒšg
(&
r
, 
kV®ueSize
, 
¡Üage
);

183 
	g‹¡
::
E¼ÜEnv
 
’v_
;

184 
O±iÚs
 
	gİtiÚs_
;

185 
DB
* 
	gdb_
;

187 
	g´iv©e
:

188 
¡d
::
¡ršg
 
dbÇme_
;

189 
Cache
* 
	gtšy_ÿche_
;

192 
	$TEST_F
(
CÜru±iÚTe¡
, 
Recov”y
) {

193 
	`Bud
(100);

194 
	`Check
(100, 100);

195 
	`CÜru±
(
kLogFe
, 19, 1);

196 
	`CÜru±
(
kLogFe
, 
log
::
kBlockSize
 + 1000, 1);

197 
	`Reİ’
();

200 
	`Check
(36, 36);

201 
	}
}

203 
	$TEST_F
(
CÜru±iÚTe¡
, 
Recov”Wr™eE¼Ü
) {

204 
’v_
.
wr™abË_fe_”rÜ_
 = 
Œue
;

205 
Stus
 
s
 = 
	`TryReİ’
();

206 
	`ASSERT_TRUE
(!
s
.
	`ok
());

207 
	}
}

209 
	$TEST_F
(
CÜru±iÚTe¡
, 
NewFeE¼ÜDuršgWr™e
) {

211 
’v_
.
wr™abË_fe_”rÜ_
 = 
Œue
;

212 cÚ¡ 
num
 = 3 + (
	`O±iÚs
().
wr™e_bufãr_size
 / 
kV®ueSize
);

213 
¡d
::
¡ršg
 
v®ue_¡Üage
;

214 
Stus
 
s
;

215 
i
 = 0; 
s
.
	`ok
(è&& i < 
num
; i++) {

216 
Wr™eB©ch
 
b©ch
;

217 
b©ch
.
	`Put
("a", 
	`V®ue
(100, &
v®ue_¡Üage
));

218 
s
 = 
db_
->
	`Wr™e
(
	`Wr™eO±iÚs
(), &
b©ch
);

220 
	`ASSERT_TRUE
(!
s
.
	`ok
());

221 
	`ASSERT_GE
(
’v_
.
num_wr™abË_fe_”rÜs_
, 1);

222 
’v_
.
wr™abË_fe_”rÜ_
 = 
çl£
;

223 
	`Reİ’
();

224 
	}
}

226 
	$TEST_F
(
CÜru±iÚTe¡
, 
TabËFe
) {

227 
	`Bud
(100);

228 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

229 
dbi
->
	`TEST_Com·ùMemTabË
();

230 
dbi
->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

231 
dbi
->
	`TEST_Com·ùRªge
(1, 
nuÎ±r
,‚ullptr);

233 
	`CÜru±
(
kTabËFe
, 100, 1);

234 
	`Check
(90, 99);

235 
	}
}

237 
	$TEST_F
(
CÜru±iÚTe¡
, 
TabËFeR•aœ
) {

238 
İtiÚs_
.
block_size
 = 2 * 
kV®ueSize
;

239 
İtiÚs_
.
·¿noid_checks
 = 
Œue
;

240 
	`Reİ’
();

241 
	`Bud
(100);

242 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

243 
dbi
->
	`TEST_Com·ùMemTabË
();

244 
dbi
->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

245 
dbi
->
	`TEST_Com·ùRªge
(1, 
nuÎ±r
,‚ullptr);

247 
	`CÜru±
(
kTabËFe
, 100, 1);

248 
	`R•aœDB
();

249 
	`Reİ’
();

250 
	`Check
(95, 99);

251 
	}
}

253 
	$TEST_F
(
CÜru±iÚTe¡
, 
TabËFeIndexD©a
) {

254 
	`Bud
(10000);

255 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

256 
dbi
->
	`TEST_Com·ùMemTabË
();

258 
	`CÜru±
(
kTabËFe
, -2000, 500);

259 
	`Reİ’
();

260 
	`Check
(5000, 9999);

261 
	}
}

263 
	$TEST_F
(
CÜru±iÚTe¡
, 
MissšgDesütÜ
) {

264 
	`Bud
(1000);

265 
	`R•aœDB
();

266 
	`Reİ’
();

267 
	`Check
(1000, 1000);

268 
	}
}

270 
	$TEST_F
(
CÜru±iÚTe¡
, 
Sequ’ûNumb”Recov”y
) {

271 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v1"));

272 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v2"));

273 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v3"));

274 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v4"));

275 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v5"));

276 
	`R•aœDB
();

277 
	`Reİ’
();

278 
¡d
::
¡ršg
 
v
;

279 
	`ASSERT_LEVELDB_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

280 
	`ASSERT_EQ
("v5", 
v
);

283 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v6"));

284 
	`ASSERT_LEVELDB_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

285 
	`ASSERT_EQ
("v6", 
v
);

286 
	`Reİ’
();

287 
	`ASSERT_LEVELDB_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

288 
	`ASSERT_EQ
("v6", 
v
);

289 
	}
}

291 
	$TEST_F
(
CÜru±iÚTe¡
, 
CÜru±edDesütÜ
) {

292 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "hello"));

293 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

294 
dbi
->
	`TEST_Com·ùMemTabË
();

295 
dbi
->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

297 
	`CÜru±
(
kDesütÜFe
, 0, 1000);

298 
Stus
 
s
 = 
	`TryReİ’
();

299 
	`ASSERT_TRUE
(!
s
.
	`ok
());

301 
	`R•aœDB
();

302 
	`Reİ’
();

303 
¡d
::
¡ršg
 
v
;

304 
	`ASSERT_LEVELDB_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

305 
	`ASSERT_EQ
("h–lo", 
v
);

306 
	}
}

308 
	$TEST_F
(
CÜru±iÚTe¡
, 
Com·ùiÚIÅutE¼Ü
) {

309 
	`Bud
(10);

310 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

311 
dbi
->
	`TEST_Com·ùMemTabË
();

312 cÚ¡ 
Ï¡
 = 
cÚfig
::
kMaxMemCom·ùLev–
;

313 
	`ASSERT_EQ
(1, 
	`Prİ”ty
("Ëv–db.num-fes-©-Ëv–" + 
	`Numb”ToSŒšg
(
Ï¡
)));

315 
	`CÜru±
(
kTabËFe
, 100, 1);

316 
	`Check
(5, 9);

319 
	`Bud
(10000);

320 
	`Check
(10000, 10000);

321 
	}
}

323 
	$TEST_F
(
CÜru±iÚTe¡
, 
Com·ùiÚIÅutE¼ÜP¬ªoid
) {

324 
İtiÚs_
.
·¿noid_checks
 = 
Œue
;

325 
İtiÚs_
.
wr™e_bufãr_size
 = 512 << 10;

326 
	`Reİ’
();

327 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

330 
i
 = 0; i < 2; i++) {

331 
	`Bud
(10);

332 
dbi
->
	`TEST_Com·ùMemTabË
();

333 
	`CÜru±
(
kTabËFe
, 100, 1);

334 
’v_
.
	`SË•FÜMiüo£cÚds
(100000);

336 
dbi
->
	`Com·ùRªge
(
nuÎ±r
,‚ullptr);

339 
¡d
::
¡ršg
 
tmp1
, 
tmp2
;

340 
Stus
 
s
 = 
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
	`Key
(5, &
tmp1
), 
	`V®ue
(5, &
tmp2
));

341 
	`ASSERT_TRUE
(!
s
.
	`ok
()) << "write did‚ot fail in corrupted…aranoid db";

342 
	}
}

344 
	$TEST_F
(
CÜru±iÚTe¡
, 
UÄ–©edKeys
) {

345 
	`Bud
(10);

346 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

347 
dbi
->
	`TEST_Com·ùMemTabË
();

348 
	`CÜru±
(
kTabËFe
, 100, 1);

350 
¡d
::
¡ršg
 
tmp1
, 
tmp2
;

351 
	`ASSERT_LEVELDB_OK
(

352 
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
	`Key
(1000, &
tmp1
), 
	`V®ue
(1000, &
tmp2
)));

353 
¡d
::
¡ršg
 
v
;

354 
	`ASSERT_LEVELDB_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), 
	`Key
(1000, &
tmp1
), &
v
));

355 
	`ASSERT_EQ
(
	`V®ue
(1000, &
tmp2
).
	`ToSŒšg
(), 
v
);

356 
dbi
->
	`TEST_Com·ùMemTabË
();

357 
	`ASSERT_LEVELDB_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), 
	`Key
(1000, &
tmp1
), &
v
));

358 
	`ASSERT_EQ
(
	`V®ue
(1000, &
tmp2
).
	`ToSŒšg
(), 
v
);

359 
	}
}

363 
	$maš
(
¬gc
, ** 
¬gv
) {

364 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

365  
	`RUN_ALL_TESTS
();

366 
	}
}

	@db_impl.cc

5 
	~"db/db_im¶.h
"

7 
	~<¡dšt.h
>

8 
	~<¡dio.h
>

10 
	~<®gÜ™hm
>

11 
	~<©omic
>

12 
	~<£t
>

13 
	~<¡ršg
>

14 
	~<veùÜ
>

16 
	~"db/bud”.h
"

17 
	~"db/db_™”.h
"

18 
	~"db/dbfÜm©.h
"

19 
	~"db/f’ame.h
"

20 
	~"db/log_»ad”.h
"

21 
	~"db/log_wr™”.h
"

22 
	~"db/membË.h
"

23 
	~"db/bË_ÿche.h
"

24 
	~"db/v”siÚ_£t.h
"

25 
	~"db/wr™e_b©ch_š‹º®.h
"

26 
	~"Ëv–db/db.h
"

27 
	~"Ëv–db/’v.h
"

28 
	~"Ëv–db/¡©us.h
"

29 
	~"Ëv–db/bË.h
"

30 
	~"Ëv–db/bË_bud”.h
"

31 
	~"pÜt/pÜt.h
"

32 
	~"bË/block.h
"

33 
	~"bË/m”g”.h
"

34 
	~"bË/two_Ëv–_™”©Ü.h
"

35 
	~"ut/codšg.h
"

36 
	~"ut/loggšg.h
"

37 
	~"ut/mu‹xlock.h
"

39 
Çme¥aû
 
	gËv–db
 {

41 cÚ¡ 
	gkNumNÚTabËCacheFes
 = 10;

44 
	gDBIm¶
::
Wr™”
 {

45 
ex¶ic™
 
Wr™”
(
pÜt
::
Mu‹x
* 
mu
)

46 : 
b©ch
(
nuÎ±r
), 
sync
(
çl£
), 
dÚe
(çl£), 
cv
(
mu
) {}

48 
Stus
 
	g¡©us
;

49 
Wr™eB©ch
* 
	gb©ch
;

50 
boŞ
 
	gsync
;

51 
boŞ
 
	gdÚe
;

52 
	gpÜt
::
CÚdV¬
 
cv
;

55 
	gDBIm¶
::
Com·ùiÚS‹
 {

57 
	sOuut
 {

58 
ušt64_t
 
numb”
;

59 
ušt64_t
 
	gfe_size
;

60 
IÁ”ÇlKey
 
	gsm®Ë¡
, 
	gÏrge¡
;

63 
Ouut
* 
cu¼’t_ouut
(è{  &
	gouuts
[
ouuts
.
size
() - 1]; }

65 
ex¶ic™
 
Com·ùiÚS‹
(
Com·ùiÚ
* 
c
)

66 : 
com·ùiÚ
(
c
),

67 
sm®Ë¡_¢­shÙ
(0),

68 
outfe
(
nuÎ±r
),

69 
bud”
(
nuÎ±r
),

70 
tÙ®_by‹s
(0) {}

72 
Com·ùiÚ
* cÚ¡ 
	gcom·ùiÚ
;

78 
Sequ’ûNumb”
 
	gsm®Ë¡_¢­shÙ
;

80 
	g¡d
::
veùÜ
<
Ouut
> 
ouuts
;

83 
Wr™abËFe
* 
	goutfe
;

84 
TabËBud”
* 
	gbud”
;

86 
ušt64_t
 
	gtÙ®_by‹s
;

90 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gV
>

91 
ClToRªge
(
T
* 
±r
, 
V
 
mšv®ue
, V 
maxv®ue
) {

92 ià(
	g¡©ic_ÿ¡
<
	gV
>(*
	g±r
è> 
	gmaxv®ue
è*±¸ğ
maxv®ue
;

93 ià(
	g¡©ic_ÿ¡
<
	gV
>(*
	g±r
è< 
	gmšv®ue
è*±¸ğ
mšv®ue
;

95 
O±iÚs
 
Sª™izeO±iÚs
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

96 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
icmp
,

97 cÚ¡ 
IÁ”ÇlF‹rPŞicy
* 
Şicy
,

98 cÚ¡ 
O±iÚs
& 
¤c
) {

99 
O±iÚs
 
	g»suÉ
 = 
¤c
;

100 
	g»suÉ
.
	gcom·¿tÜ
 = 
icmp
;

101 
	g»suÉ
.
	gf‹r_pŞicy
 = (
¤c
.
f‹r_pŞicy
 !ğ
nuÎ±r
è? 
Şicy
 :‚ullptr;

102 
ClToRªge
(&
»suÉ
.
max_İ’_fes
, 64 + 
kNumNÚTabËCacheFes
, 50000);

103 
ClToRªge
(&
»suÉ
.
wr™e_bufãr_size
, 64 << 10, 1 << 30);

104 
ClToRªge
(&
»suÉ
.
max_fe_size
, 1 << 20, 1 << 30);

105 
ClToRªge
(&
»suÉ
.
block_size
, 1 << 10, 4 << 20);

106 ià(
	g»suÉ
.
	gšfo_log
 =ğ
nuÎ±r
) {

108 
¤c
.
’v
->
C»©eDœ
(
dbÇme
);

109 
	g¤c
.
	g’v
->
R’ameFe
(
InfoLogFeName
(
dbÇme
), 
OldInfoLogFeName
(dbname));

110 
Stus
 
	gs
 = 
¤c
.
’v
->
NewLogg”
(
InfoLogFeName
(
dbÇme
), &
»suÉ
.
šfo_log
);

111 ià(!
	gs
.
ok
()) {

113 
	g»suÉ
.
	gšfo_log
 = 
nuÎ±r
;

116 ià(
	g»suÉ
.
	gblock_ÿche
 =ğ
nuÎ±r
) {

117 
»suÉ
.
block_ÿche
 = 
NewLRUCache
(8 << 20);

119  
	g»suÉ
;

122 
TabËCacheSize
(cÚ¡ 
O±iÚs
& 
§n™ized_İtiÚs
) {

124  
	g§n™ized_İtiÚs
.
	gmax_İ’_fes
 - 
	gkNumNÚTabËCacheFes
;

127 
	gDBIm¶
::
DBIm¶
(cÚ¡ 
O±iÚs
& 
¿w_İtiÚs
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
)

128 : 
’v_
(
¿w_İtiÚs
.
’v
),

129 
š‹º®_com·¿tÜ_
(
¿w_İtiÚs
.
com·¿tÜ
),

130 
š‹º®_f‹r_pŞicy_
(
¿w_İtiÚs
.
f‹r_pŞicy
),

131 
İtiÚs_
(
Sª™izeO±iÚs
(
dbÇme
, &
š‹º®_com·¿tÜ_
,

132 &
š‹º®_f‹r_pŞicy_
, 
¿w_İtiÚs
)),

133 
owns_šfo_log_
(
İtiÚs_
.
šfo_log
 !ğ
¿w_İtiÚs
.info_log),

134 
owns_ÿche_
(
İtiÚs_
.
block_ÿche
 !ğ
¿w_İtiÚs
.block_cache),

135 
dbÇme_
(
dbÇme
),

136 
bË_ÿche_
(
Ãw
 
TabËCache
(
dbÇme_
, 
İtiÚs_
, 
TabËCacheSize
(options_))),

137 
db_lock_
(
nuÎ±r
),

138 
shu‰šg_down_
(
çl£
),

139 
background_wÜk_fšished_sigÇl_
(&
mu‹x_
),

140 
mem_
(
nuÎ±r
),

141 
imm_
(
nuÎ±r
),

142 
has_imm_
(
çl£
),

143 
logfe_
(
nuÎ±r
),

144 
logfe_numb”_
(0),

145 
log_
(
nuÎ±r
),

146 
£ed_
(0),

147 
tmp_b©ch_
(
Ãw
 
Wr™eB©ch
),

148 
background_com·ùiÚ_scheduËd_
(
çl£
),

149 
mªu®_com·ùiÚ_
(
nuÎ±r
),

150 
v”siÚs_
(
Ãw
 
V”siÚS‘
(
dbÇme_
, &
İtiÚs_
, 
bË_ÿche_
,

151 &
š‹º®_com·¿tÜ_
)) {}

153 
	gDBIm¶
::~
DBIm¶
() {

155 
mu‹x_
.
Lock
();

156 
	gshu‰šg_down_
.
¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

157 
	gbackground_com·ùiÚ_scheduËd_
) {

158 
	gbackground_wÜk_fšished_sigÇl_
.
Wa™
();

160 
	gmu‹x_
.
UÆock
();

162 ià(
	gdb_lock_
 !ğ
nuÎ±r
) {

163 
’v_
->
UÆockFe
(
db_lock_
);

166 
d–‘e
 
	gv”siÚs_
;

167 ià(
	gmem_
 !ğ
nuÎ±r
è
mem_
->
UÄef
();

168 ià(
	gimm_
 !ğ
nuÎ±r
è
imm_
->
UÄef
();

169 
d–‘e
 
	gtmp_b©ch_
;

170 
d–‘e
 
	glog_
;

171 
d–‘e
 
	glogfe_
;

172 
d–‘e
 
	gbË_ÿche_
;

174 ià(
	gowns_šfo_log_
) {

175 
d–‘e
 
	gİtiÚs_
.
	gšfo_log
;

177 ià(
	gowns_ÿche_
) {

178 
d–‘e
 
	gİtiÚs_
.
	gblock_ÿche
;

182 
Stus
 
	gDBIm¶
::
NewDB
() {

183 
V”siÚEd™
 
Ãw_db
;

184 
	gÃw_db
.
S‘Com·¿tÜName
(
u£r_com·¿tÜ
()->
Name
());

185 
	gÃw_db
.
S‘LogNumb”
(0);

186 
	gÃw_db
.
S‘NextFe
(2);

187 
	gÃw_db
.
S‘La¡Sequ’û
(0);

189 cÚ¡ 
	g¡d
::
¡ršg
 
mªiã¡
 = 
DesütÜFeName
(
dbÇme_
, 1);

190 
Wr™abËFe
* 
	gfe
;

191 
Stus
 
	gs
 = 
’v_
->
NewWr™abËFe
(
mªiã¡
, &
fe
);

192 ià(!
	gs
.
ok
()) {

193  
	gs
;

196 
	glog
::
Wr™”
 
log
(
fe
);

197 
	g¡d
::
¡ršg
 
»cÜd
;

198 
	gÃw_db
.
EncodeTo
(&
»cÜd
);

199 
	gs
 = 
log
.
AddRecÜd
(
»cÜd
);

200 ià(
	gs
.
ok
()) {

201 
	gs
 = 
fe
->
Clo£
();

204 
d–‘e
 
	gfe
;

205 ià(
	gs
.
ok
()) {

207 
	gs
 = 
S‘Cu¼’tFe
(
’v_
, 
dbÇme_
, 1);

209 
	g’v_
->
RemoveFe
(
mªiã¡
);

211  
	gs
;

214 
	gDBIm¶
::
MaybeIgnÜeE¼Ü
(
Stus
* 
s
) const {

215 ià(
s
->
ok
(è|| 
İtiÚs_
.
·¿noid_checks
) {

218 
Log
(
İtiÚs_
.
šfo_log
, "IgnÜšgƒ¼Ü %s", 
s
->
ToSŒšg
().
c_¡r
());

219 *
	gs
 = 
Stus
::
OK
();

223 
	gDBIm¶
::
RemoveObsŞ‘eFes
() {

224 
mu‹x_
.
As£¹H–d
();

226 ià(!
	gbg_”rÜ_
.
ok
()) {

233 
	g¡d
::
£t
<
ušt64_t
> 
live
 = 
³ndšg_ouuts_
;

234 
	gv”siÚs_
->
AddLiveFes
(&
live
);

236 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

237 
	g’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
);

238 
ušt64_t
 
	gnumb”
;

239 
FeTy³
 
	gty³
;

240 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
fes_to_d–‘e
;

241 
	g¡d
::
¡ršg
& 
f’ame
 : 
f’ames
) {

242 ià(
P¬£FeName
(
f’ame
, &
numb”
, &
ty³
)) {

243 
boŞ
 
	gk“p
 = 
Œue
;

244 
	gty³
) {

245 
	gkLogFe
:

246 
k“p
 = ((
numb”
 >ğ
v”siÚs_
->
LogNumb”
()) ||

247 (
numb”
 =ğ
v”siÚs_
->
P»vLogNumb”
()));

249 
	gkDesütÜFe
:

252 
k“p
 = (
numb”
 >ğ
v”siÚs_
->
Mªiã¡FeNumb”
());

254 
	gkTabËFe
:

255 
k“p
 = (
live
.
fšd
(
numb”
è!ğlive.
’d
());

257 
	gkTempFe
:

260 
k“p
 = (
live
.
fšd
(
numb”
è!ğlive.
’d
());

262 
	gkCu¼’tFe
:

263 
kDBLockFe
:

264 
kInfoLogFe
:

265 
k“p
 = 
Œue
;

269 ià(!
	gk“p
) {

270 
	gfes_to_d–‘e
.
push_back
(
¡d
::
move
(
f’ame
));

271 ià(
	gty³
 =ğ
kTabËFe
) {

272 
bË_ÿche_
->
Eviù
(
numb”
);

274 
Log
(
İtiÚs_
.
šfo_log
, "D–‘ty³=%d #%Îd\n", 
¡©ic_ÿ¡
<>(
ty³
),

275 
¡©ic_ÿ¡
<>(
numb”
));

283 
	gmu‹x_
.
UÆock
();

284 cÚ¡ 
	g¡d
::
¡ršg
& 
f’ame
 : 
fes_to_d–‘e
) {

285 
’v_
->
RemoveFe
(
dbÇme_
 + "/" + 
f’ame
);

287 
	gmu‹x_
.
Lock
();

290 
Stus
 
	gDBIm¶
::
Recov”
(
V”siÚEd™
* 
ed™
, 
boŞ
* 
§ve_mªiã¡
) {

291 
	gmu‹x_
.
As£¹H–d
();

296 
	g’v_
->
C»©eDœ
(
dbÇme_
);

297 
as£¹
(
db_lock_
 =ğ
nuÎ±r
);

298 
Stus
 
	gs
 = 
’v_
->
LockFe
(
LockFeName
(
dbÇme_
), &
db_lock_
);

299 ià(!
	gs
.
ok
()) {

300  
	gs
;

303 ià(!
	g’v_
->
FeExi¡s
(
Cu¼’tFeName
(
dbÇme_
))) {

304 ià(
	gİtiÚs_
.
	gü—‹_if_missšg
) {

305 
	gs
 = 
NewDB
();

306 ià(!
	gs
.
ok
()) {

307  
	gs
;

310  
	gStus
::
Inv®idArgum’t
(

311 
dbÇme_
, "does‚otƒxist (create_if_missing is false)");

314 ià(
	gİtiÚs_
.
	g”rÜ_if_exi¡s
) {

315  
	gStus
::
Inv®idArgum’t
(
dbÇme_
,

320 
	gs
 = 
v”siÚs_
->
Recov”
(
§ve_mªiã¡
);

321 ià(!
	gs
.
ok
()) {

322  
	gs
;

324 
Sequ’ûNumb”
 
max_£qu’û
(0);

333 cÚ¡ 
ušt64_t
 
	gmš_log
 = 
v”siÚs_
->
LogNumb”
();

334 cÚ¡ 
ušt64_t
 
	g´ev_log
 = 
v”siÚs_
->
P»vLogNumb”
();

335 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

336 
	gs
 = 
’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
);

337 ià(!
	gs
.
ok
()) {

338  
	gs
;

340 
	g¡d
::
£t
<
ušt64_t
> 
ex³ùed
;

341 
	gv”siÚs_
->
AddLiveFes
(&
ex³ùed
);

342 
ušt64_t
 
	gnumb”
;

343 
FeTy³
 
	gty³
;

344 
	g¡d
::
veùÜ
<
ušt64_t
> 
logs
;

345 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

346 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
)) {

347 
	gex³ùed
.
”a£
(
numb”
);

348 ià(
	gty³
 =ğ
kLogFe
 && ((
numb”
 >ğ
mš_log
è|| (numb” =ğ
´ev_log
)))

349 
logs
.
push_back
(
numb”
);

352 ià(!
	gex³ùed
.
em±y
()) {

353 
	gbuf
[50];

354 
¢´štf
(
buf
, (buf), "%d missing files;ƒ.g.",

355 
¡©ic_ÿ¡
<>(
ex³ùed
.
size
()));

356  
	gStus
::
CÜru±iÚ
(
buf
, 
TabËFeName
(
dbÇme_
, *(
ex³ùed
.
begš
())));

360 
	g¡d
::
sÜt
(
logs
.
begš
(),†ogs.
’d
());

361 
size_t
 
	gi
 = 0; i < 
	glogs
.
size
(); i++) {

362 
	gs
 = 
Recov”LogFe
(
logs
[
i
], (˜=ğlogs.
size
(è- 1), 
§ve_mªiã¡
, 
ed™
,

363 &
max_£qu’û
);

364 ià(!
	gs
.
ok
()) {

365  
	gs
;

371 
	gv”siÚs_
->
M¬kFeNumb”U£d
(
logs
[
i
]);

374 ià(
	gv”siÚs_
->
La¡Sequ’û
(è< 
	gmax_£qu’û
) {

375 
	gv”siÚs_
->
S‘La¡Sequ’û
(
max_£qu’û
);

378  
	gStus
::
OK
();

381 
Stus
 
	gDBIm¶
::
Recov”LogFe
(
ušt64_t
 
log_numb”
, 
boŞ
 
Ï¡_log
,

382 
boŞ
* 
§ve_mªiã¡
, 
V”siÚEd™
* 
ed™
,

383 
Sequ’ûNumb”
* 
max_£qu’û
) {

384 
	gLogR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

385 
Env
* 
’v
;

386 
Logg”
* 
	gšfo_log
;

387 cÚ¡ * 
	gâame
;

388 
Stus
* 
	g¡©us
;

389 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
s
è
	gov”ride
 {

390 
Log
(
šfo_log
, "%s%s: dropping %d bytes; %s",

391 (
this
->
¡©us
 =ğ
nuÎ±r
 ? "(ignÜšgƒ¼Üè" : ""), 
âame
,

392 
¡©ic_ÿ¡
<>(
by‹s
), 
s
.
ToSŒšg
().
c_¡r
());

393 ià(
	gthis
->
	g¡©us
 !ğ
nuÎ±r
 && 
this
->
¡©us
->
ok
()è*this->¡©u ğ
s
;

397 
	gmu‹x_
.
As£¹H–d
();

400 
	g¡d
::
¡ršg
 
âame
 = 
LogFeName
(
dbÇme_
, 
log_numb”
);

401 
Sequ’tŸlFe
* 
	gfe
;

402 
Stus
 
	g¡©us
 = 
’v_
->
NewSequ’tŸlFe
(
âame
, &
fe
);

403 ià(!
	g¡©us
.
ok
()) {

404 
MaybeIgnÜeE¼Ü
(&
¡©us
);

405  
	g¡©us
;

409 
LogR•Ü‹r
 
	g»pÜ‹r
;

410 
	g»pÜ‹r
.
	g’v
 = 
’v_
;

411 
	g»pÜ‹r
.
	gšfo_log
 = 
İtiÚs_
.
šfo_log
;

412 
	g»pÜ‹r
.
	gâame
 = 
âame
.
c_¡r
();

413 
	g»pÜ‹r
.
	g¡©us
 = (
İtiÚs_
.
·¿noid_checks
 ? &
¡©us
 : 
nuÎ±r
);

418 
	glog
::
R—d”
 
»ad”
(
fe
, &
»pÜ‹r
, 
Œue
 , 0 );

419 
Log
(
İtiÚs_
.
šfo_log
, "Recovering†og #%llu",

420 ()
log_numb”
);

423 
	g¡d
::
¡ršg
 
sü©ch
;

424 
Sliû
 
	g»cÜd
;

425 
Wr™eB©ch
 
	gb©ch
;

426 
	gcom·ùiÚs
 = 0;

427 
MemTabË
* 
	gmem
 = 
nuÎ±r
;

428 
	g»ad”
.
R—dRecÜd
(&
»cÜd
, &
sü©ch
è&& 
	g¡©us
.
ok
()) {

429 ià(
	g»cÜd
.
size
() < 12) {

430 
	g»pÜ‹r
.
CÜru±iÚ
(
»cÜd
.
size
(),

431 
Stus
::
CÜru±iÚ
("log„ecordoo small"));

434 
	gWr™eB©chIÁ”Çl
::
S‘CÚ‹Ás
(&
b©ch
, 
»cÜd
);

436 ià(
	gmem
 =ğ
nuÎ±r
) {

437 
mem
 = 
Ãw
 
MemTabË
(
š‹º®_com·¿tÜ_
);

438 
	gmem
->
Ref
();

440 
	g¡©us
 = 
Wr™eB©chIÁ”Çl
::
In£¹IÁo
(&
b©ch
, 
mem
);

441 
MaybeIgnÜeE¼Ü
(&
¡©us
);

442 ià(!
	g¡©us
.
ok
()) {

445 cÚ¡ 
Sequ’ûNumb”
 
	gÏ¡_£q
 = 
Wr™eB©chIÁ”Çl
::
Sequ’û
(&
b©ch
) +

446 
Wr™eB©chIÁ”Çl
::
CouÁ
(&
b©ch
) - 1;

447 ià(
	gÏ¡_£q
 > *
	gmax_£qu’û
) {

448 *
	gmax_£qu’û
 = 
Ï¡_£q
;

451 ià(
	gmem
->
Aµroxim©eMemÜyU§ge
(è> 
	gİtiÚs_
.
	gwr™e_bufãr_size
) {

452 
	gcom·ùiÚs
++;

453 *
	g§ve_mªiã¡
 = 
Œue
;

454 
	g¡©us
 = 
Wr™eLev–0TabË
(
mem
, 
ed™
, 
nuÎ±r
);

455 
	gmem
->
UÄef
();

456 
	gmem
 = 
nuÎ±r
;

457 ià(!
	g¡©us
.
ok
()) {

465 
d–‘e
 
	gfe
;

468 ià(
	g¡©us
.
ok
(è&& 
	gİtiÚs_
.
	g»u£_logs
 && 
	gÏ¡_log
 && 
	gcom·ùiÚs
 == 0) {

469 
as£¹
(
logfe_
 =ğ
nuÎ±r
);

470 
as£¹
(
log_
 =ğ
nuÎ±r
);

471 
as£¹
(
mem_
 =ğ
nuÎ±r
);

472 
ušt64_t
 
	glfe_size
;

473 ià(
	g’v_
->
G‘FeSize
(
âame
, &
lfe_size
).
ok
() &&

474 
	g’v_
->
NewAµ’dabËFe
(
âame
, &
logfe_
).
ok
()) {

475 
Log
(
İtiÚs_
.
šfo_log
, "Reusšg old†og % \n", 
âame
.
c_¡r
());

476 
	glog_
 = 
Ãw
 
log
::
Wr™”
(
logfe_
, 
lfe_size
);

477 
	glogfe_numb”_
 = 
log_numb”
;

478 ià(
	gmem
 !ğ
nuÎ±r
) {

479 
mem_
 = 
mem
;

480 
	gmem
 = 
nuÎ±r
;

483 
	gmem_
 = 
Ãw
 
MemTabË
(
š‹º®_com·¿tÜ_
);

484 
	gmem_
->
Ref
();

489 ià(
	gmem
 !ğ
nuÎ±r
) {

491 ià(
¡©us
.
ok
()) {

492 *
§ve_mªiã¡
 = 
Œue
;

493 
	g¡©us
 = 
Wr™eLev–0TabË
(
mem
, 
ed™
, 
nuÎ±r
);

495 
	gmem
->
UÄef
();

498  
	g¡©us
;

502 
Stus
 
	gDBIm¶
::
Wr™eLev–0TabË
(
MemTabË
* 
mem
, 
V”siÚEd™
* 
ed™
,

503 
V”siÚ
* 
ba£
) {

504 
	gmu‹x_
.
As£¹H–d
();

505 cÚ¡ 
ušt64_t
 
	g¡¬t_miüos
 = 
’v_
->
NowMiüos
();

506 
FeM‘aD©a
 
	gm‘a
;

507 
	gm‘a
.
	gnumb”
 = 
v”siÚs_
->
NewFeNumb”
();

508 
	g³ndšg_ouuts_
.
š£¹
(
m‘a
.
numb”
);

509 
I‹¿tÜ
* 
	g™”
 = 
mem
->
NewI‹¿tÜ
();

510 
Log
(
İtiÚs_
.
šfo_log
, "Level-0able #%llu: started",

511 ()
m‘a
.
numb”
);

513 
Stus
 
	gs
;

515 
	gmu‹x_
.
UÆock
();

516 
	gs
 = 
BudTabË
(
dbÇme_
, 
’v_
, 
İtiÚs_
, 
bË_ÿche_
, 
™”
, &
m‘a
);

517 
	gmu‹x_
.
Lock
();

520 
Log
(
İtiÚs_
.
šfo_log
, "Level-0able #%llu: %lld bytes %s",

521 ()
m‘a
.
numb”
, ()m‘a.
fe_size
,

522 
s
.
ToSŒšg
().
c_¡r
());

523 
d–‘e
 
	g™”
;

524 
	g³ndšg_ouuts_
.
”a£
(
m‘a
.
numb”
);

528 
	gËv–
 = 0;

529 ià(
	gs
.
ok
(è&& 
	gm‘a
.
	gfe_size
 > 0) {

530 cÚ¡ 
Sliû
 
	gmš_u£r_key
 = 
m‘a
.
sm®Ë¡
.
u£r_key
();

531 cÚ¡ 
Sliû
 
	gmax_u£r_key
 = 
m‘a
.
Ïrge¡
.
u£r_key
();

532 ià(
	gba£
 !ğ
nuÎ±r
) {

533 
Ëv–
 = 
ba£
->
PickLev–FÜMemTabËOuut
(
mš_u£r_key
, 
max_u£r_key
);

535 
	ged™
->
AddFe
(
Ëv–
, 
m‘a
.
numb”
, m‘a.
fe_size
, m‘a.
sm®Ë¡
,

536 
m‘a
.
Ïrge¡
);

539 
Com·ùiÚSts
 
	g¡©s
;

540 
	g¡©s
.
	gmiüos
 = 
’v_
->
NowMiüos
(è- 
¡¬t_miüos
;

541 
	g¡©s
.
	gby‹s_wr™‹n
 = 
m‘a
.
fe_size
;

542 
	g¡©s_
[
Ëv–
].
Add
(
¡©s
);

543  
	gs
;

547 
	gDBIm¶
::
Com·ùMemTabË
() {

548 
mu‹x_
.
As£¹H–d
();

549 
as£¹
(
imm_
 !ğ
nuÎ±r
);

552 
V”siÚEd™
 
	ged™
;

553 
V”siÚ
* 
	gba£
 = 
v”siÚs_
->
cu¼’t
();

554 
	gba£
->
Ref
();

555 
Stus
 
	gs
 = 
Wr™eLev–0TabË
(
imm_
, &
ed™
, 
ba£
);

556 
	gba£
->
UÄef
();

558 ià(
	gs
.
ok
(è&& 
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

559 
s
 = 
Stus
::
IOE¼Ü
("Deleting DB during memtable compaction");

563 ià(
	gs
.
ok
()) {

564 
	ged™
.
S‘P»vLogNumb”
(0);

565 
	ged™
.
S‘LogNumb”
(
logfe_numb”_
);

566 
	gs
 = 
v”siÚs_
->
LogAndAµly
(&
ed™
, &
mu‹x_
);

570 ià(
	gs
.
ok
()) {

572 
	gimm_
->
UÄef
();

573 
	gimm_
 = 
nuÎ±r
;

574 
	ghas_imm_
.
¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

575 
RemoveObsŞ‘eFes
();

577 
RecÜdBackgroundE¼Ü
(
s
);

581 
	gDBIm¶
::
Com·ùRªge
(cÚ¡ 
Sliû
* 
begš
, cÚ¡ Sliû* 
’d
) {

582 
	gmax_Ëv–_w™h_fes
 = 1;

584 
Mu‹xLock
 
l
(&
mu‹x_
);

585 
V”siÚ
* 
	gba£
 = 
v”siÚs_
->
cu¼’t
();

586 
	gËv–
 = 1;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

587 ià(
	gba£
->
Ov”ÏpInLev–
(
Ëv–
, 
begš
, 
’d
)) {

588 
	gmax_Ëv–_w™h_fes
 = 
Ëv–
;

592 
TEST_Com·ùMemTabË
();

593 
	gËv–
 = 0;†ev– < 
	gmax_Ëv–_w™h_fes
;†evel++) {

594 
TEST_Com·ùRªge
(
Ëv–
, 
begš
, 
’d
);

598 
	gDBIm¶
::
TEST_Com·ùRªge
(
Ëv–
, cÚ¡ 
Sliû
* 
begš
,

599 cÚ¡ 
Sliû
* 
’d
) {

600 
as£¹
(
Ëv–
 >= 0);

601 
as£¹
(
Ëv–
 + 1 < 
cÚfig
::
kNumLev–s
);

603 
IÁ”ÇlKey
 
	gbegš_¡Üage
, 
	g’d_¡Üage
;

605 
Mªu®Com·ùiÚ
 
	gmªu®
;

606 
	gmªu®
.
	gËv–
 = 
Ëv–
;

607 
	gmªu®
.
	gdÚe
 = 
çl£
;

608 ià(
	gbegš
 =ğ
nuÎ±r
) {

609 
mªu®
.
begš
 = 
nuÎ±r
;

611 
	gbegš_¡Üage
 = 
IÁ”ÇlKey
(*
begš
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
);

612 
	gmªu®
.
	gbegš
 = &
begš_¡Üage
;

614 ià(
	g’d
 =ğ
nuÎ±r
) {

615 
mªu®
.
’d
 = 
nuÎ±r
;

617 
	g’d_¡Üage
 = 
IÁ”ÇlKey
(*
’d
, 0, 
¡©ic_ÿ¡
<
V®ueTy³
>(0));

618 
	gmªu®
.
	g’d
 = &
’d_¡Üage
;

621 
Mu‹xLock
 
l
(&
mu‹x_
);

622 !
	gmªu®
.
	gdÚe
 && !
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
) &&

623 
bg_”rÜ_
.
ok
()) {

624 ià(
mªu®_com·ùiÚ_
 =ğ
nuÎ±r
) {

625 
mªu®_com·ùiÚ_
 = &
mªu®
;

626 
MaybeScheduËCom·ùiÚ
();

628 
	gbackground_wÜk_fšished_sigÇl_
.
Wa™
();

631 ià(
	gmªu®_com·ùiÚ_
 =ğ&
mªu®
) {

633 
mªu®_com·ùiÚ_
 = 
nuÎ±r
;

637 
Stus
 
	gDBIm¶
::
TEST_Com·ùMemTabË
() {

639 
Stus
 
s
 = 
Wr™e
(
Wr™eO±iÚs
(), 
nuÎ±r
);

640 ià(
	gs
.
ok
()) {

642 
Mu‹xLock
 
l
(&
mu‹x_
);

643 
	gimm_
 !ğ
nuÎ±r
 && 
bg_”rÜ_
.
ok
()) {

644 
background_wÜk_fšished_sigÇl_
.
Wa™
();

646 ià(
	gimm_
 !ğ
nuÎ±r
) {

647 
s
 = 
bg_”rÜ_
;

650  
	gs
;

653 
	gDBIm¶
::
RecÜdBackgroundE¼Ü
(cÚ¡ 
Stus
& 
s
) {

654 
mu‹x_
.
As£¹H–d
();

655 ià(
	gbg_”rÜ_
.
ok
()) {

656 
	gbg_”rÜ_
 = 
s
;

657 
	gbackground_wÜk_fšished_sigÇl_
.
SigÇlAÎ
();

661 
	gDBIm¶
::
MaybeScheduËCom·ùiÚ
() {

662 
mu‹x_
.
As£¹H–d
();

663 ià(
	gbackground_com·ùiÚ_scheduËd_
) {

665 } ià(
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

667 } ià(!
bg_”rÜ_
.
ok
()) {

669 } ià(
imm_
 =ğ
nuÎ±r
 && 
mªu®_com·ùiÚ_
 ==‚ullptr &&

670 !
v”siÚs_
->
N“dsCom·ùiÚ
()) {

673 
background_com·ùiÚ_scheduËd_
 = 
Œue
;

674 
	g’v_
->
ScheduË
(&
DBIm¶
::
BGWÜk
, 
this
);

678 
	gDBIm¶
::
BGWÜk
(* 
db
) {

679 
»š‹½»t_ÿ¡
<
DBIm¶
*>(
db
)->
BackgroundC®l
();

682 
	gDBIm¶
::
BackgroundC®l
() {

683 
Mu‹xLock
 
l
(&
mu‹x_
);

684 
as£¹
(
background_com·ùiÚ_scheduËd_
);

685 ià(
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

687 } ià(!
bg_”rÜ_
.
ok
()) {

690 
BackgroundCom·ùiÚ
();

693 
	gbackground_com·ùiÚ_scheduËd_
 = 
çl£
;

697 
MaybeScheduËCom·ùiÚ
();

698 
	gbackground_wÜk_fšished_sigÇl_
.
SigÇlAÎ
();

702 
	gDBIm¶
::
BackgroundCom·ùiÚ
() {

703 
mu‹x_
.
As£¹H–d
();

705 ià(
	gimm_
 !ğ
nuÎ±r
) {

706 
Com·ùMemTabË
();

710 
Com·ùiÚ
* 
	gc
;

711 
boŞ
 
	gis_mªu®
 = (
mªu®_com·ùiÚ_
 !ğ
nuÎ±r
);

712 
IÁ”ÇlKey
 
	gmªu®_’d
;

713 ià(
	gis_mªu®
) {

714 
Mªu®Com·ùiÚ
* 
	gm
 = 
mªu®_com·ùiÚ_
;

715 
	gc
 = 
v”siÚs_
->
Com·ùRªge
(
m
->
Ëv–
, m->
begš
, m->
’d
);

716 
	gm
->
	gdÚe
 = (
c
 =ğ
nuÎ±r
);

717 ià(
	gc
 !ğ
nuÎ±r
) {

718 
mªu®_’d
 = 
c
->
šput
(0, c->
num_šput_fes
(0è- 1)->
	gÏrge¡
;

720 
Log
(
İtiÚs_
.
šfo_log
,

722 
m
->
Ëv–
, (m->
begš
 ? m->begš->
DebugSŒšg
().
c_¡r
() : "(begin)"),

723 (
m
->
’d
 ? m->’d->
DebugSŒšg
().
c_¡r
() : "(end)"),

724 (
m
->
dÚe
 ? "Ónd)" : 
mªu®_’d
.
DebugSŒšg
().
c_¡r
()));

726 
	gc
 = 
v”siÚs_
->
PickCom·ùiÚ
();

729 
Stus
 
	g¡©us
;

730 ià(
	gc
 =ğ
nuÎ±r
) {

732 } ià(!
is_mªu®
 && 
c
->
IsTrivŸlMove
()) {

734 
as£¹
(
c
->
num_šput_fes
(0) == 1);

735 
FeM‘aD©a
* 
	gf
 = 
c
->
šput
(0, 0);

736 
	gc
->
ed™
()->
RemoveFe
(
c
->
Ëv–
(), 
f
->
numb”
);

739 
	gc
->
ed™
()->
AddFe
(
c
->
Ëv–
(è+ 1, 
f
->
numb”
, f->
fe_size
, f->
sm®Ë¡
,

740 
f
->
Ïrge¡
);

743 
	g¡©us
 = 
v”siÚs_
->
LogAndAµly
(
c
->
ed™
(), &
mu‹x_
);

744 ià(!
	g¡©us
.
ok
()) {

745 
RecÜdBackgroundE¼Ü
(
¡©us
);

747 
	gV”siÚS‘
::
Lev–Summ¬yStÜage
 
tmp
;

748 
Log
(
İtiÚs_
.
šfo_log
, "Moved #%lldo†evel-%d %lld bytes %s: %s\n",

749 
¡©ic_ÿ¡
<>(
f
->
numb”
), 
c
->
Ëv–
() + 1,

750 
¡©ic_ÿ¡
<>(
f
->
fe_size
),

751 
¡©us
.
ToSŒšg
().
c_¡r
(), 
v”siÚs_
->
Lev–Summ¬y
(&
tmp
));

753 
Com·ùiÚS‹
* 
	gcom·ù
 = 
Ãw
 Com·ùiÚS‹(
c
);

754 
	g¡©us
 = 
DoCom·ùiÚWÜk
(
com·ù
);

755 ià(!
	g¡©us
.
ok
()) {

756 
RecÜdBackgroundE¼Ü
(
¡©us
);

758 
CËªupCom·ùiÚ
(
com·ù
);

759 
	gc
->
R–—£IÅuts
();

760 
RemoveObsŞ‘eFes
();

762 
d–‘e
 
	gc
;

764 ià(
	g¡©us
.
ok
()) {

766 } ià(
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

769 
Log
(
İtiÚs_
.
šfo_log
, "Com·ùiÚƒ¼Ü: %s", 
¡©us
.
ToSŒšg
().
c_¡r
());

772 ià(
	gis_mªu®
) {

773 
Mªu®Com·ùiÚ
* 
	gm
 = 
mªu®_com·ùiÚ_
;

774 ià(!
	g¡©us
.
ok
()) {

775 
	gm
->
	gdÚe
 = 
Œue
;

777 ià(!
	gm
->
	gdÚe
) {

780 
	gm
->
	gtmp_¡Üage
 = 
mªu®_’d
;

781 
	gm
->
	gbegš
 = &
m
->
tmp_¡Üage
;

783 
	gmªu®_com·ùiÚ_
 = 
nuÎ±r
;

787 
	gDBIm¶
::
CËªupCom·ùiÚ
(
Com·ùiÚS‹
* 
com·ù
) {

788 
mu‹x_
.
As£¹H–d
();

789 ià(
	gcom·ù
->
	gbud”
 !ğ
nuÎ±r
) {

791 
com·ù
->
bud”
->
AbªdÚ
();

792 
d–‘e
 
	gcom·ù
->
	gbud”
;

794 
as£¹
(
com·ù
->
outfe
 =ğ
nuÎ±r
);

796 
d–‘e
 
	gcom·ù
->
	goutfe
;

797 
size_t
 
	gi
 = 0; i < 
	gcom·ù
->
	gouuts
.
size
(); i++) {

798 cÚ¡ 
	gCom·ùiÚS‹
::
Ouut
& 
out
 = 
com·ù
->
ouuts
[
i
];

799 
	g³ndšg_ouuts_
.
”a£
(
out
.
numb”
);

801 
d–‘e
 
	gcom·ù
;

804 
Stus
 
	gDBIm¶
::
O³nCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
) {

805 
as£¹
(
com·ù
 !ğ
nuÎ±r
);

806 
as£¹
(
com·ù
->
bud”
 =ğ
nuÎ±r
);

807 
ušt64_t
 
	gfe_numb”
;

809 
	gmu‹x_
.
Lock
();

810 
	gfe_numb”
 = 
v”siÚs_
->
NewFeNumb”
();

811 
	g³ndšg_ouuts_
.
š£¹
(
fe_numb”
);

812 
	gCom·ùiÚS‹
::
Ouut
 
out
;

813 
	gout
.
	gnumb”
 = 
fe_numb”
;

814 
	gout
.
	gsm®Ë¡
.
CË¬
();

815 
	gout
.
	gÏrge¡
.
CË¬
();

816 
	gcom·ù
->
	gouuts
.
push_back
(
out
);

817 
	gmu‹x_
.
UÆock
();

821 
	g¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme_
, 
fe_numb”
);

822 
Stus
 
	gs
 = 
’v_
->
NewWr™abËFe
(
âame
, &
com·ù
->
outfe
);

823 ià(
	gs
.
ok
()) {

824 
	gcom·ù
->
	gbud”
 = 
Ãw
 
TabËBud”
(
İtiÚs_
, 
com·ù
->
outfe
);

826  
	gs
;

829 
Stus
 
	gDBIm¶
::
FšishCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
,

830 
I‹¿tÜ
* 
šput
) {

831 
as£¹
(
com·ù
 !ğ
nuÎ±r
);

832 
as£¹
(
com·ù
->
outfe
 !ğ
nuÎ±r
);

833 
as£¹
(
com·ù
->
bud”
 !ğ
nuÎ±r
);

835 cÚ¡ 
ušt64_t
 
	gouut_numb”
 = 
com·ù
->
cu¼’t_ouut
()->
numb”
;

836 
as£¹
(
ouut_numb”
 != 0);

839 
Stus
 
	gs
 = 
šput
->
¡©us
();

840 cÚ¡ 
ušt64_t
 
	gcu¼’t_’Œ›s
 = 
com·ù
->
bud”
->
NumEÁr›s
();

841 ià(
	gs
.
ok
()) {

842 
	gs
 = 
com·ù
->
bud”
->
Fšish
();

844 
	gcom·ù
->
	gbud”
->
AbªdÚ
();

846 cÚ¡ 
ušt64_t
 
	gcu¼’t_by‹s
 = 
com·ù
->
bud”
->
FeSize
();

847 
	gcom·ù
->
cu¼’t_ouut
()->
	gfe_size
 = 
cu¼’t_by‹s
;

848 
	gcom·ù
->
	gtÙ®_by‹s
 +ğ
cu¼’t_by‹s
;

849 
d–‘e
 
	gcom·ù
->
	gbud”
;

850 
	gcom·ù
->
	gbud”
 = 
nuÎ±r
;

854 ià(
	gs
.
ok
()) {

855 
	gs
 = 
com·ù
->
outfe
->
Sync
();

857 ià(
	gs
.
ok
()) {

858 
	gs
 = 
com·ù
->
outfe
->
Clo£
();

860 
d–‘e
 
	gcom·ù
->
	goutfe
;

861 
	gcom·ù
->
	goutfe
 = 
nuÎ±r
;

863 ià(
	gs
.
ok
(è&& 
	gcu¼’t_’Œ›s
 > 0) {

865 
I‹¿tÜ
* 
	g™”
 =

866 
bË_ÿche_
->
NewI‹¿tÜ
(
R—dO±iÚs
(), 
ouut_numb”
, 
cu¼’t_by‹s
);

867 
	gs
 = 
™”
->
¡©us
();

868 
d–‘e
 
	g™”
;

869 ià(
	gs
.
ok
()) {

870 
Log
(
İtiÚs_
.
šfo_log
, "Generatedable #%llu@%d: %lld keys, %lld bytes",

871 ()
ouut_numb”
, 
com·ù
->
com·ùiÚ
->
Ëv–
(),

872 ()
cu¼’t_’Œ›s
,

873 ()
cu¼’t_by‹s
);

876  
	gs
;

881 
Stus
 
	gDBIm¶
::
In¡®lCom·ùiÚResuÉs
(
Com·ùiÚS‹
* 
com·ù
) {

882 
mu‹x_
.
As£¹H–d
();

883 
Log
(
İtiÚs_
.
šfo_log
, "Compacted %d@%d + %d@%d files => %lld bytes",

884 
com·ù
->
com·ùiÚ
->
num_šput_fes
(0), com·ù->com·ùiÚ->
Ëv–
(),

885 
com·ù
->
com·ùiÚ
->
num_šput_fes
(1), com·ù->com·ùiÚ->
Ëv–
() + 1,

886 
¡©ic_ÿ¡
<>(
com·ù
->
tÙ®_by‹s
));

889 
	gcom·ù
->
	gcom·ùiÚ
->
AddIÅutD–‘iÚs
(
com·ù
->
com·ùiÚ
->
ed™
());

890 cÚ¡ 
	gËv–
 = 
com·ù
->
com·ùiÚ
->
Ëv–
();

891 
size_t
 
	gi
 = 0; i < 
	gcom·ù
->
	gouuts
.
size
(); i++) {

892 cÚ¡ 
	gCom·ùiÚS‹
::
Ouut
& 
out
 = 
com·ù
->
ouuts
[
i
];

893 
	gcom·ù
->
	gcom·ùiÚ
->
ed™
()->
AddFe
(
Ëv–
 + 1, 
out
.
numb”
, out.
fe_size
,

894 
out
.
sm®Ë¡
, out.
Ïrge¡
);

896  
	gv”siÚs_
->
LogAndAµly
(
com·ù
->
com·ùiÚ
->
ed™
(), &
mu‹x_
);

899 
Stus
 
	gDBIm¶
::
DoCom·ùiÚWÜk
(
Com·ùiÚS‹
* 
com·ù
) {

900 cÚ¡ 
ušt64_t
 
¡¬t_miüos
 = 
’v_
->
NowMiüos
();

901 
št64_t
 
	gimm_miüos
 = 0;

903 
Log
(
İtiÚs_
.
šfo_log
, "Compacting %d@%d + %d@%d files",

904 
com·ù
->
com·ùiÚ
->
num_šput_fes
(0), com·ù->com·ùiÚ->
Ëv–
(),

905 
com·ù
->
com·ùiÚ
->
num_šput_fes
(1),

906 
com·ù
->
com·ùiÚ
->
Ëv–
() + 1);

908 
as£¹
(
v”siÚs_
->
NumLev–Fes
(
com·ù
->
com·ùiÚ
->
Ëv–
()) > 0);

909 
as£¹
(
com·ù
->
bud”
 =ğ
nuÎ±r
);

910 
as£¹
(
com·ù
->
outfe
 =ğ
nuÎ±r
);

911 ià(
	g¢­shÙs_
.
em±y
()) {

912 
	gcom·ù
->
	gsm®Ë¡_¢­shÙ
 = 
v”siÚs_
->
La¡Sequ’û
();

914 
	gcom·ù
->
	gsm®Ë¡_¢­shÙ
 = 
¢­shÙs_
.
Şde¡
()->
£qu’û_numb”
();

917 
I‹¿tÜ
* 
	gšput
 = 
v”siÚs_
->
MakeIÅutI‹¿tÜ
(
com·ù
->
com·ùiÚ
);

920 
	gmu‹x_
.
UÆock
();

922 
	gšput
->
S“kToFœ¡
();

923 
Stus
 
	g¡©us
;

924 
P¬£dIÁ”ÇlKey
 
	gikey
;

925 
	g¡d
::
¡ršg
 
cu¼’t_u£r_key
;

926 
boŞ
 
	ghas_cu¼’t_u£r_key
 = 
çl£
;

927 
Sequ’ûNumb”
 
	gÏ¡_£qu’û_fÜ_key
 = 
kMaxSequ’ûNumb”
;

928 
	gšput
->
V®id
(è&& !
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

930 ià(
has_imm_
.
lßd
(
¡d
::
memÜy_Üd”_»Ïxed
)) {

931 cÚ¡ 
ušt64_t
 
imm_¡¬t
 = 
’v_
->
NowMiüos
();

932 
	gmu‹x_
.
Lock
();

933 ià(
	gimm_
 !ğ
nuÎ±r
) {

934 
Com·ùMemTabË
();

936 
	gbackground_wÜk_fšished_sigÇl_
.
SigÇlAÎ
();

938 
	gmu‹x_
.
UÆock
();

939 
	gimm_miüos
 +ğ(
’v_
->
NowMiüos
(è- 
imm_¡¬t
);

942 
Sliû
 
	gkey
 = 
šput
->
key
();

943 ià(
	gcom·ù
->
	gcom·ùiÚ
->
ShouldStİBefÜe
(
key
) &&

944 
	gcom·ù
->
	gbud”
 !ğ
nuÎ±r
) {

945 
¡©us
 = 
FšishCom·ùiÚOuutFe
(
com·ù
, 
šput
);

946 ià(!
	g¡©us
.
ok
()) {

952 
boŞ
 
	gdrİ
 = 
çl£
;

953 ià(!
P¬£IÁ”ÇlKey
(
key
, &
ikey
)) {

955 
	gcu¼’t_u£r_key
.
ş—r
();

956 
	ghas_cu¼’t_u£r_key
 = 
çl£
;

957 
	gÏ¡_£qu’û_fÜ_key
 = 
kMaxSequ’ûNumb”
;

959 ià(!
	ghas_cu¼’t_u£r_key
 ||

960 
u£r_com·¿tÜ
()->
Com·»
(
ikey
.
u£r_key
, 
Sliû
(
cu¼’t_u£r_key
)) !=

963 
cu¼’t_u£r_key
.
assign
(
ikey
.
u£r_key
.
d©a
(), ikey.u£r_key.
size
());

964 
	ghas_cu¼’t_u£r_key
 = 
Œue
;

965 
	gÏ¡_£qu’û_fÜ_key
 = 
kMaxSequ’ûNumb”
;

968 ià(
	gÏ¡_£qu’û_fÜ_key
 <ğ
com·ù
->
sm®Ë¡_¢­shÙ
) {

970 
drİ
 = 
Œue
;

971 } ià(
	gikey
.
	gty³
 =ğ
kTy³D–‘iÚ
 &&

972 
ikey
.
£qu’û
 <ğ
com·ù
->
sm®Ë¡_¢­shÙ
 &&

973 
com·ù
->
com·ùiÚ
->
IsBa£Lev–FÜKey
(
ikey
.
u£r_key
)) {

981 
drİ
 = 
Œue
;

984 
	gÏ¡_£qu’û_fÜ_key
 = 
ikey
.
£qu’û
;

987 
Log
(
İtiÚs_
.
šfo_log
,

990 
ikey
.
u£r_key
.
ToSŒšg
().
c_¡r
(),

991 ()
ikey
.
£qu’û
, ikey.
ty³
, 
kTy³V®ue
, 
drİ
,

992 
com·ù
->
com·ùiÚ
->
IsBa£Lev–FÜKey
(
ikey
.
u£r_key
),

993 ()
Ï¡_£qu’û_fÜ_key
, ()
com·ù
->
sm®Ë¡_¢­shÙ
);

996 ià(!
	gdrİ
) {

998 ià(
	gcom·ù
->
	gbud”
 =ğ
nuÎ±r
) {

999 
¡©us
 = 
O³nCom·ùiÚOuutFe
(
com·ù
);

1000 ià(!
	g¡©us
.
ok
()) {

1004 ià(
	gcom·ù
->
	gbud”
->
NumEÁr›s
() == 0) {

1005 
com·ù
->
cu¼’t_ouut
()->
sm®Ë¡
.
DecodeFrom
(
key
);

1007 
	gcom·ù
->
cu¼’t_ouut
()->
	gÏrge¡
.
DecodeFrom
(
key
);

1008 
	gcom·ù
->
	gbud”
->
Add
(
key
, 
šput
->
v®ue
());

1011 ià(
	gcom·ù
->
	gbud”
->
FeSize
() >=

1012 
com·ù
->
com·ùiÚ
->
MaxOuutFeSize
()) {

1013 
¡©us
 = 
FšishCom·ùiÚOuutFe
(
com·ù
, 
šput
);

1014 ià(!
	g¡©us
.
ok
()) {

1020 
	gšput
->
Next
();

1023 ià(
	g¡©us
.
ok
(è&& 
	gshu‰šg_down_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

1024 
¡©us
 = 
Stus
::
IOE¼Ü
("Deleting DB during compaction");

1026 ià(
	g¡©us
.
ok
(è&& 
	gcom·ù
->
	gbud”
 !ğ
nuÎ±r
) {

1027 
¡©us
 = 
FšishCom·ùiÚOuutFe
(
com·ù
, 
šput
);

1029 ià(
	g¡©us
.
ok
()) {

1030 
	g¡©us
 = 
šput
->
¡©us
();

1032 
d–‘e
 
	gšput
;

1033 
	gšput
 = 
nuÎ±r
;

1035 
Com·ùiÚSts
 
	g¡©s
;

1036 
	g¡©s
.
	gmiüos
 = 
’v_
->
NowMiüos
(è- 
¡¬t_miüos
 - 
imm_miüos
;

1037 
	gwhich
 = 0; which < 2; which++) {

1038 
	gi
 = 0; i < 
	gcom·ù
->
	gcom·ùiÚ
->
num_šput_fes
(
which
); i++) {

1039 
	g¡©s
.
	gby‹s_»ad
 +ğ
com·ù
->
com·ùiÚ
->
šput
(
which
, 
i
)->
	gfe_size
;

1042 
size_t
 
	gi
 = 0; i < 
	gcom·ù
->
	gouuts
.
size
(); i++) {

1043 
	g¡©s
.
	gby‹s_wr™‹n
 +ğ
com·ù
->
ouuts
[
i
].
fe_size
;

1046 
	gmu‹x_
.
Lock
();

1047 
	g¡©s_
[
com·ù
->
com·ùiÚ
->
Ëv–
(è+ 1].
Add
(
¡©s
);

1049 ià(
	g¡©us
.
ok
()) {

1050 
	g¡©us
 = 
In¡®lCom·ùiÚResuÉs
(
com·ù
);

1052 ià(!
	g¡©us
.
ok
()) {

1053 
RecÜdBackgroundE¼Ü
(
¡©us
);

1055 
	gV”siÚS‘
::
Lev–Summ¬yStÜage
 
tmp
;

1056 
Log
(
İtiÚs_
.
šfo_log
, "com·ùedo: %s", 
v”siÚs_
->
Lev–Summ¬y
(&
tmp
));

1057  
	g¡©us
;

1060 
	gÇme¥aû
 {

1062 
	sI‹rS‹
 {

1063 
	gpÜt
::
Mu‹x
* cÚ¡ 
mu
;

1064 
V”siÚ
* cÚ¡ 
v”siÚ
 
GUARDED_BY
(
mu
);

1065 
MemTabË
* cÚ¡ 
mem
 
GUARDED_BY
(
mu
);

1066 
MemTabË
* cÚ¡ 
imm
 
GUARDED_BY
(
mu
);

1068 
I‹rS‹
(
pÜt
::
Mu‹x
* 
mu‹x
, 
MemTabË
* 
mem
, MemTabË* 
imm
, 
V”siÚ
* 
v”siÚ
)

1069 : 
mu
(
mu‹x
), 
v”siÚ
(v”siÚ), 
mem
(mem), 
imm
(imm) {}

1072 
CËªupI‹¿tÜS‹
(* 
¬g1
, * 
¬g2
) {

1073 
I‹rS‹
* 
	g¡©e
 = 
»š‹½»t_ÿ¡
<I‹rS‹*>(
¬g1
);

1074 
	g¡©e
->
	gmu
->
Lock
();

1075 
	g¡©e
->
	gmem
->
UÄef
();

1076 ià(
	g¡©e
->
	gimm
 !ğ
nuÎ±r
è
¡©e
->
imm
->
UÄef
();

1077 
	g¡©e
->
	gv”siÚ
->
UÄef
();

1078 
	g¡©e
->
	gmu
->
UÆock
();

1079 
d–‘e
 
	g¡©e
;

1084 
I‹¿tÜ
* 
	gDBIm¶
::
NewIÁ”ÇlI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

1085 
Sequ’ûNumb”
* 
Ï‹¡_¢­shÙ
,

1086 
ušt32_t
* 
£ed
) {

1087 
	gmu‹x_
.
Lock
();

1088 *
	gÏ‹¡_¢­shÙ
 = 
v”siÚs_
->
La¡Sequ’û
();

1091 
	g¡d
::
veùÜ
<
I‹¿tÜ
*> 
li¡
;

1092 
	gli¡
.
push_back
(
mem_
->
NewI‹¿tÜ
());

1093 
	gmem_
->
Ref
();

1094 ià(
	gimm_
 !ğ
nuÎ±r
) {

1095 
li¡
.
push_back
(
imm_
->
NewI‹¿tÜ
());

1096 
	gimm_
->
Ref
();

1098 
	gv”siÚs_
->
cu¼’t
()->
AddI‹¿tÜs
(
İtiÚs
, &
li¡
);

1099 
I‹¿tÜ
* 
	gš‹º®_™”
 =

1100 
NewM”gšgI‹¿tÜ
(&
š‹º®_com·¿tÜ_
, &
li¡
[0],†i¡.
size
());

1101 
	gv”siÚs_
->
cu¼’t
()->
Ref
();

1103 
I‹rS‹
* 
	gş—nup
 = 
Ãw
 I‹rS‹(&
mu‹x_
, 
mem_
, 
imm_
, 
v”siÚs_
->
cu¼’t
());

1104 
	gš‹º®_™”
->
Regi¡”CËªup
(
CËªupI‹¿tÜS‹
, 
ş—nup
, 
nuÎ±r
);

1106 *
	g£ed
 = ++
£ed_
;

1107 
	gmu‹x_
.
UÆock
();

1108  
	gš‹º®_™”
;

1111 
I‹¿tÜ
* 
	gDBIm¶
::
TEST_NewIÁ”ÇlI‹¿tÜ
() {

1112 
Sequ’ûNumb”
 
ignÜed
;

1113 
ušt32_t
 
	gignÜed_£ed
;

1114  
NewIÁ”ÇlI‹¿tÜ
(
R—dO±iÚs
(), &
ignÜed
, &
ignÜed_£ed
);

1117 
št64_t
 
	gDBIm¶
::
TEST_MaxNextLev–Ov”ÏµšgBy‹s
() {

1118 
Mu‹xLock
 
l
(&
mu‹x_
);

1119  
	gv”siÚs_
->
MaxNextLev–Ov”ÏµšgBy‹s
();

1122 
Stus
 
	gDBIm¶
::
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, cÚ¡ 
Sliû
& 
key
,

1123 
¡d
::
¡ršg
* 
v®ue
) {

1124 
Stus
 
s
;

1125 
Mu‹xLock
 
l
(&
mu‹x_
);

1126 
Sequ’ûNumb”
 
	g¢­shÙ
;

1127 ià(
	gİtiÚs
.
	g¢­shÙ
 !ğ
nuÎ±r
) {

1128 
¢­shÙ
 =

1129 
¡©ic_ÿ¡
<cÚ¡ 
SÇpshÙIm¶
*>(
İtiÚs
.
¢­shÙ
)->
£qu’û_numb”
();

1131 
	g¢­shÙ
 = 
v”siÚs_
->
La¡Sequ’û
();

1134 
MemTabË
* 
	gmem
 = 
mem_
;

1135 
MemTabË
* 
	gimm
 = 
imm_
;

1136 
V”siÚ
* 
	gcu¼’t
 = 
v”siÚs_
->
cu¼’t
();

1137 
	gmem
->
Ref
();

1138 ià(
	gimm
 !ğ
nuÎ±r
è
imm
->
Ref
();

1139 
	gcu¼’t
->
Ref
();

1141 
boŞ
 
	ghave_¡©_upd©e
 = 
çl£
;

1142 
	gV”siÚ
::
G‘Sts
 
¡©s
;

1146 
	gmu‹x_
.
UÆock
();

1148 
LookupKey
 
lkey
(
key
, 
¢­shÙ
);

1149 ià(
	gmem
->
G‘
(
lkey
, 
v®ue
, &
s
)) {

1151 } ià(
	gimm
 !ğ
nuÎ±r
 && 
imm
->
G‘
(
lkey
, 
v®ue
, &
s
)) {

1154 
	gs
 = 
cu¼’t
->
G‘
(
İtiÚs
, 
lkey
, 
v®ue
, &
¡©s
);

1155 
	ghave_¡©_upd©e
 = 
Œue
;

1157 
	gmu‹x_
.
Lock
();

1160 ià(
	ghave_¡©_upd©e
 && 
	gcu¼’t
->
Upd©eSts
(
¡©s
)) {

1161 
MaybeScheduËCom·ùiÚ
();

1163 
	gmem
->
UÄef
();

1164 ià(
	gimm
 !ğ
nuÎ±r
è
imm
->
UÄef
();

1165 
	gcu¼’t
->
UÄef
();

1166  
	gs
;

1169 
I‹¿tÜ
* 
	gDBIm¶
::
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
) {

1170 
Sequ’ûNumb”
 
Ï‹¡_¢­shÙ
;

1171 
ušt32_t
 
	g£ed
;

1172 
I‹¿tÜ
* 
	g™”
 = 
NewIÁ”ÇlI‹¿tÜ
(
İtiÚs
, &
Ï‹¡_¢­shÙ
, &
£ed
);

1173  
NewDBI‹¿tÜ
(
this
, 
u£r_com·¿tÜ
(), 
™”
,

1174 (
İtiÚs
.
¢­shÙ
 !ğ
nuÎ±r


1175 ? 
¡©ic_ÿ¡
<cÚ¡ 
SÇpshÙIm¶
*>(
İtiÚs
.
¢­shÙ
)

1176 ->
£qu’û_numb”
()

1177 : 
Ï‹¡_¢­shÙ
),

1178 
£ed
);

1181 
	gDBIm¶
::
RecÜdR—dSam¶e
(
Sliû
 
key
) {

1182 
Mu‹xLock
 
l
(&
mu‹x_
);

1183 ià(
	gv”siÚs_
->
cu¼’t
()->
RecÜdR—dSam¶e
(
key
)) {

1184 
MaybeScheduËCom·ùiÚ
();

1188 cÚ¡ 
SÇpshÙ
* 
	gDBIm¶
::
G‘SÇpshÙ
() {

1189 
Mu‹xLock
 
l
(&
mu‹x_
);

1190  
	g¢­shÙs_
.
New
(
v”siÚs_
->
La¡Sequ’û
());

1193 
	gDBIm¶
::
R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
¢­shÙ
) {

1194 
Mu‹xLock
 
l
(&
mu‹x_
);

1195 
	g¢­shÙs_
.
D–‘e
(
¡©ic_ÿ¡
<cÚ¡ 
SÇpshÙIm¶
*>(
¢­shÙ
));

1199 
Stus
 
	gDBIm¶
::
Put
(cÚ¡ 
Wr™eO±iÚs
& 
o
, cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®
) {

1200  
	gDB
::
Put
(
o
, 
key
, 
v®
);

1203 
Stus
 
	gDBIm¶
::
D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, cÚ¡ 
Sliû
& 
key
) {

1204  
	gDB
::
D–‘e
(
İtiÚs
, 
key
);

1208 
Stus
 
	gDBIm¶
::
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
upd©es
) {

1209 
Wr™”
 
w
(&
mu‹x_
);

1210 
	gw
.
	gb©ch
 = 
upd©es
;

1211 
	gw
.
	gsync
 = 
İtiÚs
.
sync
;

1212 
	gw
.
	gdÚe
 = 
çl£
;

1214 
Mu‹xLock
 
l
(&
mu‹x_
);

1215 
	gwr™”s_
.
push_back
(&
w
);

1216 !
	gw
.
	gdÚe
 && &w !ğ
wr™”s_
.
äÚt
()) {

1217 
w
.
cv
.
Wa™
();

1219 ià(
	gw
.
	gdÚe
) {

1220  
	gw
.
	g¡©us
;

1224 
Stus
 
	g¡©us
 = 
MakeRoomFÜWr™e
(
upd©es
 =ğ
nuÎ±r
);

1225 
ušt64_t
 
	gÏ¡_£qu’û
 = 
v”siÚs_
->
La¡Sequ’û
();

1226 
Wr™”
* 
	gÏ¡_wr™”
 = &
w
;

1227 ià(
	g¡©us
.
ok
(è&& 
	gupd©es
 !ğ
nuÎ±r
) {

1228 
Wr™eB©ch
* 
wr™e_b©ch
 = 
BudB©chGroup
(&
Ï¡_wr™”
);

1229 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(
wr™e_b©ch
, 
Ï¡_£qu’û
 + 1);

1230 
	gÏ¡_£qu’û
 +ğ
Wr™eB©chIÁ”Çl
::
CouÁ
(
wr™e_b©ch
);

1237 
	gmu‹x_
.
UÆock
();

1239 
	g¡©us
 = 
log_
->
AddRecÜd
(
Wr™eB©chIÁ”Çl
::
CÚ‹Ás
(
wr™e_b©ch
));

1240 
boŞ
 
	gsync_”rÜ
 = 
çl£
;

1241 ià(
	g¡©us
.
ok
(è&& 
	gİtiÚs
.
	gsync
) {

1242 
	g¡©us
 = 
logfe_
->
Sync
();

1243 ià(!
	g¡©us
.
ok
()) {

1244 
	gsync_”rÜ
 = 
Œue
;

1248 ià(
	g¡©us
.
ok
()) {

1249 
	g¡©us
 = 
Wr™eB©chIÁ”Çl
::
In£¹IÁo
(
wr™e_b©ch
, 
mem_
);

1251 
	gmu‹x_
.
Lock
();

1252 ià(
	gsync_”rÜ
) {

1256 
RecÜdBackgroundE¼Ü
(
¡©us
);

1259 ià(
	gwr™e_b©ch
 =ğ
tmp_b©ch_
ètmp_b©ch_->
CË¬
();

1261 
	gv”siÚs_
->
S‘La¡Sequ’û
(
Ï¡_£qu’û
);

1264 
	gŒue
) {

1265 
Wr™”
* 
	g»ady
 = 
wr™”s_
.
äÚt
();

1266 
	gwr™”s_
.
pİ_äÚt
();

1267 ià(
	g»ady
 !ğ&
w
) {

1268 
»ady
->
¡©us
 = status;

1269 
	g»ady
->
	gdÚe
 = 
Œue
;

1270 
	g»ady
->
	gcv
.
SigÇl
();

1272 ià(
	g»ady
 =ğ
Ï¡_wr™”
) ;

1276 ià(!
	gwr™”s_
.
em±y
()) {

1277 
	gwr™”s_
.
äÚt
()->
	gcv
.
SigÇl
();

1280  
	g¡©us
;

1285 
Wr™eB©ch
* 
	gDBIm¶
::
BudB©chGroup
(
Wr™”
** 
Ï¡_wr™”
) {

1286 
mu‹x_
.
As£¹H–d
();

1287 
as£¹
(!
wr™”s_
.
em±y
());

1288 
Wr™”
* 
	gfœ¡
 = 
wr™”s_
.
äÚt
();

1289 
Wr™eB©ch
* 
	g»suÉ
 = 
fœ¡
->
b©ch
;

1290 
as£¹
(
»suÉ
 !ğ
nuÎ±r
);

1292 
size_t
 
	gsize
 = 
Wr™eB©chIÁ”Çl
::
By‹Size
(
fœ¡
->
b©ch
);

1297 
size_t
 
	gmax_size
 = 1 << 20;

1298 ià(
	gsize
 <= (128 << 10)) {

1299 
max_size
 = 
size
 + (128 << 10);

1302 *
	gÏ¡_wr™”
 = 
fœ¡
;

1303 
	g¡d
::
deque
<
Wr™”
*>::
™”©Ü
 
™”
 = 
wr™”s_
.
begš
();

1304 ++
	g™”
;

1305 ; 
	g™”
 !ğ
wr™”s_
.
’d
(); ++iter) {

1306 
Wr™”
* 
	gw
 = *
™”
;

1307 ià(
	gw
->
	gsync
 && !
	gfœ¡
->sync) {

1312 ià(
	gw
->
	gb©ch
 !ğ
nuÎ±r
) {

1313 
size
 +ğ
Wr™eB©chIÁ”Çl
::
By‹Size
(
w
->
b©ch
);

1314 ià(
	gsize
 > 
	gmax_size
) {

1320 ià(
	g»suÉ
 =ğ
fœ¡
->
b©ch
) {

1322 
»suÉ
 = 
tmp_b©ch_
;

1323 
as£¹
(
Wr™eB©chIÁ”Çl
::
CouÁ
(
»suÉ
) == 0);

1324 
	gWr™eB©chIÁ”Çl
::
Aµ’d
(
»suÉ
, 
fœ¡
->
b©ch
);

1326 
	gWr™eB©chIÁ”Çl
::
Aµ’d
(
»suÉ
, 
w
->
b©ch
);

1328 *
	gÏ¡_wr™”
 = 
w
;

1330  
	g»suÉ
;

1335 
Stus
 
	gDBIm¶
::
MakeRoomFÜWr™e
(
boŞ
 
fÜû
) {

1336 
mu‹x_
.
As£¹H–d
();

1337 
as£¹
(!
wr™”s_
.
em±y
());

1338 
boŞ
 
	g®low_d–ay
 = !
fÜû
;

1339 
Stus
 
	gs
;

1340 
	gŒue
) {

1341 ià(!
	gbg_”rÜ_
.
ok
()) {

1343 
	gs
 = 
bg_”rÜ_
;

1345 } ià(
	g®low_d–ay
 && 
	gv”siÚs_
->
NumLev–Fes
(0) >=

1346 
cÚfig
::
kL0_SlowdownWr™esTrigg”
) {

1353 
mu‹x_
.
UÆock
();

1354 
	g’v_
->
SË•FÜMiüo£cÚds
(1000);

1355 
	g®low_d–ay
 = 
çl£
;

1356 
	gmu‹x_
.
Lock
();

1357 } ià(!
	gfÜû
 &&

1358 (
	gmem_
->
Aµroxim©eMemÜyU§ge
(è<ğ
İtiÚs_
.
wr™e_bufãr_size
)) {

1361 } ià(
	gimm_
 !ğ
nuÎ±r
) {

1364 
Log
(
İtiÚs_
.
šfo_log
, "Current memtable full; waiting...\n");

1365 
	gbackground_wÜk_fšished_sigÇl_
.
Wa™
();

1366 } ià(
	gv”siÚs_
->
NumLev–Fes
(0è>ğ
cÚfig
::
kL0_StİWr™esTrigg”
) {

1368 
Log
(
İtiÚs_
.
šfo_log
, "Too many L0 files; waiting...\n");

1369 
	gbackground_wÜk_fšished_sigÇl_
.
Wa™
();

1372 
as£¹
(
v”siÚs_
->
P»vLogNumb”
() == 0);

1373 
ušt64_t
 
	gÃw_log_numb”
 = 
v”siÚs_
->
NewFeNumb”
();

1374 
Wr™abËFe
* 
	glfe
 = 
nuÎ±r
;

1375 
	gs
 = 
’v_
->
NewWr™abËFe
(
LogFeName
(
dbÇme_
, 
Ãw_log_numb”
), &
lfe
);

1376 ià(!
	gs
.
ok
()) {

1378 
	gv”siÚs_
->
Reu£FeNumb”
(
Ãw_log_numb”
);

1381 
d–‘e
 
	glog_
;

1382 
d–‘e
 
	glogfe_
;

1383 
	glogfe_
 = 
lfe
;

1384 
	glogfe_numb”_
 = 
Ãw_log_numb”
;

1385 
	glog_
 = 
Ãw
 
log
::
Wr™”
(
lfe
);

1386 
	gimm_
 = 
mem_
;

1387 
	ghas_imm_
.
¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1388 
	gmem_
 = 
Ãw
 
MemTabË
(
š‹º®_com·¿tÜ_
);

1389 
	gmem_
->
Ref
();

1390 
	gfÜû
 = 
çl£
;

1391 
MaybeScheduËCom·ùiÚ
();

1394  
	gs
;

1397 
boŞ
 
	gDBIm¶
::
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
) {

1398 
v®ue
->
ş—r
();

1400 
Mu‹xLock
 
l
(&
mu‹x_
);

1401 
Sliû
 
	gš
 = 
´İ”ty
;

1402 
Sliû
 
´efix
("leveldb.");

1403 ià(!
	gš
.
¡¬ts_w™h
(
´efix
)è 
	gçl£
;

1404 
	gš
.
»move_´efix
(
´efix
.
size
());

1406 ià(
	gš
.
¡¬ts_w™h
("num-files-at-level")) {

1407 
	gš
.
»move_´efix
(
¡¾’
("num-files-at-level"));

1408 
ušt64_t
 
	gËv–
;

1409 
boŞ
 
	gok
 = 
CÚsumeDecim®Numb”
(&
š
, &
Ëv–
è&& 
	gš
.
em±y
();

1410 ià(!
	gok
 || 
	gËv–
 >ğ
cÚfig
::
kNumLev–s
) {

1411  
çl£
;

1413 
	gbuf
[100];

1414 
¢´štf
(
buf
, (buf), "%d",

1415 
v”siÚs_
->
NumLev–Fes
(
¡©ic_ÿ¡
<>(
Ëv–
)));

1416 *
	gv®ue
 = 
buf
;

1417  
	gŒue
;

1419 } ià(
	gš
 == "stats") {

1420 
buf
[200];

1421 
¢´štf
(
buf
, (buf),

1425 
	gv®ue
->
­³nd
(
buf
);

1426 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

1427 
	gfes
 = 
v”siÚs_
->
NumLev–Fes
(
Ëv–
);

1428 ià(
	g¡©s_
[
Ëv–
].
	gmiüos
 > 0 || 
	gfes
 > 0) {

1429 
¢´štf
(
buf
, (buf), "%3d %8d %8.0à%9.0à%8.0à%9.0f\n", 
Ëv–
,

1430 
fes
, 
v”siÚs_
->
NumLev–By‹s
(
Ëv–
) / 1048576.0,

1431 
¡©s_
[
Ëv–
].
miüos
 / 1e6,

1432 
¡©s_
[
Ëv–
].
by‹s_»ad
 / 1048576.0,

1433 
¡©s_
[
Ëv–
].
by‹s_wr™‹n
 / 1048576.0);

1434 
	gv®ue
->
­³nd
(
buf
);

1437  
	gŒue
;

1438 } ià(
	gš
 == "sstables") {

1439 *
v®ue
 = 
v”siÚs_
->
cu¼’t
()->
DebugSŒšg
();

1440  
	gŒue
;

1441 } ià(
	gš
 == "approximate-memory-usage") {

1442 
size_t
 
tÙ®_u§ge
 = 
İtiÚs_
.
block_ÿche
->
TÙ®Ch¬ge
();

1443 ià(
	gmem_
) {

1444 
	gtÙ®_u§ge
 +ğ
mem_
->
Aµroxim©eMemÜyU§ge
();

1446 ià(
	gimm_
) {

1447 
	gtÙ®_u§ge
 +ğ
imm_
->
Aµroxim©eMemÜyU§ge
();

1449 
	gbuf
[50];

1450 
¢´štf
(
buf
, (buf), "%llu",

1451 
¡©ic_ÿ¡
<>(
tÙ®_u§ge
));

1452 
	gv®ue
->
­³nd
(
buf
);

1453  
	gŒue
;

1456  
	gçl£
;

1459 
	gDBIm¶
::
G‘Aµroxim©eSizes
(cÚ¡ 
Rªge
* 
¿nge
, 
n
, 
ušt64_t
* 
sizes
) {

1461 
Mu‹xLock
 
l
(&
mu‹x_
);

1462 
V”siÚ
* 
	gv
 = 
v”siÚs_
->
cu¼’t
();

1463 
	gv
->
Ref
();

1465 
	gi
 = 0; i < 
	gn
; i++) {

1467 
IÁ”ÇlKey
 
k1
(
¿nge
[
i
].
¡¬t
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
);

1468 
IÁ”ÇlKey
 
k2
(
¿nge
[
i
].
lim™
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
);

1469 
ušt64_t
 
	g¡¬t
 = 
v”siÚs_
->
Aµroxim©eOff£tOf
(
v
, 
k1
);

1470 
ušt64_t
 
	glim™
 = 
v”siÚs_
->
Aµroxim©eOff£tOf
(
v
, 
k2
);

1471 
	gsizes
[
i
] = (
lim™
 >ğ
¡¬t
 ?†imit - start : 0);

1474 
	gv
->
UÄef
();

1479 
Stus
 
	gDB
::
Put
(cÚ¡ 
Wr™eO±iÚs
& 
İt
, cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
) {

1480 
Wr™eB©ch
 
	gb©ch
;

1481 
	gb©ch
.
Put
(
key
, 
v®ue
);

1482  
Wr™e
(
İt
, &
b©ch
);

1485 
Stus
 
	gDB
::
D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
İt
, cÚ¡ 
Sliû
& 
key
) {

1486 
Wr™eB©ch
 
	gb©ch
;

1487 
	gb©ch
.
D–‘e
(
key
);

1488  
Wr™e
(
İt
, &
b©ch
);

1491 
	gDB
::~
DB
() = ;

1495 
Stus
 
	gDB
::
O³n
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, 
DB
** 
db±r
) {

1496 *
	gdb±r
 = 
nuÎ±r
;

1498 
DBIm¶
* 
	gim¶
 = 
Ãw
 DBIm¶(
İtiÚs
, 
dbÇme
);

1499 
	gim¶
->
	gmu‹x_
.
Lock
();

1500 
V”siÚEd™
 
	ged™
;

1502 
boŞ
 
	g§ve_mªiã¡
 = 
çl£
;

1503 
Stus
 
	gs
 = 
im¶
->
Recov”
(&
ed™
, &
§ve_mªiã¡
);

1504 ià(
	gs
.
ok
(è&& 
	gim¶
->
	gmem_
 =ğ
nuÎ±r
) {

1506 
ušt64_t
 
Ãw_log_numb”
 = 
im¶
->
v”siÚs_
->
NewFeNumb”
();

1507 
Wr™abËFe
* 
	glfe
;

1508 
	gs
 = 
İtiÚs
.
’v
->
NewWr™abËFe
(
LogFeName
(
dbÇme
, 
Ãw_log_numb”
),

1509 &
lfe
);

1510 ià(
	gs
.
ok
()) {

1511 
	ged™
.
S‘LogNumb”
(
Ãw_log_numb”
);

1512 
	gim¶
->
	glogfe_
 = 
lfe
;

1513 
	gim¶
->
	glogfe_numb”_
 = 
Ãw_log_numb”
;

1514 
	gim¶
->
	glog_
 = 
Ãw
 
log
::
Wr™”
(
lfe
);

1515 
	gim¶
->
	gmem_
 = 
Ãw
 
MemTabË
(
im¶
->
š‹º®_com·¿tÜ_
);

1516 
	gim¶
->
	gmem_
->
Ref
();

1519 ià(
	gs
.
ok
(è&& 
	g§ve_mªiã¡
) {

1520 
	ged™
.
S‘P»vLogNumb”
(0);

1521 
	ged™
.
S‘LogNumb”
(
im¶
->
logfe_numb”_
);

1522 
	gs
 = 
im¶
->
v”siÚs_
->
LogAndAµly
(&
ed™
, &im¶->
mu‹x_
);

1524 ià(
	gs
.
ok
()) {

1525 
	gim¶
->
RemoveObsŞ‘eFes
();

1526 
	gim¶
->
MaybeScheduËCom·ùiÚ
();

1528 
	gim¶
->
	gmu‹x_
.
UÆock
();

1529 ià(
	gs
.
ok
()) {

1530 
as£¹
(
im¶
->
mem_
 !ğ
nuÎ±r
);

1531 *
	gdb±r
 = 
im¶
;

1533 
d–‘e
 
	gim¶
;

1535  
	gs
;

1538 
	gSÇpshÙ
::~
SÇpshÙ
() = ;

1540 
Stus
 
De¡royDB
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
) {

1541 
Env
* 
	g’v
 = 
İtiÚs
.
’v
;

1542 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

1543 
Stus
 
	g»suÉ
 = 
’v
->
G‘Chd»n
(
dbÇme
, &
f’ames
);

1544 ià(!
	g»suÉ
.
ok
()) {

1546  
	gStus
::
OK
();

1549 
FeLock
* 
	glock
;

1550 cÚ¡ 
	g¡d
::
¡ršg
 
lockÇme
 = 
LockFeName
(
dbÇme
);

1551 
	g»suÉ
 = 
’v
->
LockFe
(
lockÇme
, &
lock
);

1552 ià(
	g»suÉ
.
ok
()) {

1553 
ušt64_t
 
	gnumb”
;

1554 
FeTy³
 
	gty³
;

1555 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

1556 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
) &&

1557 
	gty³
 !ğ
kDBLockFe
) {

1558 
Stus
 
d–
 = 
’v
->
RemoveFe
(
dbÇme
 + "/" + 
f’ames
[
i
]);

1559 ià(
	g»suÉ
.
ok
(è&& !
	gd–
.ok()) {

1560 
	g»suÉ
 = 
d–
;

1564 
	g’v
->
UÆockFe
(
lock
);

1565 
	g’v
->
RemoveFe
(
lockÇme
);

1566 
	g’v
->
RemoveDœ
(
dbÇme
);

1568  
	g»suÉ
;

	@db_impl.h

5 #iâdeà
STORAGE_LEVELDB_DB_DB_IMPL_H_


6 
	#STORAGE_LEVELDB_DB_DB_IMPL_H_


	)

8 
	~<©omic
>

9 
	~<deque
>

10 
	~<£t
>

11 
	~<¡ršg
>

13 
	~"db/dbfÜm©.h
"

14 
	~"db/log_wr™”.h
"

15 
	~"db/¢­shÙ.h
"

16 
	~"Ëv–db/db.h
"

17 
	~"Ëv–db/’v.h
"

18 
	~"pÜt/pÜt.h
"

19 
	~"pÜt/th»ad_ªnÙ©iÚs.h
"

21 
Çme¥aû
 
	gËv–db
 {

23 
şass
 
	gMemTabË
;

24 
şass
 
	gTabËCache
;

25 
şass
 
	gV”siÚ
;

26 
şass
 
	gV”siÚEd™
;

27 
şass
 
	gV”siÚS‘
;

29 şas 
	cDBIm¶
 : 
public
 
DB
 {

30 
public
:

31 
DBIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
);

33 
DBIm¶
(cÚ¡ DBIm¶&èğ
d–‘e
;

34 
	gDBIm¶
& 
	gİ”©Ü
=(cÚ¡ 
DBIm¶
&èğ
d–‘e
;

36 ~
DBIm¶
(è
	gov”ride
;

39 
Stus
 
Put
(cÚ¡ 
Wr™eO±iÚs
&, cÚ¡ 
Sliû
& 
key
,

40 cÚ¡ 
Sliû
& 
v®ue
è
	gov”ride
;

41 
Stus
 
D–‘e
(cÚ¡ 
Wr™eO±iÚs
&, cÚ¡ 
Sliû
& 
key
è
	gov”ride
;

42 
Stus
 
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
upd©es
è
	gov”ride
;

43 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, cÚ¡ 
Sliû
& 
key
,

44 
¡d
::
¡ršg
* 
v®ue
è
ov”ride
;

45 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&è
	gov”ride
;

46 cÚ¡ 
SÇpshÙ
* 
G‘SÇpshÙ
(è
	gov”ride
;

47 
R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
¢­shÙ
è
	gov”ride
;

48 
boŞ
 
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
è
ov”ride
;

49 
G‘Aµroxim©eSizes
(cÚ¡ 
Rªge
* 
¿nge
, 
n
, 
ušt64_t
* 
sizes
è
	gov”ride
;

50 
Com·ùRªge
(cÚ¡ 
Sliû
* 
begš
, cÚ¡ Sliû* 
’d
è
	gov”ride
;

55 
TEST_Com·ùRªge
(
Ëv–
, cÚ¡ 
Sliû
* 
begš
, cÚ¡ Sliû* 
’d
);

58 
Stus
 
TEST_Com·ùMemTabË
();

63 
I‹¿tÜ
* 
TEST_NewIÁ”ÇlI‹¿tÜ
();

67 
št64_t
 
TEST_MaxNextLev–Ov”ÏµšgBy‹s
();

72 
RecÜdR—dSam¶e
(
Sliû
 
key
);

74 
	g´iv©e
:

75 
ä›nd
 
şass
 
DB
;

76 
	gCom·ùiÚS‹
;

77 
	gWr™”
;

80 
	sMªu®Com·ùiÚ
 {

81 
	gËv–
;

82 
boŞ
 
	gdÚe
;

83 cÚ¡ 
IÁ”ÇlKey
* 
	gbegš
;

84 cÚ¡ 
IÁ”ÇlKey
* 
	g’d
;

85 
IÁ”ÇlKey
 
	gtmp_¡Üage
;

90 
	sCom·ùiÚSts
 {

91 
Com·ùiÚSts
(è: 
miüos
(0), 
by‹s_»ad
(0), 
by‹s_wr™‹n
(0) {}

93 
Add
(cÚ¡ 
Com·ùiÚSts
& 
c
) {

94 
	gthis
->
	gmiüos
 +ğ
c
.
miüos
;

95 
	gthis
->
	gby‹s_»ad
 +ğ
c
.
by‹s_»ad
;

96 
	gthis
->
	gby‹s_wr™‹n
 +ğ
c
.
by‹s_wr™‹n
;

99 
št64_t
 
	gmiüos
;

100 
št64_t
 
	gby‹s_»ad
;

101 
št64_t
 
	gby‹s_wr™‹n
;

104 
I‹¿tÜ
* 
NewIÁ”ÇlI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&,

105 
Sequ’ûNumb”
* 
Ï‹¡_¢­shÙ
,

106 
ušt32_t
* 
£ed
);

108 
Stus
 
NewDB
();

113 
Stus
 
Recov”
(
V”siÚEd™
* 
ed™
, 
boŞ
* 
§ve_mªiã¡
)

114 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

116 
MaybeIgnÜeE¼Ü
(
Stus
* 
s
) const;

119 
RemoveObsŞ‘eFes
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

124 
Com·ùMemTabË
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

126 
Stus
 
Recov”LogFe
(
ušt64_t
 
log_numb”
, 
boŞ
 
Ï¡_log
, boŞ* 
§ve_mªiã¡
,

127 
V”siÚEd™
* 
ed™
, 
Sequ’ûNumb”
* 
max_£qu’û
)

128 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

130 
Stus
 
Wr™eLev–0TabË
(
MemTabË
* 
mem
, 
V”siÚEd™
* 
ed™
, 
V”siÚ
* 
ba£
)

131 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

133 
Stus
 
MakeRoomFÜWr™e
(
boŞ
 
fÜû
 )

134 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

135 
Wr™eB©ch
* 
BudB©chGroup
(
Wr™”
** 
Ï¡_wr™”
)

136 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

138 
RecÜdBackgroundE¼Ü
(cÚ¡ 
Stus
& 
s
);

140 
MaybeScheduËCom·ùiÚ
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

141 
BGWÜk
(* 
db
);

142 
BackgroundC®l
();

143 
BackgroundCom·ùiÚ
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

144 
CËªupCom·ùiÚ
(
Com·ùiÚS‹
* 
com·ù
)

145 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

146 
Stus
 
DoCom·ùiÚWÜk
(
Com·ùiÚS‹
* 
com·ù
)

147 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

149 
Stus
 
O³nCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
);

150 
Stus
 
FšishCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
, 
I‹¿tÜ
* 
šput
);

151 
Stus
 
In¡®lCom·ùiÚResuÉs
(
Com·ùiÚS‹
* 
com·ù
)

152 
EXCLUSIVE_LOCKS_REQUIRED
(
mu‹x_
);

154 cÚ¡ 
Com·¿tÜ
* 
u£r_com·¿tÜ
() const {

155  
	gš‹º®_com·¿tÜ_
.
u£r_com·¿tÜ
();

159 
Env
* cÚ¡ 
	g’v_
;

160 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
	gš‹º®_com·¿tÜ_
;

161 cÚ¡ 
IÁ”ÇlF‹rPŞicy
 
	gš‹º®_f‹r_pŞicy_
;

162 cÚ¡ 
O±iÚs
 
	gİtiÚs_
;

163 cÚ¡ 
boŞ
 
	gowns_šfo_log_
;

164 cÚ¡ 
boŞ
 
	gowns_ÿche_
;

165 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

168 
TabËCache
* cÚ¡ 
	gbË_ÿche_
;

171 
FeLock
* 
	gdb_lock_
;

174 
	gpÜt
::
Mu‹x
 
mu‹x_
;

175 
	g¡d
::
©omic
<
boŞ
> 
shu‰šg_down_
;

176 
	gpÜt
::
CÚdV¬
 
background_wÜk_fšished_sigÇl_
 
GUARDED_BY
(
mu‹x_
);

177 
MemTabË
* 
	gmem_
;

178 
MemTabË
* 
imm_
 
GUARDED_BY
(
mu‹x_
);

179 
	g¡d
::
©omic
<
boŞ
> 
has_imm_
;

180 
Wr™abËFe
* 
	glogfe_
;

181 
ušt64_t
 
logfe_numb”_
 
GUARDED_BY
(
mu‹x_
);

182 
	glog
::
Wr™”
* 
log_
;

183 
ušt32_t
 
£ed_
 
GUARDED_BY
(
mu‹x_
);

186 
	g¡d
::
deque
<
Wr™”
*> 
wr™”s_
 
GUARDED_BY
(
mu‹x_
);

187 
Wr™eB©ch
* 
tmp_b©ch_
 
GUARDED_BY
(
mu‹x_
);

189 
SÇpshÙLi¡
 
¢­shÙs_
 
GUARDED_BY
(
mu‹x_
);

193 
	g¡d
::
£t
<
ušt64_t
> 
³ndšg_ouuts_
 
GUARDED_BY
(
mu‹x_
);

196 
boŞ
 
background_com·ùiÚ_scheduËd_
 
GUARDED_BY
(
mu‹x_
);

198 
Mªu®Com·ùiÚ
* 
mªu®_com·ùiÚ_
 
GUARDED_BY
(
mu‹x_
);

200 
V”siÚS‘
* cÚ¡ 
v”siÚs_
 
GUARDED_BY
(
mu‹x_
);

203 
Stus
 
bg_”rÜ_
 
GUARDED_BY
(
mu‹x_
);

205 
Com·ùiÚSts
 
	g¡©s_
[
cÚfig
::
kNumLev–s
] 
GUARDED_BY
(
mu‹x_
);

210 
O±iÚs
 
Sª™izeO±iÚs
(cÚ¡ 
¡d
::
¡ršg
& 
db
,

211 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
icmp
,

212 cÚ¡ 
IÁ”ÇlF‹rPŞicy
* 
Şicy
,

213 cÚ¡ 
O±iÚs
& 
¤c
);

	@db_iter.cc

5 
	~"db/db_™”.h
"

7 
	~"db/db_im¶.h
"

8 
	~"db/dbfÜm©.h
"

9 
	~"db/f’ame.h
"

10 
	~"Ëv–db/’v.h
"

11 
	~"Ëv–db/™”©Ü.h
"

12 
	~"pÜt/pÜt.h
"

13 
	~"ut/loggšg.h
"

14 
	~"ut/mu‹xlock.h
"

15 
	~"ut/¿ndom.h
"

17 
Çme¥aû
 
	gËv–db
 {

20 
DumpIÁ”ÇlI‹r
(
I‹¿tÜ
* 
™”
) {

21 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

22 
P¬£dIÁ”ÇlKey
 
	gk
;

23 ià(!
P¬£IÁ”ÇlKey
(
™”
->
key
(), &
k
)) {

24 
årštf
(
¡d”r
, "CÜru± '%s'\n", 
Esÿ³SŒšg
(
™”
->
key
()).
c_¡r
());

26 
årštf
(
¡d”r
, "@ '%s'\n", 
k
.
DebugSŒšg
().
c_¡r
());

32 
	gÇme¥aû
 {

39 şas 
	cDBI‹r
 : 
public
 
I‹¿tÜ
 {

40 
public
:

46 
	eDœeùiÚ
 { 
kFÜw¬d
, 
	gkRev”£
 };

48 
DBI‹r
(
DBIm¶
* 
db
, cÚ¡ 
Com·¿tÜ
* 
cmp
, 
I‹¿tÜ
* 
™”
, 
Sequ’ûNumb”
 
s
,

49 
ušt32_t
 
£ed
)

50 : 
db_
(
db
),

51 
u£r_com·¿tÜ_
(
cmp
),

52 
™”_
(
™”
),

53 
£qu’û_
(
s
),

54 
dœeùiÚ_
(
kFÜw¬d
),

55 
v®id_
(
çl£
),

56 
ºd_
(
£ed
),

57 
by‹s_uÁ_»ad_§m¶šg_
(
RªdomCom·ùiÚP”iod
()) {}

59 
DBI‹r
(cÚ¡ DBI‹r&èğ
d–‘e
;

60 
	gDBI‹r
& 
	gİ”©Ü
=(cÚ¡ 
DBI‹r
&èğ
d–‘e
;

62 ~
DBI‹r
(è
	gov”ride
 { 
d–‘e
 
	g™”_
; }

63 
boŞ
 
V®id
(ècÚ¡ 
	gov”ride
 {  
	gv®id_
; }

64 
Sliû
 
key
(ècÚ¡ 
	gov”ride
 {

65 
as£¹
(
v®id_
);

66  (
	gdœeùiÚ_
 =ğ
kFÜw¬d
è? 
ExŒaùU£rKey
(
™”_
->
key
()è: 
§ved_key_
;

68 
Sliû
 
v®ue
(ècÚ¡ 
	gov”ride
 {

69 
as£¹
(
v®id_
);

70  (
	gdœeùiÚ_
 =ğ
kFÜw¬d
è? 
™”_
->
v®ue
(è: 
§ved_v®ue_
;

72 
Stus
 
¡©us
(ècÚ¡ 
	gov”ride
 {

73 ià(
	g¡©us_
.
ok
()) {

74  
	g™”_
->
¡©us
();

76  
	g¡©us_
;

80 
Next
(è
	gov”ride
;

81 
P»v
(è
	gov”ride
;

82 
S“k
(cÚ¡ 
Sliû
& 
rg‘
è
	gov”ride
;

83 
S“kToFœ¡
(è
	gov”ride
;

84 
S“kToLa¡
(è
	gov”ride
;

86 
	g´iv©e
:

87 
FšdNextU£rEÁry
(
boŞ
 
skpšg
, 
¡d
::
¡ršg
* 
sk
);

88 
FšdP»vU£rEÁry
();

89 
boŞ
 
P¬£Key
(
P¬£dIÁ”ÇlKey
* 
key
);

91 
šlše
 
SaveKey
(cÚ¡ 
Sliû
& 
k
, 
¡d
::
¡ršg
* 
d¡
) {

92 
d¡
->
assign
(
k
.
d©a
(), k.
size
());

95 
šlše
 
CË¬SavedV®ue
() {

96 ià(
	g§ved_v®ue_
.
ÿ·c™y
() > 1048576) {

97 
	g¡d
::
¡ršg
 
em±y
;

98 
sw­
(
em±y
, 
§ved_v®ue_
);

100 
	g§ved_v®ue_
.
ş—r
();

105 
size_t
 
RªdomCom·ùiÚP”iod
() {

106  
	gºd_
.
UnifÜm
(2 * 
cÚfig
::
kR—dBy‹sP”iod
);

109 
DBIm¶
* 
	gdb_
;

110 cÚ¡ 
Com·¿tÜ
* cÚ¡ 
	gu£r_com·¿tÜ_
;

111 
I‹¿tÜ
* cÚ¡ 
	g™”_
;

112 
Sequ’ûNumb”
 cÚ¡ 
	g£qu’û_
;

113 
Stus
 
	g¡©us_
;

114 
	g¡d
::
¡ršg
 
§ved_key_
;

115 
	g¡d
::
¡ršg
 
§ved_v®ue_
;

116 
DœeùiÚ
 
	gdœeùiÚ_
;

117 
boŞ
 
	gv®id_
;

118 
Rªdom
 
	gºd_
;

119 
size_t
 
	gby‹s_uÁ_»ad_§m¶šg_
;

122 
šlše
 
boŞ
 
	gDBI‹r
::
P¬£Key
(
P¬£dIÁ”ÇlKey
* 
ikey
) {

123 
Sliû
 
k
 = 
™”_
->
key
();

125 
size_t
 
	gby‹s_»ad
 = 
k
.
size
(è+ 
™”_
->
v®ue
().size();

126 
	gby‹s_uÁ_»ad_§m¶šg_
 < 
	gby‹s_»ad
) {

127 
	gby‹s_uÁ_»ad_§m¶šg_
 +ğ
RªdomCom·ùiÚP”iod
();

128 
	gdb_
->
RecÜdR—dSam¶e
(
k
);

130 
as£¹
(
by‹s_uÁ_»ad_§m¶šg_
 >ğ
by‹s_»ad
);

131 
	gby‹s_uÁ_»ad_§m¶šg_
 -ğ
by‹s_»ad
;

133 ià(!
P¬£IÁ”ÇlKey
(
k
, 
ikey
)) {

134 
	g¡©us_
 = 
Stus
::
CÜru±iÚ
("corrupted internal key in DBIter");

135  
	gçl£
;

137  
	gŒue
;

141 
	gDBI‹r
::
Next
() {

142 
as£¹
(
v®id_
);

144 ià(
	gdœeùiÚ_
 =ğ
kRev”£
) {

145 
dœeùiÚ_
 = 
kFÜw¬d
;

149 ià(!
	g™”_
->
V®id
()) {

150 
	g™”_
->
S“kToFœ¡
();

152 
	g™”_
->
Next
();

154 ià(!
	g™”_
->
V®id
()) {

155 
	gv®id_
 = 
çl£
;

156 
	g§ved_key_
.
ş—r
();

162 
SaveKey
(
ExŒaùU£rKey
(
™”_
->
key
()), &
§ved_key_
);

166 
	g™”_
->
Next
();

167 ià(!
	g™”_
->
V®id
()) {

168 
	gv®id_
 = 
çl£
;

169 
	g§ved_key_
.
ş—r
();

174 
FšdNextU£rEÁry
(
Œue
, &
§ved_key_
);

177 
	gDBI‹r
::
FšdNextU£rEÁry
(
boŞ
 
skpšg
, 
¡d
::
¡ršg
* 
sk
) {

179 
as£¹
(
™”_
->
V®id
());

180 
as£¹
(
dœeùiÚ_
 =ğ
kFÜw¬d
);

182 
P¬£dIÁ”ÇlKey
 
	gikey
;

183 ià(
P¬£Key
(&
ikey
è&& 
	gikey
.
	g£qu’û
 <ğ
£qu’û_
) {

184 
ikey
.
ty³
) {

185 
kTy³D–‘iÚ
:

188 
SaveKey
(
ikey
.
u£r_key
, 
sk
);

189 
	gskpšg
 = 
Œue
;

191 
	gkTy³V®ue
:

192 ià(
skpšg
 &&

193 
u£r_com·¿tÜ_
->
Com·»
(
ikey
.
u£r_key
, *
sk
) <= 0) {

196 
v®id_
 = 
Œue
;

197 
	g§ved_key_
.
ş—r
();

203 
	g™”_
->
Next
();

204 } 
	g™”_
->
V®id
());

205 
	g§ved_key_
.
ş—r
();

206 
	gv®id_
 = 
çl£
;

209 
	gDBI‹r
::
P»v
() {

210 
as£¹
(
v®id_
);

212 ià(
	gdœeùiÚ_
 =ğ
kFÜw¬d
) {

215 
as£¹
(
™”_
->
V®id
());

216 
SaveKey
(
ExŒaùU£rKey
(
™”_
->
key
()), &
§ved_key_
);

217 
	gŒue
) {

218 
	g™”_
->
P»v
();

219 ià(!
	g™”_
->
V®id
()) {

220 
	gv®id_
 = 
çl£
;

221 
	g§ved_key_
.
ş—r
();

222 
CË¬SavedV®ue
();

225 ià(
	gu£r_com·¿tÜ_
->
Com·»
(
ExŒaùU£rKey
(
™”_
->
key
()), 
§ved_key_
) <

230 
	gdœeùiÚ_
 = 
kRev”£
;

233 
FšdP»vU£rEÁry
();

236 
	gDBI‹r
::
FšdP»vU£rEÁry
() {

237 
as£¹
(
dœeùiÚ_
 =ğ
kRev”£
);

239 
V®ueTy³
 
	gv®ue_ty³
 = 
kTy³D–‘iÚ
;

240 ià(
	g™”_
->
V®id
()) {

242 
P¬£dIÁ”ÇlKey
 
	gikey
;

243 ià(
P¬£Key
(&
ikey
è&& 
	gikey
.
	g£qu’û
 <ğ
£qu’û_
) {

244 ià((
v®ue_ty³
 !ğ
kTy³D–‘iÚ
) &&

245 
u£r_com·¿tÜ_
->
Com·»
(
ikey
.
u£r_key
, 
§ved_key_
) < 0) {

249 
	gv®ue_ty³
 = 
ikey
.
ty³
;

250 ià(
	gv®ue_ty³
 =ğ
kTy³D–‘iÚ
) {

251 
§ved_key_
.
ş—r
();

252 
CË¬SavedV®ue
();

254 
Sliû
 
	g¿w_v®ue
 = 
™”_
->
v®ue
();

255 ià(
	g§ved_v®ue_
.
ÿ·c™y
(è> 
	g¿w_v®ue
.
size
() + 1048576) {

256 
	g¡d
::
¡ršg
 
em±y
;

257 
sw­
(
em±y
, 
§ved_v®ue_
);

259 
SaveKey
(
ExŒaùU£rKey
(
™”_
->
key
()), &
§ved_key_
);

260 
	g§ved_v®ue_
.
assign
(
¿w_v®ue
.
d©a
(),„aw_v®ue.
size
());

263 
	g™”_
->
P»v
();

264 } 
	g™”_
->
V®id
());

267 ià(
	gv®ue_ty³
 =ğ
kTy³D–‘iÚ
) {

269 
v®id_
 = 
çl£
;

270 
	g§ved_key_
.
ş—r
();

271 
CË¬SavedV®ue
();

272 
	gdœeùiÚ_
 = 
kFÜw¬d
;

274 
	gv®id_
 = 
Œue
;

278 
	gDBI‹r
::
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

279 
dœeùiÚ_
 = 
kFÜw¬d
;

280 
CË¬SavedV®ue
();

281 
	g§ved_key_
.
ş—r
();

282 
Aµ’dIÁ”ÇlKey
(&
§ved_key_
,

283 
P¬£dIÁ”ÇlKey
(
rg‘
, 
£qu’û_
, 
kV®ueTy³FÜS“k
));

284 
	g™”_
->
S“k
(
§ved_key_
);

285 ià(
	g™”_
->
V®id
()) {

286 
FšdNextU£rEÁry
(
çl£
, &
§ved_key_
 );

288 
	gv®id_
 = 
çl£
;

292 
	gDBI‹r
::
S“kToFœ¡
() {

293 
dœeùiÚ_
 = 
kFÜw¬d
;

294 
CË¬SavedV®ue
();

295 
	g™”_
->
S“kToFœ¡
();

296 ià(
	g™”_
->
V®id
()) {

297 
FšdNextU£rEÁry
(
çl£
, &
§ved_key_
 );

299 
	gv®id_
 = 
çl£
;

303 
	gDBI‹r
::
S“kToLa¡
() {

304 
dœeùiÚ_
 = 
kRev”£
;

305 
CË¬SavedV®ue
();

306 
	g™”_
->
S“kToLa¡
();

307 
FšdP»vU£rEÁry
();

312 
I‹¿tÜ
* 
	$NewDBI‹¿tÜ
(
DBIm¶
* 
db
, cÚ¡ 
Com·¿tÜ
* 
u£r_key_com·¿tÜ
,

313 
I‹¿tÜ
* 
š‹º®_™”
, 
Sequ’ûNumb”
 
£qu’û
,

314 
ušt32_t
 
£ed
) {

315  
Ãw
 
	`DBI‹r
(
db
, 
u£r_key_com·¿tÜ
, 
š‹º®_™”
, 
£qu’û
, 
£ed
);

316 
	}
}

	@db_iter.h

5 #iâdeà
STORAGE_LEVELDB_DB_DB_ITER_H_


6 
	#STORAGE_LEVELDB_DB_DB_ITER_H_


	)

8 
	~<¡dšt.h
>

10 
	~"db/dbfÜm©.h
"

11 
	~"Ëv–db/db.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
şass
 
	gDBIm¶
;

20 
I‹¿tÜ
* 
NewDBI‹¿tÜ
(
DBIm¶
* 
db
, cÚ¡ 
Com·¿tÜ
* 
u£r_key_com·¿tÜ
,

21 
I‹¿tÜ
* 
š‹º®_™”
, 
Sequ’ûNumb”
 
£qu’û
,

22 
ušt32_t
 
£ed
);

	@db_test.cc

5 
	~"Ëv–db/db.h
"

7 
	~<©omic
>

8 
	~<¡ršg
>

10 
	~"g‹¡/g‹¡.h
"

11 
	~"db/db_im¶.h
"

12 
	~"db/f’ame.h
"

13 
	~"db/v”siÚ_£t.h
"

14 
	~"db/wr™e_b©ch_š‹º®.h
"

15 
	~"Ëv–db/ÿche.h
"

16 
	~"Ëv–db/’v.h
"

17 
	~"Ëv–db/f‹r_pŞicy.h
"

18 
	~"Ëv–db/bË.h
"

19 
	~"pÜt/pÜt.h
"

20 
	~"pÜt/th»ad_ªnÙ©iÚs.h
"

21 
	~"ut/hash.h
"

22 
	~"ut/loggšg.h
"

23 
	~"ut/mu‹xlock.h
"

24 
	~"ut/‹¡ut.h
"

26 
Çme¥aû
 
	gËv–db
 {

28 
	g¡d
::
¡ršg
 
RªdomSŒšg
(
Rªdom
* 
ºd
, 
Ën
) {

29 
	g¡d
::
¡ršg
 
r
;

30 
	g‹¡
::
RªdomSŒšg
(
ºd
, 
Ën
, &
r
);

31  
	gr
;

34 
	g¡d
::
¡ršg
 
RªdomKey
(
Rªdom
* 
ºd
) {

35 
Ën
 =

36 (
ºd
->
OÃIn
(3) ? 1

37 : (
ºd
->
OÃIn
(100è?„nd->
Skewed
(10è:„nd->
UnifÜm
(10)));

38  
	g‹¡
::
RªdomKey
(
ºd
, 
Ën
);

41 
	gÇme¥aû
 {

42 şas 
	cAtomicCouÁ”
 {

43 
	gpublic
:

44 
AtomicCouÁ”
(è: 
couÁ_
(0) {}

45 
Inüem’t
(è{ 
Inüem’tBy
(1); }

46 
Inüem’tBy
(
couÁ
è
LOCKS_EXCLUDED
(
mu_
) {

47 
Mu‹xLock
 
l
(&
mu_
);

48 
	gcouÁ_
 +ğ
couÁ
;

50 
R—d
(è
LOCKS_EXCLUDED
(
mu_
) {

51 
Mu‹xLock
 
l
(&
mu_
);

52  
	gcouÁ_
;

54 
Re£t
(è
LOCKS_EXCLUDED
(
mu_
) {

55 
Mu‹xLock
 
l
(&
mu_
);

56 
	gcouÁ_
 = 0;

59 
	g´iv©e
:

60 
pÜt
::
Mu‹x
 
mu_
;

61 
couÁ_
 
GUARDED_BY
(
mu_
);

64 
D–ayMli£cÚds
(
mlis
) {

65 
	gEnv
::
DeçuÉ
()->
SË•FÜMiüo£cÚds
(
mlis
 * 1000);

70 şas 
	cTe¡Env
 : 
public
 
EnvW¿µ”
 {

71 
public
:

72 
ex¶ic™
 
Te¡Env
(
Env
* 
ba£
è: 
EnvW¿µ”
(ba£), 
ignÜe_dÙ_fes_
(
çl£
) {}

74 
S‘IgnÜeDÙFes
(
boŞ
 
ignÜed
è{ 
	gignÜe_dÙ_fes_
 = ignored; }

76 
Stus
 
G‘Chd»n
(cÚ¡ 
¡d
::
¡ršg
& 
dœ
,

77 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
»suÉ
è
ov”ride
 {

78 
Stus
 
s
 = 
rg‘
()->
G‘Chd»n
(
dœ
, 
»suÉ
);

79 ià(!
	gs
.
ok
(è|| !
	gignÜe_dÙ_fes_
) {

80  
	gs
;

83 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
 = 
»suÉ
->
begš
();

84 
	g™
 !ğ
»suÉ
->
’d
()) {

85 ià((*
™
 == ".") || (*it == "..")) {

86 
™
 = 
»suÉ
->
”a£
(it);

88 ++
	g™
;

92  
	gs
;

95 
	g´iv©e
:

96 
boŞ
 
ignÜe_dÙ_fes_
;

100 şas 
	cS³cŸlEnv
 : 
public
 
EnvW¿µ”
 {

101 
public
:

103 
¡d
::
©omic
<
boŞ
> 
d–ay_d©a_sync_
;

106 
	g¡d
::
©omic
<
boŞ
> 
d©a_sync_”rÜ_
;

109 
	g¡d
::
©omic
<
boŞ
> 
no_¥aû_
;

112 
	g¡d
::
©omic
<
boŞ
> 
nÚ_wr™abË_
;

115 
	g¡d
::
©omic
<
boŞ
> 
mªiã¡_sync_”rÜ_
;

118 
	g¡d
::
©omic
<
boŞ
> 
mªiã¡_wr™e_”rÜ_
;

120 
boŞ
 
	gcouÁ_¿ndom_»ads_
;

121 
AtomicCouÁ”
 
	g¿ndom_»ad_couÁ”_
;

123 
ex¶ic™
 
S³cŸlEnv
(
Env
* 
ba£
)

124 : 
EnvW¿µ”
(
ba£
),

125 
d–ay_d©a_sync_
(
çl£
),

126 
d©a_sync_”rÜ_
(
çl£
),

127 
no_¥aû_
(
çl£
),

128 
nÚ_wr™abË_
(
çl£
),

129 
mªiã¡_sync_”rÜ_
(
çl£
),

130 
mªiã¡_wr™e_”rÜ_
(
çl£
),

131 
couÁ_¿ndom_»ads_
(
çl£
) {}

133 
Stus
 
NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
Wr™abËFe
** 
r
) {

134 şas 
	cD©aFe
 : 
public
 
Wr™abËFe
 {

135 
´iv©e
:

136 
S³cŸlEnv
* cÚ¡ 
’v_
;

137 
Wr™abËFe
* cÚ¡ 
	gba£_
;

139 
	gpublic
:

140 
D©aFe
(
S³cŸlEnv
* 
’v
, 
Wr™abËFe
* 
ba£
è: 
’v_
Ónv), 
ba£_
(base) {}

141 ~
D©aFe
(è{ 
d–‘e
 
	gba£_
; }

142 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) {

143 ià(
	g’v_
->
	gno_¥aû_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

145  
Stus
::
OK
();

147  
	gba£_
->
Aµ’d
(
d©a
);

150 
Stus
 
Clo£
(è{  
	gba£_
->Close(); }

151 
Stus
 
Flush
(è{  
	gba£_
->Flush(); }

152 
Stus
 
Sync
() {

153 ià(
	g’v_
->
	gd©a_sync_”rÜ_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

154  
Stus
::
IOE¼Ü
("simulated data syncƒrror");

156 
	g’v_
->
	gd–ay_d©a_sync_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

157 
D–ayMli£cÚds
(100);

159  
	gba£_
->
Sync
();

162 şas 
	cMªiã¡Fe
 : 
public
 
Wr™abËFe
 {

163 
´iv©e
:

164 
S³cŸlEnv
* 
’v_
;

165 
Wr™abËFe
* 
	gba£_
;

167 
	gpublic
:

168 
Mªiã¡Fe
(
S³cŸlEnv
* 
’v
, 
Wr™abËFe
* 
b
è: 
’v_
Ónv), 
ba£_
(b) {}

169 ~
Mªiã¡Fe
(è{ 
d–‘e
 
	gba£_
; }

170 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) {

171 ià(
	g’v_
->
	gmªiã¡_wr™e_”rÜ_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

172  
Stus
::
IOE¼Ü
("simulated writerƒrror");

174  
	gba£_
->
Aµ’d
(
d©a
);

177 
Stus
 
Clo£
(è{  
	gba£_
->Close(); }

178 
Stus
 
Flush
(è{  
	gba£_
->Flush(); }

179 
Stus
 
Sync
() {

180 ià(
	g’v_
->
	gmªiã¡_sync_”rÜ_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

181  
Stus
::
IOE¼Ü
("simulated syncƒrror");

183  
	gba£_
->
Sync
();

188 ià(
	gnÚ_wr™abË_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

189  
Stus
::
IOE¼Ü
("simulated writeƒrror");

192 
Stus
 
	gs
 = 
rg‘
()->
NewWr™abËFe
(
f
, 
r
);

193 ià(
	gs
.
ok
()) {

194 ià(
¡r¡r
(
f
.
c_¡r
(), ".ldb"è!ğ
nuÎ±r
 ||

195 
¡r¡r
(
f
.
c_¡r
(), ".log"è!ğ
nuÎ±r
) {

196 *
r
 = 
Ãw
 
D©aFe
(
this
, *r);

197 } ià(
¡r¡r
(
f
.
c_¡r
(), "MANIFEST"è!ğ
nuÎ±r
) {

198 *
r
 = 
Ãw
 
Mªiã¡Fe
(
this
, *r);

201  
	gs
;

204 
Stus
 
NewRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
RªdomAcûssFe
** 
r
) {

205 şas 
	cCouÁšgFe
 : 
public
 
RªdomAcûssFe
 {

206 
´iv©e
:

207 
RªdomAcûssFe
* 
rg‘_
;

208 
AtomicCouÁ”
* 
	gcouÁ”_
;

210 
	gpublic
:

211 
CouÁšgFe
(
RªdomAcûssFe
* 
rg‘
, 
AtomicCouÁ”
* 
couÁ”
)

212 : 
rg‘_
(
rg‘
), 
couÁ”_
(
couÁ”
) {}

213 ~
CouÁšgFe
(è
	gov”ride
 { 
d–‘e
 
	grg‘_
; }

214 
Stus
 
R—d
(
ušt64_t
 
off£t
, 
size_t
 
n
, 
Sliû
* 
»suÉ
,

215 * 
sü©ch
ècÚ¡ 
	gov”ride
 {

216 
	gcouÁ”_
->
Inüem’t
();

217  
	grg‘_
->
R—d
(
off£t
, 
n
, 
»suÉ
, 
sü©ch
);

221 
Stus
 
	gs
 = 
rg‘
()->
NewRªdomAcûssFe
(
f
, 
r
);

222 ià(
	gs
.
ok
(è&& 
	gcouÁ_¿ndom_»ads_
) {

223 *
	gr
 = 
Ãw
 
CouÁšgFe
(*
r
, &
¿ndom_»ad_couÁ”_
);

225  
	gs
;

229 şas 
	cDBTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

230 
public
:

231 
¡d
::
¡ršg
 
dbÇme_
;

232 
S³cŸlEnv
* 
	g’v_
;

233 
DB
* 
	gdb_
;

235 
O±iÚs
 
	gÏ¡_İtiÚs_
;

237 
DBTe¡
(è: 
’v_
(
Ãw
 
S³cŸlEnv
(
Env
::
DeçuÉ
())), 
İtiÚ_cÚfig_
(
kDeçuÉ
) {

238 
	gf‹r_pŞicy_
 = 
NewBloomF‹rPŞicy
(10);

239 
	gdbÇme_
 = 
‹¡šg
::
TempDœ
() + "db_test";

240 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

241 
	gdb_
 = 
nuÎ±r
;

242 
Reİ’
();

245 ~
DBTe¡
() {

246 
d–‘e
 
	gdb_
;

247 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

248 
d–‘e
 
	g’v_
;

249 
d–‘e
 
	gf‹r_pŞicy_
;

254 
boŞ
 
ChªgeO±iÚs
() {

255 
	gİtiÚ_cÚfig_
++;

256 ià(
	gİtiÚ_cÚfig_
 >ğ
kEnd
) {

257  
çl£
;

259 
De¡royAndReİ’
();

260  
	gŒue
;

265 
O±iÚs
 
Cu¼’tO±iÚs
() {

266 
O±iÚs
 
	gİtiÚs
;

267 
	gİtiÚs
.
	g»u£_logs
 = 
çl£
;

268 
	gİtiÚ_cÚfig_
) {

269 
	gkReu£
:

270 
İtiÚs
.
»u£_logs
 = 
Œue
;

272 
	gkF‹r
:

273 
İtiÚs
.
f‹r_pŞicy
 = 
f‹r_pŞicy_
;

275 
	gkUncom´es£d
:

276 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

281  
	gİtiÚs
;

284 
DBIm¶
* 
dbfuÎ
(è{  
	g»š‹½»t_ÿ¡
<
	gDBIm¶
*>(
	gdb_
); }

286 
Reİ’
(
O±iÚs
* 
İtiÚs
 = 
nuÎ±r
) {

287 
ASSERT_LEVELDB_OK
(
TryReİ’
(
İtiÚs
));

290 
Clo£
() {

291 
d–‘e
 
	gdb_
;

292 
	gdb_
 = 
nuÎ±r
;

295 
De¡royAndReİ’
(
O±iÚs
* 
İtiÚs
 = 
nuÎ±r
) {

296 
d–‘e
 
db_
;

297 
	gdb_
 = 
nuÎ±r
;

298 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

299 
ASSERT_LEVELDB_OK
(
TryReİ’
(
İtiÚs
));

302 
Stus
 
TryReİ’
(
O±iÚs
* 
İtiÚs
) {

303 
d–‘e
 
	gdb_
;

304 
	gdb_
 = 
nuÎ±r
;

305 
O±iÚs
 
	gİts
;

306 ià(
	gİtiÚs
 !ğ
nuÎ±r
) {

307 
İts
 = *
İtiÚs
;

309 
	gİts
 = 
Cu¼’tO±iÚs
();

310 
	gİts
.
	gü—‹_if_missšg
 = 
Œue
;

312 
	gÏ¡_İtiÚs_
 = 
İts
;

314  
	gDB
::
O³n
(
İts
, 
dbÇme_
, &
db_
);

317 
Stus
 
Put
(cÚ¡ 
¡d
::
¡ršg
& 
k
, cÚ¡ std::¡ršg& 
v
) {

318  
db_
->
Put
(
Wr™eO±iÚs
(), 
k
, 
v
);

321 
Stus
 
D–‘e
(cÚ¡ 
¡d
::
¡ršg
& 
k
è{  
db_
->D–‘e(
Wr™eO±iÚs
(), k); }

323 
	g¡d
::
¡ršg
 
G‘
(cÚ¡ 
¡d
::¡ršg& 
k
, cÚ¡ 
SÇpshÙ
* 
¢­shÙ
 = 
nuÎ±r
) {

324 
R—dO±iÚs
 
İtiÚs
;

325 
	gİtiÚs
.
	g¢­shÙ
 = 
¢­shÙ
;

326 
	g¡d
::
¡ršg
 
»suÉ
;

327 
Stus
 
	gs
 = 
db_
->
G‘
(
İtiÚs
, 
k
, &
»suÉ
);

328 ià(
	gs
.
IsNÙFound
()) {

329 
	g»suÉ
 = "NOT_FOUND";

330 } ià(!
	gs
.
ok
()) {

331 
	g»suÉ
 = 
s
.
ToSŒšg
();

333  
	g»suÉ
;

338 
	g¡d
::
¡ršg
 
CÚ‹Ás
() {

339 
¡d
::
veùÜ
<¡d::
¡ršg
> 
fÜw¬d
;

340 
	g¡d
::
¡ršg
 
»suÉ
;

341 
I‹¿tÜ
* 
	g™”
 = 
db_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

342 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

343 
	g¡d
::
¡ršg
 
s
 = 
I‹rStus
(
™”
);

344 
	g»suÉ
.
push_back
('(');

345 
	g»suÉ
.
­³nd
(
s
);

346 
	g»suÉ
.
push_back
(')');

347 
	gfÜw¬d
.
push_back
(
s
);

351 
size_t
 
	gm©ched
 = 0;

352 
	g™”
->
S“kToLa¡
(); i‹r->
V®id
(); i‹r->
P»v
()) {

353 
EXPECT_LT
(
m©ched
, 
fÜw¬d
.
size
());

354 
EXPECT_EQ
(
I‹rStus
(
™”
), 
fÜw¬d
[fÜw¬d.
size
(è- 
m©ched
 - 1]);

355 
	gm©ched
++;

357 
EXPECT_EQ
(
m©ched
, 
fÜw¬d
.
size
());

359 
d–‘e
 
	g™”
;

360  
	g»suÉ
;

363 
	g¡d
::
¡ršg
 
AÎEÁr›sFÜ
(cÚ¡ 
Sliû
& 
u£r_key
) {

364 
I‹¿tÜ
* 
™”
 = 
dbfuÎ
()->
TEST_NewIÁ”ÇlI‹¿tÜ
();

365 
IÁ”ÇlKey
 
rg‘
(
u£r_key
, 
kMaxSequ’ûNumb”
, 
kTy³V®ue
);

366 
	g™”
->
S“k
(
rg‘
.
Encode
());

367 
	g¡d
::
¡ršg
 
»suÉ
;

368 ià(!
	g™”
->
¡©us
().
ok
()) {

369 
	g»suÉ
 = 
™”
->
¡©us
().
ToSŒšg
();

371 
	g»suÉ
 = "[ ";

372 
boŞ
 
	gfœ¡
 = 
Œue
;

373 
	g™”
->
V®id
()) {

374 
P¬£dIÁ”ÇlKey
 
	gikey
;

375 ià(!
P¬£IÁ”ÇlKey
(
™”
->
key
(), &
ikey
)) {

376 
	g»suÉ
 += "CORRUPTED";

378 ià(
	gÏ¡_İtiÚs_
.
	gcom·¿tÜ
->
Com·»
(
ikey
.
u£r_key
, user_key) != 0) {

381 ià(!
	gfœ¡
) {

382 
	g»suÉ
 += ", ";

384 
	gfœ¡
 = 
çl£
;

385 
	gikey
.
	gty³
) {

386 
	gkTy³V®ue
:

387 
»suÉ
 +ğ
™”
->
v®ue
().
ToSŒšg
();

389 
	gkTy³D–‘iÚ
:

390 
»suÉ
 += "DEL";

394 
	g™”
->
Next
();

396 ià(!
	gfœ¡
) {

397 
	g»suÉ
 += " ";

399 
	g»suÉ
 += "]";

401 
d–‘e
 
	g™”
;

402  
	g»suÉ
;

405 
NumTabËFesAtLev–
(
Ëv–
) {

406 
	g¡d
::
¡ršg
 
´İ”ty
;

407 
EXPECT_TRUE
(
db_
->
G‘Prİ”ty
(

408 "Ëv–db.num-fes-©-Ëv–" + 
Numb”ToSŒšg
(
Ëv–
), &
´İ”ty
));

409  
	g¡d
::
¡oi
(
´İ”ty
);

412 
TÙ®TabËFes
() {

413 
	g»suÉ
 = 0;

414 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

415 
	g»suÉ
 +ğ
NumTabËFesAtLev–
(
Ëv–
);

417  
	g»suÉ
;

421 
	g¡d
::
¡ršg
 
FesP”Lev–
() {

422 
¡d
::
¡ršg
 
»suÉ
;

423 
	gÏ¡_nÚ_z”o_off£t
 = 0;

424 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

425 
	gf
 = 
NumTabËFesAtLev–
(
Ëv–
);

426 
	gbuf
[100];

427 
¢´štf
(
buf
, (buf), "%s%d", (
Ëv–
 ? "," : ""), 
f
);

428 
	g»suÉ
 +ğ
buf
;

429 ià(
	gf
 > 0) {

430 
	gÏ¡_nÚ_z”o_off£t
 = 
»suÉ
.
size
();

433 
	g»suÉ
.
»size
(
Ï¡_nÚ_z”o_off£t
);

434  
	g»suÉ
;

437 
CouÁFes
() {

438 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
fes
;

439 
	g’v_
->
G‘Chd»n
(
dbÇme_
, &
fes
);

440  
	g¡©ic_ÿ¡
<>(
	gfes
.
size
());

443 
ušt64_t
 
Size
(cÚ¡ 
Sliû
& 
¡¬t
, cÚ¡ Sliû& 
lim™
) {

444 
Rªge
 
r
(
¡¬t
, 
lim™
);

445 
ušt64_t
 
	gsize
;

446 
	gdb_
->
G‘Aµroxim©eSizes
(&
r
, 1, &
size
);

447  
	gsize
;

450 
Com·ù
(cÚ¡ 
Sliû
& 
¡¬t
, cÚ¡ Sliû& 
lim™
) {

451 
	gdb_
->
Com·ùRªge
(&
¡¬t
, &
lim™
);

456 
MakeTabËs
(
n
, cÚ¡ 
¡d
::
¡ršg
& 
sm®l_key
,

457 cÚ¡ 
¡d
::
¡ršg
& 
Ïrge_key
) {

458 
i
 = 0; 
	gi
 < 
	gn
; i++) {

459 
Put
(
sm®l_key
, "begin");

460 
Put
(
Ïrge_key
, "end");

461 
dbfuÎ
()->
TEST_Com·ùMemTabË
();

467 
FlLev–s
(cÚ¡ 
¡d
::
¡ršg
& 
sm®Ë¡
, cÚ¡ std::¡ršg& 
Ïrge¡
) {

468 
MakeTabËs
(
cÚfig
::
kNumLev–s
, 
sm®Ë¡
, 
Ïrge¡
);

471 
DumpFeCouÁs
(cÚ¡ * 
Ïb–
) {

472 
årštf
(
¡d”r
, "---\n%s:\n", 
Ïb–
);

473 
årštf
(

474 
¡d”r
, "maxoverlap: %lld\n",

475 
¡©ic_ÿ¡
<>(
dbfuÎ
()->
TEST_MaxNextLev–Ov”ÏµšgBy‹s
()));

476 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

477 
	gnum
 = 
NumTabËFesAtLev–
(
Ëv–
);

478 ià(
	gnum
 > 0) {

479 
årštf
(
¡d”r
, "†ev– %3d : %d fes\n", 
Ëv–
, 
num
);

484 
	g¡d
::
¡ršg
 
DumpSSTabËLi¡
() {

485 
¡d
::
¡ršg
 
´İ”ty
;

486 
	gdb_
->
G‘Prİ”ty
("Ëv–db.s¡abËs", &
´İ”ty
);

487  
	g´İ”ty
;

490 
	g¡d
::
¡ršg
 
I‹rStus
(
I‹¿tÜ
* 
™”
) {

491 
¡d
::
¡ršg
 
»suÉ
;

492 ià(
	g™”
->
V®id
()) {

493 
	g»suÉ
 = 
™”
->
key
().
ToSŒšg
(è+ "->" + i‹r->
v®ue
().ToString();

495 
	g»suÉ
 = "(invalid)";

497  
	g»suÉ
;

500 
boŞ
 
D–‘eAnSSTFe
() {

501 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

502 
EXPECT_LEVELDB_OK
(
’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
));

503 
ušt64_t
 
	gnumb”
;

504 
FeTy³
 
	gty³
;

505 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

506 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
è&& 
	gty³
 =ğ
kTabËFe
) {

507 
EXPECT_LEVELDB_OK
(
’v_
->
RemoveFe
(
TabËFeName
(
dbÇme_
, 
numb”
)));

508  
	gŒue
;

511  
	gçl£
;

515 
R’ameLDBToSST
() {

516 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

517 
EXPECT_LEVELDB_OK
(
’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
));

518 
ušt64_t
 
	gnumb”
;

519 
FeTy³
 
	gty³
;

520 
	gfes_»Çmed
 = 0;

521 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

522 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
è&& 
	gty³
 =ğ
kTabËFe
) {

523 cÚ¡ 
¡d
::
¡ršg
 
äom
 = 
TabËFeName
(
dbÇme_
, 
numb”
);

524 cÚ¡ 
	g¡d
::
¡ršg
 
to
 = 
SSTTabËFeName
(
dbÇme_
, 
numb”
);

525 
EXPECT_LEVELDB_OK
(
’v_
->
R’ameFe
(
äom
, 
to
));

526 
	gfes_»Çmed
++;

529  
	gfes_»Çmed
;

532 
	g´iv©e
:

534 
	eO±iÚCÚfig
 { 
kDeçuÉ
, 
	gkReu£
, 
	gkF‹r
, 
	gkUncom´es£d
, 
	gkEnd
 };

536 cÚ¡ 
F‹rPŞicy
* 
	gf‹r_pŞicy_
;

537 
	gİtiÚ_cÚfig_
;

540 
	$TEST_F
(
DBTe¡
, 
Em±y
) {

542 
	`ASSERT_TRUE
(
db_
 !ğ
nuÎ±r
);

543 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("foo"));

544 } 
	`ChªgeO±iÚs
());

545 
	}
}

547 
	$TEST_F
(
DBTe¡
, 
Em±yKey
) {

549 
	`ASSERT_LEVELDB_OK
(
	`Put
("", "v1"));

550 
	`ASSERT_EQ
("v1", 
	`G‘
(""));

551 
	`ASSERT_LEVELDB_OK
(
	`Put
("", "v2"));

552 
	`ASSERT_EQ
("v2", 
	`G‘
(""));

553 } 
	`ChªgeO±iÚs
());

554 
	}
}

556 
	$TEST_F
(
DBTe¡
, 
Em±yV®ue
) {

558 
	`ASSERT_LEVELDB_OK
(
	`Put
("key", "v1"));

559 
	`ASSERT_EQ
("v1", 
	`G‘
("key"));

560 
	`ASSERT_LEVELDB_OK
(
	`Put
("key", ""));

561 
	`ASSERT_EQ
("", 
	`G‘
("key"));

562 
	`ASSERT_LEVELDB_OK
(
	`Put
("key", "v2"));

563 
	`ASSERT_EQ
("v2", 
	`G‘
("key"));

564 } 
	`ChªgeO±iÚs
());

565 
	}
}

567 
	$TEST_F
(
DBTe¡
, 
R—dWr™e
) {

569 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

570 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

571 
	`ASSERT_LEVELDB_OK
(
	`Put
("bar", "v2"));

572 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v3"));

573 
	`ASSERT_EQ
("v3", 
	`G‘
("foo"));

574 
	`ASSERT_EQ
("v2", 
	`G‘
("bar"));

575 } 
	`ChªgeO±iÚs
());

576 
	}
}

578 
	$TEST_F
(
DBTe¡
, 
PutD–‘eG‘
) {

580 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v1"));

581 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

582 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v2"));

583 
	`ASSERT_EQ
("v2", 
	`G‘
("foo"));

584 
	`ASSERT_LEVELDB_OK
(
db_
->
	`D–‘e
(
	`Wr™eO±iÚs
(), "foo"));

585 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("foo"));

586 } 
	`ChªgeO±iÚs
());

587 
	}
}

589 
	$TEST_F
(
DBTe¡
, 
G‘FromImmubËLay”
) {

591 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

592 
İtiÚs
.
’v
 = 
’v_
;

593 
İtiÚs
.
wr™e_bufãr_size
 = 100000;

594 
	`Reİ’
(&
İtiÚs
);

596 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

597 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

600 
’v_
->
d–ay_d©a_sync_
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

601 
	`Put
("k1", 
¡d
::
	`¡ršg
(100000, 'x'));

602 
	`Put
("k2", 
¡d
::
	`¡ršg
(100000, 'y'));

603 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

605 
’v_
->
d–ay_d©a_sync_
.
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

606 } 
	`ChªgeO±iÚs
());

607 
	}
}

609 
	$TEST_F
(
DBTe¡
, 
G‘FromV”siÚs
) {

611 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

612 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

613 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

614 } 
	`ChªgeO±iÚs
());

615 
	}
}

617 
	$TEST_F
(
DBTe¡
, 
G‘MemU§ge
) {

619 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

620 
¡d
::
¡ršg
 
v®
;

621 
	`ASSERT_TRUE
(
db_
->
	`G‘Prİ”ty
("Ëv–db.­´oxim©e-memÜy-u§ge", &
v®
));

622 
mem_u§ge
 = 
¡d
::
	`¡oi
(
v®
);

623 
	`ASSERT_GT
(
mem_u§ge
, 0);

624 
	`ASSERT_LT
(
mem_u§ge
, 5 * 1024 * 1024);

625 } 
	`ChªgeO±iÚs
());

626 
	}
}

628 
	$TEST_F
(
DBTe¡
, 
G‘SÇpshÙ
) {

631 
i
 = 0; i < 2; i++) {

632 
¡d
::
¡ršg
 
key
 = (
i
 =ğ0è? std::
	`¡ršg
("foo") : std::string(200, 'x');

633 
	`ASSERT_LEVELDB_OK
(
	`Put
(
key
, "v1"));

634 cÚ¡ 
SÇpshÙ
* 
s1
 = 
db_
->
	`G‘SÇpshÙ
();

635 
	`ASSERT_LEVELDB_OK
(
	`Put
(
key
, "v2"));

636 
	`ASSERT_EQ
("v2", 
	`G‘
(
key
));

637 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s1
));

638 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

639 
	`ASSERT_EQ
("v2", 
	`G‘
(
key
));

640 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s1
));

641 
db_
->
	`R–—£SÇpshÙ
(
s1
);

643 } 
	`ChªgeO±iÚs
());

644 
	}
}

646 
	$TEST_F
(
DBTe¡
, 
G‘Id’tiÿlSÇpshÙs
) {

649 
i
 = 0; i < 2; i++) {

650 
¡d
::
¡ršg
 
key
 = (
i
 =ğ0è? std::
	`¡ršg
("foo") : std::string(200, 'x');

651 
	`ASSERT_LEVELDB_OK
(
	`Put
(
key
, "v1"));

652 cÚ¡ 
SÇpshÙ
* 
s1
 = 
db_
->
	`G‘SÇpshÙ
();

653 cÚ¡ 
SÇpshÙ
* 
s2
 = 
db_
->
	`G‘SÇpshÙ
();

654 cÚ¡ 
SÇpshÙ
* 
s3
 = 
db_
->
	`G‘SÇpshÙ
();

655 
	`ASSERT_LEVELDB_OK
(
	`Put
(
key
, "v2"));

656 
	`ASSERT_EQ
("v2", 
	`G‘
(
key
));

657 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s1
));

658 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s2
));

659 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s3
));

660 
db_
->
	`R–—£SÇpshÙ
(
s1
);

661 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

662 
	`ASSERT_EQ
("v2", 
	`G‘
(
key
));

663 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s2
));

664 
db_
->
	`R–—£SÇpshÙ
(
s2
);

665 
	`ASSERT_EQ
("v1", 
	`G‘
(
key
, 
s3
));

666 
db_
->
	`R–—£SÇpshÙ
(
s3
);

668 } 
	`ChªgeO±iÚs
());

669 
	}
}

671 
	$TEST_F
(
DBTe¡
, 
I‹¿‹Ov”Em±ySÇpshÙ
) {

673 cÚ¡ 
SÇpshÙ
* 
¢­shÙ
 = 
db_
->
	`G‘SÇpshÙ
();

674 
R—dO±iÚs
 
»ad_İtiÚs
;

675 
»ad_İtiÚs
.
¢­shÙ
 = snapshot;

676 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

677 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v2"));

679 
I‹¿tÜ
* 
™”©Ü1
 = 
db_
->
	`NewI‹¿tÜ
(
»ad_İtiÚs
);

680 
™”©Ü1
->
	`S“kToFœ¡
();

681 
	`ASSERT_TRUE
(!
™”©Ü1
->
	`V®id
());

682 
d–‘e
 
™”©Ü1
;

684 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

686 
I‹¿tÜ
* 
™”©Ü2
 = 
db_
->
	`NewI‹¿tÜ
(
»ad_İtiÚs
);

687 
™”©Ü2
->
	`S“kToFœ¡
();

688 
	`ASSERT_TRUE
(!
™”©Ü2
->
	`V®id
());

689 
d–‘e
 
™”©Ü2
;

691 
db_
->
	`R–—£SÇpshÙ
(
¢­shÙ
);

692 } 
	`ChªgeO±iÚs
());

693 
	}
}

695 
	$TEST_F
(
DBTe¡
, 
G‘Lev–0Ord”šg
) {

701 
	`ASSERT_LEVELDB_OK
(
	`Put
("bar", "b"));

702 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

703 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

704 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v2"));

705 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

706 
	`ASSERT_EQ
("v2", 
	`G‘
("foo"));

707 } 
	`ChªgeO±iÚs
());

708 
	}
}

710 
	$TEST_F
(
DBTe¡
, 
G‘Ord”edByLev–s
) {

712 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

713 
	`Com·ù
("a", "z");

714 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

715 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v2"));

716 
	`ASSERT_EQ
("v2", 
	`G‘
("foo"));

717 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

718 
	`ASSERT_EQ
("v2", 
	`G‘
("foo"));

719 } 
	`ChªgeO±iÚs
());

720 
	}
}

722 
	$TEST_F
(
DBTe¡
, 
G‘PicksCÜ»ùFe
) {

725 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "va"));

726 
	`Com·ù
("a", "b");

727 
	`ASSERT_LEVELDB_OK
(
	`Put
("x", "vx"));

728 
	`Com·ù
("x", "y");

729 
	`ASSERT_LEVELDB_OK
(
	`Put
("f", "vf"));

730 
	`Com·ù
("f", "g");

731 
	`ASSERT_EQ
("va", 
	`G‘
("a"));

732 
	`ASSERT_EQ
("vf", 
	`G‘
("f"));

733 
	`ASSERT_EQ
("vx", 
	`G‘
("x"));

734 } 
	`ChªgeO±iÚs
());

735 
	}
}

737 
	$TEST_F
(
DBTe¡
, 
G‘EncouÁ”sEm±yLev–
) {

748 
com·ùiÚ_couÁ
 = 0;

749 
	`NumTabËFesAtLev–
(0) == 0 || NumTableFilesAtLevel(2) == 0) {

750 
	`ASSERT_LE
(
com·ùiÚ_couÁ
, 100) << "could‚ot fill†evels 0‡nd 2";

751 
com·ùiÚ_couÁ
++;

752 
	`Put
("a", "begin");

753 
	`Put
("z", "end");

754 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

758 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, 
nuÎ±r
,‚ullptr);

759 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 1);

760 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(1), 0);

761 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(2), 1);

764 
i
 = 0; i < 1000; i++) {

765 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("missing"));

769 
	`D–ayMli£cÚds
(1000);

771 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

772 } 
	`ChªgeO±iÚs
());

773 
	}
}

775 
	$TEST_F
(
DBTe¡
, 
I‹rEm±y
) {

776 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

778 
™”
->
	`S“kToFœ¡
();

779 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

781 
™”
->
	`S“kToLa¡
();

782 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

784 
™”
->
	`S“k
("foo");

785 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

787 
d–‘e
 
™”
;

788 
	}
}

790 
	$TEST_F
(
DBTe¡
, 
I‹rSšgË
) {

791 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "va"));

792 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

794 
™”
->
	`S“kToFœ¡
();

795 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

796 
™”
->
	`Next
();

797 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

798 
™”
->
	`S“kToFœ¡
();

799 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

800 
™”
->
	`P»v
();

801 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

803 
™”
->
	`S“kToLa¡
();

804 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

805 
™”
->
	`Next
();

806 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

807 
™”
->
	`S“kToLa¡
();

808 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

809 
™”
->
	`P»v
();

810 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

812 
™”
->
	`S“k
("");

813 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

814 
™”
->
	`Next
();

815 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

817 
™”
->
	`S“k
("a");

818 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

819 
™”
->
	`Next
();

820 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

822 
™”
->
	`S“k
("b");

823 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

825 
d–‘e
 
™”
;

826 
	}
}

828 
	$TEST_F
(
DBTe¡
, 
I‹rMuÉi
) {

829 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "va"));

830 
	`ASSERT_LEVELDB_OK
(
	`Put
("b", "vb"));

831 
	`ASSERT_LEVELDB_OK
(
	`Put
("c", "vc"));

832 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

834 
™”
->
	`S“kToFœ¡
();

835 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

836 
™”
->
	`Next
();

837 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

838 
™”
->
	`Next
();

839 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

840 
™”
->
	`Next
();

841 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

842 
™”
->
	`S“kToFœ¡
();

843 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

844 
™”
->
	`P»v
();

845 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

847 
™”
->
	`S“kToLa¡
();

848 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

849 
™”
->
	`P»v
();

850 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

851 
™”
->
	`P»v
();

852 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

853 
™”
->
	`P»v
();

854 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

855 
™”
->
	`S“kToLa¡
();

856 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

857 
™”
->
	`Next
();

858 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

860 
™”
->
	`S“k
("");

861 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

862 
™”
->
	`S“k
("a");

863 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

864 
™”
->
	`S“k
("ax");

865 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

866 
™”
->
	`S“k
("b");

867 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

868 
™”
->
	`S“k
("z");

869 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

872 
™”
->
	`S“kToLa¡
();

873 
™”
->
	`P»v
();

874 
™”
->
	`P»v
();

875 
™”
->
	`Next
();

876 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

879 
™”
->
	`S“kToFœ¡
();

880 
™”
->
	`Next
();

881 
™”
->
	`Next
();

882 
™”
->
	`P»v
();

883 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

886 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "va2"));

887 
	`ASSERT_LEVELDB_OK
(
	`Put
("a2", "va3"));

888 
	`ASSERT_LEVELDB_OK
(
	`Put
("b", "vb2"));

889 
	`ASSERT_LEVELDB_OK
(
	`Put
("c", "vc2"));

890 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("b"));

891 
™”
->
	`S“kToFœ¡
();

892 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

893 
™”
->
	`Next
();

894 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

895 
™”
->
	`Next
();

896 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

897 
™”
->
	`Next
();

898 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

899 
™”
->
	`S“kToLa¡
();

900 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

901 
™”
->
	`P»v
();

902 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

903 
™”
->
	`P»v
();

904 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

905 
™”
->
	`P»v
();

906 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

908 
d–‘e
 
™”
;

909 
	}
}

911 
	$TEST_F
(
DBTe¡
, 
I‹rSm®lAndL¬geMix
) {

912 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "va"));

913 
	`ASSERT_LEVELDB_OK
(
	`Put
("b", 
¡d
::
	`¡ršg
(100000, 'b')));

914 
	`ASSERT_LEVELDB_OK
(
	`Put
("c", "vc"));

915 
	`ASSERT_LEVELDB_OK
(
	`Put
("d", 
¡d
::
	`¡ršg
(100000, 'd')));

916 
	`ASSERT_LEVELDB_OK
(
	`Put
("e", 
¡d
::
	`¡ršg
(100000, 'e')));

918 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

920 
™”
->
	`S“kToFœ¡
();

921 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

922 
™”
->
	`Next
();

923 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->" + 
¡d
::
	`¡ršg
(100000, 'b'));

924 
™”
->
	`Next
();

925 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

926 
™”
->
	`Next
();

927 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "d->" + 
¡d
::
	`¡ršg
(100000, 'd'));

928 
™”
->
	`Next
();

929 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "e->" + 
¡d
::
	`¡ršg
(100000, 'e'));

930 
™”
->
	`Next
();

931 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

933 
™”
->
	`S“kToLa¡
();

934 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "e->" + 
¡d
::
	`¡ršg
(100000, 'e'));

935 
™”
->
	`P»v
();

936 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "d->" + 
¡d
::
	`¡ršg
(100000, 'd'));

937 
™”
->
	`P»v
();

938 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

939 
™”
->
	`P»v
();

940 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->" + 
¡d
::
	`¡ršg
(100000, 'b'));

941 
™”
->
	`P»v
();

942 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

943 
™”
->
	`P»v
();

944 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

946 
d–‘e
 
™”
;

947 
	}
}

949 
	$TEST_F
(
DBTe¡
, 
I‹rMuÉiW™hD–‘e
) {

951 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "va"));

952 
	`ASSERT_LEVELDB_OK
(
	`Put
("b", "vb"));

953 
	`ASSERT_LEVELDB_OK
(
	`Put
("c", "vc"));

954 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("b"));

955 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("b"));

957 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

958 
™”
->
	`S“k
("c");

959 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

960 
™”
->
	`P»v
();

961 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

962 
d–‘e
 
™”
;

963 } 
	`ChªgeO±iÚs
());

964 
	}
}

966 
	$TEST_F
(
DBTe¡
, 
Recov”
) {

968 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

969 
	`ASSERT_LEVELDB_OK
(
	`Put
("baz", "v5"));

971 
	`Reİ’
();

972 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

974 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

975 
	`ASSERT_EQ
("v5", 
	`G‘
("baz"));

976 
	`ASSERT_LEVELDB_OK
(
	`Put
("bar", "v2"));

977 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v3"));

979 
	`Reİ’
();

980 
	`ASSERT_EQ
("v3", 
	`G‘
("foo"));

981 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v4"));

982 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

983 
	`ASSERT_EQ
("v2", 
	`G‘
("bar"));

984 
	`ASSERT_EQ
("v5", 
	`G‘
("baz"));

985 } 
	`ChªgeO±iÚs
());

986 
	}
}

988 
	$TEST_F
(
DBTe¡
, 
Recov”yW™hEm±yLog
) {

990 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

991 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v2"));

992 
	`Reİ’
();

993 
	`Reİ’
();

994 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v3"));

995 
	`Reİ’
();

996 
	`ASSERT_EQ
("v3", 
	`G‘
("foo"));

997 } 
	`ChªgeO±iÚs
());

998 
	}
}

1002 
	$TEST_F
(
DBTe¡
, 
Recov”DuršgMembËCom·ùiÚ
) {

1004 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1005 
İtiÚs
.
’v
 = 
’v_
;

1006 
İtiÚs
.
wr™e_bufãr_size
 = 1000000;

1007 
	`Reİ’
(&
İtiÚs
);

1010 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

1011 
	`ASSERT_LEVELDB_OK
(

1012 
	`Put
("big1", 
¡d
::
	`¡ršg
(10000000, 'x')));

1013 
	`ASSERT_LEVELDB_OK
(

1014 
	`Put
("big2", 
¡d
::
	`¡ršg
(1000, 'y')));

1015 
	`ASSERT_LEVELDB_OK
(
	`Put
("bar", "v2"));

1017 
	`Reİ’
(&
İtiÚs
);

1018 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

1019 
	`ASSERT_EQ
("v2", 
	`G‘
("bar"));

1020 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(10000000, 'x'), 
	`G‘
("big1"));

1021 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(1000, 'y'), 
	`G‘
("big2"));

1022 } 
	`ChªgeO±iÚs
());

1023 
	}
}

1025 
	g¡d
::
¡ršg
 
	$Key
(
i
) {

1026 
buf
[100];

1027 
	`¢´štf
(
buf
, (buf), "key%06d", 
i
);

1028  
¡d
::
	`¡ršg
(
buf
);

1029 
	}
}

1031 
	$TEST_F
(
DBTe¡
, 
MšÜCom·ùiÚsH­³n
) {

1032 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1033 
İtiÚs
.
wr™e_bufãr_size
 = 10000;

1034 
	`Reİ’
(&
İtiÚs
);

1036 cÚ¡ 
N
 = 500;

1038 
¡¬tšg_num_bËs
 = 
	`TÙ®TabËFes
();

1039 
i
 = 0; i < 
N
; i++) {

1040 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(
i
), Key(iè+ 
¡d
::
	`¡ršg
(1000, 'v')));

1042 
’dšg_num_bËs
 = 
	`TÙ®TabËFes
();

1043 
	`ASSERT_GT
(
’dšg_num_bËs
, 
¡¬tšg_num_bËs
);

1045 
i
 = 0; i < 
N
; i++) {

1046 
	`ASSERT_EQ
(
	`Key
(
i
è+ 
¡d
::
	`¡ršg
(1000, 'v'), 
	`G‘
(Key(i)));

1049 
	`Reİ’
();

1051 
i
 = 0; i < 
N
; i++) {

1052 
	`ASSERT_EQ
(
	`Key
(
i
è+ 
¡d
::
	`¡ršg
(1000, 'v'), 
	`G‘
(Key(i)));

1054 
	}
}

1056 
	$TEST_F
(
DBTe¡
, 
Recov”W™hL¬geLog
) {

1058 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1059 
	`Reİ’
(&
İtiÚs
);

1060 
	`ASSERT_LEVELDB_OK
(
	`Put
("big1", 
¡d
::
	`¡ršg
(200000, '1')));

1061 
	`ASSERT_LEVELDB_OK
(
	`Put
("big2", 
¡d
::
	`¡ršg
(200000, '2')));

1062 
	`ASSERT_LEVELDB_OK
(
	`Put
("sm®l3", 
¡d
::
	`¡ršg
(10, '3')));

1063 
	`ASSERT_LEVELDB_OK
(
	`Put
("sm®l4", 
¡d
::
	`¡ršg
(10, '4')));

1064 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

1069 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1070 
İtiÚs
.
wr™e_bufãr_size
 = 100000;

1071 
	`Reİ’
(&
İtiÚs
);

1072 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 3);

1073 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(200000, '1'), 
	`G‘
("big1"));

1074 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(200000, '2'), 
	`G‘
("big2"));

1075 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(10, '3'), 
	`G‘
("small3"));

1076 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(10, '4'), 
	`G‘
("small4"));

1077 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(0), 1);

1078 
	}
}

1080 
	$TEST_F
(
DBTe¡
, 
Com·ùiÚsG’”©eMuÉËFes
) {

1081 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1082 
İtiÚs
.
wr™e_bufãr_size
 = 100000000;

1083 
	`Reİ’
(&
İtiÚs
);

1085 
Rªdom
 
	`ºd
(301);

1088 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

1089 
¡d
::
veùÜ
<¡d::
¡ršg
> 
v®ues
;

1090 
i
 = 0; i < 80; i++) {

1091 
v®ues
.
	`push_back
(
	`RªdomSŒšg
(&
ºd
, 100000));

1092 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(
i
), 
v®ues
[i]));

1096 
	`Reİ’
(&
İtiÚs
);

1097 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

1099 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

1100 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(1), 1);

1101 
i
 = 0; i < 80; i++) {

1102 
	`ASSERT_EQ
(
	`G‘
(
	`Key
(
i
)), 
v®ues
[i]);

1104 
	}
}

1106 
	$TEST_F
(
DBTe¡
, 
R•—‹dWr™esToSameKey
) {

1107 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1108 
İtiÚs
.
’v
 = 
’v_
;

1109 
İtiÚs
.
wr™e_bufãr_size
 = 100000;

1110 
	`Reİ’
(&
İtiÚs
);

1114 cÚ¡ 
kMaxFes
 = 
cÚfig
::
kNumLev–s
 + cÚfig::
kL0_StİWr™esTrigg”
;

1116 
Rªdom
 
	`ºd
(301);

1117 
¡d
::
¡ršg
 
v®ue
 = 
	`RªdomSŒšg
(&
ºd
, 2 * 
İtiÚs
.
wr™e_bufãr_size
);

1118 
i
 = 0; i < 5 * 
kMaxFes
; i++) {

1119 
	`Put
("key", 
v®ue
);

1120 
	`ASSERT_LE
(
	`TÙ®TabËFes
(), 
kMaxFes
);

1121 
	`årštf
(
¡d”r
, "aá” %d: %d fes\n", 
i
 + 1, 
	`TÙ®TabËFes
());

1123 
	}
}

1125 
	$TEST_F
(
DBTe¡
, 
S·r£M”ge
) {

1126 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1127 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

1128 
	`Reİ’
(&
İtiÚs
);

1130 
	`FlLev–s
("A", "Z");

1138 cÚ¡ 
¡d
::
¡ršg
 
	`v®ue
(1000, 'x');

1139 
	`Put
("A", "va");

1141 
i
 = 0; i < 100000; i++) {

1142 
key
[100];

1143 
	`¢´štf
(
key
, (key), "B%010d", 
i
);

1144 
	`Put
(
key
, 
v®ue
);

1146 
	`Put
("C", "vc");

1147 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1148 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

1151 
	`Put
("A", "va2");

1152 
	`Put
("B100", "bvalue2");

1153 
	`Put
("C", "vc2");

1154 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1158 
	`ASSERT_LE
(
	`dbfuÎ
()->
	`TEST_MaxNextLev–Ov”ÏµšgBy‹s
(), 20 * 1048576);

1159 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

1160 
	`ASSERT_LE
(
	`dbfuÎ
()->
	`TEST_MaxNextLev–Ov”ÏµšgBy‹s
(), 20 * 1048576);

1161 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, 
nuÎ±r
,‚ullptr);

1162 
	`ASSERT_LE
(
	`dbfuÎ
()->
	`TEST_MaxNextLev–Ov”ÏµšgBy‹s
(), 20 * 1048576);

1163 
	}
}

1165 
boŞ
 
	$B‘w“n
(
ušt64_t
 
v®
, ušt64_ˆ
low
, ušt64_ˆ
high
) {

1166 
boŞ
 
»suÉ
 = (
v®
 >ğ
low
è&& (v® <ğ
high
);

1167 ià(!
»suÉ
) {

1168 
	`årštf
(
¡d”r
, "Value %llu is‚ot in„ange [%llu, %llu]\n",

1169 ()(
v®
), ()(
low
),

1170 ()(
high
));

1172  
»suÉ
;

1173 
	}
}

1175 
	$TEST_F
(
DBTe¡
, 
Aµroxim©eSizes
) {

1177 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1178 
İtiÚs
.
wr™e_bufãr_size
 = 100000000;

1179 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

1180 
	`De¡royAndReİ’
();

1182 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "xyz"), 0, 0));

1183 
	`Reİ’
(&
İtiÚs
);

1184 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "xyz"), 0, 0));

1187 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

1188 cÚ¡ 
N
 = 80;

1189 cÚ¡ 
S1
 = 100000;

1190 cÚ¡ 
S2
 = 105000;

1191 
Rªdom
 
	`ºd
(301);

1192 
i
 = 0; i < 
N
; i++) {

1193 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(
i
), 
	`RªdomSŒšg
(&
ºd
, 
S1
)));

1197 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50)), 0, 0));

1199 ià(
İtiÚs
.
»u£_logs
) {

1202 
	`Reİ’
(&
İtiÚs
);

1203 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50)), 0, 0));

1208 
run
 = 0;„un < 3;„un++) {

1209 
	`Reİ’
(&
İtiÚs
);

1211 
com·ù_¡¬t
 = 0; com·ù_¡¬ˆ< 
N
; compact_start += 10) {

1212 
i
 = 0; i < 
N
; i += 10) {

1213 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(
i
)), 
S1
 * i, 
S2
 * i));

1214 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(
i
è+ ".suffix"), 
S1
 * (i + 1),

1215 
S2
 * (
i
 + 1)));

1216 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
(
	`Key
(
i
), Key(˜+ 10)), 
S1
 * 10, 
S2
 * 10));

1218 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50)), 
S1
 * 50, 
S2
 * 50));

1219 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50è+ ".suffix"), 
S1
 * 50, 
S2
 * 50));

1221 
¡d
::
¡ršg
 
c¡¬t_¡r
 = 
	`Key
(
com·ù_¡¬t
);

1222 
¡d
::
¡ršg
 
ûnd_¡r
 = 
	`Key
(
com·ù_¡¬t
 + 9);

1223 
Sliû
 
c¡¬t
 = 
c¡¬t_¡r
;

1224 
Sliû
 
ûnd
 = 
ûnd_¡r
;

1225 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, &
c¡¬t
, &
ûnd
);

1228 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

1229 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(1), 0);

1231 } 
	`ChªgeO±iÚs
());

1232 
	}
}

1234 
	$TEST_F
(
DBTe¡
, 
Aµroxim©eSizes_MixOfSm®lAndL¬ge
) {

1236 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1237 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

1238 
	`Reİ’
();

1240 
Rªdom
 
	`ºd
(301);

1241 
¡d
::
¡ršg
 
big1
 = 
	`RªdomSŒšg
(&
ºd
, 100000);

1242 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(0), 
	`RªdomSŒšg
(&
ºd
, 10000)));

1243 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(1), 
	`RªdomSŒšg
(&
ºd
, 10000)));

1244 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(2), 
big1
));

1245 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(3), 
	`RªdomSŒšg
(&
ºd
, 10000)));

1246 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(4), 
big1
));

1247 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(5), 
	`RªdomSŒšg
(&
ºd
, 10000)));

1248 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(6), 
	`RªdomSŒšg
(&
ºd
, 300000)));

1249 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(7), 
	`RªdomSŒšg
(&
ºd
, 10000)));

1251 ià(
İtiÚs
.
»u£_logs
) {

1253 
	`ASSERT_LEVELDB_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

1257 
run
 = 0;„un < 3;„un++) {

1258 
	`Reİ’
(&
İtiÚs
);

1260 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(0)), 0, 0));

1261 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(1)), 10000, 11000));

1262 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(2)), 20000, 21000));

1263 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(3)), 120000, 121000));

1264 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(4)), 130000, 131000));

1265 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(5)), 230000, 231000));

1266 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(6)), 240000, 241000));

1267 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(7)), 540000, 541000));

1268 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(8)), 550000, 560000));

1270 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
(
	`Key
(3), Key(5)), 110000, 111000));

1272 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
,‚ullptr);

1274 } 
	`ChªgeO±iÚs
());

1275 
	}
}

1277 
	$TEST_F
(
DBTe¡
, 
I‹¿tÜPšsRef
) {

1278 
	`Put
("foo", "hello");

1281 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

1284 
	`Put
("foo", "newvalue1");

1285 
i
 = 0; i < 100; i++) {

1286 
	`ASSERT_LEVELDB_OK
(

1287 
	`Put
(
	`Key
(
i
), Key(iè+ 
¡d
::
	`¡ršg
(100000, 'v')));

1289 
	`Put
("foo", "newvalue2");

1291 
™”
->
	`S“kToFœ¡
();

1292 
	`ASSERT_TRUE
(
™”
->
	`V®id
());

1293 
	`ASSERT_EQ
("foo", 
™”
->
	`key
().
	`ToSŒšg
());

1294 
	`ASSERT_EQ
("h–lo", 
™”
->
	`v®ue
().
	`ToSŒšg
());

1295 
™”
->
	`Next
();

1296 
	`ASSERT_TRUE
(!
™”
->
	`V®id
());

1297 
d–‘e
 
™”
;

1298 
	}
}

1300 
	$TEST_F
(
DBTe¡
, 
SÇpshÙ
) {

1302 
	`Put
("foo", "v1");

1303 cÚ¡ 
SÇpshÙ
* 
s1
 = 
db_
->
	`G‘SÇpshÙ
();

1304 
	`Put
("foo", "v2");

1305 cÚ¡ 
SÇpshÙ
* 
s2
 = 
db_
->
	`G‘SÇpshÙ
();

1306 
	`Put
("foo", "v3");

1307 cÚ¡ 
SÇpshÙ
* 
s3
 = 
db_
->
	`G‘SÇpshÙ
();

1309 
	`Put
("foo", "v4");

1310 
	`ASSERT_EQ
("v1", 
	`G‘
("foo", 
s1
));

1311 
	`ASSERT_EQ
("v2", 
	`G‘
("foo", 
s2
));

1312 
	`ASSERT_EQ
("v3", 
	`G‘
("foo", 
s3
));

1313 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

1315 
db_
->
	`R–—£SÇpshÙ
(
s3
);

1316 
	`ASSERT_EQ
("v1", 
	`G‘
("foo", 
s1
));

1317 
	`ASSERT_EQ
("v2", 
	`G‘
("foo", 
s2
));

1318 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

1320 
db_
->
	`R–—£SÇpshÙ
(
s1
);

1321 
	`ASSERT_EQ
("v2", 
	`G‘
("foo", 
s2
));

1322 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

1324 
db_
->
	`R–—£SÇpshÙ
(
s2
);

1325 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

1326 } 
	`ChªgeO±iÚs
());

1327 
	}
}

1329 
	$TEST_F
(
DBTe¡
, 
Hidd’V®uesA»Removed
) {

1331 
Rªdom
 
	`ºd
(301);

1332 
	`FlLev–s
("a", "z");

1334 
¡d
::
¡ršg
 
big
 = 
	`RªdomSŒšg
(&
ºd
, 50000);

1335 
	`Put
("foo", 
big
);

1336 
	`Put
("pastfoo", "v");

1337 cÚ¡ 
SÇpshÙ
* 
¢­shÙ
 = 
db_
->
	`G‘SÇpshÙ
();

1338 
	`Put
("foo", "tiny");

1339 
	`Put
("pastfoo2", "v2");

1341 
	`ASSERT_LEVELDB_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

1342 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(0), 0);

1344 
	`ASSERT_EQ
(
big
, 
	`G‘
("foo", 
¢­shÙ
));

1345 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "pastfoo"), 50000, 60000));

1346 
db_
->
	`R–—£SÇpshÙ
(
¢­shÙ
);

1347 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[šy, " + 
big
 + " ]");

1348 
Sliû
 
	`x
("x");

1349 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, 
nuÎ±r
, &
x
);

1350 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[iny ]");

1351 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

1352 
	`ASSERT_GE
(
	`NumTabËFesAtLev–
(1), 1);

1353 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, 
nuÎ±r
, &
x
);

1354 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[iny ]");

1356 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "pastfoo"), 0, 1000));

1357 } 
	`ChªgeO±iÚs
());

1358 
	}
}

1360 
	$TEST_F
(
DBTe¡
, 
D–‘iÚM¬k”s1
) {

1361 
	`Put
("foo", "v1");

1362 
	`ASSERT_LEVELDB_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

1363 cÚ¡ 
Ï¡
 = 
cÚfig
::
kMaxMemCom·ùLev–
;

1364 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
), 1);

1367 
	`Put
("a", "begin");

1368 
	`Put
("z", "end");

1369 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1370 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
), 1);

1371 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
 - 1), 1);

1373 
	`D–‘e
("foo");

1374 
	`Put
("foo", "v2");

1375 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2, DEL, v1 ]");

1376 
	`ASSERT_LEVELDB_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

1377 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2, DEL, v1 ]");

1378 
Sliû
 
	`z
("z");

1379 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(
Ï¡
 - 2, 
nuÎ±r
, &
z
);

1382 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2, v1 ]");

1383 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(
Ï¡
 - 1, 
nuÎ±r
,‚ullptr);

1386 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2 ]");

1387 
	}
}

1389 
	$TEST_F
(
DBTe¡
, 
D–‘iÚM¬k”s2
) {

1390 
	`Put
("foo", "v1");

1391 
	`ASSERT_LEVELDB_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

1392 cÚ¡ 
Ï¡
 = 
cÚfig
::
kMaxMemCom·ùLev–
;

1393 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
), 1);

1396 
	`Put
("a", "begin");

1397 
	`Put
("z", "end");

1398 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1399 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
), 1);

1400 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
 - 1), 1);

1402 
	`D–‘e
("foo");

1403 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ DEL, v1 ]");

1404 
	`ASSERT_LEVELDB_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

1405 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ DEL, v1 ]");

1406 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(
Ï¡
 - 2, 
nuÎ±r
,‚ullptr);

1408 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ DEL, v1 ]");

1409 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(
Ï¡
 - 1, 
nuÎ±r
,‚ullptr);

1412 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ ]");

1413 
	}
}

1415 
	$TEST_F
(
DBTe¡
, 
Ov”ÏpInLev–0
) {

1417 
	`ASSERT_EQ
(
cÚfig
::
kMaxMemCom·ùLev–
, 2) << "Fixesto match config";

1421 
	`ASSERT_LEVELDB_OK
(
	`Put
("100", "v100"));

1422 
	`ASSERT_LEVELDB_OK
(
	`Put
("999", "v999"));

1423 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1424 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("100"));

1425 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("999"));

1426 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1427 
	`ASSERT_EQ
("0,1,1", 
	`FesP”Lev–
());

1433 
	`ASSERT_LEVELDB_OK
(
	`Put
("300", "v300"));

1434 
	`ASSERT_LEVELDB_OK
(
	`Put
("500", "v500"));

1435 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1436 
	`ASSERT_LEVELDB_OK
(
	`Put
("200", "v200"));

1437 
	`ASSERT_LEVELDB_OK
(
	`Put
("600", "v600"));

1438 
	`ASSERT_LEVELDB_OK
(
	`Put
("900", "v900"));

1439 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1440 
	`ASSERT_EQ
("2,1,1", 
	`FesP”Lev–
());

1443 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, 
nuÎ±r
,‚ullptr);

1444 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(2, 
nuÎ±r
,‚ullptr);

1445 
	`ASSERT_EQ
("2", 
	`FesP”Lev–
());

1450 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("600"));

1451 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1452 
	`ASSERT_EQ
("3", 
	`FesP”Lev–
());

1453 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("600"));

1454 } 
	`ChªgeO±iÚs
());

1455 
	}
}

1457 
	$TEST_F
(
DBTe¡
, 
L0_Com·ùiÚBug_Issue44_a
) {

1458 
	`Reİ’
();

1459 
	`ASSERT_LEVELDB_OK
(
	`Put
("b", "v"));

1460 
	`Reİ’
();

1461 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("b"));

1462 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("a"));

1463 
	`Reİ’
();

1464 
	`ASSERT_LEVELDB_OK
(
	`D–‘e
("a"));

1465 
	`Reİ’
();

1466 
	`ASSERT_LEVELDB_OK
(
	`Put
("a", "v"));

1467 
	`Reİ’
();

1468 
	`Reİ’
();

1469 
	`ASSERT_EQ
("×->v)", 
	`CÚ‹Ás
());

1470 
	`D–ayMli£cÚds
(1000);

1471 
	`ASSERT_EQ
("×->v)", 
	`CÚ‹Ás
());

1472 
	}
}

1474 
	$TEST_F
(
DBTe¡
, 
L0_Com·ùiÚBug_Issue44_b
) {

1475 
	`Reİ’
();

1476 
	`Put
("", "");

1477 
	`Reİ’
();

1478 
	`D–‘e
("e");

1479 
	`Put
("", "");

1480 
	`Reİ’
();

1481 
	`Put
("c", "cv");

1482 
	`Reİ’
();

1483 
	`Put
("", "");

1484 
	`Reİ’
();

1485 
	`Put
("", "");

1486 
	`D–ayMli£cÚds
(1000);

1487 
	`Reİ’
();

1488 
	`Put
("d", "dv");

1489 
	`Reİ’
();

1490 
	`Put
("", "");

1491 
	`Reİ’
();

1492 
	`D–‘e
("d");

1493 
	`D–‘e
("b");

1494 
	`Reİ’
();

1495 
	`ASSERT_EQ
("(->)(c->cv)", 
	`CÚ‹Ás
());

1496 
	`D–ayMli£cÚds
(1000);

1497 
	`ASSERT_EQ
("(->)(c->cv)", 
	`CÚ‹Ás
());

1498 
	}
}

1500 
	$TEST_F
(
DBTe¡
, 
Fæush_Issue474
) {

1501 cÚ¡ 
kNum
 = 100000;

1502 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
());

1503 
i
 = 0; i < 
kNum
; i++) {

1504 
	`fæush
(
nuÎ±r
);

1505 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`RªdomKey
(&
ºd
), 
	`RªdomSŒšg
(&rnd, 100)));

1507 
	}
}

1509 
	$TEST_F
(
DBTe¡
, 
Com·¿tÜCheck
) {

1510 şas 
	cNewCom·¿tÜ
 : 
public
 
Com·¿tÜ
 {

1511 
public
:

1512 cÚ¡ * 
	`Name
(ècÚ¡ 
ov”ride
 {  "leveldb.NewComparator"; }

1513 
	`Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
ècÚ¡ 
ov”ride
 {

1514  
	`By‹wi£Com·¿tÜ
()->
	`Com·»
(
a
, 
b
);

1516 
	`FšdShÜ‹¡S•¬©Ü
(
¡d
::
¡ršg
* 
s
, cÚ¡ 
Sliû
& 
l
ècÚ¡ 
ov”ride
 {

1517 
	`By‹wi£Com·¿tÜ
()->
	`FšdShÜ‹¡S•¬©Ü
(
s
, 
l
);

1519 
	`FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
ècÚ¡ 
ov”ride
 {

1520 
	`By‹wi£Com·¿tÜ
()->
	`FšdShÜtSucûssÜ
(
key
);

1523 
NewCom·¿tÜ
 
cmp
;

1524 
O±iÚs
 
Ãw_İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1525 
Ãw_İtiÚs
.
com·¿tÜ
 = &
cmp
;

1526 
Stus
 
s
 = 
	`TryReİ’
(&
Ãw_İtiÚs
);

1527 
	`ASSERT_TRUE
(!
s
.
	`ok
());

1528 
	`ASSERT_TRUE
(
s
.
	`ToSŒšg
().
	`fšd
("com·¿tÜ"è!ğ
¡d
::
¡ršg
::
Åos
)

1529 << 
s
.
	`ToSŒšg
();

1530 
	}
}

1532 
	$TEST_F
(
DBTe¡
, 
Cu¡omCom·¿tÜ
) {

1533 şas 
	cNumb”Com·¿tÜ
 : 
public
 
Com·¿tÜ
 {

1534 
public
:

1535 cÚ¡ * 
	`Name
(ècÚ¡ 
ov”ride
 {  "test.NumberComparator"; }

1536 
	`Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
ècÚ¡ 
ov”ride
 {

1537  
	`ToNumb”
(
a
è- ToNumb”(
b
);

1539 
	`FšdShÜ‹¡S•¬©Ü
(
¡d
::
¡ršg
* 
s
, cÚ¡ 
Sliû
& 
l
ècÚ¡ 
ov”ride
 {

1540 
	`ToNumb”
(*
s
);

1541 
	`ToNumb”
(
l
);

1543 
	`FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
ècÚ¡ 
ov”ride
 {

1544 
	`ToNumb”
(*
key
);

1547 
´iv©e
:

1548 
	`ToNumb”
(cÚ¡ 
Sliû
& 
x
) {

1550 
	`EXPECT_TRUE
(
x
.
	`size
() >= 2 && x[0] == '[' && x[x.size() - 1] == ']')

1551 << 
	`Esÿ³SŒšg
(
x
);

1552 
v®
;

1553 
ignÜed
;

1554 
	`EXPECT_TRUE
(
	`ssÿnf
(
x
.
	`ToSŒšg
().
	`c_¡r
(), "[%i]%c", &
v®
, &
ignÜed
) == 1)

1555 << 
	`Esÿ³SŒšg
(
x
);

1556  
v®
;

1559 
Numb”Com·¿tÜ
 
cmp
;

1560 
O±iÚs
 
Ãw_İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1561 
Ãw_İtiÚs
.
ü—‹_if_missšg
 = 
Œue
;

1562 
Ãw_İtiÚs
.
com·¿tÜ
 = &
cmp
;

1563 
Ãw_İtiÚs
.
f‹r_pŞicy
 = 
nuÎ±r
;

1564 
Ãw_İtiÚs
.
wr™e_bufãr_size
 = 1000;

1565 
	`De¡royAndReİ’
(&
Ãw_İtiÚs
);

1566 
	`ASSERT_LEVELDB_OK
(
	`Put
("[10]", "ten"));

1567 
	`ASSERT_LEVELDB_OK
(
	`Put
("[0x14]", "twenty"));

1568 
i
 = 0; i < 2; i++) {

1569 
	`ASSERT_EQ
("‹n", 
	`G‘
("[10]"));

1570 
	`ASSERT_EQ
("‹n", 
	`G‘
("[0xa]"));

1571 
	`ASSERT_EQ
("tw’ty", 
	`G‘
("[20]"));

1572 
	`ASSERT_EQ
("tw’ty", 
	`G‘
("[0x14]"));

1573 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("[15]"));

1574 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("[0xf]"));

1575 
	`Com·ù
("[0]", "[9999]");

1578 
run
 = 0;„un < 2;„un++) {

1579 
i
 = 0; i < 1000; i++) {

1580 
buf
[100];

1581 
	`¢´štf
(
buf
, (buf), "[%d]", 
i
 * 10);

1582 
	`ASSERT_LEVELDB_OK
(
	`Put
(
buf
, buf));

1584 
	`Com·ù
("[0]", "[1000000]");

1586 
	}
}

1588 
	$TEST_F
(
DBTe¡
, 
Mªu®Com·ùiÚ
) {

1589 
	`ASSERT_EQ
(
cÚfig
::
kMaxMemCom·ùLev–
, 2)

1592 
	`MakeTabËs
(3, "p", "q");

1593 
	`ASSERT_EQ
("1,1,1", 
	`FesP”Lev–
());

1596 
	`Com·ù
("", "c");

1597 
	`ASSERT_EQ
("1,1,1", 
	`FesP”Lev–
());

1600 
	`Com·ù
("r", "z");

1601 
	`ASSERT_EQ
("1,1,1", 
	`FesP”Lev–
());

1604 
	`Com·ù
("p1", "p9");

1605 
	`ASSERT_EQ
("0,0,1", 
	`FesP”Lev–
());

1608 
	`MakeTabËs
(3, "c", "e");

1609 
	`ASSERT_EQ
("1,1,2", 
	`FesP”Lev–
());

1612 
	`Com·ù
("b", "f");

1613 
	`ASSERT_EQ
("0,0,2", 
	`FesP”Lev–
());

1616 
	`MakeTabËs
(1, "a", "z");

1617 
	`ASSERT_EQ
("0,1,2", 
	`FesP”Lev–
());

1618 
db_
->
	`Com·ùRªge
(
nuÎ±r
,‚ullptr);

1619 
	`ASSERT_EQ
("0,0,1", 
	`FesP”Lev–
());

1620 
	}
}

1622 
	$TEST_F
(
DBTe¡
, 
DBO³n_O±iÚs
) {

1623 
¡d
::
¡ršg
 
dbÇme
 = 
‹¡šg
::
	`TempDœ
() + "db_options_test";

1624 
	`De¡royDB
(
dbÇme
, 
	`O±iÚs
());

1627 
DB
* 
db
 = 
nuÎ±r
;

1628 
O±iÚs
 
İts
;

1629 
İts
.
ü—‹_if_missšg
 = 
çl£
;

1630 
Stus
 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

1631 
	`ASSERT_TRUE
(
	`¡r¡r
(
s
.
	`ToSŒšg
().
	`c_¡r
(), "dÛ nÙƒxi¡"è!ğ
nuÎ±r
);

1632 
	`ASSERT_TRUE
(
db
 =ğ
nuÎ±r
);

1635 
İts
.
ü—‹_if_missšg
 = 
Œue
;

1636 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

1637 
	`ASSERT_LEVELDB_OK
(
s
);

1638 
	`ASSERT_TRUE
(
db
 !ğ
nuÎ±r
);

1640 
d–‘e
 
db
;

1641 
db
 = 
nuÎ±r
;

1644 
İts
.
ü—‹_if_missšg
 = 
çl£
;

1645 
İts
.
”rÜ_if_exi¡s
 = 
Œue
;

1646 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

1647 
	`ASSERT_TRUE
(
	`¡r¡r
(
s
.
	`ToSŒšg
().
	`c_¡r
(), "exi¡s"è!ğ
nuÎ±r
);

1648 
	`ASSERT_TRUE
(
db
 =ğ
nuÎ±r
);

1651 
İts
.
ü—‹_if_missšg
 = 
Œue
;

1652 
İts
.
”rÜ_if_exi¡s
 = 
çl£
;

1653 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

1654 
	`ASSERT_LEVELDB_OK
(
s
);

1655 
	`ASSERT_TRUE
(
db
 !ğ
nuÎ±r
);

1657 
d–‘e
 
db
;

1658 
db
 = 
nuÎ±r
;

1659 
	}
}

1661 
	$TEST_F
(
DBTe¡
, 
De¡royEm±yDœ
) {

1662 
¡d
::
¡ršg
 
dbÇme
 = 
‹¡šg
::
	`TempDœ
() + "db_empty_dir";

1663 
Te¡Env
 
	`’v
(
Env
::
	`DeçuÉ
());

1664 
’v
.
	`RemoveDœ
(
dbÇme
);

1665 
	`ASSERT_TRUE
(!
’v
.
	`FeExi¡s
(
dbÇme
));

1667 
O±iÚs
 
İts
;

1668 
İts
.
’v
 = &env;

1670 
	`ASSERT_LEVELDB_OK
(
’v
.
	`C»©eDœ
(
dbÇme
));

1671 
	`ASSERT_TRUE
(
’v
.
	`FeExi¡s
(
dbÇme
));

1672 
¡d
::
veùÜ
<¡d::
¡ršg
> 
chd»n
;

1673 
	`ASSERT_LEVELDB_OK
(
’v
.
	`G‘Chd»n
(
dbÇme
, &
chd»n
));

1675 
	`ASSERT_EQ
(2, 
chd»n
.
	`size
());

1676 
	`ASSERT_LEVELDB_OK
(
	`De¡royDB
(
dbÇme
, 
İts
));

1677 
	`ASSERT_TRUE
(!
’v
.
	`FeExi¡s
(
dbÇme
));

1680 
’v
.
	`S‘IgnÜeDÙFes
(
Œue
);

1681 
	`ASSERT_LEVELDB_OK
(
’v
.
	`C»©eDœ
(
dbÇme
));

1682 
	`ASSERT_TRUE
(
’v
.
	`FeExi¡s
(
dbÇme
));

1683 
	`ASSERT_LEVELDB_OK
(
’v
.
	`G‘Chd»n
(
dbÇme
, &
chd»n
));

1684 
	`ASSERT_EQ
(0, 
chd»n
.
	`size
());

1685 
	`ASSERT_LEVELDB_OK
(
	`De¡royDB
(
dbÇme
, 
İts
));

1686 
	`ASSERT_TRUE
(!
’v
.
	`FeExi¡s
(
dbÇme
));

1687 
	}
}

1689 
	$TEST_F
(
DBTe¡
, 
De¡royO³nDB
) {

1690 
¡d
::
¡ršg
 
dbÇme
 = 
‹¡šg
::
	`TempDœ
() + "open_db_dir";

1691 
’v_
->
	`RemoveDœ
(
dbÇme
);

1692 
	`ASSERT_TRUE
(!
’v_
->
	`FeExi¡s
(
dbÇme
));

1694 
O±iÚs
 
İts
;

1695 
İts
.
ü—‹_if_missšg
 = 
Œue
;

1696 
DB
* 
db
 = 
nuÎ±r
;

1697 
	`ASSERT_LEVELDB_OK
(
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
));

1698 
	`ASSERT_TRUE
(
db
 !ğ
nuÎ±r
);

1701 
	`ASSERT_TRUE
(
’v_
->
	`FeExi¡s
(
dbÇme
));

1702 
	`ASSERT_TRUE
(!
	`De¡royDB
(
dbÇme
, 
	`O±iÚs
()).
	`ok
());

1703 
	`ASSERT_TRUE
(
’v_
->
	`FeExi¡s
(
dbÇme
));

1705 
d–‘e
 
db
;

1706 
db
 = 
nuÎ±r
;

1709 
	`ASSERT_LEVELDB_OK
(
	`De¡royDB
(
dbÇme
, 
	`O±iÚs
()));

1710 
	`ASSERT_TRUE
(!
’v_
->
	`FeExi¡s
(
dbÇme
));

1711 
	}
}

1713 
	$TEST_F
(
DBTe¡
, 
Lockšg
) {

1714 
DB
* 
db2
 = 
nuÎ±r
;

1715 
Stus
 
s
 = 
DB
::
	`O³n
(
	`Cu¼’tO±iÚs
(), 
dbÇme_
, &
db2
);

1716 
	`ASSERT_TRUE
(!
s
.
	`ok
()) << "Locking did‚ot…revent„e-opening db";

1717 
	}
}

1720 
	$TEST_F
(
DBTe¡
, 
NoS·û
) {

1721 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1722 
İtiÚs
.
’v
 = 
’v_
;

1723 
	`Reİ’
(&
İtiÚs
);

1725 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

1726 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

1727 
	`Com·ù
("a", "z");

1728 cÚ¡ 
num_fes
 = 
	`CouÁFes
();

1730 
’v_
->
no_¥aû_
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1731 
i
 = 0; i < 10; i++) {

1732 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
 - 1;†evel++) {

1733 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(
Ëv–
, 
nuÎ±r
,‚ullptr);

1736 
’v_
->
no_¥aû_
.
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1737 
	`ASSERT_LT
(
	`CouÁFes
(), 
num_fes
 + 3);

1738 
	}
}

1740 
	$TEST_F
(
DBTe¡
, 
NÚWr™abËFeSy¡em
) {

1741 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1742 
İtiÚs
.
wr™e_bufãr_size
 = 1000;

1743 
İtiÚs
.
’v
 = 
’v_
;

1744 
	`Reİ’
(&
İtiÚs
);

1745 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v1"));

1747 
’v_
->
nÚ_wr™abË_
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1748 
¡d
::
¡ršg
 
	`big
(100000, 'x');

1749 
”rÜs
 = 0;

1750 
i
 = 0; i < 20; i++) {

1751 
	`årštf
(
¡d”r
, "™” %d;ƒ¼Ü %d\n", 
i
, 
”rÜs
);

1752 ià(!
	`Put
("foo", 
big
).
	`ok
()) {

1753 
”rÜs
++;

1754 
	`D–ayMli£cÚds
(100);

1757 
	`ASSERT_GT
(
”rÜs
, 0);

1758 
’v_
->
nÚ_wr™abË_
.
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1759 
	}
}

1761 
	$TEST_F
(
DBTe¡
, 
Wr™eSyncE¼Ü
) {

1765 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1766 
İtiÚs
.
’v
 = 
’v_
;

1767 
	`Reİ’
(&
İtiÚs
);

1768 
’v_
->
d©a_sync_”rÜ_
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1771 
Wr™eO±iÚs
 
w
;

1772 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
w
, "k1", "v1"));

1773 
	`ASSERT_EQ
("v1", 
	`G‘
("k1"));

1776 
w
.
sync
 = 
Œue
;

1777 
	`ASSERT_TRUE
(!
db_
->
	`Put
(
w
, "k2", "v2").
	`ok
());

1778 
	`ASSERT_EQ
("v1", 
	`G‘
("k1"));

1779 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("k2"));

1782 
’v_
->
d©a_sync_”rÜ_
.
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1785 
w
.
sync
 = 
çl£
;

1786 
	`ASSERT_TRUE
(!
db_
->
	`Put
(
w
, "k3", "v3").
	`ok
());

1787 
	`ASSERT_EQ
("v1", 
	`G‘
("k1"));

1788 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("k2"));

1789 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("k3"));

1790 
	}
}

1792 
	$TEST_F
(
DBTe¡
, 
Mªiã¡Wr™eE¼Ü
) {

1801 
™”
 = 0; iter < 2; iter++) {

1802 
¡d
::
©omic
<
boŞ
>* 
”rÜ_ty³
 = (
™”
 =ğ0è? &
’v_
->
mªiã¡_sync_”rÜ_


1803 : &
’v_
->
mªiã¡_wr™e_”rÜ_
;

1806 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1807 
İtiÚs
.
’v
 = 
’v_
;

1808 
İtiÚs
.
ü—‹_if_missšg
 = 
Œue
;

1809 
İtiÚs
.
”rÜ_if_exi¡s
 = 
çl£
;

1810 
	`De¡royAndReİ’
(&
İtiÚs
);

1811 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

1812 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1815 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1816 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1817 cÚ¡ 
Ï¡
 = 
cÚfig
::
kMaxMemCom·ùLev–
;

1818 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(
Ï¡
), 1);

1821 
”rÜ_ty³
->
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1822 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(
Ï¡
, 
nuÎ±r
,‚ullptr);

1823 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1826 
”rÜ_ty³
->
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1827 
	`Reİ’
(&
İtiÚs
);

1828 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1830 
	}
}

1832 
	$TEST_F
(
DBTe¡
, 
MissšgSSTFe
) {

1833 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

1834 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1837 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1838 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1840 
	`Clo£
();

1841 
	`ASSERT_TRUE
(
	`D–‘eAnSSTFe
());

1842 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1843 
İtiÚs
.
·¿noid_checks
 = 
Œue
;

1844 
Stus
 
s
 = 
	`TryReİ’
(&
İtiÚs
);

1845 
	`ASSERT_TRUE
(!
s
.
	`ok
());

1846 
	`ASSERT_TRUE
(
s
.
	`ToSŒšg
().
	`fšd
("issšg"è!ğ
¡d
::
¡ršg
::
Åos
) << s.ToString();

1847 
	}
}

1849 
	$TEST_F
(
DBTe¡
, 
StlR—dSST
) {

1850 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

1851 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1854 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1855 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1856 
	`Clo£
();

1857 
	`ASSERT_GT
(
	`R’ameLDBToSST
(), 0);

1858 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1859 
İtiÚs
.
·¿noid_checks
 = 
Œue
;

1860 
Stus
 
s
 = 
	`TryReİ’
(&
İtiÚs
);

1861 
	`ASSERT_TRUE
(
s
.
	`ok
());

1862 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

1863 
	}
}

1865 
	$TEST_F
(
DBTe¡
, 
FesD–‘edAá”Com·ùiÚ
) {

1866 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v2"));

1867 
	`Com·ù
("a", "z");

1868 cÚ¡ 
num_fes
 = 
	`CouÁFes
();

1869 
i
 = 0; i < 10; i++) {

1870 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "v2"));

1871 
	`Com·ù
("a", "z");

1873 
	`ASSERT_EQ
(
	`CouÁFes
(), 
num_fes
);

1874 
	}
}

1876 
	$TEST_F
(
DBTe¡
, 
BloomF‹r
) {

1877 
’v_
->
couÁ_¿ndom_»ads_
 = 
Œue
;

1878 
O±iÚs
 
İtiÚs
 = 
	`Cu¼’tO±iÚs
();

1879 
İtiÚs
.
’v
 = 
’v_
;

1880 
İtiÚs
.
block_ÿche
 = 
	`NewLRUCache
(0);

1881 
İtiÚs
.
f‹r_pŞicy
 = 
	`NewBloomF‹rPŞicy
(10);

1882 
	`Reİ’
(&
İtiÚs
);

1885 cÚ¡ 
N
 = 10000;

1886 
i
 = 0; i < 
N
; i++) {

1887 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(
i
), Key(i)));

1889 
	`Com·ù
("a", "z");

1890 
i
 = 0; i < 
N
; i += 100) {

1891 
	`ASSERT_LEVELDB_OK
(
	`Put
(
	`Key
(
i
), Key(i)));

1893 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

1896 
’v_
->
d–ay_d©a_sync_
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1899 
’v_
->
¿ndom_»ad_couÁ”_
.
	`Re£t
();

1900 
i
 = 0; i < 
N
; i++) {

1901 
	`ASSERT_EQ
(
	`Key
(
i
), 
	`G‘
(Key(i)));

1903 
»ads
 = 
’v_
->
¿ndom_»ad_couÁ”_
.
	`R—d
();

1904 
	`årštf
(
¡d”r
, "%d…»£Á => %d„—ds\n", 
N
, 
»ads
);

1905 
	`ASSERT_GE
(
»ads
, 
N
);

1906 
	`ASSERT_LE
(
»ads
, 
N
 + 2 * N / 100);

1909 
’v_
->
¿ndom_»ad_couÁ”_
.
	`Re£t
();

1910 
i
 = 0; i < 
N
; i++) {

1911 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
(
	`Key
(
i
) + ".missing"));

1913 
»ads
 = 
’v_
->
¿ndom_»ad_couÁ”_
.
	`R—d
();

1914 
	`årštf
(
¡d”r
, "%d missšg => %d„—ds\n", 
N
, 
»ads
);

1915 
	`ASSERT_LE
(
»ads
, 3 * 
N
 / 100);

1917 
’v_
->
d–ay_d©a_sync_
.
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1918 
	`Clo£
();

1919 
d–‘e
 
İtiÚs
.
block_ÿche
;

1920 
d–‘e
 
İtiÚs
.
f‹r_pŞicy
;

1921 
	}
}

1924 
	gÇme¥aû
 {

1926 cÚ¡ 
	gkNumTh»ads
 = 4;

1927 cÚ¡ 
	gkTe¡SecÚds
 = 10;

1928 cÚ¡ 
	gkNumKeys
 = 1000;

1930 
	sMTS‹
 {

1931 
DBTe¡
* 
	g‹¡
;

1932 
	g¡d
::
©omic
<
boŞ
> 
¡İ
;

1933 
	g¡d
::
©omic
<> 
couÁ”
[
kNumTh»ads
];

1934 
	g¡d
::
©omic
<
boŞ
> 
th»ad_dÚe
[
kNumTh»ads
];

1937 
	sMTTh»ad
 {

1938 
MTS‹
* 
	g¡©e
;

1939 
	gid
;

1942 
MTTh»adBody
(* 
¬g
) {

1943 
MTTh»ad
* 
	gt
 = 
»š‹½»t_ÿ¡
<MTTh»ad*>(
¬g
);

1944 
	gid
 = 
t
->
id
;

1945 
DB
* 
	gdb
 = 
t
->
¡©e
->
‹¡
->
db_
;

1946 
	gcouÁ”
 = 0;

1947 
årštf
(
¡d”r
, "... s¹šgh»ad %d\n", 
id
);

1948 
Rªdom
 
ºd
(1000 + 
id
);

1949 
	g¡d
::
¡ršg
 
v®ue
;

1950 
	gv®buf
[1500];

1951 !
	gt
->
	g¡©e
->
	g¡İ
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

1952 
t
->
¡©e
->
couÁ”
[
id
].
¡Üe
(couÁ”, 
¡d
::
memÜy_Üd”_»Ëa£
);

1954 
	gkey
 = 
ºd
.
UnifÜm
(
kNumKeys
);

1955 
	gkeybuf
[20];

1956 
¢´štf
(
keybuf
, (keybuf), "%016d", 
key
);

1958 ià(
	gºd
.
OÃIn
(2)) {

1961 
¢´štf
(
v®buf
, (v®buf), "%d.%d.%-1000d", 
key
, 
id
,

1962 
¡©ic_ÿ¡
<>(
couÁ”
));

1963 
ASSERT_LEVELDB_OK
(
db
->
Put
(
Wr™eO±iÚs
(), 
Sliû
(
keybuf
), Sliû(
v®buf
)));

1966 
Stus
 
	gs
 = 
db
->
G‘
(
R—dO±iÚs
(), 
Sliû
(
keybuf
), &
v®ue
);

1967 ià(
	gs
.
IsNÙFound
()) {

1971 
ASSERT_LEVELDB_OK
(
s
);

1972 
	gk
, 
	gw
, 
	gc
;

1973 
ASSERT_EQ
(3, 
ssÿnf
(
v®ue
.
c_¡r
(), "%d.%d.%d", &
k
, &
w
, &
c
)è<< 
	gv®ue
;

1974 
ASSERT_EQ
(
k
, 
key
);

1975 
ASSERT_GE
(
w
, 0);

1976 
ASSERT_LT
(
w
, 
kNumTh»ads
);

1977 
ASSERT_LE
(
c
, 
t
->
¡©e
->
couÁ”
[
w
].
lßd
(
¡d
::
memÜy_Üd”_acquœe
));

1980 
	gcouÁ”
++;

1982 
	gt
->
	g¡©e
->
	gth»ad_dÚe
[
id
].
¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1983 
årštf
(
¡d”r
, "... stİpšgh»ad %d‡á” %d ops\n", 
id
, 
couÁ”
);

1988 
	$TEST_F
(
DBTe¡
, 
MuÉiTh»aded
) {

1991 
MTS‹
 
mt
;

1992 
mt
.
‹¡
 = 
this
;

1993 
mt
.
¡İ
.
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1994 
id
 = 0; id < 
kNumTh»ads
; id++) {

1995 
mt
.
couÁ”
[
id
].
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

1996 
mt
.
th»ad_dÚe
[
id
].
	`¡Üe
(
çl£
, 
¡d
::
memÜy_Üd”_»Ëa£
);

2000 
MTTh»ad
 
th»ad
[
kNumTh»ads
];

2001 
id
 = 0; id < 
kNumTh»ads
; id++) {

2002 
th»ad
[
id
].
¡©e
 = &
mt
;

2003 
th»ad
[
id
].id = id;

2004 
’v_
->
	`S¹Th»ad
(
MTTh»adBody
, &
th»ad
[
id
]);

2008 
	`D–ayMli£cÚds
(
kTe¡SecÚds
 * 1000);

2011 
mt
.
¡İ
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

2012 
id
 = 0; id < 
kNumTh»ads
; id++) {

2013 !
mt
.
th»ad_dÚe
[
id
].
	`lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

2014 
	`D–ayMli£cÚds
(100);

2017 } 
	`ChªgeO±iÚs
());

2018 
	}
}

2020 
	gÇme¥aû
 {

2021 
	g¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::¡ršg> 
	tKVM­
;

2024 şas 
	cMod–DB
 : 
public
 
DB
 {

2025 
public
:

2026 şas 
	cMod–SÇpshÙ
 : 
public
 
SÇpshÙ
 {

2027 
public
:

2028 
KVM­
 
m­_
;

2031 
ex¶ic™
 
Mod–DB
(cÚ¡ 
O±iÚs
& 
İtiÚs
è: 
İtiÚs_
(options) {}

2032 ~
Mod–DB
(è
ov”ride
 = ;

2033 
Stus
 
Put
(cÚ¡ 
Wr™eO±iÚs
& 
o
, cÚ¡ 
Sliû
& 
k
, cÚ¡ Sliû& 
v
è
	gov”ride
 {

2034  
	gDB
::
Put
(
o
, 
k
, 
v
);

2036 
Stus
 
D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
o
, cÚ¡ 
Sliû
& 
key
è
	gov”ride
 {

2037  
	gDB
::
D–‘e
(
o
, 
key
);

2039 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, cÚ¡ 
Sliû
& 
key
,

2040 
¡d
::
¡ršg
* 
v®ue
è
ov”ride
 {

2041 
as£¹
(
çl£
);

2042  
	gStus
::
NÙFound
(
key
);

2044 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
è
	gov”ride
 {

2045 ià(
	gİtiÚs
.
	g¢­shÙ
 =ğ
nuÎ±r
) {

2046 
KVM­
* 
§ved
 = 
Ãw
 KVMap;

2047 *
	g§ved
 = 
m­_
;

2048  
Ãw
 
Mod–I‹r
(
§ved
, 
Œue
);

2050 cÚ¡ 
KVM­
* 
	g¢­shÙ_¡©e
 =

2051 &(
»š‹½»t_ÿ¡
<cÚ¡ 
Mod–SÇpshÙ
*>(
İtiÚs
.
¢­shÙ
)->
m­_
);

2052  
Ãw
 
Mod–I‹r
(
¢­shÙ_¡©e
, 
çl£
);

2055 cÚ¡ 
SÇpshÙ
* 
G‘SÇpshÙ
(è
	gov”ride
 {

2056 
Mod–SÇpshÙ
* 
	g¢­shÙ
 = 
Ãw
 ModelSnapshot;

2057 
	g¢­shÙ
->
	gm­_
 = 
m­_
;

2058  
	g¢­shÙ
;

2061 
R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
¢­shÙ
è
	gov”ride
 {

2062 
d–‘e
 
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gMod–SÇpshÙ
*>(
	g¢­shÙ
);

2064 
Stus
 
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
b©ch
è
	gov”ride
 {

2065 şas 
	cHªdËr
 : 
public
 
Wr™eB©ch
::
HªdËr
 {

2066 
public
:

2067 
KVM­
* 
m­_
;

2068 
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
è
	gov”ride
 {

2069 (*
	gm­_
)[
key
.
ToSŒšg
()] = 
v®ue
.ToString();

2071 
D–‘e
(cÚ¡ 
Sliû
& 
key
è
	gov”ride
 { 
	gm­_
->
”a£
(key.
ToSŒšg
()); }

2073 
HªdËr
 
	ghªdËr
;

2074 
	ghªdËr
.
	gm­_
 = &
m­_
;

2075  
	gb©ch
->
I‹¿‹
(&
hªdËr
);

2078 
boŞ
 
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
è
ov”ride
 {

2079  
çl£
;

2081 
G‘Aµroxim©eSizes
(cÚ¡ 
Rªge
* 
r
, 
n
, 
ušt64_t
* 
sizes
è
	gov”ride
 {

2082 
	gi
 = 0; i < 
	gn
; i++) {

2083 
	gsizes
[
i
] = 0;

2086 
Com·ùRªge
(cÚ¡ 
Sliû
* 
¡¬t
, cÚ¡ Sliû* 
’d
è
	gov”ride
 {}

2088 
	g´iv©e
:

2089 şas 
	cMod–I‹r
 : 
public
 
I‹¿tÜ
 {

2090 
public
:

2091 
Mod–I‹r
(cÚ¡ 
KVM­
* 
m­
, 
boŞ
 
owÃd
)

2092 : 
m­_
(
m­
), 
owÃd_
(
owÃd
), 
™”_
(m­_->
’d
()) {}

2093 ~
Mod–I‹r
(è
	gov”ride
 {

2094 ià(
	gowÃd_
è
d–‘e
 
	gm­_
;

2096 
boŞ
 
V®id
(ècÚ¡ 
	gov”ride
 {  
	g™”_
 !ğ
m­_
->
’d
(); }

2097 
S“kToFœ¡
(è
	gov”ride
 { 
	g™”_
 = 
m­_
->
begš
(); }

2098 
S“kToLa¡
(è
	gov”ride
 {

2099 ià(
	gm­_
->
em±y
()) {

2100 
	g™”_
 = 
m­_
->
’d
();

2102 
	g™”_
 = 
m­_
->
fšd
(m­_->
rbegš
()->
fœ¡
);

2105 
S“k
(cÚ¡ 
Sliû
& 
k
è
	gov”ride
 {

2106 
	g™”_
 = 
m­_
->
low”_bound
(
k
.
ToSŒšg
());

2108 
Next
(è
	gov”ride
 { ++
	g™”_
; }

2109 
P»v
(è
	gov”ride
 { --
	g™”_
; }

2110 
Sliû
 
key
(ècÚ¡ 
	gov”ride
 {  
	g™”_
->
	gfœ¡
; }

2111 
Sliû
 
v®ue
(ècÚ¡ 
	gov”ride
 {  
	g™”_
->
	g£cÚd
; }

2112 
Stus
 
¡©us
(ècÚ¡ 
	gov”ride
 {  
	gStus
::
OK
(); }

2114 
	g´iv©e
:

2115 cÚ¡ 
KVM­
* cÚ¡ 
m­_
;

2116 cÚ¡ 
boŞ
 
	gowÃd_
;

2117 
	gKVM­
::
cÚ¡_™”©Ü
 
™”_
;

2119 cÚ¡ 
O±iÚs
 
	gİtiÚs_
;

2120 
KVM­
 
	gm­_
;

2123 
boŞ
 
	$Com·»I‹¿tÜs
(
¡•
, 
DB
* 
mod–
, DB* 
db
,

2124 cÚ¡ 
SÇpshÙ
* 
mod–_¢­
,

2125 cÚ¡ 
SÇpshÙ
* 
db_¢­
) {

2126 
R—dO±iÚs
 
İtiÚs
;

2127 
İtiÚs
.
¢­shÙ
 = 
mod–_¢­
;

2128 
I‹¿tÜ
* 
m™”
 = 
mod–
->
	`NewI‹¿tÜ
(
İtiÚs
);

2129 
İtiÚs
.
¢­shÙ
 = 
db_¢­
;

2130 
I‹¿tÜ
* 
db™”
 = 
db
->
	`NewI‹¿tÜ
(
İtiÚs
);

2131 
boŞ
 
ok
 = 
Œue
;

2132 
couÁ
 = 0;

2133 
m™”
->
	`S“kToFœ¡
(), 
db™”
->SeekToFirst();

2134 
ok
 && 
m™”
->
	`V®id
(è&& 
db™”
->V®id(); m™”->
	`Next
(), dbiter->Next()) {

2135 
couÁ
++;

2136 ià(
m™”
->
	`key
().
	`com·»
(
db™”
->key()) != 0) {

2137 
	`årštf
(
¡d”r
, "¡• %d: Key mism©ch: '%s' vs. '%s'\n", 
¡•
,

2138 
	`Esÿ³SŒšg
(
m™”
->
	`key
()).
	`c_¡r
(),

2139 
	`Esÿ³SŒšg
(
db™”
->
	`key
()).
	`c_¡r
());

2140 
ok
 = 
çl£
;

2144 ià(
m™”
->
	`v®ue
().
	`com·»
(
db™”
->value()) != 0) {

2145 
	`årštf
(
¡d”r
, "step %d: Value mismatch for key '%s': '%s' vs. '%s'\n",

2146 
¡•
, 
	`Esÿ³SŒšg
(
m™”
->
	`key
()).
	`c_¡r
(),

2147 
	`Esÿ³SŒšg
(
m™”
->
	`v®ue
()).
	`c_¡r
(),

2148 
	`Esÿ³SŒšg
(
m™”
->
	`v®ue
()).
	`c_¡r
());

2149 
ok
 = 
çl£
;

2153 ià(
ok
) {

2154 ià(
m™”
->
	`V®id
(è!ğ
db™”
->Valid()) {

2155 
	`årštf
(
¡d”r
, "step %d: Mismatch‡tƒnd of iterators: %d vs. %d\n",

2156 
¡•
, 
m™”
->
	`V®id
(), 
db™”
->Valid());

2157 
ok
 = 
çl£
;

2160 
	`årštf
(
¡d”r
, "%dƒÁr› com·»d: ok=%d\n", 
couÁ
, 
ok
);

2161 
d–‘e
 
m™”
;

2162 
d–‘e
 
db™”
;

2163  
ok
;

2164 
	}
}

2166 
	$TEST_F
(
DBTe¡
, 
Rªdomized
) {

2167 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
());

2169 
Mod–DB
 
	`mod–
(
	`Cu¼’tO±iÚs
());

2170 cÚ¡ 
N
 = 10000;

2171 cÚ¡ 
SÇpshÙ
* 
mod–_¢­
 = 
nuÎ±r
;

2172 cÚ¡ 
SÇpshÙ
* 
db_¢­
 = 
nuÎ±r
;

2173 
¡d
::
¡ršg
 
k
, 
v
;

2174 
¡•
 = 0; s‹°< 
N
; step++) {

2175 ià(
¡•
 % 100 == 0) {

2176 
	`årštf
(
¡d”r
, "S‹°%d oà%d\n", 
¡•
, 
N
);

2179 
p
 = 
ºd
.
	`UnifÜm
(100);

2180 ià(
p
 < 45) {

2181 
k
 = 
	`RªdomKey
(&
ºd
);

2182 
v
 = 
	`RªdomSŒšg
(

2183 &
ºd
,„nd.
	`OÃIn
(20è? 100 +„nd.
	`UnifÜm
(100) :„nd.Uniform(8));

2184 
	`ASSERT_LEVELDB_OK
(
mod–
.
	`Put
(
	`Wr™eO±iÚs
(), 
k
, 
v
));

2185 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
k
, 
v
));

2187 } ià(
p
 < 90) {

2188 
k
 = 
	`RªdomKey
(&
ºd
);

2189 
	`ASSERT_LEVELDB_OK
(
mod–
.
	`D–‘e
(
	`Wr™eO±iÚs
(), 
k
));

2190 
	`ASSERT_LEVELDB_OK
(
db_
->
	`D–‘e
(
	`Wr™eO±iÚs
(), 
k
));

2193 
Wr™eB©ch
 
b
;

2194 cÚ¡ 
num
 = 
ºd
.
	`UnifÜm
(8);

2195 
i
 = 0; i < 
num
; i++) {

2196 ià(
i
 =ğ0 || !
ºd
.
	`OÃIn
(10)) {

2197 
k
 = 
	`RªdomKey
(&
ºd
);

2202 ià(
ºd
.
	`OÃIn
(2)) {

2203 
v
 = 
	`RªdomSŒšg
(&
ºd
,„nd.
	`UnifÜm
(10));

2204 
b
.
	`Put
(
k
, 
v
);

2206 
b
.
	`D–‘e
(
k
);

2209 
	`ASSERT_LEVELDB_OK
(
mod–
.
	`Wr™e
(
	`Wr™eO±iÚs
(), &
b
));

2210 
	`ASSERT_LEVELDB_OK
(
db_
->
	`Wr™e
(
	`Wr™eO±iÚs
(), &
b
));

2213 ià((
¡•
 % 100) == 0) {

2214 
	`ASSERT_TRUE
(
	`Com·»I‹¿tÜs
(
¡•
, &
mod–
, 
db_
, 
nuÎ±r
,‚ullptr));

2215 
	`ASSERT_TRUE
(
	`Com·»I‹¿tÜs
(
¡•
, &
mod–
, 
db_
, 
mod–_¢­
, 
db_¢­
));

2219 ià(
mod–_¢­
 !ğ
nuÎ±r
è
mod–
.
	`R–—£SÇpshÙ
(model_snap);

2220 ià(
db_¢­
 !ğ
nuÎ±r
è
db_
->
	`R–—£SÇpshÙ
(db_snap);

2222 
	`Reİ’
();

2223 
	`ASSERT_TRUE
(
	`Com·»I‹¿tÜs
(
¡•
, &
mod–
, 
db_
, 
nuÎ±r
,‚ullptr));

2225 
mod–_¢­
 = 
mod–
.
	`G‘SÇpshÙ
();

2226 
db_¢­
 = 
db_
->
	`G‘SÇpshÙ
();

2229 ià(
mod–_¢­
 !ğ
nuÎ±r
è
mod–
.
	`R–—£SÇpshÙ
(model_snap);

2230 ià(
db_¢­
 !ğ
nuÎ±r
è
db_
->
	`R–—£SÇpshÙ
(db_snap);

2231 } 
	`ChªgeO±iÚs
());

2232 
	}
}

2234 
	g¡d
::
¡ršg
 
	$MakeKey
(
num
) {

2235 
buf
[30];

2236 
	`¢´štf
(
buf
, (buf), "%016u", 
num
);

2237  
¡d
::
	`¡ršg
(
buf
);

2238 
	}
}

2240 
	$BM_LogAndAµly
(
™”s
, 
num_ba£_fes
) {

2241 
¡d
::
¡ršg
 
dbÇme
 = 
‹¡šg
::
	`TempDœ
() + "leveldb_test_benchmark";

2242 
	`De¡royDB
(
dbÇme
, 
	`O±iÚs
());

2244 
DB
* 
db
 = 
nuÎ±r
;

2245 
O±iÚs
 
İts
;

2246 
İts
.
ü—‹_if_missšg
 = 
Œue
;

2247 
Stus
 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

2248 
	`ASSERT_LEVELDB_OK
(
s
);

2249 
	`ASSERT_TRUE
(
db
 !ğ
nuÎ±r
);

2251 
d–‘e
 
db
;

2252 
db
 = 
nuÎ±r
;

2254 
Env
* 
’v
 = Env::
	`DeçuÉ
();

2256 
pÜt
::
Mu‹x
 
mu
;

2257 
Mu‹xLock
 
	`l
(&
mu
);

2259 
IÁ”ÇlKeyCom·¿tÜ
 
	`cmp
(
	`By‹wi£Com·¿tÜ
());

2260 
O±iÚs
 
İtiÚs
;

2261 
V”siÚS‘
 
	`v£t
(
dbÇme
, &
İtiÚs
, 
nuÎ±r
, &
cmp
);

2262 
boŞ
 
§ve_mªiã¡
;

2263 
	`ASSERT_LEVELDB_OK
(
v£t
.
	`Recov”
(&
§ve_mªiã¡
));

2264 
V”siÚEd™
 
vba£
;

2265 
ušt64_t
 
âum
 = 1;

2266 
i
 = 0; i < 
num_ba£_fes
; i++) {

2267 
IÁ”ÇlKey
 
	`¡¬t
(
	`MakeKey
(2 * 
âum
), 1, 
kTy³V®ue
);

2268 
IÁ”ÇlKey
 
	`lim™
(
	`MakeKey
(2 * 
âum
 + 1), 1, 
kTy³D–‘iÚ
);

2269 
vba£
.
	`AddFe
(2, 
âum
++, 1 , 
¡¬t
, 
lim™
);

2271 
	`ASSERT_LEVELDB_OK
(
v£t
.
	`LogAndAµly
(&
vba£
, &
mu
));

2273 
ušt64_t
 
¡¬t_miüos
 = 
’v
->
	`NowMiüos
();

2275 
i
 = 0; i < 
™”s
; i++) {

2276 
V”siÚEd™
 
ved™
;

2277 
ved™
.
	`RemoveFe
(2, 
âum
);

2278 
IÁ”ÇlKey
 
	`¡¬t
(
	`MakeKey
(2 * 
âum
), 1, 
kTy³V®ue
);

2279 
IÁ”ÇlKey
 
	`lim™
(
	`MakeKey
(2 * 
âum
 + 1), 1, 
kTy³D–‘iÚ
);

2280 
ved™
.
	`AddFe
(2, 
âum
++, 1 , 
¡¬t
, 
lim™
);

2281 
v£t
.
	`LogAndAµly
(&
ved™
, &
mu
);

2283 
ušt64_t
 
¡İ_miüos
 = 
’v
->
	`NowMiüos
();

2284 
us
 = 
¡İ_miüos
 - 
¡¬t_miüos
;

2285 
buf
[16];

2286 
	`¢´štf
(
buf
, (buf), "%d", 
num_ba£_fes
);

2287 
	`årštf
(
¡d”r
,

2288 "BM_LogAndAµly/%-6  %8d i‹r : %9u u (%7.0àu / i‹r)\n", 
buf
,

2289 
™”s
, 
us
, (()us) / iters);

2290 
	}
}

2294 
	$maš
(
¬gc
, ** 
¬gv
) {

2295 ià(
¬gc
 > 1 && 
¡d
::
	`¡ršg
(
¬gv
[1]) == "--benchmark") {

2296 
Ëv–db
::
	`BM_LogAndAµly
(1000, 1);

2297 
Ëv–db
::
	`BM_LogAndAµly
(1000, 100);

2298 
Ëv–db
::
	`BM_LogAndAµly
(1000, 10000);

2299 
Ëv–db
::
	`BM_LogAndAµly
(100, 100000);

2303 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

2304  
	`RUN_ALL_TESTS
();

2305 
	}
}

	@dbformat.cc

5 
	~"db/dbfÜm©.h
"

7 
	~<¡dio.h
>

9 
	~<s¡»am
>

11 
	~"pÜt/pÜt.h
"

12 
	~"ut/codšg.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
ušt64_t
 
PackSequ’ûAndTy³
(ušt64_ˆ
£q
, 
V®ueTy³
 
t
) {

17 
as£¹
(
£q
 <ğ
kMaxSequ’ûNumb”
);

18 
as£¹
(
t
 <ğ
kV®ueTy³FÜS“k
);

19  (
	g£q
 << 8è| 
	gt
;

22 
Aµ’dIÁ”ÇlKey
(
¡d
::
¡ršg
* 
»suÉ
, cÚ¡ 
P¬£dIÁ”ÇlKey
& 
key
) {

23 
	g»suÉ
->
­³nd
(
key
.
u£r_key
.
d©a
(), key.u£r_key.
size
());

24 
PutFixed64
(
»suÉ
, 
PackSequ’ûAndTy³
(
key
.
£qu’û
, key.
ty³
));

27 
	g¡d
::
¡ršg
 
P¬£dIÁ”ÇlKey
::
DebugSŒšg
() const {

28 
¡d
::
o¡ršg¡»am
 
ss
;

29 
	gss
 << '\'' << 
Esÿ³SŒšg
(
u£r_key
.
ToSŒšg
()è<< "' @ " << 
	g£qu’û
 << " : "

30 << 
	g¡©ic_ÿ¡
<>(
	gty³
);

31  
	gss
.
¡r
();

34 
	g¡d
::
¡ršg
 
IÁ”ÇlKey
::
DebugSŒšg
() const {

35 
P¬£dIÁ”ÇlKey
 
·r£d
;

36 ià(
P¬£IÁ”ÇlKey
(
»p_
, &
·r£d
)) {

37  
	g·r£d
.
DebugSŒšg
();

39 
	g¡d
::
o¡ršg¡»am
 
ss
;

40 
	gss
 << "(bad)" << 
Esÿ³SŒšg
(
»p_
);

41  
	gss
.
¡r
();

44 cÚ¡ * 
	gIÁ”ÇlKeyCom·¿tÜ
::
Name
() const {

48 
	gIÁ”ÇlKeyCom·¿tÜ
::
Com·»
(cÚ¡ 
Sliû
& 
akey
, cÚ¡ Sliû& 
bkey
) const {

53 
	gr
 = 
u£r_com·¿tÜ_
->
Com·»
(
ExŒaùU£rKey
(
akey
), ExŒaùU£rKey(
bkey
));

54 ià(
	gr
 == 0) {

55 cÚ¡ 
ušt64_t
 
ªum
 = 
DecodeFixed64
(
akey
.
d©a
(è+‡key.
size
() - 8);

56 cÚ¡ 
ušt64_t
 
	gbnum
 = 
DecodeFixed64
(
bkey
.
d©a
(è+ bkey.
size
() - 8);

57 ià(
	gªum
 > 
	gbnum
) {

58 
	gr
 = -1;

59 } ià(
	gªum
 < 
	gbnum
) {

60 
	gr
 = +1;

63  
	gr
;

66 
	gIÁ”ÇlKeyCom·¿tÜ
::
FšdShÜ‹¡S•¬©Ü
(
¡d
::
¡ršg
* 
¡¬t
,

67 cÚ¡ 
Sliû
& 
lim™
) const {

69 
Sliû
 
	gu£r_¡¬t
 = 
ExŒaùU£rKey
(*
¡¬t
);

70 
Sliû
 
	gu£r_lim™
 = 
ExŒaùU£rKey
(
lim™
);

71 
	g¡d
::
¡ršg
 
tmp
(
u£r_¡¬t
.
d©a
(), u£r_¡¬t.
size
());

72 
	gu£r_com·¿tÜ_
->
FšdShÜ‹¡S•¬©Ü
(&
tmp
, 
u£r_lim™
);

73 ià(
	gtmp
.
size
(è< 
	gu£r_¡¬t
.size() &&

74 
	gu£r_com·¿tÜ_
->
Com·»
(
u£r_¡¬t
, 
tmp
) < 0) {

77 
PutFixed64
(&
tmp
,

78 
PackSequ’ûAndTy³
(
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
));

79 
as£¹
(
this
->
Com·»
(*
¡¬t
, 
tmp
) < 0);

80 
as£¹
(
this
->
Com·»
(
tmp
, 
lim™
) < 0);

81 
	g¡¬t
->
sw­
(
tmp
);

85 
	gIÁ”ÇlKeyCom·¿tÜ
::
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const {

86 
Sliû
 
u£r_key
 = 
ExŒaùU£rKey
(*
key
);

87 
	g¡d
::
¡ršg
 
tmp
(
u£r_key
.
d©a
(), u£r_key.
size
());

88 
	gu£r_com·¿tÜ_
->
FšdShÜtSucûssÜ
(&
tmp
);

89 ià(
	gtmp
.
size
(è< 
	gu£r_key
.size() &&

90 
	gu£r_com·¿tÜ_
->
Com·»
(
u£r_key
, 
tmp
) < 0) {

93 
PutFixed64
(&
tmp
,

94 
PackSequ’ûAndTy³
(
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
));

95 
as£¹
(
this
->
Com·»
(*
key
, 
tmp
) < 0);

96 
	gkey
->
sw­
(
tmp
);

100 cÚ¡ * 
	gIÁ”ÇlF‹rPŞicy
::
Name
(ècÚ¡ {  
u£r_pŞicy_
->Name(); }

102 
	gIÁ”ÇlF‹rPŞicy
::
C»©eF‹r
(cÚ¡ 
Sliû
* 
keys
, 
n
,

103 
¡d
::
¡ršg
* 
d¡
) const {

106 
Sliû
* 
mkey
 = 
cÚ¡_ÿ¡
<Sliû*>(
keys
);

107 
	gi
 = 0; i < 
	gn
; i++) {

108 
	gmkey
[
i
] = 
ExŒaùU£rKey
(
keys
[i]);

111 
	gu£r_pŞicy_
->
C»©eF‹r
(
keys
, 
n
, 
d¡
);

114 
boŞ
 
	gIÁ”ÇlF‹rPŞicy
::
KeyMayM©ch
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
f
) const {

115  
	gu£r_pŞicy_
->
KeyMayM©ch
(
ExŒaùU£rKey
(
key
), 
f
);

118 
	gLookupKey
::
LookupKey
(cÚ¡ 
Sliû
& 
u£r_key
, 
Sequ’ûNumb”
 
s
) {

119 
size_t
 
	gusize
 = 
u£r_key
.
size
();

120 
size_t
 
	gÃeded
 = 
usize
 + 13;

121 * 
	gd¡
;

122 ià(
	gÃeded
 <ğ(
¥aû_
)) {

123 
d¡
 = 
¥aû_
;

125 
	gd¡
 = 
Ãw
 [
Ãeded
];

127 
	g¡¬t_
 = 
d¡
;

128 
	gd¡
 = 
EncodeV¬št32
(
d¡
, 
usize
 + 8);

129 
	gk¡¬t_
 = 
d¡
;

130 
memıy
(
d¡
, 
u£r_key
.
d©a
(), 
usize
);

131 
	gd¡
 +ğ
usize
;

132 
EncodeFixed64
(
d¡
, 
PackSequ’ûAndTy³
(
s
, 
kV®ueTy³FÜS“k
));

133 
	gd¡
 += 8;

134 
	g’d_
 = 
d¡
;

	@dbformat.h

5 #iâdeà
STORAGE_LEVELDB_DB_DBFORMAT_H_


6 
	#STORAGE_LEVELDB_DB_DBFORMAT_H_


	)

8 
	~<c¡ddef
>

9 
	~<c¡dšt
>

10 
	~<¡ršg
>

12 
	~"Ëv–db/com·¿tÜ.h
"

13 
	~"Ëv–db/db.h
"

14 
	~"Ëv–db/f‹r_pŞicy.h
"

15 
	~"Ëv–db/¦iû.h
"

16 
	~"Ëv–db/bË_bud”.h
"

17 
	~"ut/codšg.h
"

18 
	~"ut/loggšg.h
"

20 
Çme¥aû
 
	gËv–db
 {

24 
Çme¥aû
 
	gcÚfig
 {

25 cÚ¡ 
	gkNumLev–s
 = 7;

28 cÚ¡ 
	gkL0_Com·ùiÚTrigg”
 = 4;

31 cÚ¡ 
	gkL0_SlowdownWr™esTrigg”
 = 8;

34 cÚ¡ 
	gkL0_StİWr™esTrigg”
 = 12;

42 cÚ¡ 
	gkMaxMemCom·ùLev–
 = 2;

45 cÚ¡ 
	gkR—dBy‹sP”iod
 = 1048576;

49 
şass
 
	gIÁ”ÇlKey
;

54 
	eV®ueTy³
 { 
	gkTy³D–‘iÚ
 = 0x0, 
	gkTy³V®ue
 = 0x1 };

61 cÚ¡ 
V®ueTy³
 
	gkV®ueTy³FÜS“k
 = 
kTy³V®ue
;

63 
ušt64_t
 
	tSequ’ûNumb”
;

67 cÚ¡ 
Sequ’ûNumb”
 
	gkMaxSequ’ûNumb”
 = ((0x1ull << 56) - 1);

69 
	sP¬£dIÁ”ÇlKey
 {

70 
Sliû
 
	gu£r_key
;

71 
Sequ’ûNumb”
 
	g£qu’û
;

72 
V®ueTy³
 
	gty³
;

74 
P¬£dIÁ”ÇlKey
() {}

75 
P¬£dIÁ”ÇlKey
(cÚ¡ 
Sliû
& 
u
, cÚ¡ 
Sequ’ûNumb”
& 
£q
, 
V®ueTy³
 
t
)

76 : 
u£r_key
(
u
), 
£qu’û
(
£q
), 
ty³
(
t
) {}

77 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

81 
šlše
 
size_t
 
IÁ”ÇlKeyEncodšgL’gth
(cÚ¡ 
P¬£dIÁ”ÇlKey
& 
key
) {

82  
	gkey
.
	gu£r_key
.
size
() + 8;

86 
Aµ’dIÁ”ÇlKey
(
¡d
::
¡ršg
* 
»suÉ
, cÚ¡ 
P¬£dIÁ”ÇlKey
& 
key
);

92 
boŞ
 
P¬£IÁ”ÇlKey
(cÚ¡ 
Sliû
& 
š‹º®_key
, 
P¬£dIÁ”ÇlKey
* 
»suÉ
);

95 
šlše
 
Sliû
 
ExŒaùU£rKey
(cÚ¡ Sliû& 
š‹º®_key
) {

96 
as£¹
(
š‹º®_key
.
size
() >= 8);

97  
Sliû
(
š‹º®_key
.
d©a
(), iÁ”Çl_key.
size
() - 8);

102 şas 
	cIÁ”ÇlKeyCom·¿tÜ
 : 
public
 
Com·¿tÜ
 {

103 
´iv©e
:

104 cÚ¡ 
Com·¿tÜ
* 
u£r_com·¿tÜ_
;

106 
	gpublic
:

107 
ex¶ic™
 
IÁ”ÇlKeyCom·¿tÜ
(cÚ¡ 
Com·¿tÜ
* 
c
è: 
u£r_com·¿tÜ_
(c) {}

108 cÚ¡ * 
Name
(ècÚ¡ 
ov”ride
;

109 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
ècÚ¡ 
	gov”ride
;

110 
FšdShÜ‹¡S•¬©Ü
(
¡d
::
¡ršg
* 
¡¬t
,

111 cÚ¡ 
Sliû
& 
lim™
ècÚ¡ 
	gov”ride
;

112 
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
ècÚ¡ 
ov”ride
;

114 cÚ¡ 
Com·¿tÜ
* 
u£r_com·¿tÜ
(ècÚ¡ {  
	gu£r_com·¿tÜ_
; }

116 
Com·»
(cÚ¡ 
IÁ”ÇlKey
& 
a
, cÚ¡ IÁ”ÇlKey& 
b
) const;

120 şas 
	cIÁ”ÇlF‹rPŞicy
 : 
public
 
F‹rPŞicy
 {

121 
´iv©e
:

122 cÚ¡ 
F‹rPŞicy
* cÚ¡ 
u£r_pŞicy_
;

124 
	gpublic
:

125 
ex¶ic™
 
IÁ”ÇlF‹rPŞicy
(cÚ¡ 
F‹rPŞicy
* 
p
è: 
u£r_pŞicy_
(p) {}

126 cÚ¡ * 
Name
(ècÚ¡ 
ov”ride
;

127 
C»©eF‹r
(cÚ¡ 
Sliû
* 
keys
, 
n
, 
¡d
::
¡ršg
* 
d¡
ècÚ¡ 
ov”ride
;

128 
boŞ
 
KeyMayM©ch
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
f‹r
ècÚ¡ 
	gov”ride
;

134 şas 
	cIÁ”ÇlKey
 {

135 
	g´iv©e
:

136 
¡d
::
¡ršg
 
»p_
;

138 
	gpublic
:

139 
IÁ”ÇlKey
() {}

140 
IÁ”ÇlKey
(cÚ¡ 
Sliû
& 
u£r_key
, 
Sequ’ûNumb”
 
s
, 
V®ueTy³
 
t
) {

141 
Aµ’dIÁ”ÇlKey
(&
»p_
, 
P¬£dIÁ”ÇlKey
(
u£r_key
, 
s
, 
t
));

144 
boŞ
 
DecodeFrom
(cÚ¡ 
Sliû
& 
s
) {

145 
	g»p_
.
assign
(
s
.
d©a
(), s.
size
());

146  !
	g»p_
.
em±y
();

149 
Sliû
 
Encode
() const {

150 
as£¹
(!
»p_
.
em±y
());

151  
	g»p_
;

154 
Sliû
 
u£r_key
(ècÚ¡ {  
ExŒaùU£rKey
(
»p_
); }

156 
S‘From
(cÚ¡ 
P¬£dIÁ”ÇlKey
& 
p
) {

157 
	g»p_
.
ş—r
();

158 
Aµ’dIÁ”ÇlKey
(&
»p_
, 
p
);

161 
CË¬
(è{ 
	g»p_
.
ş—r
(); }

163 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

166 
šlše
 
	gIÁ”ÇlKeyCom·¿tÜ
::
	$Com·»
(cÚ¡ 
IÁ”ÇlKey
& 
a
,

167 cÚ¡ 
IÁ”ÇlKey
& 
b
) const {

168  
	`Com·»
(
a
.
	`Encode
(), 
b
.Encode());

169 
	}
}

171 
šlše
 
boŞ
 
	$P¬£IÁ”ÇlKey
(cÚ¡ 
Sliû
& 
š‹º®_key
,

172 
P¬£dIÁ”ÇlKey
* 
»suÉ
) {

173 cÚ¡ 
size_t
 
n
 = 
š‹º®_key
.
	`size
();

174 ià(
n
 < 8è 
çl£
;

175 
ušt64_t
 
num
 = 
	`DecodeFixed64
(
š‹º®_key
.
	`d©a
(è+ 
n
 - 8);

176 
ušt8_t
 
c
 = 
num
 & 0xff;

177 
»suÉ
->
£qu’û
 = 
num
 >> 8;

178 
»suÉ
->
ty³
 = 
¡©ic_ÿ¡
<
V®ueTy³
>(
c
);

179 
»suÉ
->
u£r_key
 = 
	`Sliû
(
š‹º®_key
.
	`d©a
(), 
n
 - 8);

180  (
c
 <ğ
¡©ic_ÿ¡
<
ušt8_t
>(
kTy³V®ue
));

181 
	}
}

184 şas 
	cLookupKey
 {

185 
	gpublic
:

188 
LookupKey
(cÚ¡ 
Sliû
& 
u£r_key
, 
Sequ’ûNumb”
 
£qu’û
);

190 
LookupKey
(cÚ¡ LookupKey&èğ
d–‘e
;

191 
	gLookupKey
& 
	gİ”©Ü
=(cÚ¡ 
LookupKey
&èğ
d–‘e
;

193 ~
LookupKey
();

196 
Sliû
 
membË_key
(ècÚ¡ {  Sliû(
¡¬t_
, 
’d_
 - start_); }

199 
Sliû
 
š‹º®_key
(ècÚ¡ {  Sliû(
k¡¬t_
, 
’d_
 - kstart_); }

202 
Sliû
 
u£r_key
(ècÚ¡ {  Sliû(
k¡¬t_
, 
’d_
 - kstart_ - 8); }

204 
	g´iv©e
:

212 cÚ¡ * 
¡¬t_
;

213 cÚ¡ * 
	gk¡¬t_
;

214 cÚ¡ * 
	g’d_
;

215 
	g¥aû_
[200];

218 
šlše
 
	gLookupKey
::~
	$LookupKey
() {

219 ià(
¡¬t_
 !ğ
¥aû_
è
d–‘e
[] start_;

220 
	}
}

	@dbformat_test.cc

5 
	~"db/dbfÜm©.h
"

7 
	~"g‹¡/g‹¡.h
"

8 
	~"ut/loggšg.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
	g¡d
::
¡ršg
 
IKey
(cÚ¡ 
¡d
::¡ršg& 
u£r_key
, 
ušt64_t
 
£q
,

13 
V®ueTy³
 
vt
) {

14 
	g¡d
::
¡ršg
 
’coded
;

15 
Aµ’dIÁ”ÇlKey
(&
’coded
, 
P¬£dIÁ”ÇlKey
(
u£r_key
, 
£q
, 
vt
));

16  
	g’coded
;

19 
	g¡d
::
¡ršg
 
ShÜ‹n
(cÚ¡ 
¡d
::¡ršg& 
s
, cÚ¡ std::¡ršg& 
l
) {

20 
¡d
::
¡ršg
 
»suÉ
 = 
s
;

21 
IÁ”ÇlKeyCom·¿tÜ
(
By‹wi£Com·¿tÜ
()).
FšdShÜ‹¡S•¬©Ü
(&
»suÉ
, 
l
);

22  
	g»suÉ
;

25 
	g¡d
::
¡ršg
 
ShÜtSucûssÜ
(cÚ¡ 
¡d
::¡ršg& 
s
) {

26 
¡d
::
¡ršg
 
»suÉ
 = 
s
;

27 
IÁ”ÇlKeyCom·¿tÜ
(
By‹wi£Com·¿tÜ
()).
FšdShÜtSucûssÜ
(&
»suÉ
);

28  
	g»suÉ
;

31 
Te¡Key
(cÚ¡ 
¡d
::
¡ršg
& 
key
, 
ušt64_t
 
£q
, 
V®ueTy³
 
vt
) {

32 
	g¡d
::
¡ršg
 
’coded
 = 
IKey
(
key
, 
£q
, 
vt
);

34 
Sliû
 
š
(
’coded
);

35 
P¬£dIÁ”ÇlKey
 
decoded
("", 0, 
kTy³V®ue
);

37 
ASSERT_TRUE
(
P¬£IÁ”ÇlKey
(
š
, &
decoded
));

38 
ASSERT_EQ
(
key
, 
decoded
.
u£r_key
.
ToSŒšg
());

39 
ASSERT_EQ
(
£q
, 
decoded
.
£qu’û
);

40 
ASSERT_EQ
(
vt
, 
decoded
.
ty³
);

42 
ASSERT_TRUE
(!
P¬£IÁ”ÇlKey
(
Sliû
("b¬"), &
decoded
));

45 
TEST
(
FÜm©Te¡
, 
IÁ”ÇlKey_EncodeDecode
) {

46 cÚ¡ * 
	gkeys
[] = {"", "k", "hello", "longggggggggggggggggggggg"};

47 cÚ¡ 
ušt64_t
 
	g£q
[] = {1,

59 
	gk
 = 0; k < (
	gkeys
) / (keys[0]); k++) {

60 
	gs
 = 0; s < (
	g£q
) / (seq[0]); s++) {

61 
Te¡Key
(
keys
[
k
], 
£q
[
s
], 
kTy³V®ue
);

62 
Te¡Key
("h–lo", 1, 
kTy³D–‘iÚ
);

67 
TEST
(
FÜm©Te¡
, 
IÁ”ÇlKey_DecodeFromEm±y
) {

68 
IÁ”ÇlKey
 
	gš‹º®_key
;

70 
ASSERT_TRUE
(!
š‹º®_key
.
DecodeFrom
(""));

73 
TEST
(
FÜm©Te¡
, 
IÁ”ÇlKeyShÜtS•¬©Ü
) {

75 
ASSERT_EQ
(
IKey
("foo", 100, 
kTy³V®ue
),

76 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("foo", 99, kTypeValue)));

77 
ASSERT_EQ
(

78 
IKey
("foo", 100, 
kTy³V®ue
),

79 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("foo", 101, kTypeValue)));

80 
ASSERT_EQ
(

81 
IKey
("foo", 100, 
kTy³V®ue
),

82 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("foo", 100, kTypeValue)));

83 
ASSERT_EQ
(

84 
IKey
("foo", 100, 
kTy³V®ue
),

85 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("foo", 100, 
kTy³D–‘iÚ
)));

88 
ASSERT_EQ
(
IKey
("foo", 100, 
kTy³V®ue
),

89 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("bar", 99, kTypeValue)));

92 
ASSERT_EQ
(

93 
IKey
("g", 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
),

94 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("hello", 200, kTypeValue)));

97 
ASSERT_EQ
(

98 
IKey
("foo", 100, 
kTy³V®ue
),

99 
ShÜ‹n
(
IKey
("foo", 100, 
kTy³V®ue
), IKey("foobar", 200, kTypeValue)));

102 
ASSERT_EQ
(

103 
IKey
("foob¬", 100, 
kTy³V®ue
),

104 
ShÜ‹n
(
IKey
("foob¬", 100, 
kTy³V®ue
), IKey("foo", 200, kTypeValue)));

107 
TEST
(
FÜm©Te¡
, 
IÁ”ÇlKeyShÜ‹¡SucûssÜ
) {

108 
ASSERT_EQ
(
IKey
("g", 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
),

109 
ShÜtSucûssÜ
(
IKey
("foo", 100, 
kTy³V®ue
)));

110 
ASSERT_EQ
(
IKey
("\xff\xff", 100, 
kTy³V®ue
),

111 
ShÜtSucûssÜ
(
IKey
("\xff\xff", 100, 
kTy³V®ue
)));

114 
TEST
(
FÜm©Te¡
, 
P¬£dIÁ”ÇlKeyDebugSŒšg
) {

115 
P¬£dIÁ”ÇlKey
 
key
("Th\"key\" iÀ'sšgË quÙes'", 42, 
kTy³V®ue
);

117 
ASSERT_EQ
("'Th\"key\" iÀ'sšgË quÙes'' @ 42 : 1", 
key
.
DebugSŒšg
());

120 
TEST
(
FÜm©Te¡
, 
IÁ”ÇlKeyDebugSŒšg
) {

121 
IÁ”ÇlKey
 
key
("Th\"key\" iÀ'sšgË quÙes'", 42, 
kTy³V®ue
);

122 
ASSERT_EQ
("'Th\"key\" iÀ'sšgË quÙes'' @ 42 : 1", 
key
.
DebugSŒšg
());

124 
IÁ”ÇlKey
 
	gšv®id_key
;

125 
ASSERT_EQ
("(bad)", 
šv®id_key
.
DebugSŒšg
());

130 
	$maš
(
¬gc
, ** 
¬gv
) {

131 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

132  
	`RUN_ALL_TESTS
();

133 
	}
}

	@dumpfile.cc

5 
	~"Ëv–db/dumpfe.h
"

7 
	~<¡dio.h
>

9 
	~"db/dbfÜm©.h
"

10 
	~"db/f’ame.h
"

11 
	~"db/log_»ad”.h
"

12 
	~"db/v”siÚ_ed™.h
"

13 
	~"db/wr™e_b©ch_š‹º®.h
"

14 
	~"Ëv–db/’v.h
"

15 
	~"Ëv–db/™”©Ü.h
"

16 
	~"Ëv–db/İtiÚs.h
"

17 
	~"Ëv–db/¡©us.h
"

18 
	~"Ëv–db/bË.h
"

19 
	~"Ëv–db/wr™e_b©ch.h
"

20 
	~"ut/loggšg.h
"

22 
Çme¥aû
 
	gËv–db
 {

24 
	gÇme¥aû
 {

26 
boŞ
 
GuessTy³
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FeTy³
* 
ty³
) {

27 
size_t
 
	gpos
 = 
âame
.
rfšd
('/');

28 
	g¡d
::
¡ršg
 
ba£Çme
;

29 ià(
	gpos
 =ğ
¡d
::
¡ršg
::
Åos
) {

30 
ba£Çme
 = 
âame
;

32 
	gba£Çme
 = 
¡d
::
¡ršg
(
âame
.
d©a
(è+ 
pos
 + 1, fÇme.
size
() -…os - 1);

34 
ušt64_t
 
	gignÜed
;

35  
P¬£FeName
(
ba£Çme
, &
ignÜed
, 
ty³
);

39 şas 
	cCÜru±iÚR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

40 
public
:

41 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
¡©us
è
	gov”ride
 {

42 
	g¡d
::
¡ršg
 
r
 = "corruption: ";

43 
Aµ’dNumb”To
(&
r
, 
by‹s
);

44 
	gr
 += " bytes; ";

45 
	gr
 +ğ
¡©us
.
ToSŒšg
();

46 
	gr
.
push_back
('\n');

47 
	gd¡_
->
Aµ’d
(
r
);

50 
Wr™abËFe
* 
	gd¡_
;

54 
Stus
 
PrštLogCÚ‹Ás
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
,

55 (*
func
)(
ušt64_t
, 
Sliû
, 
Wr™abËFe
*),

56 
Wr™abËFe
* 
d¡
) {

57 
Sequ’tŸlFe
* 
	gfe
;

58 
Stus
 
	gs
 = 
’v
->
NewSequ’tŸlFe
(
âame
, &
fe
);

59 ià(!
	gs
.
ok
()) {

60  
	gs
;

62 
CÜru±iÚR•Ü‹r
 
	g»pÜ‹r
;

63 
	g»pÜ‹r
.
	gd¡_
 = 
d¡
;

64 
	glog
::
R—d”
 
»ad”
(
fe
, &
»pÜ‹r
, 
Œue
, 0);

65 
Sliû
 
	g»cÜd
;

66 
	g¡d
::
¡ršg
 
sü©ch
;

67 
	g»ad”
.
R—dRecÜd
(&
»cÜd
, &
sü©ch
)) {

68 (*
	gfunc
)(
	g»ad”
.
La¡RecÜdOff£t
(), 
	g»cÜd
, 
	gd¡
);

70 
d–‘e
 
	gfe
;

71  
	gStus
::
OK
();

75 şas 
	cWr™eB©chI‹mPrš‹r
 : 
public
 
Wr™eB©ch
::
HªdËr
 {

76 
public
:

77 
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
è
	gov”ride
 {

78 
	g¡d
::
¡ršg
 
r
 = "…ut '";

79 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
key
);

80 
	gr
 += "' '";

81 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
v®ue
);

82 
	gr
 += "'\n";

83 
	gd¡_
->
Aµ’d
(
r
);

85 
D–‘e
(cÚ¡ 
Sliû
& 
key
è
	gov”ride
 {

86 
	g¡d
::
¡ršg
 
r
 = " del '";

87 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
key
);

88 
	gr
 += "'\n";

89 
	gd¡_
->
Aµ’d
(
r
);

92 
Wr™abËFe
* 
	gd¡_
;

97 
Wr™eB©chPrš‹r
(
ušt64_t
 
pos
, 
Sliû
 
»cÜd
, 
Wr™abËFe
* 
d¡
) {

98 
	g¡d
::
¡ršg
 
r
 = "--- offset ";

99 
Aµ’dNumb”To
(&
r
, 
pos
);

100 
	gr
 += "; ";

101 ià(
	g»cÜd
.
size
() < 12) {

102 
	gr
 += "log„ecord†ength ";

103 
Aµ’dNumb”To
(&
r
, 
»cÜd
.
size
());

104 
	gr
 += " isoo small\n";

105 
	gd¡
->
Aµ’d
(
r
);

108 
Wr™eB©ch
 
	gb©ch
;

109 
	gWr™eB©chIÁ”Çl
::
S‘CÚ‹Ás
(&
b©ch
, 
»cÜd
);

110 
	gr
 += "sequence ";

111 
Aµ’dNumb”To
(&
r
, 
Wr™eB©chIÁ”Çl
::
Sequ’û
(&
b©ch
));

112 
	gr
.
push_back
('\n');

113 
	gd¡
->
Aµ’d
(
r
);

114 
Wr™eB©chI‹mPrš‹r
 
	gb©ch_™em_´š‹r
;

115 
	gb©ch_™em_´š‹r
.
	gd¡_
 = 
d¡
;

116 
Stus
 
	gs
 = 
b©ch
.
I‹¿‹
(&
b©ch_™em_´š‹r
);

117 ià(!
	gs
.
ok
()) {

118 
	gd¡
->
Aµ’d
("ƒ¼Ü: " + 
s
.
ToSŒšg
() + "\n");

122 
Stus
 
DumpLog
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
Wr™abËFe
* 
d¡
) {

123  
PrštLogCÚ‹Ás
(
’v
, 
âame
, 
Wr™eB©chPrš‹r
, 
d¡
);

128 
V”siÚEd™Prš‹r
(
ušt64_t
 
pos
, 
Sliû
 
»cÜd
, 
Wr™abËFe
* 
d¡
) {

129 
	g¡d
::
¡ršg
 
r
 = "--- offset ";

130 
Aµ’dNumb”To
(&
r
, 
pos
);

131 
	gr
 += "; ";

132 
V”siÚEd™
 
	ged™
;

133 
Stus
 
	gs
 = 
ed™
.
DecodeFrom
(
»cÜd
);

134 ià(!
	gs
.
ok
()) {

135 
	gr
 +ğ
s
.
ToSŒšg
();

136 
	gr
.
push_back
('\n');

138 
	gr
 +ğ
ed™
.
DebugSŒšg
();

140 
	gd¡
->
Aµ’d
(
r
);

143 
Stus
 
DumpDesütÜ
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
Wr™abËFe
* 
d¡
) {

144  
PrštLogCÚ‹Ás
(
’v
, 
âame
, 
V”siÚEd™Prš‹r
, 
d¡
);

147 
Stus
 
DumpTabË
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
Wr™abËFe
* 
d¡
) {

148 
ušt64_t
 
	gfe_size
;

149 
RªdomAcûssFe
* 
	gfe
 = 
nuÎ±r
;

150 
TabË
* 
	gbË
 = 
nuÎ±r
;

151 
Stus
 
	gs
 = 
’v
->
G‘FeSize
(
âame
, &
fe_size
);

152 ià(
	gs
.
ok
()) {

153 
	gs
 = 
’v
->
NewRªdomAcûssFe
(
âame
, &
fe
);

155 ià(
	gs
.
ok
()) {

160 
	gs
 = 
TabË
::
O³n
(
O±iÚs
(), 
fe
, 
fe_size
, &
bË
);

162 ià(!
	gs
.
ok
()) {

163 
d–‘e
 
	gbË
;

164 
d–‘e
 
	gfe
;

165  
	gs
;

168 
R—dO±iÚs
 
	gro
;

169 
	gro
.
	gfl_ÿche
 = 
çl£
;

170 
I‹¿tÜ
* 
	g™”
 = 
bË
->
NewI‹¿tÜ
(
ro
);

171 
	g¡d
::
¡ršg
 
r
;

172 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

173 
	gr
.
ş—r
();

174 
P¬£dIÁ”ÇlKey
 
	gkey
;

175 ià(!
P¬£IÁ”ÇlKey
(
™”
->
key
(), &key)) {

176 
	gr
 = "badkey '";

177 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
™”
->
key
());

178 
	gr
 += "' => '";

179 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
™”
->
v®ue
());

180 
	gr
 += "'\n";

181 
	gd¡
->
Aµ’d
(
r
);

183 
	gr
 = "'";

184 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
key
.
u£r_key
);

185 
	gr
 += "' @ ";

186 
Aµ’dNumb”To
(&
r
, 
key
.
£qu’û
);

187 
	gr
 += " : ";

188 ià(
	gkey
.
	gty³
 =ğ
kTy³D–‘iÚ
) {

189 
r
 += "del";

190 } ià(
	gkey
.
	gty³
 =ğ
kTy³V®ue
) {

191 
r
 += "val";

193 
Aµ’dNumb”To
(&
r
, 
key
.
ty³
);

195 
	gr
 += " => '";

196 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
™”
->
v®ue
());

197 
	gr
 += "'\n";

198 
	gd¡
->
Aµ’d
(
r
);

201 
	gs
 = 
™”
->
¡©us
();

202 ià(!
	gs
.
ok
()) {

203 
	gd¡
->
Aµ’d
("™”©Üƒ¼Ü: " + 
s
.
ToSŒšg
() + "\n");

206 
d–‘e
 
	g™”
;

207 
d–‘e
 
	gbË
;

208 
d–‘e
 
	gfe
;

209  
	gStus
::
OK
();

214 
Stus
 
	$DumpFe
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
Wr™abËFe
* 
d¡
) {

215 
FeTy³
 
áy³
;

216 ià(!
	`GuessTy³
(
âame
, &
áy³
)) {

217  
Stus
::
	`Inv®idArgum’t
(
âame
 + ": unknown fileype");

219 
áy³
) {

220 
kLogFe
:

221  
	`DumpLog
(
’v
, 
âame
, 
d¡
);

222 
kDesütÜFe
:

223  
	`DumpDesütÜ
(
’v
, 
âame
, 
d¡
);

224 
kTabËFe
:

225  
	`DumpTabË
(
’v
, 
âame
, 
d¡
);

229  
Stus
::
	`Inv®idArgum’t
(
âame
 + ":‚ot‡ dump-able fileype");

230 
	}
}

	@fault_injection_test.cc

9 
	~<m­
>

10 
	~<£t
>

12 
	~"g‹¡/g‹¡.h
"

13 
	~"db/db_im¶.h
"

14 
	~"db/f’ame.h
"

15 
	~"db/log_fÜm©.h
"

16 
	~"db/v”siÚ_£t.h
"

17 
	~"Ëv–db/ÿche.h
"

18 
	~"Ëv–db/db.h
"

19 
	~"Ëv–db/’v.h
"

20 
	~"Ëv–db/bË.h
"

21 
	~"Ëv–db/wr™e_b©ch.h
"

22 
	~"pÜt/pÜt.h
"

23 
	~"pÜt/th»ad_ªnÙ©iÚs.h
"

24 
	~"ut/loggšg.h
"

25 
	~"ut/mu‹xlock.h
"

26 
	~"ut/‹¡ut.h
"

28 
Çme¥aû
 
	gËv–db
 {

30 cÚ¡ 
	gkV®ueSize
 = 1000;

31 cÚ¡ 
	gkMaxNumV®ues
 = 2000;

32 cÚ¡ 
size_t
 
	gkNumI‹¿tiÚs
 = 3;

34 
şass
 
	gFauÉInjeùiÚTe¡Env
;

36 
	gÇme¥aû
 {

39 
	g¡d
::
¡ršg
 
G‘DœName
(cÚ¡ 
¡d
::¡ršg& 
f’ame
) {

40 
size_t
 
found
 = 
f’ame
.
fšd_Ï¡_of
("/\\");

41 ià(
	gfound
 =ğ
¡d
::
¡ršg
::
Åos
) {

44  
	gf’ame
.
sub¡r
(0, 
found
);

48 
Stus
 
SyncDœ
(cÚ¡ 
¡d
::
¡ršg
& 
dœ
) {

50  
Stus
::
OK
();

54 
Stus
 
Trunÿ‹
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
, 
ušt64_t
 
Ëngth
) {

55 
	gËv–db
::
Env
* 
’v
 = 
Ëv–db
::Env::
DeçuÉ
();

57 
Sequ’tŸlFe
* 
	gÜig_fe
;

58 
Stus
 
	gs
 = 
’v
->
NewSequ’tŸlFe
(
f’ame
, &
Üig_fe
);

59 ià(!
	gs
.
ok
())  s;

61 * 
	gsü©ch
 = 
Ãw
 [
Ëngth
];

62 
	gËv–db
::
Sliû
 
»suÉ
;

63 
	gs
 = 
Üig_fe
->
R—d
(
Ëngth
, &
»suÉ
, 
sü©ch
);

64 
d–‘e
 
	gÜig_fe
;

65 ià(
	gs
.
ok
()) {

66 
	g¡d
::
¡ršg
 
tmp_Çme
 = 
G‘DœName
(
f’ame
) + "/truncate.tmp";

67 
Wr™abËFe
* 
	gtmp_fe
;

68 
	gs
 = 
’v
->
NewWr™abËFe
(
tmp_Çme
, &
tmp_fe
);

69 ià(
	gs
.
ok
()) {

70 
	gs
 = 
tmp_fe
->
Aµ’d
(
»suÉ
);

71 
d–‘e
 
	gtmp_fe
;

72 ià(
	gs
.
ok
()) {

73 
	gs
 = 
’v
->
R’ameFe
(
tmp_Çme
, 
f’ame
);

75 
	g’v
->
RemoveFe
(
tmp_Çme
);

80 
	gd–‘e
[] 
	gsü©ch
;

82  
	gs
;

85 
	sFeS‹
 {

86 
	g¡d
::
¡ršg
 
f’ame_
;

87 
št64_t
 
	gpos_
;

88 
št64_t
 
	gpos_©_Ï¡_sync_
;

89 
št64_t
 
	gpos_©_Ï¡_æush_
;

91 
FeS‹
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
)

92 : 
f’ame_
(
f’ame
),

93 
pos_
(-1),

94 
pos_©_Ï¡_sync_
(-1),

95 
pos_©_Ï¡_æush_
(-1) {}

97 
FeS‹
(è: 
pos_
(-1), 
pos_©_Ï¡_sync_
(-1), 
pos_©_Ï¡_æush_
(-1) {}

99 
boŞ
 
IsFuÎySynûd
(ècÚ¡ {  
	gpos_
 <ğ0 || 
pos_
 =ğ
pos_©_Ï¡_sync_
; }

101 
Stus
 
DrİUnsynûdD©a
() const;

108 şas 
	cTe¡Wr™abËFe
 : 
public
 
Wr™abËFe
 {

109 
public
:

110 
Te¡Wr™abËFe
(cÚ¡ 
FeS‹
& 
¡©e
, 
Wr™abËFe
* 
f
,

111 
FauÉInjeùiÚTe¡Env
* 
’v
);

112 ~
Te¡Wr™abËFe
(è
	gov”ride
;

113 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
è
	gov”ride
;

114 
Stus
 
Clo£
(è
	gov”ride
;

115 
Stus
 
Flush
(è
	gov”ride
;

116 
Stus
 
Sync
(è
	gov”ride
;

118 
	g´iv©e
:

119 
FeS‹
 
¡©e_
;

120 
Wr™abËFe
* 
	grg‘_
;

121 
boŞ
 
	gwr™abË_fe_İ’ed_
;

122 
FauÉInjeùiÚTe¡Env
* 
	g’v_
;

124 
Stus
 
SyncP¬’t
();

127 şas 
	cFauÉInjeùiÚTe¡Env
 : 
public
 
EnvW¿µ”
 {

128 
public
:

129 
FauÉInjeùiÚTe¡Env
()

130 : 
EnvW¿µ”
(
Env
::
DeçuÉ
()), 
fesy¡em_aùive_
(
Œue
) {}

131 ~
FauÉInjeùiÚTe¡Env
(è
	gov”ride
 = ;

132 
Stus
 
NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

133 
Wr™abËFe
** 
»suÉ
è
	gov”ride
;

134 
Stus
 
NewAµ’dabËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

135 
Wr™abËFe
** 
»suÉ
è
	gov”ride
;

136 
Stus
 
RemoveFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
è
ov”ride
;

137 
Stus
 
R’ameFe
(cÚ¡ 
¡d
::
¡ršg
& 
s
, cÚ¡ std::¡ršg& 
t
è
ov”ride
;

139 
Wr™abËFeClo£d
(cÚ¡ 
FeS‹
& 
¡©e
);

140 
Stus
 
DrİUnsynûdFeD©a
();

141 
Stus
 
RemoveFesC»©edAá”La¡DœSync
();

142 
DœWasSynûd
();

143 
boŞ
 
IsFeC»©edSšûLa¡DœSync
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
);

144 
Re£tS‹
();

145 
UÁ¿ckFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
);

150 
boŞ
 
IsFesy¡emAùive
(è
LOCKS_EXCLUDED
(
mu‹x_
) {

151 
Mu‹xLock
 
l
(&
mu‹x_
);

152  
	gfesy¡em_aùive_
;

154 
S‘Fesy¡emAùive
(
boŞ
 
aùive
è
LOCKS_EXCLUDED
(
mu‹x_
) {

155 
Mu‹xLock
 
l
(&
mu‹x_
);

156 
	gfesy¡em_aùive_
 = 
aùive
;

159 
	g´iv©e
:

160 
pÜt
::
Mu‹x
 
mu‹x_
;

161 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gFeS‹
> 
db_fe_¡©e_
 
GUARDED_BY
(
mu‹x_
);

162 
	g¡d
::
£t
<
¡d
::
¡ršg
> 
Ãw_fes_sšû_Ï¡_dœ_sync_
 
GUARDED_BY
(
mu‹x_
);

163 
boŞ
 
fesy¡em_aùive_
 
GUARDED_BY
(
mu‹x_
);

166 
	gTe¡Wr™abËFe
::
	$Te¡Wr™abËFe
(cÚ¡ 
FeS‹
& 
¡©e
, 
Wr™abËFe
* 
f
,

167 
FauÉInjeùiÚTe¡Env
* 
’v
)

168 : 
	`¡©e_
(
¡©e
), 
	`rg‘_
(
f
), 
	`wr™abË_fe_İ’ed_
(
Œue
), 
	$’v_
(
’v
) {

169 
	`as£¹
(
f
 !ğ
nuÎ±r
);

170 
	}
}

172 
	gTe¡Wr™abËFe
::~
	$Te¡Wr™abËFe
() {

173 ià(
wr™abË_fe_İ’ed_
) {

174 
	`Clo£
();

176 
d–‘e
 
rg‘_
;

177 
	}
}

179 
Stus
 
	gTe¡Wr™abËFe
::
	$Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) {

180 
Stus
 
s
 = 
rg‘_
->
	`Aµ’d
(
d©a
);

181 ià(
s
.
	`ok
(è&& 
’v_
->
	`IsFesy¡emAùive
()) {

182 
¡©e_
.
pos_
 +ğ
d©a
.
	`size
();

184  
s
;

185 
	}
}

187 
Stus
 
	gTe¡Wr™abËFe
::
	$Clo£
() {

188 
wr™abË_fe_İ’ed_
 = 
çl£
;

189 
Stus
 
s
 = 
rg‘_
->
	`Clo£
();

190 ià(
s
.
	`ok
()) {

191 
’v_
->
	`Wr™abËFeClo£d
(
¡©e_
);

193  
s
;

194 
	}
}

196 
Stus
 
	gTe¡Wr™abËFe
::
	$Flush
() {

197 
Stus
 
s
 = 
rg‘_
->
	`Flush
();

198 ià(
s
.
	`ok
(è&& 
’v_
->
	`IsFesy¡emAùive
()) {

199 
¡©e_
.
pos_©_Ï¡_æush_
 = s‹_.
pos_
;

201  
s
;

202 
	}
}

204 
Stus
 
	gTe¡Wr™abËFe
::
	$SyncP¬’t
() {

205 
Stus
 
s
 = 
	`SyncDœ
(
	`G‘DœName
(
¡©e_
.
f’ame_
));

206 ià(
s
.
	`ok
()) {

207 
’v_
->
	`DœWasSynûd
();

209  
s
;

210 
	}
}

212 
Stus
 
	gTe¡Wr™abËFe
::
	$Sync
() {

213 ià(!
’v_
->
	`IsFesy¡emAùive
()) {

214  
Stus
::
	`OK
();

217 
Stus
 
s
 = 
rg‘_
->
	`Sync
();

218 ià(
s
.
	`ok
()) {

219 
¡©e_
.
pos_©_Ï¡_sync_
 = s‹_.
pos_
;

221 ià(
’v_
->
	`IsFeC»©edSšûLa¡DœSync
(
¡©e_
.
f’ame_
)) {

222 
Stus
 
ps
 = 
	`SyncP¬’t
();

223 ià(
s
.
	`ok
(è&& !
ps
.ok()) {

224 
s
 = 
ps
;

227  
s
;

228 
	}
}

230 
Stus
 
	gFauÉInjeùiÚTe¡Env
::
	$NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

231 
Wr™abËFe
** 
»suÉ
) {

232 
Wr™abËFe
* 
aùu®_wr™abË_fe
;

233 
Stus
 
s
 = 
	`rg‘
()->
	`NewWr™abËFe
(
âame
, &
aùu®_wr™abË_fe
);

234 ià(
s
.
	`ok
()) {

235 
FeS‹
 
	`¡©e
(
âame
);

236 
¡©e
.
pos_
 = 0;

237 *
»suÉ
 = 
Ãw
 
	`Te¡Wr™abËFe
(
¡©e
, 
aùu®_wr™abË_fe
, 
this
);

241 
	`UÁ¿ckFe
(
âame
);

242 
Mu‹xLock
 
	`l
(&
mu‹x_
);

243 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`š£¹
(
âame
);

245  
s
;

246 
	}
}

248 
Stus
 
	gFauÉInjeùiÚTe¡Env
::
	$NewAµ’dabËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

249 
Wr™abËFe
** 
»suÉ
) {

250 
Wr™abËFe
* 
aùu®_wr™abË_fe
;

251 
Stus
 
s
 = 
	`rg‘
()->
	`NewAµ’dabËFe
(
âame
, &
aùu®_wr™abË_fe
);

252 ià(
s
.
	`ok
()) {

253 
FeS‹
 
	`¡©e
(
âame
);

254 
¡©e
.
pos_
 = 0;

256 
Mu‹xLock
 
	`l
(&
mu‹x_
);

257 ià(
db_fe_¡©e_
.
	`couÁ
(
âame
) == 0) {

258 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`š£¹
(
âame
);

260 
¡©e
 = 
db_fe_¡©e_
[
âame
];

263 *
»suÉ
 = 
Ãw
 
	`Te¡Wr™abËFe
(
¡©e
, 
aùu®_wr™abË_fe
, 
this
);

265  
s
;

266 
	}
}

268 
Stus
 
	gFauÉInjeùiÚTe¡Env
::
	$DrİUnsynûdFeD©a
() {

269 
Stus
 
s
;

270 
Mu‹xLock
 
	`l
(&
mu‹x_
);

271 cÚ¡‡uto& 
kvp
 : 
db_fe_¡©e_
) {

272 ià(!
s
.
	`ok
()) {

275 cÚ¡ 
FeS‹
& 
¡©e
 = 
kvp
.
£cÚd
;

276 ià(!
¡©e
.
	`IsFuÎySynûd
()) {

277 
s
 = 
¡©e
.
	`DrİUnsynûdD©a
();

280  
s
;

281 
	}
}

283 
	gFauÉInjeùiÚTe¡Env
::
	$DœWasSynûd
() {

284 
Mu‹xLock
 
	`l
(&
mu‹x_
);

285 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`ş—r
();

286 
	}
}

288 
boŞ
 
	gFauÉInjeùiÚTe¡Env
::
	$IsFeC»©edSšûLa¡DœSync
(

289 cÚ¡ 
¡d
::
¡ršg
& 
f’ame
) {

290 
Mu‹xLock
 
	`l
(&
mu‹x_
);

291  
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`fšd
(
f’ame
) !=

292 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`’d
();

293 
	}
}

295 
	gFauÉInjeùiÚTe¡Env
::
	$UÁ¿ckFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
) {

296 
Mu‹xLock
 
	`l
(&
mu‹x_
);

297 
db_fe_¡©e_
.
	`”a£
(
f
);

298 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`”a£
(
f
);

299 
	}
}

301 
Stus
 
	gFauÉInjeùiÚTe¡Env
::
	$RemoveFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
) {

302 
Stus
 
s
 = 
EnvW¿µ”
::
	`RemoveFe
(
f
);

303 
	`EXPECT_LEVELDB_OK
(
s
);

304 ià(
s
.
	`ok
()) {

305 
	`UÁ¿ckFe
(
f
);

307  
s
;

308 
	}
}

310 
Stus
 
	gFauÉInjeùiÚTe¡Env
::
	$R’ameFe
(cÚ¡ 
¡d
::
¡ršg
& 
s
,

311 cÚ¡ 
¡d
::
¡ršg
& 
t
) {

312 
Stus
 
»t
 = 
EnvW¿µ”
::
	`R’ameFe
(
s
, 
t
);

314 ià(
»t
.
	`ok
()) {

315 
Mu‹xLock
 
	`l
(&
mu‹x_
);

316 ià(
db_fe_¡©e_
.
	`fšd
(
s
è!ğdb_fe_¡©e_.
	`’d
()) {

317 
db_fe_¡©e_
[
t
] = db_fe_¡©e_[
s
];

318 
db_fe_¡©e_
.
	`”a£
(
s
);

321 ià(
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`”a£
(
s
) != 0) {

322 
	`as£¹
(
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`fšd
(
t
) ==

323 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`’d
());

324 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`š£¹
(
t
);

328  
»t
;

329 
	}
}

331 
	gFauÉInjeùiÚTe¡Env
::
	$Re£tS‹
() {

335 
	`S‘Fesy¡emAùive
(
Œue
);

336 
	}
}

338 
Stus
 
	gFauÉInjeùiÚTe¡Env
::
	$RemoveFesC»©edAá”La¡DœSync
() {

340 
mu‹x_
.
	`Lock
();

341 
¡d
::
£t
<¡d::
¡ršg
> 
	`Ãw_fes
(
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`begš
(),

342 
Ãw_fes_sšû_Ï¡_dœ_sync_
.
	`’d
());

343 
mu‹x_
.
	`UÆock
();

344 
Stus
 
¡©us
;

345 cÚ¡‡uto& 
Ãw_fe
 : 
Ãw_fes
) {

346 
Stus
 
»move_¡©us
 = 
	`RemoveFe
(
Ãw_fe
);

347 ià(!
»move_¡©us
.
	`ok
(è&& 
¡©us
.ok()) {

348 
¡©us
 = 
¡d
::
	`move
(
»move_¡©us
);

351  
¡©us
;

352 
	}
}

354 
	gFauÉInjeùiÚTe¡Env
::
	$Wr™abËFeClo£d
(cÚ¡ 
FeS‹
& 
¡©e
) {

355 
Mu‹xLock
 
	`l
(&
mu‹x_
);

356 
db_fe_¡©e_
[
¡©e
.
f’ame_
] = state;

357 
	}
}

359 
Stus
 
	gFeS‹
::
	$DrİUnsynûdD©a
() const {

360 
št64_t
 
sync_pos
 = 
pos_©_Ï¡_sync_
 == -1 ? 0 :…os_at_last_sync_;

361  
	`Trunÿ‹
(
f’ame_
, 
sync_pos
);

362 
	}
}

364 şas 
	cFauÉInjeùiÚTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

365 
public
:

366 
	eEx³ùedV”ifResuÉ
 { 
VAL_EXPECT_NO_ERROR
, 
	gVAL_EXPECT_ERROR
 };

367 
	eRe£tM‘hod
 { 
	gRESET_DROP_UNSYNCED_DATA
, 
	gRESET_DELETE_UNSYNCED_FILES
 };

369 
FauÉInjeùiÚTe¡Env
* 
	g’v_
;

370 
	g¡d
::
¡ršg
 
dbÇme_
;

371 
Cache
* 
	gtšy_ÿche_
;

372 
O±iÚs
 
	gİtiÚs_
;

373 
DB
* 
	gdb_
;

375 
FauÉInjeùiÚTe¡
()

376 : 
’v_
(
Ãw
 
FauÉInjeùiÚTe¡Env
),

377 
tšy_ÿche_
(
NewLRUCache
(100)),

378 
db_
(
nuÎ±r
) {

379 
	gdbÇme_
 = 
‹¡šg
::
TempDœ
() + "fault_test";

380 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

381 
	gİtiÚs_
.
	g»u£_logs
 = 
Œue
;

382 
	gİtiÚs_
.
	g’v
 = 
’v_
;

383 
	gİtiÚs_
.
	g·¿noid_checks
 = 
Œue
;

384 
	gİtiÚs_
.
	gblock_ÿche
 = 
tšy_ÿche_
;

385 
	gİtiÚs_
.
	gü—‹_if_missšg
 = 
Œue
;

388 ~
FauÉInjeùiÚTe¡
() {

389 
Clo£DB
();

390 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

391 
d–‘e
 
	gtšy_ÿche_
;

392 
d–‘e
 
	g’v_
;

395 
Reu£Logs
(
boŞ
 
»u£
è{ 
	gİtiÚs_
.
	g»u£_logs
 =„euse; }

397 
Bud
(
¡¬t_idx
, 
num_v®s
) {

398 
	g¡d
::
¡ršg
 
key_¥aû
, 
	gv®ue_¥aû
;

399 
Wr™eB©ch
 
	gb©ch
;

400 
	gi
 = 
¡¬t_idx
; i < 
	g¡¬t_idx
 + 
	gnum_v®s
; i++) {

401 
Sliû
 
	gkey
 = 
Key
(
i
, &
key_¥aû
);

402 
	gb©ch
.
CË¬
();

403 
	gb©ch
.
Put
(
key
, 
V®ue
(
i
, &
v®ue_¥aû
));

404 
Wr™eO±iÚs
 
	gİtiÚs
;

405 
ASSERT_LEVELDB_OK
(
db_
->
Wr™e
(
İtiÚs
, &
b©ch
));

409 
Stus
 
R—dV®ue
(
i
, 
¡d
::
¡ršg
* 
v®
) const {

410 
¡d
::
¡ršg
 
key_¥aû
, 
	gv®ue_¥aû
;

411 
Sliû
 
	gkey
 = 
Key
(
i
, &
key_¥aû
);

412 
V®ue
(
i
, &
v®ue_¥aû
);

413 
R—dO±iÚs
 
	gİtiÚs
;

414  
	gdb_
->
G‘
(
İtiÚs
, 
key
, 
v®
);

417 
Stus
 
V”ify
(
¡¬t_idx
, 
num_v®s
,

418 
Ex³ùedV”ifResuÉ
 
ex³ùed
) const {

419 
	g¡d
::
¡ršg
 
v®
;

420 
	g¡d
::
¡ršg
 
v®ue_¥aû
;

421 
Stus
 
	gs
;

422 
	gi
 = 
¡¬t_idx
; i < 
	g¡¬t_idx
 + 
	gnum_v®s
 && 
	gs
.
ok
(); i++) {

423 
V®ue
(
i
, &
v®ue_¥aû
);

424 
	gs
 = 
R—dV®ue
(
i
, &
v®
);

425 ià(
	gex³ùed
 =ğ
VAL_EXPECT_NO_ERROR
) {

426 ià(
s
.
ok
()) {

427 
EXPECT_EQ
(
v®ue_¥aû
, 
v®
);

429 } ià(
	gs
.
ok
()) {

430 
årštf
(
¡d”r
, "Ex³ùed‡À”rÜ‡ˆ%d, buˆwa OK\n", 
i
);

431 
	gs
 = 
Stus
::
IOE¼Ü
(
dbÇme_
, "Expected valueƒrror:");

433 
	gs
 = 
Stus
::
OK
();

436  
	gs
;

440 
Sliû
 
Key
(
i
, 
¡d
::
¡ršg
* 
¡Üage
) const {

441 
buf
[100];

442 
¢´štf
(
buf
, (buf), "%016d", 
i
);

443 
	g¡Üage
->
assign
(
buf
, 
¡¾’
(buf));

444  
Sliû
(*
¡Üage
);

448 
Sliû
 
V®ue
(
k
, 
¡d
::
¡ršg
* 
¡Üage
) const {

449 
Rªdom
 
r
(
k
);

450  
	g‹¡
::
RªdomSŒšg
(&
r
, 
kV®ueSize
, 
¡Üage
);

453 
Stus
 
O³nDB
() {

454 
d–‘e
 
	gdb_
;

455 
	gdb_
 = 
nuÎ±r
;

456 
	g’v_
->
Re£tS‹
();

457  
	gDB
::
O³n
(
İtiÚs_
, 
dbÇme_
, &
db_
);

460 
Clo£DB
() {

461 
d–‘e
 
	gdb_
;

462 
	gdb_
 = 
nuÎ±r
;

465 
D–‘eAÎD©a
() {

466 
I‹¿tÜ
* 
	g™”
 = 
db_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

467 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

468 
ASSERT_LEVELDB_OK
(
db_
->
D–‘e
(
Wr™eO±iÚs
(), 
™”
->
key
()));

471 
d–‘e
 
	g™”
;

474 
Re£tDBS‹
(
Re£tM‘hod
 
»£t_m‘hod
) {

475 
	g»£t_m‘hod
) {

476 
	gRESET_DROP_UNSYNCED_DATA
:

477 
ASSERT_LEVELDB_OK
(
’v_
->
DrİUnsynûdFeD©a
());

479 
	gRESET_DELETE_UNSYNCED_FILES
:

480 
ASSERT_LEVELDB_OK
(
’v_
->
RemoveFesC»©edAá”La¡DœSync
());

483 
as£¹
(
çl£
);

487 
P¬tŸlCom·ùTe¡P»FauÉ
(
num_´e_sync
, 
num_po¡_sync
) {

488 
D–‘eAÎD©a
();

489 
Bud
(0, 
num_´e_sync
);

490 
	gdb_
->
Com·ùRªge
(
nuÎ±r
,‚ullptr);

491 
Bud
(
num_´e_sync
, 
num_po¡_sync
);

494 
P¬tŸlCom·ùTe¡Reİ’W™hFauÉ
(
Re£tM‘hod
 
»£t_m‘hod
,

495 
num_´e_sync
, 
num_po¡_sync
) {

496 
	g’v_
->
S‘Fesy¡emAùive
(
çl£
);

497 
Clo£DB
();

498 
Re£tDBS‹
(
»£t_m‘hod
);

499 
ASSERT_LEVELDB_OK
(
O³nDB
());

500 
ASSERT_LEVELDB_OK
(

501 
V”ify
(0, 
num_´e_sync
, 
FauÉInjeùiÚTe¡
::
VAL_EXPECT_NO_ERROR
));

502 
ASSERT_LEVELDB_OK
(
V”ify
(
num_´e_sync
, 
num_po¡_sync
,

503 
FauÉInjeùiÚTe¡
::
VAL_EXPECT_ERROR
));

506 
NoWr™eTe¡P»FauÉ
() {}

508 
NoWr™eTe¡Reİ’W™hFauÉ
(
Re£tM‘hod
 
»£t_m‘hod
) {

509 
Clo£DB
();

510 
Re£tDBS‹
(
»£t_m‘hod
);

511 
ASSERT_LEVELDB_OK
(
O³nDB
());

514 
DoTe¡
() {

515 
Rªdom
 
ºd
(0);

516 
ASSERT_LEVELDB_OK
(
O³nDB
());

517 
size_t
 
	gidx
 = 0; idx < 
	gkNumI‹¿tiÚs
; idx++) {

518 
	gnum_´e_sync
 = 
ºd
.
UnifÜm
(
kMaxNumV®ues
);

519 
	gnum_po¡_sync
 = 
ºd
.
UnifÜm
(
kMaxNumV®ues
);

521 
P¬tŸlCom·ùTe¡P»FauÉ
(
num_´e_sync
, 
num_po¡_sync
);

522 
P¬tŸlCom·ùTe¡Reİ’W™hFauÉ
(
RESET_DROP_UNSYNCED_DATA
, 
num_´e_sync
,

523 
num_po¡_sync
);

525 
NoWr™eTe¡P»FauÉ
();

526 
NoWr™eTe¡Reİ’W™hFauÉ
(
RESET_DROP_UNSYNCED_DATA
);

528 
P¬tŸlCom·ùTe¡P»FauÉ
(
num_´e_sync
, 
num_po¡_sync
);

531 
P¬tŸlCom·ùTe¡Reİ’W™hFauÉ
(
RESET_DELETE_UNSYNCED_FILES
,

532 
num_´e_sync
 + 
num_po¡_sync
, 0);

534 
NoWr™eTe¡P»FauÉ
();

535 
NoWr™eTe¡Reİ’W™hFauÉ
(
RESET_DELETE_UNSYNCED_FILES
);

540 
	$TEST_F
(
FauÉInjeùiÚTe¡
, 
FauÉTe¡NoLogReu£
) {

541 
	`Reu£Logs
(
çl£
);

542 
	`DoTe¡
();

543 
	}
}

545 
	$TEST_F
(
FauÉInjeùiÚTe¡
, 
FauÉTe¡W™hLogReu£
) {

546 
	`Reu£Logs
(
Œue
);

547 
	`DoTe¡
();

548 
	}
}

552 
	$maš
(
¬gc
, ** 
¬gv
) {

553 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

554  
	`RUN_ALL_TESTS
();

555 
	}
}

	@filename.cc

5 
	~"db/f’ame.h
"

7 
	~<ùy³.h
>

8 
	~<¡dio.h
>

10 
	~"db/dbfÜm©.h
"

11 
	~"Ëv–db/’v.h
"

12 
	~"ut/loggšg.h
"

14 
Çme¥aû
 
	gËv–db
 {

17 
Stus
 
Wr™eSŒšgToFeSync
(
Env
* 
’v
, cÚ¡ 
Sliû
& 
d©a
,

18 cÚ¡ 
¡d
::
¡ršg
& 
âame
);

20 
	g¡d
::
¡ršg
 
MakeFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
,

21 cÚ¡ * 
suffix
) {

22 
	gbuf
[100];

23 
¢´štf
(
buf
, (buf), "/%06llu.%s",

24 
¡©ic_ÿ¡
<>(
numb”
), 
suffix
);

25  
	gdbÇme
 + 
	gbuf
;

28 
	g¡d
::
¡ršg
 
LogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

29 
as£¹
(
numb”
 > 0);

30  
MakeFeName
(
dbÇme
, 
numb”
, "log");

33 
	g¡d
::
¡ršg
 
TabËFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

34 
as£¹
(
numb”
 > 0);

35  
MakeFeName
(
dbÇme
, 
numb”
, "ldb");

38 
	g¡d
::
¡ršg
 
SSTTabËFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

39 
as£¹
(
numb”
 > 0);

40  
MakeFeName
(
dbÇme
, 
numb”
, "sst");

43 
	g¡d
::
¡ršg
 
DesütÜFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

44 
as£¹
(
numb”
 > 0);

45 
	gbuf
[100];

46 
¢´štf
(
buf
, (buf), "/MANIFEST-%06llu",

47 
¡©ic_ÿ¡
<>(
numb”
));

48  
	gdbÇme
 + 
	gbuf
;

51 
	g¡d
::
¡ršg
 
Cu¼’tFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

52  
dbÇme
 + "/CURRENT";

55 
	g¡d
::
¡ršg
 
LockFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {  dbname + "/LOCK"; }

57 
	g¡d
::
¡ršg
 
TempFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

58 
as£¹
(
numb”
 > 0);

59  
MakeFeName
(
dbÇme
, 
numb”
, "dbtmp");

62 
	g¡d
::
¡ršg
 
InfoLogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

63  
dbÇme
 + "/LOG";

67 
	g¡d
::
¡ršg
 
OldInfoLogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

68  
dbÇme
 + "/LOG.old";

78 
boŞ
 
P¬£FeName
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
, 
ušt64_t
* 
numb”
,

79 
FeTy³
* 
ty³
) {

80 
Sliû
 
»¡
(
f’ame
);

81 ià(
	g»¡
 == "CURRENT") {

82 *
numb”
 = 0;

83 *
	gty³
 = 
kCu¼’tFe
;

84 } ià(
	g»¡
 == "LOCK") {

85 *
numb”
 = 0;

86 *
	gty³
 = 
kDBLockFe
;

87 } ià(
	g»¡
 =ğ"LOG" || 
»¡
 == "LOG.old") {

88 *
numb”
 = 0;

89 *
	gty³
 = 
kInfoLogFe
;

90 } ià(
	g»¡
.
¡¬ts_w™h
("MANIFEST-")) {

91 
	g»¡
.
»move_´efix
(
¡¾’
("MANIFEST-"));

92 
ušt64_t
 
	gnum
;

93 ià(!
CÚsumeDecim®Numb”
(&
»¡
, &
num
)) {

94  
	gçl£
;

96 ià(!
	g»¡
.
em±y
()) {

97  
	gçl£
;

99 *
	gty³
 = 
kDesütÜFe
;

100 *
	gnumb”
 = 
num
;

104 
ušt64_t
 
	gnum
;

105 ià(!
CÚsumeDecim®Numb”
(&
»¡
, &
num
)) {

106  
	gçl£
;

108 
Sliû
 
	gsuffix
 = 
»¡
;

109 ià(
	gsuffix
 =ğ
Sliû
(".log")) {

110 *
ty³
 = 
kLogFe
;

111 } ià(
	gsuffix
 =ğ
Sliû
(".s¡"è|| 
suffix
 == Slice(".ldb")) {

112 *
ty³
 = 
kTabËFe
;

113 } ià(
	gsuffix
 =ğ
Sliû
(".dbtmp")) {

114 *
ty³
 = 
kTempFe
;

116  
	gçl£
;

118 *
	gnumb”
 = 
num
;

120  
	gŒue
;

123 
Stus
 
S‘Cu¼’tFe
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

124 
ušt64_t
 
desütÜ_numb”
) {

126 
	g¡d
::
¡ršg
 
mªiã¡
 = 
DesütÜFeName
(
dbÇme
, 
desütÜ_numb”
);

127 
Sliû
 
	gcÚ‹Ás
 = 
mªiã¡
;

128 
as£¹
(
cÚ‹Ás
.
¡¬ts_w™h
(
dbÇme
 + "/"));

129 
	gcÚ‹Ás
.
»move_´efix
(
dbÇme
.
size
() + 1);

130 
	g¡d
::
¡ršg
 
tmp
 = 
TempFeName
(
dbÇme
, 
desütÜ_numb”
);

131 
Stus
 
	gs
 = 
Wr™eSŒšgToFeSync
(
’v
, 
cÚ‹Ás
.
ToSŒšg
(è+ "\n", 
tmp
);

132 ià(
	gs
.
ok
()) {

133 
	gs
 = 
’v
->
R’ameFe
(
tmp
, 
Cu¼’tFeName
(
dbÇme
));

135 ià(!
	gs
.
ok
()) {

136 
	g’v
->
RemoveFe
(
tmp
);

138  
	gs
;

	@filename.h

7 #iâdeà
STORAGE_LEVELDB_DB_FILENAME_H_


8 
	#STORAGE_LEVELDB_DB_FILENAME_H_


	)

10 
	~<¡dšt.h
>

12 
	~<¡ršg
>

14 
	~"Ëv–db/¦iû.h
"

15 
	~"Ëv–db/¡©us.h
"

16 
	~"pÜt/pÜt.h
"

18 
Çme¥aû
 
	gËv–db
 {

20 
şass
 
	gEnv
;

22 
	eFeTy³
 {

23 
	gkLogFe
,

24 
	gkDBLockFe
,

25 
	gkTabËFe
,

26 
	gkDesütÜFe
,

27 
	gkCu¼’tFe
,

28 
	gkTempFe
,

29 
	gkInfoLogFe


35 
	g¡d
::
¡ršg
 
LogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

40 
	g¡d
::
¡ršg
 
TabËFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

45 
	g¡d
::
¡ršg
 
SSTTabËFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

50 
	g¡d
::
¡ršg
 
DesütÜFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

55 
	g¡d
::
¡ršg
 
Cu¼’tFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
);

59 
	g¡d
::
¡ršg
 
LockFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
);

63 
	g¡d
::
¡ršg
 
TempFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

66 
	g¡d
::
¡ršg
 
InfoLogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
);

69 
	g¡d
::
¡ršg
 
OldInfoLogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
);

74 
boŞ
 
P¬£FeName
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
, 
ušt64_t
* 
numb”
,

75 
FeTy³
* 
ty³
);

79 
Stus
 
S‘Cu¼’tFe
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

80 
ušt64_t
 
desütÜ_numb”
);

	@filename_test.cc

5 
	~"db/f’ame.h
"

7 
	~"g‹¡/g‹¡.h
"

8 
	~"db/dbfÜm©.h
"

9 
	~"pÜt/pÜt.h
"

10 
	~"ut/loggšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
TEST
(
FeNameTe¡
, 
P¬£
) {

15 
Sliû
 
	gdb
;

16 
FeTy³
 
	gty³
;

17 
ušt64_t
 
	gnumb”
;

21 cÚ¡ * 
	gâame
;

22 
ušt64_t
 
	gnumb”
;

23 
FeTy³
 
	gty³
;

24 } 
	gÿ£s
[] = {

25 {"100.log", 100, 
kLogFe
},

26 {"0.log", 0, 
kLogFe
},

27 {"0.s¡", 0, 
kTabËFe
},

28 {"0.ldb", 0, 
kTabËFe
},

29 {"CURRENT", 0, 
kCu¼’tFe
},

30 {"LOCK", 0, 
kDBLockFe
},

31 {"MANIFEST-2", 2, 
kDesütÜFe
},

32 {"MANIFEST-7", 7, 
kDesütÜFe
},

33 {"LOG", 0, 
kInfoLogFe
},

34 {"LOG.Şd", 0, 
kInfoLogFe
},

35 {"18446744073709551615.log", 18446744073709551615uÎ, 
kLogFe
},

37 
	gi
 = 0; i < (
	gÿ£s
) / (cases[0]); i++) {

38 
	g¡d
::
¡ršg
 
f
 = 
ÿ£s
[
i
].
âame
;

39 
ASSERT_TRUE
(
P¬£FeName
(
f
, &
numb”
, &
ty³
)è<< 
	gf
;

40 
ASSERT_EQ
(
ÿ£s
[
i
].
ty³
,y³è<< 
	gf
;

41 
ASSERT_EQ
(
ÿ£s
[
i
].
numb”
,‚umb”è<< 
	gf
;

45 cÚ¡ * 
	g”rÜs
[] = {"",

67 
	gi
 = 0; i < (
	g”rÜs
) / (errors[0]); i++) {

68 
	g¡d
::
¡ršg
 
f
 = 
”rÜs
[
i
];

69 
ASSERT_TRUE
(!
P¬£FeName
(
f
, &
numb”
, &
ty³
)è<< 
	gf
;

73 
TEST
(
FeNameTe¡
, 
CÚ¡ruùiÚ
) {

74 
ušt64_t
 
	gnumb”
;

75 
FeTy³
 
	gty³
;

76 
	g¡d
::
¡ršg
 
âame
;

78 
	gâame
 = 
Cu¼’tFeName
("foo");

79 
ASSERT_EQ
("foo/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

80 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

81 
ASSERT_EQ
(0, 
numb”
);

82 
ASSERT_EQ
(
kCu¼’tFe
, 
ty³
);

84 
	gâame
 = 
LockFeName
("foo");

85 
ASSERT_EQ
("foo/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

86 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

87 
ASSERT_EQ
(0, 
numb”
);

88 
ASSERT_EQ
(
kDBLockFe
, 
ty³
);

90 
	gâame
 = 
LogFeName
("foo", 192);

91 
ASSERT_EQ
("foo/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

92 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

93 
ASSERT_EQ
(192, 
numb”
);

94 
ASSERT_EQ
(
kLogFe
, 
ty³
);

96 
	gâame
 = 
TabËFeName
("bar", 200);

97 
ASSERT_EQ
("b¬/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

98 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

99 
ASSERT_EQ
(200, 
numb”
);

100 
ASSERT_EQ
(
kTabËFe
, 
ty³
);

102 
	gâame
 = 
DesütÜFeName
("bar", 100);

103 
ASSERT_EQ
("b¬/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

104 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

105 
ASSERT_EQ
(100, 
numb”
);

106 
ASSERT_EQ
(
kDesütÜFe
, 
ty³
);

108 
	gâame
 = 
TempFeName
("tmp", 999);

109 
ASSERT_EQ
("tmp/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

110 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

111 
ASSERT_EQ
(999, 
numb”
);

112 
ASSERT_EQ
(
kTempFe
, 
ty³
);

114 
	gâame
 = 
InfoLogFeName
("foo");

115 
ASSERT_EQ
("foo/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

116 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

117 
ASSERT_EQ
(0, 
numb”
);

118 
ASSERT_EQ
(
kInfoLogFe
, 
ty³
);

120 
	gâame
 = 
OldInfoLogFeName
("foo");

121 
ASSERT_EQ
("foo/", 
¡d
::
¡ršg
(
âame
.
d©a
(), 4));

122 
ASSERT_TRUE
(
P¬£FeName
(
âame
.
c_¡r
(è+ 4, &
numb”
, &
ty³
));

123 
ASSERT_EQ
(0, 
numb”
);

124 
ASSERT_EQ
(
kInfoLogFe
, 
ty³
);

129 
	$maš
(
¬gc
, ** 
¬gv
) {

130 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

131  
	`RUN_ALL_TESTS
();

132 
	}
}

	@leveldbutil.cc

5 
	~<¡dio.h
>

7 
	~"Ëv–db/dumpfe.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"Ëv–db/¡©us.h
"

11 
Çme¥aû
 
	gËv–db
 {

12 
	gÇme¥aû
 {

14 şas 
	cStdoutPrš‹r
 : 
public
 
Wr™abËFe
 {

15 
public
:

16 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
è
ov”ride
 {

17 
fwr™e
(
d©a
.d©a(), 1, d©a.
size
(), 
¡dout
);

18  
	gStus
::
OK
();

20 
Stus
 
Clo£
(è
	gov”ride
 {  
	gStus
::
OK
(); }

21 
Stus
 
Flush
(è
	gov”ride
 {  
	gStus
::
OK
(); }

22 
Stus
 
Sync
(è
	gov”ride
 {  
	gStus
::
OK
(); }

25 
boŞ
 
HªdËDumpCommªd
(
Env
* 
’v
, ** 
fes
, 
num
) {

26 
StdoutPrš‹r
 
	g´š‹r
;

27 
boŞ
 
	gok
 = 
Œue
;

28 
	gi
 = 0; i < 
	gnum
; i++) {

29 
Stus
 
	gs
 = 
DumpFe
(
’v
, 
fes
[
i
], &
´š‹r
);

30 ià(!
	gs
.
ok
()) {

31 
årštf
(
¡d”r
, "%s\n", 
s
.
ToSŒšg
().
c_¡r
());

32 
	gok
 = 
çl£
;

35  
	gok
;

41 
	$U§ge
() {

42 
	`årštf
(
¡d”r
,

45 
	}
}

47 
	$maš
(
¬gc
, ** 
¬gv
) {

48 
Ëv–db
::
Env
* 
’v
 =†ev–db::Env::
	`DeçuÉ
();

49 
boŞ
 
ok
 = 
Œue
;

50 ià(
¬gc
 < 2) {

51 
	`U§ge
();

52 
ok
 = 
çl£
;

54 
¡d
::
¡ršg
 
commªd
 = 
¬gv
[1];

55 ià(
commªd
 == "dump") {

56 
ok
 = 
Ëv–db
::
	`HªdËDumpCommªd
(
’v
, 
¬gv
 + 2, 
¬gc
 - 2);

58 
	`U§ge
();

59 
ok
 = 
çl£
;

62  (
ok
 ? 0 : 1);

63 
	}
}

	@log_format.h

8 #iâdeà
STORAGE_LEVELDB_DB_LOG_FORMAT_H_


9 
	#STORAGE_LEVELDB_DB_LOG_FORMAT_H_


	)

11 
Çme¥aû
 
	gËv–db
 {

12 
Çme¥aû
 
	glog
 {

14 
	eRecÜdTy³
 {

16 
	gkZ”oTy³
 = 0,

18 
	gkFuÎTy³
 = 1,

21 
	gkFœ¡Ty³
 = 2,

22 
	gkMiddËTy³
 = 3,

23 
	gkLa¡Ty³
 = 4

25 cÚ¡ 
	gkMaxRecÜdTy³
 = 
kLa¡Ty³
;

27 cÚ¡ 
	gkBlockSize
 = 32768;

30 cÚ¡ 
	gkH—d”Size
 = 4 + 2 + 1;

	@log_reader.cc

5 
	~"db/log_»ad”.h
"

7 
	~<¡dio.h
>

9 
	~"Ëv–db/’v.h
"

10 
	~"ut/codšg.h
"

11 
	~"ut/üc32c.h
"

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	glog
 {

16 
	gR—d”
::
R•Ü‹r
::~Reporter() = ;

18 
	gR—d”
::
R—d”
(
Sequ’tŸlFe
* 
fe
, 
R•Ü‹r
* 
»pÜ‹r
, 
boŞ
 
checksum
,

19 
ušt64_t
 
š™Ÿl_off£t
)

20 : 
fe_
(
fe
),

21 
»pÜ‹r_
(
»pÜ‹r
),

22 
checksum_
(
checksum
),

23 
backšg_¡Üe_
(
Ãw
 [
kBlockSize
]),

24 
bufãr_
(),

25 
eof_
(
çl£
),

26 
Ï¡_»cÜd_off£t_
(0),

27 
’d_of_bufãr_off£t_
(0),

28 
š™Ÿl_off£t_
(
š™Ÿl_off£t
),

29 
»syncšg_
(
š™Ÿl_off£t
 > 0) {}

31 
	gR—d”
::~
R—d”
(è{ 
d–‘e
[] 
backšg_¡Üe_
; }

33 
boŞ
 
	gR—d”
::
SkToIn™ŸlBlock
() {

34 cÚ¡ 
size_t
 
off£t_š_block
 = 
š™Ÿl_off£t_
 % 
kBlockSize
;

35 
ušt64_t
 
	gblock_¡¬t_loÿtiÚ
 = 
š™Ÿl_off£t_
 - 
off£t_š_block
;

38 ià(
	goff£t_š_block
 > 
	gkBlockSize
 - 6) {

39 
	gblock_¡¬t_loÿtiÚ
 +ğ
kBlockSize
;

42 
	g’d_of_bufãr_off£t_
 = 
block_¡¬t_loÿtiÚ
;

45 ià(
	gblock_¡¬t_loÿtiÚ
 > 0) {

46 
Stus
 
	gsk_¡©us
 = 
fe_
->
Sk
(
block_¡¬t_loÿtiÚ
);

47 ià(!
	gsk_¡©us
.
ok
()) {

48 
R•ÜtDrİ
(
block_¡¬t_loÿtiÚ
, 
sk_¡©us
);

49  
	gçl£
;

53  
	gŒue
;

56 
boŞ
 
	gR—d”
::
R—dRecÜd
(
Sliû
* 
»cÜd
, 
¡d
::
¡ršg
* 
sü©ch
) {

57 ià(
Ï¡_»cÜd_off£t_
 < 
š™Ÿl_off£t_
) {

58 ià(!
SkToIn™ŸlBlock
()) {

59  
çl£
;

63 
	gsü©ch
->
ş—r
();

64 
	g»cÜd
->
ş—r
();

65 
boŞ
 
	gš_äagm’‹d_»cÜd
 = 
çl£
;

68 
ušt64_t
 
	g´o¥eùive_»cÜd_off£t
 = 0;

70 
Sliû
 
	gäagm’t
;

71 
	gŒue
) {

72 cÚ¡ 
	g»cÜd_ty³
 = 
R—dPhysiÿlRecÜd
(&
äagm’t
);

77 
ušt64_t
 
	gphysiÿl_»cÜd_off£t
 =

78 
’d_of_bufãr_off£t_
 - 
bufãr_
.
size
(è- 
kH—d”Size
 - 
äagm’t
.size();

80 ià(
	g»syncšg_
) {

81 ià(
	g»cÜd_ty³
 =ğ
kMiddËTy³
) {

83 } ià(
	g»cÜd_ty³
 =ğ
kLa¡Ty³
) {

84 
»syncšg_
 = 
çl£
;

87 
	g»syncšg_
 = 
çl£
;

91 
	g»cÜd_ty³
) {

92 
	gkFuÎTy³
:

93 ià(
š_äagm’‹d_»cÜd
) {

98 ià(!
sü©ch
->
em±y
()) {

99 
R•ÜtCÜru±iÚ
(
sü©ch
->
size
(), "partial„ecord withoutƒnd(1)");

102 
	g´o¥eùive_»cÜd_off£t
 = 
physiÿl_»cÜd_off£t
;

103 
	gsü©ch
->
ş—r
();

104 *
	g»cÜd
 = 
äagm’t
;

105 
	gÏ¡_»cÜd_off£t_
 = 
´o¥eùive_»cÜd_off£t
;

106  
	gŒue
;

108 
	gkFœ¡Ty³
:

109 ià(
š_äagm’‹d_»cÜd
) {

114 ià(!
sü©ch
->
em±y
()) {

115 
R•ÜtCÜru±iÚ
(
sü©ch
->
size
(), "partial„ecord withoutƒnd(2)");

118 
	g´o¥eùive_»cÜd_off£t
 = 
physiÿl_»cÜd_off£t
;

119 
	gsü©ch
->
assign
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

120 
	gš_äagm’‹d_»cÜd
 = 
Œue
;

123 
	gkMiddËTy³
:

124 ià(!
š_äagm’‹d_»cÜd
) {

125 
R•ÜtCÜru±iÚ
(
äagm’t
.
size
(),

128 
	gsü©ch
->
­³nd
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

132 
	gkLa¡Ty³
:

133 ià(!
š_äagm’‹d_»cÜd
) {

134 
R•ÜtCÜru±iÚ
(
äagm’t
.
size
(),

137 
	gsü©ch
->
­³nd
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

138 *
	g»cÜd
 = 
Sliû
(*
sü©ch
);

139 
	gÏ¡_»cÜd_off£t_
 = 
´o¥eùive_»cÜd_off£t
;

140  
	gŒue
;

144 
	gkEof
:

145 ià(
š_äagm’‹d_»cÜd
) {

149 
sü©ch
->
ş—r
();

151  
	gçl£
;

153 
	gkBadRecÜd
:

154 ià(
š_äagm’‹d_»cÜd
) {

155 
R•ÜtCÜru±iÚ
(
sü©ch
->
size
(), "error in middle of„ecord");

156 
	gš_äagm’‹d_»cÜd
 = 
çl£
;

157 
	gsü©ch
->
ş—r
();

162 
buf
[40];

163 
¢´štf
(
buf
, (buf), "unknowÀ»cÜdy³ %u", 
»cÜd_ty³
);

164 
R•ÜtCÜru±iÚ
(

165 (
äagm’t
.
size
(è+ (
š_äagm’‹d_»cÜd
 ? 
sü©ch
->size() : 0)),

166 
buf
);

167 
	gš_äagm’‹d_»cÜd
 = 
çl£
;

168 
	gsü©ch
->
ş—r
();

173  
	gçl£
;

176 
ušt64_t
 
	gR—d”
::
La¡RecÜdOff£t
(è{  
Ï¡_»cÜd_off£t_
; }

178 
	gR—d”
::
R•ÜtCÜru±iÚ
(
ušt64_t
 
by‹s
, cÚ¡ * 
»asÚ
) {

179 
R•ÜtDrİ
(
by‹s
, 
Stus
::
CÜru±iÚ
(
»asÚ
));

182 
	gR—d”
::
R•ÜtDrİ
(
ušt64_t
 
by‹s
, cÚ¡ 
Stus
& 
»asÚ
) {

183 ià(
	g»pÜ‹r_
 !ğ
nuÎ±r
 &&

184 
’d_of_bufãr_off£t_
 - 
bufãr_
.
size
(è- 
by‹s
 >ğ
š™Ÿl_off£t_
) {

185 
»pÜ‹r_
->
CÜru±iÚ
(
¡©ic_ÿ¡
<
size_t
>(
by‹s
), 
»asÚ
);

189 
	gR—d”
::
R—dPhysiÿlRecÜd
(
Sliû
* 
»suÉ
) {

190 
Œue
) {

191 ià(
bufãr_
.
size
(è< 
kH—d”Size
) {

192 ià(!
eof_
) {

194 
bufãr_
.
ş—r
();

195 
Stus
 
	g¡©us
 = 
fe_
->
R—d
(
kBlockSize
, &
bufãr_
, 
backšg_¡Üe_
);

196 
	g’d_of_bufãr_off£t_
 +ğ
bufãr_
.
size
();

197 ià(!
	g¡©us
.
ok
()) {

198 
	gbufãr_
.
ş—r
();

199 
R•ÜtDrİ
(
kBlockSize
, 
¡©us
);

200 
	geof_
 = 
Œue
;

201  
	gkEof
;

202 } ià(
	gbufãr_
.
size
(è< 
	gkBlockSize
) {

203 
	geof_
 = 
Œue
;

211 
	gbufãr_
.
ş—r
();

212  
	gkEof
;

217 cÚ¡ * 
	gh—d”
 = 
bufãr_
.
d©a
();

218 cÚ¡ 
ušt32_t
 
	ga
 = 
¡©ic_ÿ¡
<ušt32_t>(
h—d”
[4]) & 0xff;

219 cÚ¡ 
ušt32_t
 
	gb
 = 
¡©ic_ÿ¡
<ušt32_t>(
h—d”
[5]) & 0xff;

220 cÚ¡ 
	gty³
 = 
h—d”
[6];

221 cÚ¡ 
ušt32_t
 
	gËngth
 = 
a
 | (
b
 << 8);

222 ià(
	gkH—d”Size
 + 
	gËngth
 > 
	gbufãr_
.
size
()) {

223 
size_t
 
	gdrİ_size
 = 
bufãr_
.
size
();

224 
	gbufãr_
.
ş—r
();

225 ià(!
	geof_
) {

226 
R•ÜtCÜru±iÚ
(
drİ_size
, "bad„ecord†ength");

227  
	gkBadRecÜd
;

232  
	gkEof
;

235 ià(
	gty³
 =ğ
kZ”oTy³
 && 
Ëngth
 == 0) {

239 
bufãr_
.
ş—r
();

240  
	gkBadRecÜd
;

244 ià(
	gchecksum_
) {

245 
ušt32_t
 
	gex³ùed_üc
 = 
üc32c
::
Unmask
(
DecodeFixed32
(
h—d”
));

246 
ušt32_t
 
	gaùu®_üc
 = 
üc32c
::
V®ue
(
h—d”
 + 6, 1 + 
Ëngth
);

247 ià(
	gaùu®_üc
 !ğ
ex³ùed_üc
) {

252 
size_t
 
drİ_size
 = 
bufãr_
.
size
();

253 
	gbufãr_
.
ş—r
();

254 
R•ÜtCÜru±iÚ
(
drİ_size
, "checksum mismatch");

255  
	gkBadRecÜd
;

259 
	gbufãr_
.
»move_´efix
(
kH—d”Size
 + 
Ëngth
);

262 ià(
	g’d_of_bufãr_off£t_
 - 
	gbufãr_
.
size
(è- 
	gkH—d”Size
 - 
	gËngth
 <

263 
	gš™Ÿl_off£t_
) {

264 
	g»suÉ
->
ş—r
();

265  
	gkBadRecÜd
;

268 *
	g»suÉ
 = 
Sliû
(
h—d”
 + 
kH—d”Size
, 
Ëngth
);

269  
	gty³
;

	@log_reader.h

5 #iâdeà
STORAGE_LEVELDB_DB_LOG_READER_H_


6 
	#STORAGE_LEVELDB_DB_LOG_READER_H_


	)

8 
	~<¡dšt.h
>

10 
	~"db/log_fÜm©.h
"

11 
	~"Ëv–db/¦iû.h
"

12 
	~"Ëv–db/¡©us.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
şass
 
	gSequ’tŸlFe
;

18 
Çme¥aû
 
	glog
 {

20 şas 
	cR—d”
 {

21 
	gpublic
:

23 şas 
	cR•Ü‹r
 {

24 
public
:

25 
vœtu®
 ~
R•Ü‹r
();

29 
vœtu®
 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
¡©us
) = 0;

43 
R—d”
(
Sequ’tŸlFe
* 
fe
, 
R•Ü‹r
* 
»pÜ‹r
, 
boŞ
 
checksum
,

44 
ušt64_t
 
š™Ÿl_off£t
);

46 
R—d”
(cÚ¡ R—d”&èğ
d–‘e
;

47 
	gR—d”
& 
	gİ”©Ü
=(cÚ¡ 
R—d”
&èğ
d–‘e
;

49 ~
R—d”
();

56 
boŞ
 
R—dRecÜd
(
Sliû
* 
»cÜd
, 
¡d
::
¡ršg
* 
sü©ch
);

61 
ušt64_t
 
La¡RecÜdOff£t
();

63 
	g´iv©e
:

66 
kEof
 = 
kMaxRecÜdTy³
 + 1,

72 
	gkBadRecÜd
 = 
kMaxRecÜdTy³
 + 2

78 
boŞ
 
SkToIn™ŸlBlock
();

81 
R—dPhysiÿlRecÜd
(
Sliû
* 
»suÉ
);

85 
R•ÜtCÜru±iÚ
(
ušt64_t
 
by‹s
, cÚ¡ * 
»asÚ
);

86 
R•ÜtDrİ
(
ušt64_t
 
by‹s
, cÚ¡ 
Stus
& 
»asÚ
);

88 
Sequ’tŸlFe
* cÚ¡ 
	gfe_
;

89 
R•Ü‹r
* cÚ¡ 
	g»pÜ‹r_
;

90 
boŞ
 cÚ¡ 
	gchecksum_
;

91 * cÚ¡ 
	gbackšg_¡Üe_
;

92 
Sliû
 
	gbufãr_
;

93 
boŞ
 
	geof_
;

96 
ušt64_t
 
	gÏ¡_»cÜd_off£t_
;

98 
ušt64_t
 
	g’d_of_bufãr_off£t_
;

101 
ušt64_t
 cÚ¡ 
	gš™Ÿl_off£t_
;

106 
boŞ
 
	g»syncšg_
;

	@log_test.cc

5 
	~"g‹¡/g‹¡.h
"

6 
	~"db/log_»ad”.h
"

7 
	~"db/log_wr™”.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"ut/codšg.h
"

10 
	~"ut/üc32c.h
"

11 
	~"ut/¿ndom.h
"

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	glog
 {

18 
	g¡d
::
¡ršg
 
BigSŒšg
(cÚ¡ 
¡d
::¡ršg& 
·¹Ÿl_¡ršg
, 
size_t
 
n
) {

19 
	g¡d
::
¡ršg
 
»suÉ
;

20 
	g»suÉ
.
size
(è< 
	gn
) {

21 
	g»suÉ
.
­³nd
(
·¹Ÿl_¡ršg
);

23 
	g»suÉ
.
»size
(
n
);

24  
	g»suÉ
;

28 
	g¡d
::
¡ršg
 
Numb”SŒšg
(
n
) {

29 
buf
[50];

30 
¢´štf
(
buf
, (buf), "%d.", 
n
);

31  
	g¡d
::
¡ršg
(
buf
);

35 
	g¡d
::
¡ršg
 
RªdomSkewedSŒšg
(
i
, 
Rªdom
* 
ºd
) {

36  
BigSŒšg
(
Numb”SŒšg
(
i
), 
ºd
->
Skewed
(17));

39 şas 
	cLogTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

40 
public
:

41 
LogTe¡
()

42 : 
»adšg_
(
çl£
),

43 
wr™”_
(
Ãw
 
Wr™”
(&
de¡_
)),

44 
»ad”_
(
Ãw
 
R—d”
(&
sourû_
, &
»pÜt_
, 
Œue
 ,

47 ~
LogTe¡
() {

48 
d–‘e
 
	gwr™”_
;

49 
d–‘e
 
	g»ad”_
;

52 
Reİ’FÜAµ’d
() {

53 
d–‘e
 
	gwr™”_
;

54 
	gwr™”_
 = 
Ãw
 
Wr™”
(&
de¡_
, de¡_.
cÚ‹Ás_
.
size
());

57 
Wr™e
(cÚ¡ 
¡d
::
¡ršg
& 
msg
) {

58 
ASSERT_TRUE
(!
»adšg_
) << "Write()‡fter startingo„ead";

59 
	gwr™”_
->
AddRecÜd
(
Sliû
(
msg
));

62 
size_t
 
Wr™‹nBy‹s
(ècÚ¡ {  
	gde¡_
.
	gcÚ‹Ás_
.
size
(); }

64 
	g¡d
::
¡ršg
 
R—d
() {

65 ià(!
»adšg_
) {

66 
»adšg_
 = 
Œue
;

67 
	gsourû_
.
	gcÚ‹Ás_
 = 
Sliû
(
de¡_
.
cÚ‹Ás_
);

69 
	g¡d
::
¡ršg
 
sü©ch
;

70 
Sliû
 
	g»cÜd
;

71 ià(
	g»ad”_
->
R—dRecÜd
(&
»cÜd
, &
sü©ch
)) {

72  
	g»cÜd
.
ToSŒšg
();

78 
Inüem’tBy‹
(
off£t
, 
d–
) {

79 
	gde¡_
.
	gcÚ‹Ás_
[
off£t
] +ğ
d–
;

82 
S‘By‹
(
off£t
, 
Ãw_by‹
) {

83 
	gde¡_
.
	gcÚ‹Ás_
[
off£t
] = 
Ãw_by‹
;

86 
ShrškSize
(
by‹s
) {

87 
	gde¡_
.
	gcÚ‹Ás_
.
»size
(
de¡_
.
cÚ‹Ás_
.
size
(è- 
by‹s
);

90 
FixChecksum
(
h—d”_off£t
, 
Ën
) {

92 
ušt32_t
 
	güc
 = 
üc32c
::
V®ue
(&
de¡_
.
cÚ‹Ás_
[
h—d”_off£t
 + 6], 1 + 
Ën
);

93 
	güc
 = 
üc32c
::
Mask
(
üc
);

94 
EncodeFixed32
(&
de¡_
.
cÚ‹Ás_
[
h—d”_off£t
], 
üc
);

97 
FÜûE¼Ü
(è{ 
	gsourû_
.
	gfÜû_”rÜ_
 = 
Œue
; }

99 
size_t
 
Drİ³dBy‹s
(ècÚ¡ {  
	g»pÜt_
.
	gdrİ³d_by‹s_
; }

101 
	g¡d
::
¡ršg
 
R•ÜtMes§ge
(ècÚ¡ {  
»pÜt_
.
mes§ge_
; }

104 
	g¡d
::
¡ršg
 
M©chE¼Ü
(cÚ¡ 
¡d
::¡ršg& 
msg
) const {

105 ià(
»pÜt_
.
mes§ge_
.
fšd
(
msg
è=ğ
¡d
::
¡ršg
::
Åos
) {

106  
»pÜt_
.
mes§ge_
;

112 
Wr™eIn™ŸlOff£tLog
() {

113 
	gi
 = 0; i < 
	gnum_š™Ÿl_off£t_»cÜds_
; i++) {

114 
	g¡d
::
¡ršg
 
»cÜd
(
š™Ÿl_off£t_»cÜd_sizes_
[
i
],

115 
¡©ic_ÿ¡
<>('a' + 
i
));

116 
Wr™e
(
»cÜd
);

120 
S¹R—dšgAt
(
ušt64_t
 
š™Ÿl_off£t
) {

121 
d–‘e
 
	g»ad”_
;

122 
	g»ad”_
 = 
Ãw
 
R—d”
(&
sourû_
, &
»pÜt_
, 
Œue
 , 
š™Ÿl_off£t
);

125 
CheckOff£tPa¡EndR‘uºsNoRecÜds
(
ušt64_t
 
off£t_·¡_’d
) {

126 
Wr™eIn™ŸlOff£tLog
();

127 
	g»adšg_
 = 
Œue
;

128 
	gsourû_
.
	gcÚ‹Ás_
 = 
Sliû
(
de¡_
.
cÚ‹Ás_
);

129 
R—d”
* 
	goff£t_»ad”
 = 
Ãw
 R—d”(&
sourû_
, &
»pÜt_
, 
Œue
 ,

130 
Wr™‹nBy‹s
(è+ 
off£t_·¡_’d
);

131 
Sliû
 
	g»cÜd
;

132 
	g¡d
::
¡ršg
 
sü©ch
;

133 
ASSERT_TRUE
(!
off£t_»ad”
->
R—dRecÜd
(&
»cÜd
, &
sü©ch
));

134 
d–‘e
 
	goff£t_»ad”
;

137 
CheckIn™ŸlOff£tRecÜd
(
ušt64_t
 
š™Ÿl_off£t
,

138 
ex³ùed_»cÜd_off£t
) {

139 
Wr™eIn™ŸlOff£tLog
();

140 
	g»adšg_
 = 
Œue
;

141 
	gsourû_
.
	gcÚ‹Ás_
 = 
Sliû
(
de¡_
.
cÚ‹Ás_
);

142 
R—d”
* 
	goff£t_»ad”
 =

143 
Ãw
 
R—d”
(&
sourû_
, &
»pÜt_
, 
Œue
 , 
š™Ÿl_off£t
);

146 
ASSERT_LT
(
ex³ùed_»cÜd_off£t
, 
num_š™Ÿl_off£t_»cÜds_
);

147 ; 
	gex³ùed_»cÜd_off£t
 < 
	gnum_š™Ÿl_off£t_»cÜds_
;

148 ++
	gex³ùed_»cÜd_off£t
) {

149 
Sliû
 
	g»cÜd
;

150 
	g¡d
::
¡ršg
 
sü©ch
;

151 
ASSERT_TRUE
(
off£t_»ad”
->
R—dRecÜd
(&
»cÜd
, &
sü©ch
));

152 
ASSERT_EQ
(
š™Ÿl_off£t_»cÜd_sizes_
[
ex³ùed_»cÜd_off£t
],

153 
»cÜd
.
size
());

154 
ASSERT_EQ
(
š™Ÿl_off£t_Ï¡_»cÜd_off£ts_
[
ex³ùed_»cÜd_off£t
],

155 
off£t_»ad”
->
La¡RecÜdOff£t
());

156 
ASSERT_EQ
(()('a' + 
ex³ùed_»cÜd_off£t
), 
»cÜd
.
d©a
()[0]);

158 
d–‘e
 
	goff£t_»ad”
;

161 
	g´iv©e
:

162 şas 
	cSŒšgDe¡
 : 
public
 
Wr™abËFe
 {

163 
public
:

164 
Stus
 
Clo£
(è
ov”ride
 {  Stus::
OK
(); }

165 
Stus
 
Flush
(è
	gov”ride
 {  
	gStus
::
OK
(); }

166 
Stus
 
Sync
(è
	gov”ride
 {  
	gStus
::
OK
(); }

167 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
¦iû
è
	gov”ride
 {

168 
	gcÚ‹Ás_
.
­³nd
(
¦iû
.
d©a
(), sliû.
size
());

169  
	gStus
::
OK
();

172 
	g¡d
::
¡ršg
 
cÚ‹Ás_
;

175 şas 
	cSŒšgSourû
 : 
public
 
Sequ’tŸlFe
 {

176 
public
:

177 
SŒšgSourû
(è: 
fÜû_”rÜ_
(
çl£
), 
»tuºed_·¹Ÿl_
(false) {}

179 
Stus
 
R—d
(
size_t
 
n
, 
Sliû
* 
»suÉ
, * 
sü©ch
è
	gov”ride
 {

180 
EXPECT_TRUE
(!
»tuºed_·¹Ÿl_
) << "must‚ot Read()‡fterƒof/error";

182 ià(
	gfÜû_”rÜ_
) {

183 
	gfÜû_”rÜ_
 = 
çl£
;

184 
	g»tuºed_·¹Ÿl_
 = 
Œue
;

185  
	gStus
::
CÜru±iÚ
("readƒrror");

188 ià(
	gcÚ‹Ás_
.
size
(è< 
	gn
) {

189 
	gn
 = 
cÚ‹Ás_
.
size
();

190 
	g»tuºed_·¹Ÿl_
 = 
Œue
;

192 *
	g»suÉ
 = 
Sliû
(
cÚ‹Ás_
.
d©a
(), 
n
);

193 
	gcÚ‹Ás_
.
»move_´efix
(
n
);

194  
	gStus
::
OK
();

197 
Stus
 
Sk
(
ušt64_t
 
n
è
	gov”ride
 {

198 ià(
	gn
 > 
	gcÚ‹Ás_
.
size
()) {

199 
	gcÚ‹Ás_
.
ş—r
();

200  
	gStus
::
NÙFound
("in-memory file skipped…astƒnd");

203 
	gcÚ‹Ás_
.
»move_´efix
(
n
);

205  
	gStus
::
OK
();

208 
Sliû
 
	gcÚ‹Ás_
;

209 
boŞ
 
	gfÜû_”rÜ_
;

210 
boŞ
 
	g»tuºed_·¹Ÿl_
;

213 şas 
	cR•ÜtCŞËùÜ
 : 
public
 
R—d”
::
R•Ü‹r
 {

214 
public
:

215 
R•ÜtCŞËùÜ
(è: 
drİ³d_by‹s_
(0) {}

216 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
¡©us
è
	gov”ride
 {

217 
	gdrİ³d_by‹s_
 +ğ
by‹s
;

218 
	gmes§ge_
.
­³nd
(
¡©us
.
ToSŒšg
());

221 
size_t
 
	gdrİ³d_by‹s_
;

222 
	g¡d
::
¡ršg
 
mes§ge_
;

226 
size_t
 
	gš™Ÿl_off£t_»cÜd_sizes_
[];

227 
ušt64_t
 
	gš™Ÿl_off£t_Ï¡_»cÜd_off£ts_
[];

228 
	gnum_š™Ÿl_off£t_»cÜds_
;

230 
SŒšgDe¡
 
	gde¡_
;

231 
SŒšgSourû
 
	gsourû_
;

232 
R•ÜtCŞËùÜ
 
	g»pÜt_
;

233 
boŞ
 
	g»adšg_
;

234 
Wr™”
* 
	gwr™”_
;

235 
R—d”
* 
	g»ad”_
;

238 
size_t
 
	gLogTe¡
::
š™Ÿl_off£t_»cÜd_sizes_
[] = {

241 2 * 
log
::
kBlockSize
 - 1000,

244 
log
::
kBlockSize
 - 
kH—d”Size
,

247 
ušt64_t
 
	gLogTe¡
::
š™Ÿl_off£t_Ï¡_»cÜd_off£ts_
[] = {

249 
kH—d”Size
 + 10000,

250 2 * (
kH—d”Size
 + 10000),

251 2 * (
kH—d”Size
 + 10000è+ (2 * 
log
::
kBlockSize
 - 1000) + 3 * kHeaderSize,

252 2 * (
kH—d”Size
 + 10000è+ (2 * 
log
::
kBlockSize
 - 1000) + 3 * kHeaderSize +

253 
kH—d”Size
 + 1,

254 3 * 
log
::
kBlockSize
,

258 
	gLogTe¡
::
num_š™Ÿl_off£t_»cÜds_
 =

259 (
LogTe¡
::
š™Ÿl_off£t_Ï¡_»cÜd_off£ts_
è/ (
ušt64_t
);

261 
TEST_F
(
LogTe¡
, 
Em±y
è{ 
ASSERT_EQ
("EOF", 
R—d
()); }

263 
TEST_F
(
LogTe¡
, 
R—dWr™e
) {

264 
Wr™e
("foo");

265 
Wr™e
("bar");

266 
Wr™e
("");

267 
Wr™e
("xxxx");

268 
ASSERT_EQ
("foo", 
R—d
());

269 
ASSERT_EQ
("b¬", 
R—d
());

270 
ASSERT_EQ
("", 
R—d
());

271 
ASSERT_EQ
("xxxx", 
R—d
());

272 
ASSERT_EQ
("EOF", 
R—d
());

273 
ASSERT_EQ
("EOF", 
R—d
());

276 
TEST_F
(
LogTe¡
, 
MªyBlocks
) {

277 
	gi
 = 0; i < 100000; i++) {

278 
Wr™e
(
Numb”SŒšg
(
i
));

280 
	gi
 = 0; i < 100000; i++) {

281 
ASSERT_EQ
(
Numb”SŒšg
(
i
), 
R—d
());

283 
ASSERT_EQ
("EOF", 
R—d
());

286 
TEST_F
(
LogTe¡
, 
F¿gm’tiÚ
) {

287 
Wr™e
("small");

288 
Wr™e
(
BigSŒšg
("medium", 50000));

289 
Wr™e
(
BigSŒšg
("large", 100000));

290 
ASSERT_EQ
("sm®l", 
R—d
());

291 
ASSERT_EQ
(
BigSŒšg
("medium", 50000), 
R—d
());

292 
ASSERT_EQ
(
BigSŒšg
("Ïrge", 100000), 
R—d
());

293 
ASSERT_EQ
("EOF", 
R—d
());

296 
TEST_F
(
LogTe¡
, 
M¬gš®T¿”
) {

298 cÚ¡ 
	gn
 = 
kBlockSize
 - 2 * 
kH—d”Size
;

299 
Wr™e
(
BigSŒšg
("foo", 
n
));

300 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
, 
Wr™‹nBy‹s
());

301 
Wr™e
("");

302 
Wr™e
("bar");

303 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

304 
ASSERT_EQ
("", 
R—d
());

305 
ASSERT_EQ
("b¬", 
R—d
());

306 
ASSERT_EQ
("EOF", 
R—d
());

309 
TEST_F
(
LogTe¡
, 
M¬gš®T¿”2
) {

311 cÚ¡ 
	gn
 = 
kBlockSize
 - 2 * 
kH—d”Size
;

312 
Wr™e
(
BigSŒšg
("foo", 
n
));

313 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
, 
Wr™‹nBy‹s
());

314 
Wr™e
("bar");

315 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

316 
ASSERT_EQ
("b¬", 
R—d
());

317 
ASSERT_EQ
("EOF", 
R—d
());

318 
ASSERT_EQ
(0, 
Drİ³dBy‹s
());

319 
ASSERT_EQ
("", 
R•ÜtMes§ge
());

322 
TEST_F
(
LogTe¡
, 
ShÜtT¿”
) {

323 cÚ¡ 
	gn
 = 
kBlockSize
 - 2 * 
kH—d”Size
 + 4;

324 
Wr™e
(
BigSŒšg
("foo", 
n
));

325 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
 + 4, 
Wr™‹nBy‹s
());

326 
Wr™e
("");

327 
Wr™e
("bar");

328 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

329 
ASSERT_EQ
("", 
R—d
());

330 
ASSERT_EQ
("b¬", 
R—d
());

331 
ASSERT_EQ
("EOF", 
R—d
());

334 
TEST_F
(
LogTe¡
, 
AligÃdEof
) {

335 cÚ¡ 
	gn
 = 
kBlockSize
 - 2 * 
kH—d”Size
 + 4;

336 
Wr™e
(
BigSŒšg
("foo", 
n
));

337 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
 + 4, 
Wr™‹nBy‹s
());

338 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

339 
ASSERT_EQ
("EOF", 
R—d
());

342 
TEST_F
(
LogTe¡
, 
O³nFÜAµ’d
) {

343 
Wr™e
("hello");

344 
Reİ’FÜAµ’d
();

345 
Wr™e
("world");

346 
ASSERT_EQ
("h–lo", 
R—d
());

347 
ASSERT_EQ
("wÜld", 
R—d
());

348 
ASSERT_EQ
("EOF", 
R—d
());

351 
TEST_F
(
LogTe¡
, 
RªdomR—d
) {

352 cÚ¡ 
	gN
 = 500;

353 
Rªdom
 
wr™e_ºd
(301);

354 
	gi
 = 0; i < 
	gN
; i++) {

355 
Wr™e
(
RªdomSkewedSŒšg
(
i
, &
wr™e_ºd
));

357 
Rªdom
 
»ad_ºd
(301);

358 
	gi
 = 0; i < 
	gN
; i++) {

359 
ASSERT_EQ
(
RªdomSkewedSŒšg
(
i
, &
»ad_ºd
), 
R—d
());

361 
ASSERT_EQ
("EOF", 
R—d
());

366 
TEST_F
(
LogTe¡
, 
R—dE¼Ü
) {

367 
Wr™e
("foo");

368 
FÜûE¼Ü
();

369 
ASSERT_EQ
("EOF", 
R—d
());

370 
ASSERT_EQ
(
kBlockSize
, 
Drİ³dBy‹s
());

371 
ASSERT_EQ
("OK", 
M©chE¼Ü
("readƒrror"));

374 
TEST_F
(
LogTe¡
, 
BadRecÜdTy³
) {

375 
Wr™e
("foo");

377 
Inüem’tBy‹
(6, 100);

378 
FixChecksum
(0, 3);

379 
ASSERT_EQ
("EOF", 
R—d
());

380 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

381 
ASSERT_EQ
("OK", 
M©chE¼Ü
("unknown„ecordype"));

384 
TEST_F
(
LogTe¡
, 
Trunÿ‹dT¿šgRecÜdIsIgnÜed
) {

385 
Wr™e
("foo");

386 
ShrškSize
(4);

387 
ASSERT_EQ
("EOF", 
R—d
());

389 
ASSERT_EQ
(0, 
Drİ³dBy‹s
());

390 
ASSERT_EQ
("", 
R•ÜtMes§ge
());

393 
TEST_F
(
LogTe¡
, 
BadL’gth
) {

394 cÚ¡ 
	gkPaylßdSize
 = 
kBlockSize
 - 
kH—d”Size
;

395 
Wr™e
(
BigSŒšg
("b¬", 
kPaylßdSize
));

396 
Wr™e
("foo");

398 
Inüem’tBy‹
(4, 1);

399 
ASSERT_EQ
("foo", 
R—d
());

400 
ASSERT_EQ
(
kBlockSize
, 
Drİ³dBy‹s
());

401 
ASSERT_EQ
("OK", 
M©chE¼Ü
("bad„ecord†ength"));

404 
TEST_F
(
LogTe¡
, 
BadL’gthAtEndIsIgnÜed
) {

405 
Wr™e
("foo");

406 
ShrškSize
(1);

407 
ASSERT_EQ
("EOF", 
R—d
());

408 
ASSERT_EQ
(0, 
Drİ³dBy‹s
());

409 
ASSERT_EQ
("", 
R•ÜtMes§ge
());

412 
TEST_F
(
LogTe¡
, 
ChecksumMism©ch
) {

413 
Wr™e
("foo");

414 
Inüem’tBy‹
(0, 10);

415 
ASSERT_EQ
("EOF", 
R—d
());

416 
ASSERT_EQ
(10, 
Drİ³dBy‹s
());

417 
ASSERT_EQ
("OK", 
M©chE¼Ü
("checksum mismatch"));

420 
TEST_F
(
LogTe¡
, 
UÃx³ùedMiddËTy³
) {

421 
Wr™e
("foo");

422 
S‘By‹
(6, 
kMiddËTy³
);

423 
FixChecksum
(0, 3);

424 
ASSERT_EQ
("EOF", 
R—d
());

425 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

426 
ASSERT_EQ
("OK", 
M©chE¼Ü
("missing start"));

429 
TEST_F
(
LogTe¡
, 
UÃx³ùedLa¡Ty³
) {

430 
Wr™e
("foo");

431 
S‘By‹
(6, 
kLa¡Ty³
);

432 
FixChecksum
(0, 3);

433 
ASSERT_EQ
("EOF", 
R—d
());

434 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

435 
ASSERT_EQ
("OK", 
M©chE¼Ü
("missing start"));

438 
TEST_F
(
LogTe¡
, 
UÃx³ùedFuÎTy³
) {

439 
Wr™e
("foo");

440 
Wr™e
("bar");

441 
S‘By‹
(6, 
kFœ¡Ty³
);

442 
FixChecksum
(0, 3);

443 
ASSERT_EQ
("b¬", 
R—d
());

444 
ASSERT_EQ
("EOF", 
R—d
());

445 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

446 
ASSERT_EQ
("OK", 
M©chE¼Ü
("partial„ecord withoutƒnd"));

449 
TEST_F
(
LogTe¡
, 
UÃx³ùedFœ¡Ty³
) {

450 
Wr™e
("foo");

451 
Wr™e
(
BigSŒšg
("bar", 100000));

452 
S‘By‹
(6, 
kFœ¡Ty³
);

453 
FixChecksum
(0, 3);

454 
ASSERT_EQ
(
BigSŒšg
("b¬", 100000), 
R—d
());

455 
ASSERT_EQ
("EOF", 
R—d
());

456 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

457 
ASSERT_EQ
("OK", 
M©chE¼Ü
("partial„ecord withoutƒnd"));

460 
TEST_F
(
LogTe¡
, 
MissšgLa¡IsIgnÜed
) {

461 
Wr™e
(
BigSŒšg
("b¬", 
kBlockSize
));

463 
ShrškSize
(14);

464 
ASSERT_EQ
("EOF", 
R—d
());

465 
ASSERT_EQ
("", 
R•ÜtMes§ge
());

466 
ASSERT_EQ
(0, 
Drİ³dBy‹s
());

469 
TEST_F
(
LogTe¡
, 
P¬tŸlLa¡IsIgnÜed
) {

470 
Wr™e
(
BigSŒšg
("b¬", 
kBlockSize
));

472 
ShrškSize
(1);

473 
ASSERT_EQ
("EOF", 
R—d
());

474 
ASSERT_EQ
("", 
R•ÜtMes§ge
());

475 
ASSERT_EQ
(0, 
Drİ³dBy‹s
());

478 
TEST_F
(
LogTe¡
, 
SkIÁoMuÉiRecÜd
) {

484 
Wr™e
(
BigSŒšg
("foo", 3 * 
kBlockSize
));

485 
Wr™e
("correct");

486 
S¹R—dšgAt
(
kBlockSize
);

488 
ASSERT_EQ
("cÜ»ù", 
R—d
());

489 
ASSERT_EQ
("", 
R•ÜtMes§ge
());

490 
ASSERT_EQ
(0, 
Drİ³dBy‹s
());

491 
ASSERT_EQ
("EOF", 
R—d
());

494 
TEST_F
(
LogTe¡
, 
E¼ÜJošsRecÜds
) {

501 
Wr™e
(
BigSŒšg
("foo", 
kBlockSize
));

502 
Wr™e
(
BigSŒšg
("b¬", 
kBlockSize
));

503 
Wr™e
("correct");

506 
	goff£t
 = 
kBlockSize
; off£ˆ< 2 * 
	gkBlockSize
; offset++) {

507 
S‘By‹
(
off£t
, 'x');

510 
ASSERT_EQ
("cÜ»ù", 
R—d
());

511 
ASSERT_EQ
("EOF", 
R—d
());

512 cÚ¡ 
size_t
 
	gdrİ³d
 = 
Drİ³dBy‹s
();

513 
ASSERT_LE
(
drİ³d
, 2 * 
kBlockSize
 + 100);

514 
ASSERT_GE
(
drİ³d
, 2 * 
kBlockSize
);

517 
TEST_F
(
LogTe¡
, 
R—dS¹
è{ 
CheckIn™ŸlOff£tRecÜd
(0, 0); }

519 
TEST_F
(
LogTe¡
, 
R—dSecÚdOÃOff
è{ 
CheckIn™ŸlOff£tRecÜd
(1, 1); }

521 
TEST_F
(
LogTe¡
, 
R—dSecÚdT’Thou§nd
è{ 
CheckIn™ŸlOff£tRecÜd
(10000, 1); }

523 
TEST_F
(
LogTe¡
, 
R—dSecÚdS¹
è{ 
CheckIn™ŸlOff£tRecÜd
(10007, 1); }

525 
TEST_F
(
LogTe¡
, 
R—dThœdOÃOff
è{ 
CheckIn™ŸlOff£tRecÜd
(10008, 2); }

527 
TEST_F
(
LogTe¡
, 
R—dThœdS¹
è{ 
CheckIn™ŸlOff£tRecÜd
(20014, 2); }

529 
TEST_F
(
LogTe¡
, 
R—dFou¹hOÃOff
è{ 
CheckIn™ŸlOff£tRecÜd
(20015, 3); }

531 
TEST_F
(
LogTe¡
, 
R—dFou¹hFœ¡BlockT¿”
) {

532 
CheckIn™ŸlOff£tRecÜd
(
log
::
kBlockSize
 - 4, 3);

535 
TEST_F
(
LogTe¡
, 
R—dFou¹hMiddËBlock
) {

536 
CheckIn™ŸlOff£tRecÜd
(
log
::
kBlockSize
 + 1, 3);

539 
TEST_F
(
LogTe¡
, 
R—dFou¹hLa¡Block
) {

540 
CheckIn™ŸlOff£tRecÜd
(2 * 
log
::
kBlockSize
 + 1, 3);

543 
TEST_F
(
LogTe¡
, 
R—dFou¹hS¹
) {

544 
CheckIn™ŸlOff£tRecÜd
(

545 2 * (
kH—d”Size
 + 1000è+ (2 * 
log
::
kBlockSize
 - 1000) + 3 * kHeaderSize,

549 
TEST_F
(
LogTe¡
, 
R—dIn™ŸlOff£tIÁoBlockPaddšg
) {

550 
CheckIn™ŸlOff£tRecÜd
(3 * 
log
::
kBlockSize
 - 3, 5);

553 
TEST_F
(
LogTe¡
, 
R—dEnd
è{ 
CheckOff£tPa¡EndR‘uºsNoRecÜds
(0); }

555 
TEST_F
(
LogTe¡
, 
R—dPa¡End
è{ 
CheckOff£tPa¡EndR‘uºsNoRecÜds
(5); }

560 
	$maš
(
¬gc
, ** 
¬gv
) {

561 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

562  
	`RUN_ALL_TESTS
();

563 
	}
}

	@log_writer.cc

5 
	~"db/log_wr™”.h
"

7 
	~<¡dšt.h
>

9 
	~"Ëv–db/’v.h
"

10 
	~"ut/codšg.h
"

11 
	~"ut/üc32c.h
"

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	glog
 {

16 
In™Ty³Crc
(
ušt32_t
* 
ty³_üc
) {

17 
	gi
 = 0; i <ğ
kMaxRecÜdTy³
; i++) {

18 
	gt
 = 
¡©ic_ÿ¡
<>(
i
);

19 
	gty³_üc
[
i
] = 
üc32c
::
V®ue
(&
t
, 1);

23 
	gWr™”
::
Wr™”
(
Wr™abËFe
* 
de¡
è: 
de¡_
(de¡), 
block_off£t_
(0) {

24 
In™Ty³Crc
(
ty³_üc_
);

27 
	gWr™”
::
Wr™”
(
Wr™abËFe
* 
de¡
, 
ušt64_t
 
de¡_Ëngth
)

28 : 
de¡_
(
de¡
), 
block_off£t_
(
de¡_Ëngth
 % 
kBlockSize
) {

29 
In™Ty³Crc
(
ty³_üc_
);

32 
	gWr™”
::~
Wr™”
() = ;

36 
Stus
 
	gWr™”
::
AddRecÜd
(cÚ¡ 
Sliû
& 
¦iû
) {

37 cÚ¡ * 
±r
 = 
¦iû
.
d©a
();

38 
size_t
 
	gËá
 = 
¦iû
.
size
();

43 
Stus
 
	gs
;

44 
boŞ
 
	gbegš
 = 
Œue
;

46 cÚ¡ 
	gËáov”
 = 
kBlockSize
 - 
block_off£t_
;

47 
as£¹
(
Ëáov”
 >= 0);

48 ià(
	gËáov”
 < 
	gkH—d”Size
) {

50 ià(
	gËáov”
 > 0) {

52 
¡©ic_as£¹
(
kH—d”Size
 == 7, "");

53 
	gde¡_
->
Aµ’d
(
Sliû
("\x00\x00\x00\x00\x00\x00", 
Ëáov”
));

55 
	gblock_off£t_
 = 0;

59 
as£¹
(
kBlockSize
 - 
block_off£t_
 - 
kH—d”Size
 >= 0);

61 cÚ¡ 
size_t
 
	gava
 = 
kBlockSize
 - 
block_off£t_
 - 
kH—d”Size
;

62 cÚ¡ 
size_t
 
	gäagm’t_Ëngth
 = (
Ëá
 < 
ava
) ?†eft :‡vail;

64 
RecÜdTy³
 
	gty³
;

65 cÚ¡ 
boŞ
 
	g’d
 = (
Ëá
 =ğ
äagm’t_Ëngth
);

66 ià(
	gbegš
 && 
	g’d
) {

67 
	gty³
 = 
kFuÎTy³
;

68 } ià(
	gbegš
) {

69 
	gty³
 = 
kFœ¡Ty³
;

70 } ià(
	g’d
) {

71 
	gty³
 = 
kLa¡Ty³
;

73 
	gty³
 = 
kMiddËTy³
;

76 
	gs
 = 
Em™PhysiÿlRecÜd
(
ty³
, 
±r
, 
äagm’t_Ëngth
);

77 
	g±r
 +ğ
äagm’t_Ëngth
;

78 
	gËá
 -ğ
äagm’t_Ëngth
;

79 
	gbegš
 = 
çl£
;

80 } 
	gs
.
ok
(è&& 
	gËá
 > 0);

81  
	gs
;

84 
Stus
 
	gWr™”
::
Em™PhysiÿlRecÜd
(
RecÜdTy³
 
t
, cÚ¡ * 
±r
,

85 
size_t
 
Ëngth
) {

86 
as£¹
(
Ëngth
 <= 0xffff);

87 
as£¹
(
block_off£t_
 + 
kH—d”Size
 + 
Ëngth
 <ğ
kBlockSize
);

90 
	gbuf
[
kH—d”Size
];

91 
	gbuf
[4] = 
¡©ic_ÿ¡
<>(
Ëngth
 & 0xff);

92 
	gbuf
[5] = 
¡©ic_ÿ¡
<>(
Ëngth
 >> 8);

93 
	gbuf
[6] = 
¡©ic_ÿ¡
<>(
t
);

96 
ušt32_t
 
	güc
 = 
üc32c
::
Ex‹nd
(
ty³_üc_
[
t
], 
±r
, 
Ëngth
);

97 
	güc
 = 
üc32c
::
Mask
(
üc
);

98 
EncodeFixed32
(
buf
, 
üc
);

101 
Stus
 
	gs
 = 
de¡_
->
Aµ’d
(
Sliû
(
buf
, 
kH—d”Size
));

102 ià(
	gs
.
ok
()) {

103 
	gs
 = 
de¡_
->
Aµ’d
(
Sliû
(
±r
, 
Ëngth
));

104 ià(
	gs
.
ok
()) {

106 
	gs
 = 
de¡_
->
Flush
();

109 
	gblock_off£t_
 +ğ
kH—d”Size
 + 
Ëngth
;

110  
	gs
;

	@log_writer.h

5 #iâdeà
STORAGE_LEVELDB_DB_LOG_WRITER_H_


6 
	#STORAGE_LEVELDB_DB_LOG_WRITER_H_


	)

8 
	~<¡dšt.h
>

10 
	~"db/log_fÜm©.h
"

11 
	~"Ëv–db/¦iû.h
"

12 
	~"Ëv–db/¡©us.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
şass
 
	gWr™abËFe
;

18 
Çme¥aû
 
	glog
 {

20 şas 
	cWr™”
 {

21 
	gpublic
:

25 
ex¶ic™
 
Wr™”
(
Wr™abËFe
* 
de¡
);

30 
Wr™”
(
Wr™abËFe
* 
de¡
, 
ušt64_t
 
de¡_Ëngth
);

32 
Wr™”
(cÚ¡ Wr™”&èğ
d–‘e
;

33 
	gWr™”
& 
	gİ”©Ü
=(cÚ¡ 
Wr™”
&èğ
d–‘e
;

35 ~
Wr™”
();

37 
Stus
 
AddRecÜd
(cÚ¡ 
Sliû
& 
¦iû
);

39 
	g´iv©e
:

40 
Stus
 
Em™PhysiÿlRecÜd
(
RecÜdTy³
 
ty³
, cÚ¡ * 
±r
, 
size_t
 
Ëngth
);

42 
Wr™abËFe
* 
	gde¡_
;

43 
	gblock_off£t_
;

48 
ušt32_t
 
	gty³_üc_
[
kMaxRecÜdTy³
 + 1];

	@memtable.cc

5 
	~"db/membË.h
"

6 
	~"db/dbfÜm©.h
"

7 
	~"Ëv–db/com·¿tÜ.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"Ëv–db/™”©Ü.h
"

10 
	~"ut/codšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
Sliû
 
G‘L’gthP»fixedSliû
(cÚ¡ * 
d©a
) {

15 
ušt32_t
 
	gËn
;

16 cÚ¡ * 
	gp
 = 
d©a
;

17 
	gp
 = 
G‘V¬št32PŒ
(
p
,… + 5, &
Ën
);

18  
Sliû
(
p
, 
Ën
);

21 
	gMemTabË
::
MemTabË
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
com·¿tÜ
)

22 : 
com·¿tÜ_
(
com·¿tÜ
), 
»fs_
(0), 
bË_
(com·¿tÜ_, &
¬’a_
) {}

24 
	gMemTabË
::~
MemTabË
(è{ 
as£¹
(
»fs_
 == 0); }

26 
size_t
 
	gMemTabË
::
Aµroxim©eMemÜyU§ge
(è{  
¬’a_
.
MemÜyU§ge
(); }

28 
	gMemTabË
::
KeyCom·¿tÜ
::
İ”©Ü
()(cÚ¡ * 
­Œ
,

29 cÚ¡ * 
	gb±r
) const {

31 
Sliû
 
	ga
 = 
G‘L’gthP»fixedSliû
(
­Œ
);

32 
Sliû
 
	gb
 = 
G‘L’gthP»fixedSliû
(
b±r
);

33  
	gcom·¿tÜ
.
Com·»
(
a
, 
b
);

39 cÚ¡ * 
EncodeKey
(
¡d
::
¡ršg
* 
sü©ch
, cÚ¡ 
Sliû
& 
rg‘
) {

40 
	gsü©ch
->
ş—r
();

41 
PutV¬št32
(
sü©ch
, 
rg‘
.
size
());

42 
	gsü©ch
->
­³nd
(
rg‘
.
d©a
(),¬g‘.
size
());

43  
	gsü©ch
->
d©a
();

46 şas 
	cMemTabËI‹¿tÜ
 : 
public
 
I‹¿tÜ
 {

47 
public
:

48 
ex¶ic™
 
MemTabËI‹¿tÜ
(
MemTabË
::
TabË
* 
bË
è: 
™”_
(table) {}

50 
MemTabËI‹¿tÜ
(cÚ¡ MemTabËI‹¿tÜ&èğ
d–‘e
;

51 
	gMemTabËI‹¿tÜ
& 
	gİ”©Ü
=(cÚ¡ 
MemTabËI‹¿tÜ
&èğ
d–‘e
;

53 ~
MemTabËI‹¿tÜ
(è
	gov”ride
 = ;

55 
boŞ
 
V®id
(ècÚ¡ 
	gov”ride
 {  
	g™”_
.Valid(); }

56 
S“k
(cÚ¡ 
Sliû
& 
k
è
	gov”ride
 { 
	g™”_
.S“k(
EncodeKey
(&
tmp_
, k)); }

57 
S“kToFœ¡
(è
	gov”ride
 { 
	g™”_
.SeekToFirst(); }

58 
S“kToLa¡
(è
	gov”ride
 { 
	g™”_
.SeekToLast(); }

59 
Next
(è
	gov”ride
 { 
	g™”_
.Next(); }

60 
P»v
(è
	gov”ride
 { 
	g™”_
.Prev(); }

61 
Sliû
 
key
(ècÚ¡ 
	gov”ride
 {  
G‘L’gthP»fixedSliû
(
™”_
.key()); }

62 
Sliû
 
v®ue
(ècÚ¡ 
	gov”ride
 {

63 
Sliû
 
	gkey_¦iû
 = 
G‘L’gthP»fixedSliû
(
™”_
.
key
());

64  
G‘L’gthP»fixedSliû
(
key_¦iû
.
d©a
(è+ key_¦iû.
size
());

67 
Stus
 
¡©us
(ècÚ¡ 
	gov”ride
 {  
	gStus
::
OK
(); }

69 
	g´iv©e
:

70 
MemTabË
::
TabË
::
I‹¿tÜ
 
™”_
;

71 
	g¡d
::
¡ršg
 
tmp_
;

74 
I‹¿tÜ
* 
	gMemTabË
::
	$NewI‹¿tÜ
(è{  
Ãw
 
	`MemTabËI‹¿tÜ
(&
bË_
); 
	}
}

76 
	gMemTabË
::
	$Add
(
Sequ’ûNumb”
 
s
, 
V®ueTy³
 
ty³
, cÚ¡ 
Sliû
& 
key
,

77 cÚ¡ 
Sliû
& 
v®ue
) {

83 
size_t
 
key_size
 = 
key
.
	`size
();

84 
size_t
 
v®_size
 = 
v®ue
.
	`size
();

85 
size_t
 
š‹º®_key_size
 = 
key_size
 + 8;

86 cÚ¡ 
size_t
 
’coded_Ën
 = 
	`V¬štL’gth
(
š‹º®_key_size
) +

87 
š‹º®_key_size
 + 
	`V¬štL’gth
(
v®_size
) +

88 
v®_size
;

89 * 
buf
 = 
¬’a_
.
	`AÎoÿ‹
(
’coded_Ën
);

90 * 
p
 = 
	`EncodeV¬št32
(
buf
, 
š‹º®_key_size
);

91 
	`memıy
(
p
, 
key
.
	`d©a
(), 
key_size
);

92 
p
 +ğ
key_size
;

93 
	`EncodeFixed64
(
p
, (
s
 << 8è| 
ty³
);

94 
p
 += 8;

95 
p
 = 
	`EncodeV¬št32
Õ, 
v®_size
);

96 
	`memıy
(
p
, 
v®ue
.
	`d©a
(), 
v®_size
);

97 
	`as£¹
(
p
 + 
v®_size
 =ğ
buf
 + 
’coded_Ën
);

98 
bË_
.
	`In£¹
(
buf
);

99 
	}
}

101 
boŞ
 
	gMemTabË
::
	$G‘
(cÚ¡ 
LookupKey
& 
key
, 
¡d
::
¡ršg
* 
v®ue
, 
Stus
* 
s
) {

102 
Sliû
 
memkey
 = 
key
.
	`membË_key
();

103 
TabË
::
I‹¿tÜ
 
	`™”
(&
bË_
);

104 
™”
.
	`S“k
(
memkey
.
	`d©a
());

105 ià(
™”
.
	`V®id
()) {

115 cÚ¡ * 
’Œy
 = 
™”
.
	`key
();

116 
ušt32_t
 
key_Ëngth
;

117 cÚ¡ * 
key_±r
 = 
	`G‘V¬št32PŒ
(
’Œy
,ƒÁry + 5, &
key_Ëngth
);

118 ià(
com·¿tÜ_
.
com·¿tÜ
.
	`u£r_com·¿tÜ
()->
	`Com·»
(

119 
	`Sliû
(
key_±r
, 
key_Ëngth
 - 8), 
key
.
	`u£r_key
()) == 0) {

121 cÚ¡ 
ušt64_t
 
g
 = 
	`DecodeFixed64
(
key_±r
 + 
key_Ëngth
 - 8);

122 
¡©ic_ÿ¡
<
V®ueTy³
>(
g
 & 0xff)) {

123 
kTy³V®ue
: {

124 
Sliû
 
v
 = 
	`G‘L’gthP»fixedSliû
(
key_±r
 + 
key_Ëngth
);

125 
v®ue
->
	`assign
(
v
.
	`d©a
(), v.
	`size
());

126  
Œue
;

128 
kTy³D–‘iÚ
:

129 *
s
 = 
Stus
::
	`NÙFound
(
	`Sliû
());

130  
Œue
;

134  
çl£
;

135 
	}
}

	@memtable.h

5 #iâdeà
STORAGE_LEVELDB_DB_MEMTABLE_H_


6 
	#STORAGE_LEVELDB_DB_MEMTABLE_H_


	)

8 
	~<¡ršg
>

10 
	~"db/dbfÜm©.h
"

11 
	~"db/skli¡.h
"

12 
	~"Ëv–db/db.h
"

13 
	~"ut/¬’a.h
"

15 
Çme¥aû
 
	gËv–db
 {

17 
şass
 
	gIÁ”ÇlKeyCom·¿tÜ
;

18 
şass
 
	gMemTabËI‹¿tÜ
;

20 şas 
	cMemTabË
 {

21 
	gpublic
:

24 
ex¶ic™
 
MemTabË
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
com·¿tÜ
);

26 
MemTabË
(cÚ¡ MemTabË&èğ
d–‘e
;

27 
	gMemTabË
& 
	gİ”©Ü
=(cÚ¡ 
MemTabË
&èğ
d–‘e
;

30 
Ref
(è{ ++
	g»fs_
; }

33 
UÄef
() {

34 --
	g»fs_
;

35 
as£¹
(
»fs_
 >= 0);

36 ià(
	g»fs_
 <= 0) {

37 
d–‘e
 
this
;

43 
size_t
 
Aµroxim©eMemÜyU§ge
();

51 
I‹¿tÜ
* 
NewI‹¿tÜ
();

56 
Add
(
Sequ’ûNumb”
 
£q
, 
V®ueTy³
 
ty³
, cÚ¡ 
Sliû
& 
key
,

57 cÚ¡ 
Sliû
& 
v®ue
);

63 
boŞ
 
G‘
(cÚ¡ 
LookupKey
& 
key
, 
¡d
::
¡ršg
* 
v®ue
, 
Stus
* 
s
);

65 
	g´iv©e
:

66 
ä›nd
 
şass
 
MemTabËI‹¿tÜ
;

67 
ä›nd
 
şass
 
	gMemTabËBackw¬dI‹¿tÜ
;

69 
	sKeyCom·¿tÜ
 {

70 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
	gcom·¿tÜ
;

71 
ex¶ic™
 
KeyCom·¿tÜ
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
c
è: 
com·¿tÜ
(c) {}

72 
İ”©Ü
()(cÚ¡ * 
a
, cÚ¡ * 
	gb
) const;

75 
	gSkLi¡
<cÚ¡ *, 
	tKeyCom·¿tÜ
> 
	tTabË
;

77 ~
MemTabË
();

79 
KeyCom·¿tÜ
 
	gcom·¿tÜ_
;

80 
	g»fs_
;

81 
A»Ç
 
	g¬’a_
;

82 
TabË
 
	gbË_
;

	@recovery_test.cc

5 
	~"g‹¡/g‹¡.h
"

6 
	~"db/db_im¶.h
"

7 
	~"db/f’ame.h
"

8 
	~"db/v”siÚ_£t.h
"

9 
	~"db/wr™e_b©ch_š‹º®.h
"

10 
	~"Ëv–db/db.h
"

11 
	~"Ëv–db/’v.h
"

12 
	~"Ëv–db/wr™e_b©ch.h
"

13 
	~"ut/loggšg.h
"

14 
	~"ut/‹¡ut.h
"

16 
Çme¥aû
 
	gËv–db
 {

18 şas 
	cRecov”yTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

19 
public
:

20 
Recov”yTe¡
(è: 
’v_
(
Env
::
DeçuÉ
()), 
db_
(
nuÎ±r
) {

21 
	gdbÇme_
 = 
‹¡šg
::
TempDœ
() + "/recovery_test";

22 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

23 
O³n
();

26 ~
Recov”yTe¡
() {

27 
Clo£
();

28 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

31 
DBIm¶
* 
dbfuÎ
(ècÚ¡ {  
	g»š‹½»t_ÿ¡
<
	gDBIm¶
*>(
	gdb_
); }

32 
Env
* 
’v
(ècÚ¡ {  
	g’v_
; }

34 
boŞ
 
CªAµ’d
() {

35 
Wr™abËFe
* 
	gtmp
;

36 
Stus
 
	gs
 = 
’v_
->
NewAµ’dabËFe
(
Cu¼’tFeName
(
dbÇme_
), &
tmp
);

37 
d–‘e
 
	gtmp
;

38 ià(
	gs
.
IsNÙSuµÜ‹dE¼Ü
()) {

39  
	gçl£
;

41  
	gŒue
;

45 
Clo£
() {

46 
d–‘e
 
	gdb_
;

47 
	gdb_
 = 
nuÎ±r
;

50 
Stus
 
O³nW™hStus
(
O±iÚs
* 
İtiÚs
 = 
nuÎ±r
) {

51 
Clo£
();

52 
O±iÚs
 
	gİts
;

53 ià(
	gİtiÚs
 !ğ
nuÎ±r
) {

54 
İts
 = *
İtiÚs
;

56 
	gİts
.
	g»u£_logs
 = 
Œue
;

57 
	gİts
.
	gü—‹_if_missšg
 = 
Œue
;

59 ià(
	gİts
.
	g’v
 =ğ
nuÎ±r
) {

60 
İts
.
’v
 = 
’v_
;

62  
	gDB
::
O³n
(
İts
, 
dbÇme_
, &
db_
);

65 
O³n
(
O±iÚs
* 
İtiÚs
 = 
nuÎ±r
) {

66 
ASSERT_LEVELDB_OK
(
O³nW™hStus
(
İtiÚs
));

67 
ASSERT_EQ
(1, 
NumLogs
());

70 
Stus
 
Put
(cÚ¡ 
¡d
::
¡ršg
& 
k
, cÚ¡ std::¡ršg& 
v
) {

71  
db_
->
Put
(
Wr™eO±iÚs
(), 
k
, 
v
);

74 
	g¡d
::
¡ršg
 
G‘
(cÚ¡ 
¡d
::¡ršg& 
k
, cÚ¡ 
SÇpshÙ
* 
¢­shÙ
 = 
nuÎ±r
) {

75 
¡d
::
¡ršg
 
»suÉ
;

76 
Stus
 
	gs
 = 
db_
->
G‘
(
R—dO±iÚs
(), 
k
, &
»suÉ
);

77 ià(
	gs
.
IsNÙFound
()) {

78 
	g»suÉ
 = "NOT_FOUND";

79 } ià(!
	gs
.
ok
()) {

80 
	g»suÉ
 = 
s
.
ToSŒšg
();

82  
	g»suÉ
;

85 
	g¡d
::
¡ršg
 
Mªiã¡FeName
() {

86 
¡d
::
¡ršg
 
cu¼’t
;

87 
EXPECT_LEVELDB_OK
(

88 
R—dFeToSŒšg
(
’v_
, 
Cu¼’tFeName
(
dbÇme_
), &
cu¼’t
));

89 
size_t
 
	gËn
 = 
cu¼’t
.
size
();

90 ià(
	gËn
 > 0 && 
	gcu¼’t
[
Ën
 - 1] == '\n') {

91 
cu¼’t
.
»size
(
Ën
 - 1);

93  
	gdbÇme_
 + "/" + 
	gcu¼’t
;

96 
	g¡d
::
¡ršg
 
LogName
(
ušt64_t
 
numb”
è{  
LogFeName
(
dbÇme_
,‚umber); }

98 
size_t
 
RemoveLogFes
() {

101 
Clo£
();

102 
	g¡d
::
veùÜ
<
ušt64_t
> 
logs
 = 
G‘Fes
(
kLogFe
);

103 
size_t
 
	gi
 = 0; i < 
	glogs
.
size
(); i++) {

104 
EXPECT_LEVELDB_OK
(
’v_
->
RemoveFe
(
LogName
(
logs
[
i
]))) << LogName(logs[i]);

106  
	glogs
.
size
();

109 
RemoveMªiã¡Fe
() {

110 
ASSERT_LEVELDB_OK
(
’v_
->
RemoveFe
(
Mªiã¡FeName
()));

113 
ušt64_t
 
Fœ¡LogFe
(è{  
G‘Fes
(
kLogFe
)[0]; }

115 
	g¡d
::
veùÜ
<
ušt64_t
> 
G‘Fes
(
FeTy³
 
t
) {

116 
¡d
::
veùÜ
<¡d::
¡ršg
> 
f’ames
;

117 
EXPECT_LEVELDB_OK
(
’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
));

118 
	g¡d
::
veùÜ
<
ušt64_t
> 
»suÉ
;

119 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

120 
ušt64_t
 
	gnumb”
;

121 
FeTy³
 
	gty³
;

122 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
è&& 
	gty³
 =ğ
t
) {

123 
»suÉ
.
push_back
(
numb”
);

126  
	g»suÉ
;

129 
NumLogs
(è{  
G‘Fes
(
kLogFe
).
size
(); }

131 
NumTabËs
(è{  
G‘Fes
(
kTabËFe
).
size
(); }

133 
ušt64_t
 
FeSize
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

134 
ušt64_t
 
»suÉ
;

135 
EXPECT_LEVELDB_OK
(
’v_
->
G‘FeSize
(
âame
, &
»suÉ
)è<< 
	gâame
;

136  
	g»suÉ
;

139 
Com·ùMemTabË
(è{ 
dbfuÎ
()->
TEST_Com·ùMemTabË
(); }

142 
MakeLogFe
(
ušt64_t
 
lognum
, 
Sequ’ûNumb”
 
£q
, 
Sliû
 
key
, Sliû 
v®
) {

143 
	g¡d
::
¡ršg
 
âame
 = 
LogFeName
(
dbÇme_
, 
lognum
);

144 
Wr™abËFe
* 
	gfe
;

145 
ASSERT_LEVELDB_OK
(
’v_
->
NewWr™abËFe
(
âame
, &
fe
));

146 
	glog
::
Wr™”
 
wr™”
(
fe
);

147 
Wr™eB©ch
 
	gb©ch
;

148 
	gb©ch
.
Put
(
key
, 
v®
);

149 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(&
b©ch
, 
£q
);

150 
ASSERT_LEVELDB_OK
(
wr™”
.
AddRecÜd
(
Wr™eB©chIÁ”Çl
::
CÚ‹Ás
(&
b©ch
)));

151 
ASSERT_LEVELDB_OK
(
fe
->
Flush
());

152 
d–‘e
 
	gfe
;

155 
	g´iv©e
:

156 
¡d
::
¡ršg
 
dbÇme_
;

157 
Env
* 
	g’v_
;

158 
DB
* 
	gdb_
;

161 
	$TEST_F
(
Recov”yTe¡
, 
Mªiã¡Reu£d
) {

162 ià(!
	`CªAµ’d
()) {

163 
	`årštf
(
¡d”r
, "skippingest becauseƒnv does‚ot support‡ppending\n");

166 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

167 
	`Clo£
();

168 
¡d
::
¡ršg
 
Şd_mªiã¡
 = 
	`Mªiã¡FeName
();

169 
	`O³n
();

170 
	`ASSERT_EQ
(
Şd_mªiã¡
, 
	`Mªiã¡FeName
());

171 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

172 
	`O³n
();

173 
	`ASSERT_EQ
(
Şd_mªiã¡
, 
	`Mªiã¡FeName
());

174 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

175 
	}
}

177 
	$TEST_F
(
Recov”yTe¡
, 
L¬geMªiã¡Com·ùed
) {

178 ià(!
	`CªAµ’d
()) {

179 
	`årštf
(
¡d”r
, "skippingest becauseƒnv does‚ot support‡ppending\n");

182 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

183 
	`Clo£
();

184 
¡d
::
¡ršg
 
Şd_mªiã¡
 = 
	`Mªiã¡FeName
();

188 
ušt64_t
 
Ën
 = 
	`FeSize
(
Şd_mªiã¡
);

189 
Wr™abËFe
* 
fe
;

190 
	`ASSERT_LEVELDB_OK
(
	`’v
()->
	`NewAµ’dabËFe
(
Şd_mªiã¡
, &
fe
));

191 
¡d
::
¡ršg
 
	`z”Ûs
(3 * 1048576 - 
¡©ic_ÿ¡
<
size_t
>(
Ën
), 0);

192 
	`ASSERT_LEVELDB_OK
(
fe
->
	`Aµ’d
(
z”Ûs
));

193 
	`ASSERT_LEVELDB_OK
(
fe
->
	`Flush
());

194 
d–‘e
 
fe
;

197 
	`O³n
();

198 
¡d
::
¡ršg
 
Ãw_mªiã¡
 = 
	`Mªiã¡FeName
();

199 
	`ASSERT_NE
(
Şd_mªiã¡
, 
Ãw_mªiã¡
);

200 
	`ASSERT_GT
(10000, 
	`FeSize
(
Ãw_mªiã¡
));

201 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

203 
	`O³n
();

204 
	`ASSERT_EQ
(
Ãw_mªiã¡
, 
	`Mªiã¡FeName
());

205 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

206 
	}
}

208 
	$TEST_F
(
Recov”yTe¡
, 
NoLogFes
) {

209 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

210 
	`ASSERT_EQ
(1, 
	`RemoveLogFes
());

211 
	`O³n
();

212 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("foo"));

213 
	`O³n
();

214 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("foo"));

215 
	}
}

217 
	$TEST_F
(
Recov”yTe¡
, 
LogFeReu£
) {

218 ià(!
	`CªAµ’d
()) {

219 
	`årštf
(
¡d”r
, "skippingest becauseƒnv does‚ot support‡ppending\n");

222 
i
 = 0; i < 2; i++) {

223 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

224 ià(
i
 == 0) {

226 
	`Com·ùMemTabË
();

228 
	`Clo£
();

229 
	`ASSERT_EQ
(1, 
	`NumLogs
());

230 
ušt64_t
 
numb”
 = 
	`Fœ¡LogFe
();

231 ià(
i
 == 0) {

232 
	`ASSERT_EQ
(0, 
	`FeSize
(
	`LogName
(
numb”
)));

234 
	`ASSERT_LT
(0, 
	`FeSize
(
	`LogName
(
numb”
)));

236 
	`O³n
();

237 
	`ASSERT_EQ
(1, 
	`NumLogs
());

238 
	`ASSERT_EQ
(
numb”
, 
	`Fœ¡LogFe
()) << "did‚ot„euse†og file";

239 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

240 
	`O³n
();

241 
	`ASSERT_EQ
(1, 
	`NumLogs
());

242 
	`ASSERT_EQ
(
numb”
, 
	`Fœ¡LogFe
()) << "did‚ot„euse†og file";

243 
	`ASSERT_EQ
("b¬", 
	`G‘
("foo"));

245 
	}
}

247 
	$TEST_F
(
Recov”yTe¡
, 
MuÉËMemTabËs
) {

249 cÚ¡ 
kNum
 = 1000;

250 
i
 = 0; i < 
kNum
; i++) {

251 
buf
[100];

252 
	`¢´štf
(
buf
, (buf), "%050d", 
i
);

253 
	`ASSERT_LEVELDB_OK
(
	`Put
(
buf
, buf));

255 
	`ASSERT_EQ
(0, 
	`NumTabËs
());

256 
	`Clo£
();

257 
	`ASSERT_EQ
(0, 
	`NumTabËs
());

258 
	`ASSERT_EQ
(1, 
	`NumLogs
());

259 
ušt64_t
 
Şd_log_fe
 = 
	`Fœ¡LogFe
();

262 
O±iÚs
 
İt
;

263 
İt
.
»u£_logs
 = 
Œue
;

264 
İt
.
wr™e_bufãr_size
 = (
kNum
 * 100) / 2;

265 
	`O³n
(&
İt
);

266 
	`ASSERT_LE
(2, 
	`NumTabËs
());

267 
	`ASSERT_EQ
(1, 
	`NumLogs
());

268 
	`ASSERT_NE
(
Şd_log_fe
, 
	`Fœ¡LogFe
()) << "must‚ot„euse†og";

269 
i
 = 0; i < 
kNum
; i++) {

270 
buf
[100];

271 
	`¢´štf
(
buf
, (buf), "%050d", 
i
);

272 
	`ASSERT_EQ
(
buf
, 
	`G‘
(buf));

274 
	}
}

276 
	$TEST_F
(
Recov”yTe¡
, 
MuÉËLogFes
) {

277 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

278 
	`Clo£
();

279 
	`ASSERT_EQ
(1, 
	`NumLogs
());

282 
ušt64_t
 
Şd_log
 = 
	`Fœ¡LogFe
();

283 
	`MakeLogFe
(
Şd_log
 + 1, 1000, "hello", "world");

284 
	`MakeLogFe
(
Şd_log
 + 2, 1001, "hi", "there");

285 
	`MakeLogFe
(
Şd_log
 + 3, 1002, "foo", "bar2");

288 
	`O³n
();

289 
	`ASSERT_LE
(1, 
	`NumTabËs
());

290 
	`ASSERT_EQ
(1, 
	`NumLogs
());

291 
ušt64_t
 
Ãw_log
 = 
	`Fœ¡LogFe
();

292 
	`ASSERT_LE
(
Şd_log
 + 3, 
Ãw_log
);

293 
	`ASSERT_EQ
("b¬2", 
	`G‘
("foo"));

294 
	`ASSERT_EQ
("wÜld", 
	`G‘
("hello"));

295 
	`ASSERT_EQ
("th”e", 
	`G‘
("hi"));

298 
	`O³n
();

299 
	`ASSERT_LE
(1, 
	`NumTabËs
());

300 
	`ASSERT_EQ
(1, 
	`NumLogs
());

301 ià(
	`CªAµ’d
()) {

302 
	`ASSERT_EQ
(
Ãw_log
, 
	`Fœ¡LogFe
());

304 
	`ASSERT_EQ
("b¬2", 
	`G‘
("foo"));

305 
	`ASSERT_EQ
("wÜld", 
	`G‘
("hello"));

306 
	`ASSERT_EQ
("th”e", 
	`G‘
("hi"));

309 
	`Clo£
();

310 
	`MakeLogFe
(
Şd_log
 + 1, 2000, "hello", "stale write");

311 
	`O³n
();

312 
	`ASSERT_LE
(1, 
	`NumTabËs
());

313 
	`ASSERT_EQ
(1, 
	`NumLogs
());

314 ià(
	`CªAµ’d
()) {

315 
	`ASSERT_EQ
(
Ãw_log
, 
	`Fœ¡LogFe
());

317 
	`ASSERT_EQ
("b¬2", 
	`G‘
("foo"));

318 
	`ASSERT_EQ
("wÜld", 
	`G‘
("hello"));

319 
	`ASSERT_EQ
("th”e", 
	`G‘
("hi"));

320 
	}
}

322 
	$TEST_F
(
Recov”yTe¡
, 
Mªiã¡Missšg
) {

323 
	`ASSERT_LEVELDB_OK
(
	`Put
("foo", "bar"));

324 
	`Clo£
();

325 
	`RemoveMªiã¡Fe
();

327 
Stus
 
¡©us
 = 
	`O³nW™hStus
();

328 
	`ASSERT_TRUE
(
¡©us
.
	`IsCÜru±iÚ
());

329 
	}
}

333 
	$maš
(
¬gc
, ** 
¬gv
) {

334 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

335  
	`RUN_ALL_TESTS
();

336 
	}
}

	@repair.cc

27 
	~"db/bud”.h
"

28 
	~"db/db_im¶.h
"

29 
	~"db/dbfÜm©.h
"

30 
	~"db/f’ame.h
"

31 
	~"db/log_»ad”.h
"

32 
	~"db/log_wr™”.h
"

33 
	~"db/membË.h
"

34 
	~"db/bË_ÿche.h
"

35 
	~"db/v”siÚ_ed™.h
"

36 
	~"db/wr™e_b©ch_š‹º®.h
"

37 
	~"Ëv–db/com·¿tÜ.h
"

38 
	~"Ëv–db/db.h
"

39 
	~"Ëv–db/’v.h
"

41 
Çme¥aû
 
	gËv–db
 {

43 
	gÇme¥aû
 {

45 şas 
	cR•aœ”
 {

46 
	gpublic
:

47 
R•aœ”
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
)

48 : 
dbÇme_
(
dbÇme
),

49 
’v_
(
İtiÚs
.
’v
),

50 
icmp_
(
İtiÚs
.
com·¿tÜ
),

51 
Şicy_
(
İtiÚs
.
f‹r_pŞicy
),

52 
İtiÚs_
(
Sª™izeO±iÚs
(
dbÇme
, &
icmp_
, &
Şicy_
, 
İtiÚs
)),

53 
owns_šfo_log_
(
İtiÚs_
.
šfo_log
 !ğ
İtiÚs
.info_log),

54 
owns_ÿche_
(
İtiÚs_
.
block_ÿche
 !ğ
İtiÚs
.block_cache),

55 
Ãxt_fe_numb”_
(1) {

57 
	gbË_ÿche_
 = 
Ãw
 
TabËCache
(
dbÇme_
, 
İtiÚs_
, 10);

60 ~
R•aœ”
() {

61 
d–‘e
 
	gbË_ÿche_
;

62 ià(
	gowns_šfo_log_
) {

63 
d–‘e
 
	gİtiÚs_
.
	gšfo_log
;

65 ià(
	gowns_ÿche_
) {

66 
d–‘e
 
	gİtiÚs_
.
	gblock_ÿche
;

70 
Stus
 
Run
() {

71 
Stus
 
	g¡©us
 = 
FšdFes
();

72 ià(
	g¡©us
.
ok
()) {

73 
CÚv”tLogFesToTabËs
();

74 
ExŒaùM‘aD©a
();

75 
	g¡©us
 = 
Wr™eDesütÜ
();

77 ià(
	g¡©us
.
ok
()) {

78 
	gby‹s
 = 0;

79 
size_t
 
	gi
 = 0; i < 
	gbËs_
.
size
(); i++) {

80 
	gby‹s
 +ğ
bËs_
[
i
].
m‘a
.
fe_size
;

82 
Log
(
İtiÚs_
.
šfo_log
,

87 
dbÇme_
.
c_¡r
(), 
¡©ic_ÿ¡
<>(
bËs_
.
size
()), 
by‹s
);

89  
	g¡©us
;

92 
	g´iv©e
:

93 
	sTabËInfo
 {

94 
FeM‘aD©a
 
m‘a
;

95 
Sequ’ûNumb”
 
	gmax_£qu’û
;

98 
Stus
 
FšdFes
() {

99 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

100 
Stus
 
	g¡©us
 = 
’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
);

101 ià(!
	g¡©us
.
ok
()) {

102  
	g¡©us
;

104 ià(
	gf’ames
.
em±y
()) {

105  
	gStus
::
IOE¼Ü
(
dbÇme_
, "repair found‚o files");

108 
ušt64_t
 
	gnumb”
;

109 
FeTy³
 
	gty³
;

110 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

111 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
)) {

112 ià(
	gty³
 =ğ
kDesütÜFe
) {

113 
mªiã¡s_
.
push_back
(
f’ames
[
i
]);

115 ià(
	gnumb”
 + 1 > 
	gÃxt_fe_numb”_
) {

116 
	gÃxt_fe_numb”_
 = 
numb”
 + 1;

118 ià(
	gty³
 =ğ
kLogFe
) {

119 
logs_
.
push_back
(
numb”
);

120 } ià(
	gty³
 =ğ
kTabËFe
) {

121 
bË_numb”s_
.
push_back
(
numb”
);

128  
	g¡©us
;

131 
CÚv”tLogFesToTabËs
() {

132 
size_t
 
	gi
 = 0; i < 
	glogs_
.
size
(); i++) {

133 
	g¡d
::
¡ršg
 
logÇme
 = 
LogFeName
(
dbÇme_
, 
logs_
[
i
]);

134 
Stus
 
	g¡©us
 = 
CÚv”tLogToTabË
(
logs_
[
i
]);

135 ià(!
	g¡©us
.
ok
()) {

136 
Log
(
İtiÚs_
.
šfo_log
, "Log #%llu: ignoring conversionƒrror: %s",

137 ()
logs_
[
i
], 
¡©us
.
ToSŒšg
().
c_¡r
());

139 
ArchiveFe
(
logÇme
);

143 
Stus
 
CÚv”tLogToTabË
(
ušt64_t
 
log
) {

144 
	gLogR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

145 
Env
* 
’v
;

146 
Logg”
* 
	gšfo_log
;

147 
ušt64_t
 
	glognum
;

148 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
s
è
	gov”ride
 {

150 
Log
(
šfo_log
, "Log #%llu: dropping %d bytes; %s",

151 ()
lognum
, 
¡©ic_ÿ¡
<>(
by‹s
),

152 
s
.
ToSŒšg
().
c_¡r
());

157 
	g¡d
::
¡ršg
 
logÇme
 = 
LogFeName
(
dbÇme_
, 
log
);

158 
Sequ’tŸlFe
* 
	glfe
;

159 
Stus
 
	g¡©us
 = 
’v_
->
NewSequ’tŸlFe
(
logÇme
, &
lfe
);

160 ià(!
	g¡©us
.
ok
()) {

161  
	g¡©us
;

165 
LogR•Ü‹r
 
	g»pÜ‹r
;

166 
	g»pÜ‹r
.
	g’v
 = 
’v_
;

167 
	g»pÜ‹r
.
	gšfo_log
 = 
İtiÚs_
.
šfo_log
;

168 
	g»pÜ‹r
.
	glognum
 = 
log
;

173 
	glog
::
R—d”
 
»ad”
(
lfe
, &
»pÜ‹r
, 
çl£
 ,

177 
	g¡d
::
¡ršg
 
sü©ch
;

178 
Sliû
 
	g»cÜd
;

179 
Wr™eB©ch
 
	gb©ch
;

180 
MemTabË
* 
	gmem
 = 
Ãw
 MemTabË(
icmp_
);

181 
	gmem
->
Ref
();

182 
	gcouÁ”
 = 0;

183 
	g»ad”
.
R—dRecÜd
(&
»cÜd
, &
sü©ch
)) {

184 ià(
	g»cÜd
.
size
() < 12) {

185 
	g»pÜ‹r
.
CÜru±iÚ
(
»cÜd
.
size
(),

186 
Stus
::
CÜru±iÚ
("log„ecordoo small"));

189 
	gWr™eB©chIÁ”Çl
::
S‘CÚ‹Ás
(&
b©ch
, 
»cÜd
);

190 
	g¡©us
 = 
Wr™eB©chIÁ”Çl
::
In£¹IÁo
(&
b©ch
, 
mem
);

191 ià(
	g¡©us
.
ok
()) {

192 
	gcouÁ”
 +ğ
Wr™eB©chIÁ”Çl
::
CouÁ
(&
b©ch
);

194 
Log
(
İtiÚs_
.
šfo_log
, "Log #%llu: ignoring %s",

195 ()
log
, 
¡©us
.
ToSŒšg
().
c_¡r
());

196 
	g¡©us
 = 
Stus
::
OK
();

199 
d–‘e
 
	glfe
;

203 
FeM‘aD©a
 
	gm‘a
;

204 
	gm‘a
.
	gnumb”
 = 
Ãxt_fe_numb”_
++;

205 
I‹¿tÜ
* 
	g™”
 = 
mem
->
NewI‹¿tÜ
();

206 
	g¡©us
 = 
BudTabË
(
dbÇme_
, 
’v_
, 
İtiÚs_
, 
bË_ÿche_
, 
™”
, &
m‘a
);

207 
d–‘e
 
	g™”
;

208 
	gmem
->
UÄef
();

209 
	gmem
 = 
nuÎ±r
;

210 ià(
	g¡©us
.
ok
()) {

211 ià(
	gm‘a
.
	gfe_size
 > 0) {

212 
	gbË_numb”s_
.
push_back
(
m‘a
.
numb”
);

215 
Log
(
İtiÚs_
.
šfo_log
, "Log #%llu: %d ops savedo Table #%llu %s",

216 ()
log
, 
couÁ”
, ()
m‘a
.
numb”
,

217 
¡©us
.
ToSŒšg
().
c_¡r
());

218  
	g¡©us
;

221 
ExŒaùM‘aD©a
() {

222 
size_t
 
	gi
 = 0; i < 
	gbË_numb”s_
.
size
(); i++) {

223 
SÿnTabË
(
bË_numb”s_
[
i
]);

227 
I‹¿tÜ
* 
NewTabËI‹¿tÜ
(cÚ¡ 
FeM‘aD©a
& 
m‘a
) {

230 
R—dO±iÚs
 
	gr
;

231 
	gr
.
	gv”ify_checksums
 = 
İtiÚs_
.
·¿noid_checks
;

232  
	gbË_ÿche_
->
NewI‹¿tÜ
(
r
, 
m‘a
.
numb”
, m‘a.
fe_size
);

235 
SÿnTabË
(
ušt64_t
 
numb”
) {

236 
TabËInfo
 
	gt
;

237 
	gt
.
	gm‘a
.
	gnumb”
 = 
numb”
;

238 
	g¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme_
, 
numb”
);

239 
Stus
 
	g¡©us
 = 
’v_
->
G‘FeSize
(
âame
, &
t
.
m‘a
.
fe_size
);

240 ià(!
	g¡©us
.
ok
()) {

242 
	gâame
 = 
SSTTabËFeName
(
dbÇme_
, 
numb”
);

243 
Stus
 
	gs2
 = 
’v_
->
G‘FeSize
(
âame
, &
t
.
m‘a
.
fe_size
);

244 ià(
	gs2
.
ok
()) {

245 
	g¡©us
 = 
Stus
::
OK
();

248 ià(!
	g¡©us
.
ok
()) {

249 
ArchiveFe
(
TabËFeName
(
dbÇme_
, 
numb”
));

250 
ArchiveFe
(
SSTTabËFeName
(
dbÇme_
, 
numb”
));

251 
Log
(
İtiÚs_
.
šfo_log
, "Table #%llu: dropped: %s",

252 ()
t
.
m‘a
.
numb”
, 
¡©us
.
ToSŒšg
().
c_¡r
());

257 
	gcouÁ”
 = 0;

258 
I‹¿tÜ
* 
	g™”
 = 
NewTabËI‹¿tÜ
(
t
.
m‘a
);

259 
boŞ
 
	gem±y
 = 
Œue
;

260 
P¬£dIÁ”ÇlKey
 
	g·r£d
;

261 
	gt
.
	gmax_£qu’û
 = 0;

262 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

263 
Sliû
 
	gkey
 = 
™”
->
key
();

264 ià(!
P¬£IÁ”ÇlKey
(
key
, &
·r£d
)) {

265 
Log
(
İtiÚs_
.
šfo_log
, "Table #%llu: unparsable key %s",

266 ()
t
.
m‘a
.
numb”
, 
Esÿ³SŒšg
(
key
).
c_¡r
());

270 
	gcouÁ”
++;

271 ià(
	gem±y
) {

272 
	gem±y
 = 
çl£
;

273 
	gt
.
	gm‘a
.
	gsm®Ë¡
.
DecodeFrom
(
key
);

275 
	gt
.
	gm‘a
.
	gÏrge¡
.
DecodeFrom
(
key
);

276 ià(
	g·r£d
.
	g£qu’û
 > 
	gt
.
	gmax_£qu’û
) {

277 
	gt
.
	gmax_£qu’û
 = 
·r£d
.
£qu’û
;

280 ià(!
	g™”
->
¡©us
().
ok
()) {

281 
	g¡©us
 = 
™”
->
¡©us
();

283 
d–‘e
 
	g™”
;

284 
Log
(
İtiÚs_
.
šfo_log
, "Table #%llu: %dƒntries %s",

285 ()
t
.
m‘a
.
numb”
, 
couÁ”
, 
¡©us
.
ToSŒšg
().
c_¡r
());

287 ià(
	g¡©us
.
ok
()) {

288 
	gbËs_
.
push_back
(
t
);

290 
R•aœTabË
(
âame
, 
t
);

294 
R•aœTabË
(cÚ¡ 
¡d
::
¡ršg
& 
¤c
, 
TabËInfo
 
t
) {

299 
	g¡d
::
¡ršg
 
cİy
 = 
TabËFeName
(
dbÇme_
, 
Ãxt_fe_numb”_
++);

300 
Wr™abËFe
* 
	gfe
;

301 
Stus
 
	gs
 = 
’v_
->
NewWr™abËFe
(
cİy
, &
fe
);

302 ià(!
	gs
.
ok
()) {

305 
TabËBud”
* 
	gbud”
 = 
Ãw
 TabËBud”(
İtiÚs_
, 
fe
);

308 
I‹¿tÜ
* 
	g™”
 = 
NewTabËI‹¿tÜ
(
t
.
m‘a
);

309 
	gcouÁ”
 = 0;

310 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

311 
	gbud”
->
Add
(
™”
->
key
(), i‹r->
v®ue
());

312 
	gcouÁ”
++;

314 
d–‘e
 
	g™”
;

316 
ArchiveFe
(
¤c
);

317 ià(
	gcouÁ”
 == 0) {

318 
bud”
->
AbªdÚ
();

320 
	gs
 = 
bud”
->
Fšish
();

321 ià(
	gs
.
ok
()) {

322 
	gt
.
	gm‘a
.
	gfe_size
 = 
bud”
->
FeSize
();

325 
d–‘e
 
	gbud”
;

326 
	gbud”
 = 
nuÎ±r
;

328 ià(
	gs
.
ok
()) {

329 
	gs
 = 
fe
->
Clo£
();

331 
d–‘e
 
	gfe
;

332 
	gfe
 = 
nuÎ±r
;

334 ià(
	gcouÁ”
 > 0 && 
	gs
.
ok
()) {

335 
	g¡d
::
¡ršg
 
Üig
 = 
TabËFeName
(
dbÇme_
, 
t
.
m‘a
.
numb”
);

336 
	gs
 = 
’v_
->
R’ameFe
(
cİy
, 
Üig
);

337 ià(
	gs
.
ok
()) {

338 
Log
(
İtiÚs_
.
šfo_log
, "Table #%llu: %dƒntries„epaired",

339 ()
t
.
m‘a
.
numb”
, 
couÁ”
);

340 
	gbËs_
.
push_back
(
t
);

343 ià(!
	gs
.
ok
()) {

344 
	g’v_
->
RemoveFe
(
cİy
);

348 
Stus
 
Wr™eDesütÜ
() {

349 
	g¡d
::
¡ršg
 
tmp
 = 
TempFeName
(
dbÇme_
, 1);

350 
Wr™abËFe
* 
	gfe
;

351 
Stus
 
	g¡©us
 = 
’v_
->
NewWr™abËFe
(
tmp
, &
fe
);

352 ià(!
	g¡©us
.
ok
()) {

353  
	g¡©us
;

356 
Sequ’ûNumb”
 
	gmax_£qu’û
 = 0;

357 
size_t
 
	gi
 = 0; i < 
	gbËs_
.
size
(); i++) {

358 ià(
	gmax_£qu’û
 < 
	gbËs_
[
i
].max_sequence) {

359 
	gmax_£qu’û
 = 
bËs_
[
i
].
max_£qu’û
;

363 
	ged™_
.
S‘Com·¿tÜName
(
icmp_
.
u£r_com·¿tÜ
()->
Name
());

364 
	ged™_
.
S‘LogNumb”
(0);

365 
	ged™_
.
S‘NextFe
(
Ãxt_fe_numb”_
);

366 
	ged™_
.
S‘La¡Sequ’û
(
max_£qu’û
);

368 
size_t
 
	gi
 = 0; i < 
	gbËs_
.
size
(); i++) {

370 cÚ¡ 
	gTabËInfo
& 
	gt
 = 
bËs_
[
i
];

371 
	ged™_
.
AddFe
(0, 
t
.
m‘a
.
numb”
,.m‘a.
fe_size
,.m‘a.
sm®Ë¡
,

372 
t
.
m‘a
.
Ïrge¡
);

377 
	glog
::
Wr™”
 
log
(
fe
);

378 
	g¡d
::
¡ršg
 
»cÜd
;

379 
	ged™_
.
EncodeTo
(&
»cÜd
);

380 
	g¡©us
 = 
log
.
AddRecÜd
(
»cÜd
);

382 ià(
	g¡©us
.
ok
()) {

383 
	g¡©us
 = 
fe
->
Clo£
();

385 
d–‘e
 
	gfe
;

386 
	gfe
 = 
nuÎ±r
;

388 ià(!
	g¡©us
.
ok
()) {

389 
	g’v_
->
RemoveFe
(
tmp
);

392 
size_t
 
	gi
 = 0; i < 
	gmªiã¡s_
.
size
(); i++) {

393 
ArchiveFe
(
dbÇme_
 + "/" + 
mªiã¡s_
[
i
]);

397 
	g¡©us
 = 
’v_
->
R’ameFe
(
tmp
, 
DesütÜFeName
(
dbÇme_
, 1));

398 ià(
	g¡©us
.
ok
()) {

399 
	g¡©us
 = 
S‘Cu¼’tFe
(
’v_
, 
dbÇme_
, 1);

401 
	g’v_
->
RemoveFe
(
tmp
);

404  
	g¡©us
;

407 
ArchiveFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

412 cÚ¡ * 
¦ash
 = 
¡¼chr
(
âame
.
c_¡r
(), '/');

413 
	g¡d
::
¡ršg
 
Ãw_dœ
;

414 ià(
	g¦ash
 !ğ
nuÎ±r
) {

415 
Ãw_dœ
.
assign
(
âame
.
d©a
(), 
¦ash
 - fname.data());

417 
	gÃw_dœ
.
­³nd
("/lost");

418 
	g’v_
->
C»©eDœ
(
Ãw_dœ
);

419 
	g¡d
::
¡ršg
 
Ãw_fe
 = 
Ãw_dœ
;

420 
	gÃw_fe
.
­³nd
("/");

421 
	gÃw_fe
.
­³nd
((
¦ash
 =ğ
nuÎ±r
è? 
âame
.
c_¡r
() : slash + 1);

422 
Stus
 
	gs
 = 
’v_
->
R’ameFe
(
âame
, 
Ãw_fe
);

423 
Log
(
İtiÚs_
.
šfo_log
, "Archivšg %s: %s\n", 
âame
.
c_¡r
(),

424 
s
.
ToSŒšg
().
c_¡r
());

427 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

428 
Env
* cÚ¡ 
	g’v_
;

429 
IÁ”ÇlKeyCom·¿tÜ
 cÚ¡ 
	gicmp_
;

430 
IÁ”ÇlF‹rPŞicy
 cÚ¡ 
	gŞicy_
;

431 cÚ¡ 
O±iÚs
 
	gİtiÚs_
;

432 
boŞ
 
	gowns_šfo_log_
;

433 
boŞ
 
	gowns_ÿche_
;

434 
TabËCache
* 
	gbË_ÿche_
;

435 
V”siÚEd™
 
	ged™_
;

437 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
mªiã¡s_
;

438 
	g¡d
::
veùÜ
<
ušt64_t
> 
bË_numb”s_
;

439 
	g¡d
::
veùÜ
<
ušt64_t
> 
logs_
;

440 
	g¡d
::
veùÜ
<
TabËInfo
> 
bËs_
;

441 
ušt64_t
 
	gÃxt_fe_numb”_
;

445 
Stus
 
	$R•aœDB
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
) {

446 
R•aœ”
 
	`»·œ”
(
dbÇme
, 
İtiÚs
);

447  
»·œ”
.
	`Run
();

448 
	}
}

	@skiplist.h

5 #iâdeà
STORAGE_LEVELDB_DB_SKIPLIST_H_


6 
	#STORAGE_LEVELDB_DB_SKIPLIST_H_


	)

30 
	~<©omic
>

31 
	~<ÿs£¹
>

32 
	~<c¡dlib
>

34 
	~"ut/¬’a.h
"

35 
	~"ut/¿ndom.h
"

37 
Çme¥aû
 
	gËv–db
 {

39 
şass
 
	gA»Ç
;

41 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

42 şas 
	cSkLi¡
 {

43 
	g´iv©e
:

44 
Node
;

46 
	gpublic
:

50 
ex¶ic™
 
SkLi¡
(
Com·¿tÜ
 
cmp
, 
A»Ç
* 
¬’a
);

52 
SkLi¡
(cÚ¡ SkLi¡&èğ
d–‘e
;

53 
	gSkLi¡
& 
	gİ”©Ü
=(cÚ¡ 
SkLi¡
&èğ
d–‘e
;

57 
In£¹
(cÚ¡ 
Key
& 
key
);

60 
boŞ
 
CÚšs
(cÚ¡ 
Key
& 
key
) const;

63 şas 
	cI‹¿tÜ
 {

64 
	gpublic
:

67 
ex¶ic™
 
I‹¿tÜ
(cÚ¡ 
SkLi¡
* 
li¡
);

70 
boŞ
 
V®id
() const;

74 cÚ¡ 
	gKey
& 
key
() const;

78 
Next
();

82 
P»v
();

85 
S“k
(cÚ¡ 
Key
& 
rg‘
);

89 
S“kToFœ¡
();

93 
S“kToLa¡
();

95 
	g´iv©e
:

96 cÚ¡ 
SkLi¡
* 
li¡_
;

97 
Node
* 
	gnode_
;

101 
	g´iv©e
:

102 ’um { 
kMaxHeight
 = 12 };

104 
šlše
 
G‘MaxHeight
() const {

105  
	gmax_height_
.
lßd
(
¡d
::
memÜy_Üd”_»Ïxed
);

108 
Node
* 
NewNode
(cÚ¡ 
Key
& 
key
, 
height
);

109 
RªdomHeight
();

110 
boŞ
 
Equ®
(cÚ¡ 
Key
& 
a
, cÚ¡ Key& 
b
ècÚ¡ {  (
com·»_
(a, b) == 0); }

113 
boŞ
 
KeyIsAá”Node
(cÚ¡ 
Key
& 
key
, 
Node
* 
n
) const;

120 
Node
* 
FšdG»©”OrEqu®
(cÚ¡ 
Key
& 
key
, Node** 
´ev
) const;

124 
Node
* 
FšdLessThª
(cÚ¡ 
Key
& 
key
) const;

128 
Node
* 
FšdLa¡
() const;

131 
Com·¿tÜ
 cÚ¡ 
	gcom·»_
;

132 
A»Ç
* cÚ¡ 
	g¬’a_
;

134 
Node
* cÚ¡ 
	gh—d_
;

138 
	g¡d
::
©omic
<> 
max_height_
;

141 
Rªdom
 
	gºd_
;

145 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

146 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
Node
 {

147 
ex¶ic™
 
Node
(cÚ¡ 
Key
& 
k
è: 
key
(k) {}

149 
Key
 cÚ¡ 
key
;

153 
Node
* 
Next
(
n
) {

154 
as£¹
(
n
 >= 0);

157  
	gÃxt_
[
n
].
lßd
(
¡d
::
memÜy_Üd”_acquœe
);

159 
S‘Next
(
n
, 
Node
* 
x
) {

160 
as£¹
(
n
 >= 0);

163 
	gÃxt_
[
n
].
¡Üe
(
x
, 
¡d
::
memÜy_Üd”_»Ëa£
);

167 
Node
* 
NoB¬r›r_Next
(
n
) {

168 
as£¹
(
n
 >= 0);

169  
	gÃxt_
[
n
].
lßd
(
¡d
::
memÜy_Üd”_»Ïxed
);

171 
NoB¬r›r_S‘Next
(
n
, 
Node
* 
x
) {

172 
as£¹
(
n
 >= 0);

173 
	gÃxt_
[
n
].
¡Üe
(
x
, 
¡d
::
memÜy_Üd”_»Ïxed
);

176 
	g´iv©e
:

178 
¡d
::
©omic
<
Node
*> 
Ãxt_
[1];

181 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

182 
ty³Çme
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
Node
* 
SkLi¡
<
Key
, Com·¿tÜ>::
	$NewNode
(

183 cÚ¡ 
Key
& 
key
, 
height
) {

184 * cÚ¡ 
node_memÜy
 = 
¬’a_
->
	`AÎoÿ‹AligÃd
(

185 (
Node
è+ (
¡d
::
©omic
<Node*>è* (
height
 - 1));

186  
	`Ãw
 (
node_memÜy
è
	`Node
(
key
);

187 
	}
}

189 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

190 
šlše
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$I‹¿tÜ
(cÚ¡ 
SkLi¡
* 
li¡
) {

191 
li¡_
 = 
li¡
;

192 
node_
 = 
nuÎ±r
;

193 
	}
}

195 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

196 
šlše
 
boŞ
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$V®id
() const {

197  
node_
 !ğ
nuÎ±r
;

198 
	}
}

200 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

201 
šlše
 cÚ¡ 
	gKey
& 
	gSkLi¡
<Key, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$key
() const {

202 
	`as£¹
(
	`V®id
());

203  
node_
->
key
;

204 
	}
}

206 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

207 
šlše
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$Next
() {

208 
	`as£¹
(
	`V®id
());

209 
node_
 =‚ode_->
	`Next
(0);

210 
	}
}

212 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

213 
šlše
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$P»v
() {

216 
	`as£¹
(
	`V®id
());

217 
node_
 = 
li¡_
->
	`FšdLessThª
Òode_->
key
);

218 ià(
node_
 =ğ
li¡_
->
h—d_
) {

219 
node_
 = 
nuÎ±r
;

221 
	}
}

223 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

224 
šlše
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$S“k
(cÚ¡ 
Key
& 
rg‘
) {

225 
node_
 = 
li¡_
->
	`FšdG»©”OrEqu®
(
rg‘
, 
nuÎ±r
);

226 
	}
}

228 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

229 
šlše
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$S“kToFœ¡
() {

230 
node_
 = 
li¡_
->
h—d_
->
	`Next
(0);

231 
	}
}

233 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

234 
šlše
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$S“kToLa¡
() {

235 
node_
 = 
li¡_
->
	`FšdLa¡
();

236 ià(
node_
 =ğ
li¡_
->
h—d_
) {

237 
node_
 = 
nuÎ±r
;

239 
	}
}

241 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

242 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
	$RªdomHeight
() {

244 cÚ¡ 
kB¿nchšg
 = 4;

245 
height
 = 1;

246 
height
 < 
kMaxHeight
 && ((
ºd_
.
	`Next
(è% 
kB¿nchšg
) == 0)) {

247 
height
++;

249 
	`as£¹
(
height
 > 0);

250 
	`as£¹
(
height
 <ğ
kMaxHeight
);

251  
height
;

252 
	}
}

254 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

255 
boŞ
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
	$KeyIsAá”Node
(cÚ¡ 
Key
& 
key
, 
Node
* 
n
) const {

257  (
n
 !ğ
nuÎ±r
è&& (
	`com·»_
Ò->
key
, key) < 0);

258 
	}
}

260 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

261 
ty³Çme
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
Node
*

262 
SkLi¡
<
Key
, 
	gCom·¿tÜ
>::
	$FšdG»©”OrEqu®
(cÚ¡ 
Key
& 
key
,

263 
Node
** 
´ev
) const {

264 
Node
* 
x
 = 
h—d_
;

265 
Ëv–
 = 
	`G‘MaxHeight
() - 1;

266 
Œue
) {

267 
Node
* 
Ãxt
 = 
x
->
	`Next
(
Ëv–
);

268 ià(
	`KeyIsAá”Node
(
key
, 
Ãxt
)) {

270 
x
 = 
Ãxt
;

272 ià(
´ev
 !ğ
nuÎ±r
è´ev[
Ëv–
] = 
x
;

273 ià(
Ëv–
 == 0) {

274  
Ãxt
;

277 
Ëv–
--;

281 
	}
}

283 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

284 
ty³Çme
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
Node
*

285 
SkLi¡
<
Key
, 
	gCom·¿tÜ
>::
	$FšdLessThª
(cÚ¡ 
Key
& 
key
) const {

286 
Node
* 
x
 = 
h—d_
;

287 
Ëv–
 = 
	`G‘MaxHeight
() - 1;

288 
Œue
) {

289 
	`as£¹
(
x
 =ğ
h—d_
 || 
	`com·»_
(x->
key
, key) < 0);

290 
Node
* 
Ãxt
 = 
x
->
	`Next
(
Ëv–
);

291 ià(
Ãxt
 =ğ
nuÎ±r
 || 
	`com·»_
Òext->
key
, key) >= 0) {

292 ià(
Ëv–
 == 0) {

293  
x
;

296 
Ëv–
--;

299 
x
 = 
Ãxt
;

302 
	}
}

304 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

305 
ty³Çme
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
Node
* 
SkLi¡
<
Key
, Com·¿tÜ>::
	$FšdLa¡
()

307 
Node
* 
x
 = 
h—d_
;

308 
Ëv–
 = 
	`G‘MaxHeight
() - 1;

309 
Œue
) {

310 
Node
* 
Ãxt
 = 
x
->
	`Next
(
Ëv–
);

311 ià(
Ãxt
 =ğ
nuÎ±r
) {

312 ià(
Ëv–
 == 0) {

313  
x
;

316 
Ëv–
--;

319 
x
 = 
Ãxt
;

322 
	}
}

324 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

325 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
	$SkLi¡
(
Com·¿tÜ
 
cmp
, 
A»Ç
* 
¬’a
)

326 : 
	`com·»_
(
cmp
),

327 
	`¬’a_
(
¬’a
),

328 
	`h—d_
(
	`NewNode
(0 , 
kMaxHeight
)),

329 
	`max_height_
(1),

330 
	$ºd_
(0xdeadbeef) {

331 
i
 = 0; i < 
kMaxHeight
; i++) {

332 
h—d_
->
	`S‘Next
(
i
, 
nuÎ±r
);

334 
	}
}

336 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

337 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
	$In£¹
(cÚ¡ 
Key
& 
key
) {

340 
Node
* 
´ev
[
kMaxHeight
];

341 
Node
* 
x
 = 
	`FšdG»©”OrEqu®
(
key
, 
´ev
);

344 
	`as£¹
(
x
 =ğ
nuÎ±r
 || !
	`Equ®
(
key
, x->key));

346 
height
 = 
	`RªdomHeight
();

347 ià(
height
 > 
	`G‘MaxHeight
()) {

348 
i
 = 
	`G‘MaxHeight
(); i < 
height
; i++) {

349 
´ev
[
i
] = 
h—d_
;

358 
max_height_
.
	`¡Üe
(
height
, 
¡d
::
memÜy_Üd”_»Ïxed
);

361 
x
 = 
	`NewNode
(
key
, 
height
);

362 
i
 = 0; i < 
height
; i++) {

365 
x
->
	`NoB¬r›r_S‘Next
(
i
, 
´ev
[i]->
	`NoB¬r›r_Next
(i));

366 
´ev
[
i
]->
	`S‘Next
(i, 
x
);

368 
	}
}

370 
	g‹m¶©e
 <
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

371 
boŞ
 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
	$CÚšs
(cÚ¡ 
Key
& 
key
) const {

372 
Node
* 
x
 = 
	`FšdG»©”OrEqu®
(
key
, 
nuÎ±r
);

373 ià(
x
 !ğ
nuÎ±r
 && 
	`Equ®
(
key
, x->key)) {

374  
Œue
;

376  
çl£
;

378 
	}
}

	@skiplist_test.cc

5 
	~"db/skli¡.h
"

7 
	~<©omic
>

8 
	~<£t
>

10 
	~"g‹¡/g‹¡.h
"

11 
	~"Ëv–db/’v.h
"

12 
	~"pÜt/pÜt.h
"

13 
	~"pÜt/th»ad_ªnÙ©iÚs.h
"

14 
	~"ut/¬’a.h
"

15 
	~"ut/hash.h
"

16 
	~"ut/¿ndom.h
"

17 
	~"ut/‹¡ut.h
"

19 
Çme¥aû
 
	gËv–db
 {

21 
ušt64_t
 
	tKey
;

23 
	sCom·¿tÜ
 {

24 
İ”©Ü
()(cÚ¡ 
	gKey
& 
	ga
, cÚ¡ Key& 
	gb
) const {

25 ià(
	ga
 < 
	gb
) {

27 } ià(
	ga
 > 
	gb
) {

35 
TEST
(
SkTe¡
, 
Em±y
) {

36 
A»Ç
 
	g¬’a
;

37 
Com·¿tÜ
 
	gcmp
;

38 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
> 
li¡
(
cmp
, &
¬’a
);

39 
ASSERT_TRUE
(!
li¡
.
CÚšs
(10));

41 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
 
™”
(&
li¡
);

42 
ASSERT_TRUE
(!
™”
.
V®id
());

43 
	g™”
.
S“kToFœ¡
();

44 
ASSERT_TRUE
(!
™”
.
V®id
());

45 
	g™”
.
S“k
(100);

46 
ASSERT_TRUE
(!
™”
.
V®id
());

47 
	g™”
.
S“kToLa¡
();

48 
ASSERT_TRUE
(!
™”
.
V®id
());

51 
TEST
(
SkTe¡
, 
In£¹AndLookup
) {

52 cÚ¡ 
	gN
 = 2000;

53 cÚ¡ 
	gR
 = 5000;

54 
Rªdom
 
ºd
(1000);

55 
	g¡d
::
£t
<
Key
> 
keys
;

56 
A»Ç
 
	g¬’a
;

57 
Com·¿tÜ
 
	gcmp
;

58 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
> 
li¡
(
cmp
, &
¬’a
);

59 
	gi
 = 0; i < 
	gN
; i++) {

60 
Key
 
	gkey
 = 
ºd
.
Next
(è% 
R
;

61 ià(
	gkeys
.
š£¹
(
key
).
	g£cÚd
) {

62 
	gli¡
.
In£¹
(
key
);

66 
	gi
 = 0; i < 
	gR
; i++) {

67 ià(
	gli¡
.
CÚšs
(
i
)) {

68 
ASSERT_EQ
(
keys
.
couÁ
(
i
), 1);

70 
ASSERT_EQ
(
keys
.
couÁ
(
i
), 0);

76 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
 
™”
(&
li¡
);

77 
ASSERT_TRUE
(!
™”
.
V®id
());

79 
	g™”
.
S“k
(0);

80 
ASSERT_TRUE
(
™”
.
V®id
());

81 
ASSERT_EQ
(*(
keys
.
begš
()), 
™”
.
key
());

83 
	g™”
.
S“kToFœ¡
();

84 
ASSERT_TRUE
(
™”
.
V®id
());

85 
ASSERT_EQ
(*(
keys
.
begš
()), 
™”
.
key
());

87 
	g™”
.
S“kToLa¡
();

88 
ASSERT_TRUE
(
™”
.
V®id
());

89 
ASSERT_EQ
(*(
keys
.
rbegš
()), 
™”
.
key
());

93 
	gi
 = 0; i < 
	gR
; i++) {

94 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
 
™”
(&
li¡
);

95 
	g™”
.
S“k
(
i
);

98 
	g¡d
::
£t
<
Key
>::
™”©Ü
 
mod–_™”
 = 
keys
.
low”_bound
(
i
);

99 
	gj
 = 0; j < 3; j++) {

100 ià(
	gmod–_™”
 =ğ
keys
.
’d
()) {

101 
ASSERT_TRUE
(!
™”
.
V®id
());

104 
ASSERT_TRUE
(
™”
.
V®id
());

105 
ASSERT_EQ
(*
mod–_™”
, 
™”
.
key
());

106 ++
	gmod–_™”
;

107 
	g™”
.
Next
();

114 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
 
™”
(&
li¡
);

115 
	g™”
.
S“kToLa¡
();

118 
	g¡d
::
£t
<
Key
>::
»v”£_™”©Ü
 
mod–_™”
 = 
keys
.
rbegš
();

119 
	gmod–_™”
 !ğ
keys
.
»nd
(); ++model_iter) {

120 
ASSERT_TRUE
(
™”
.
V®id
());

121 
ASSERT_EQ
(*
mod–_™”
, 
™”
.
key
());

122 
	g™”
.
P»v
();

124 
ASSERT_TRUE
(!
™”
.
V®id
());

152 şas 
	cCÚcu¼’tTe¡
 {

153 
	g´iv©e
:

154 cÚ¡ 
ušt32_t
 
K
 = 4;

156 
ušt64_t
 
key
(
Key
 keyè{  (
	gkey
 >> 40); }

157 
ušt64_t
 
g’
(
Key
 
key
è{  (
	gkey
 >> 8) & 0xffffffffu; }

158 
ušt64_t
 
hash
(
Key
 
key
è{  
	gkey
 & 0xff; }

160 
ušt64_t
 
HashNumb”s
(ušt64_ˆ
k
, ušt64_ˆ
g
) {

161 
ušt64_t
 
	gd©a
[2] = {
k
, 
g
};

162  
Hash
(
»š‹½»t_ÿ¡
<*>(
d©a
), (data), 0);

165 
Key
 
MakeKey
(
ušt64_t
 
k
, ušt64_ˆ
g
) {

166 
¡©ic_as£¹
((
Key
è=ğ(
ušt64_t
), "");

167 
as£¹
(
k
 <ğ
K
);

168 
as£¹
(
g
 <= 0xffffffffu);

169  ((
	gk
 << 40è| (
	gg
 << 8è| (
HashNumb”s
(
k
, 
g
) & 0xff));

172 
boŞ
 
IsV®idKey
(
Key
 
k
) {

173  
hash
(
k
è=ğ(
HashNumb”s
(
key
(k), 
g’
(k)) & 0xff);

176 
Key
 
RªdomT¬g‘
(
Rªdom
* 
ºd
) {

177 
	gºd
->
Next
() % 10) {

180  
MakeKey
(0, 0);

183  
MakeKey
(
K
, 0);

186  
MakeKey
(
ºd
->
Next
(è% 
K
, 0);

191 
	sS‹
 {

192 
	g¡d
::
©omic
<> 
g’”©iÚ
[
K
];

193 
S‘
(
k
, 
v
) {

194 
	gg’”©iÚ
[
k
].
¡Üe
(
v
, 
¡d
::
memÜy_Üd”_»Ëa£
);

196 
G‘
(
k
è{  
	gg’”©iÚ
[k].
lßd
(
¡d
::
memÜy_Üd”_acquœe
); }

198 
S‹
() {

199 
	gk
 = 0; k < 
	gK
; k++) {

200 
S‘
(
k
, 0);

206 
S‹
 
	gcu¼’t_
;

208 
A»Ç
 
	g¬’a_
;

212 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
> 
	gli¡_
;

214 
	gpublic
:

215 
CÚcu¼’tTe¡
(è: 
li¡_
(
Com·¿tÜ
(), &
¬’a_
) {}

218 
Wr™eS‹p
(
Rªdom
* 
ºd
) {

219 cÚ¡ 
ušt32_t
 
	gk
 = 
ºd
->
Next
(è% 
K
;

220 cÚ¡ 
šŒ_t
 
	gg
 = 
cu¼’t_
.
G‘
(
k
) + 1;

221 cÚ¡ 
Key
 
	gkey
 = 
MakeKey
(
k
, 
g
);

222 
	gli¡_
.
In£¹
(
key
);

223 
	gcu¼’t_
.
S‘
(
k
, 
g
);

226 
R—dS‹p
(
Rªdom
* 
ºd
) {

228 
S‹
 
	gš™Ÿl_¡©e
;

229 
	gk
 = 0; k < 
	gK
; k++) {

230 
	gš™Ÿl_¡©e
.
S‘
(
k
, 
cu¼’t_
.
G‘
(k));

233 
Key
 
	gpos
 = 
RªdomT¬g‘
(
ºd
);

234 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
 
™”
(&
li¡_
);

235 
	g™”
.
S“k
(
pos
);

236 
	gŒue
) {

237 
Key
 
	gcu¼’t
;

238 ià(!
	g™”
.
V®id
()) {

239 
	gcu¼’t
 = 
MakeKey
(
K
, 0);

241 
	gcu¼’t
 = 
™”
.
key
();

242 
ASSERT_TRUE
(
IsV®idKey
(
cu¼’t
)è<< 
	gcu¼’t
;

244 
ASSERT_LE
(
pos
, 
cu¼’t
) << "should‚ot go backwards";

248 
	gpos
 < 
	gcu¼’t
) {

249 
ASSERT_LT
(
key
(
pos
), 
K
è<< 
	gpos
;

253 
ASSERT_TRUE
((
g’
(
pos
) == 0) ||

254 (
g’
(
pos
è> 
¡©ic_ÿ¡
<
Key
>(
š™Ÿl_¡©e
.
G‘
(
key
(pos)))))

255 << "key: " << 
key
(
pos
è<< "; g’: " << 
g’
(pos)

256 << "; in™g’: " << 
š™Ÿl_¡©e
.
G‘
(
key
(
pos
));

259 ià(
key
(
pos
è< key(
cu¼’t
)) {

260 
	gpos
 = 
MakeKey
(
key
(
pos
) + 1, 0);

262 
	gpos
 = 
MakeKey
(
key
(
pos
), 
g’
(pos) + 1);

266 ià(!
	g™”
.
V®id
()) {

270 ià(
	gºd
->
Next
() % 2) {

271 
	g™”
.
Next
();

272 
	gpos
 = 
MakeKey
(
key
(
pos
), 
g’
(pos) + 1);

274 
Key
 
	gÃw_rg‘
 = 
RªdomT¬g‘
(
ºd
);

275 ià(
	gÃw_rg‘
 > 
	gpos
) {

276 
	gpos
 = 
Ãw_rg‘
;

277 
	g™”
.
S“k
(
Ãw_rg‘
);

283 cÚ¡ 
ušt32_t
 
	gCÚcu¼’tTe¡
::
K
;

287 
	$TEST
(
SkTe¡
, 
CÚcu¼’tW™houtTh»ads
) {

288 
CÚcu¼’tTe¡
 
‹¡
;

289 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
());

290 
i
 = 0; i < 10000; i++) {

291 
‹¡
.
	`R—dS‹p
(&
ºd
);

292 
‹¡
.
	`Wr™eS‹p
(&
ºd
);

294 
	}
}

296 şas 
	cTe¡S‹
 {

297 
	gpublic
:

298 
CÚcu¼’tTe¡
 
t_
;

299 
	g£ed_
;

300 
	g¡d
::
©omic
<
boŞ
> 
qu™_æag_
;

302 
	eR—d”S‹
 { 
	gSTARTING
, 
	gRUNNING
, 
	gDONE
 };

304 
ex¶ic™
 
Te¡S‹
(
s
)

305 : 
£ed_
(
s
), 
qu™_æag_
(
çl£
), 
¡©e_
(
STARTING
), 
¡©e_cv_
(&
mu_
) {}

307 
Wa™
(
R—d”S‹
 
s
è
LOCKS_EXCLUDED
(
mu_
) {

308 
	gmu_
.
Lock
();

309 
	g¡©e_
 !ğ
s
) {

310 
¡©e_cv_
.
Wa™
();

312 
	gmu_
.
UÆock
();

315 
Chªge
(
R—d”S‹
 
s
è
LOCKS_EXCLUDED
(
mu_
) {

316 
	gmu_
.
Lock
();

317 
	g¡©e_
 = 
s
;

318 
	g¡©e_cv_
.
SigÇl
();

319 
	gmu_
.
UÆock
();

322 
	g´iv©e
:

323 
pÜt
::
Mu‹x
 
mu_
;

324 
R—d”S‹
 
¡©e_
 
GUARDED_BY
(
mu_
);

325 
	gpÜt
::
CÚdV¬
 
¡©e_cv_
 
GUARDED_BY
(
mu_
);

328 
	$CÚcu¼’tR—d”
(* 
¬g
) {

329 
Te¡S‹
* 
¡©e
 = 
»š‹½»t_ÿ¡
<Te¡S‹*>(
¬g
);

330 
Rªdom
 
	`ºd
(
¡©e
->
£ed_
);

331 
št64_t
 
»ads
 = 0;

332 
¡©e
->
	`Chªge
(
Te¡S‹
::
RUNNING
);

333 !
¡©e
->
qu™_æag_
.
	`lßd
(
¡d
::
memÜy_Üd”_acquœe
)) {

334 
¡©e
->
t_
.
	`R—dS‹p
(&
ºd
);

335 ++
»ads
;

337 
¡©e
->
	`Chªge
(
Te¡S‹
::
DONE
);

338 
	}
}

340 
	$RunCÚcu¼’t
(
run
) {

341 cÚ¡ 
£ed
 = 
‹¡
::
	`RªdomS“d
(è+ (
run
 * 100);

342 
Rªdom
 
	`ºd
(
£ed
);

343 cÚ¡ 
N
 = 1000;

344 cÚ¡ 
kSize
 = 1000;

345 
i
 = 0; i < 
N
; i++) {

346 ià((
i
 % 100) == 0) {

347 
	`årštf
(
¡d”r
, "RuÀ%d oà%d\n", 
i
, 
N
);

349 
Te¡S‹
 
	`¡©e
(
£ed
 + 1);

350 
Env
::
	`DeçuÉ
()->
	`ScheduË
(
CÚcu¼’tR—d”
, &
¡©e
);

351 
¡©e
.
	`Wa™
(
Te¡S‹
::
RUNNING
);

352 
i
 = 0; i < 
kSize
; i++) {

353 
¡©e
.
t_
.
	`Wr™eS‹p
(&
ºd
);

355 
¡©e
.
qu™_æag_
.
	`¡Üe
(
Œue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

356 
¡©e
.
	`Wa™
(
Te¡S‹
::
DONE
);

358 
	}
}

360 
	$TEST
(
SkTe¡
, 
CÚcu¼’t1
è{ 
	`RunCÚcu¼’t
(1); 
	}
}

361 
	$TEST
(
SkTe¡
, 
CÚcu¼’t2
è{ 
	`RunCÚcu¼’t
(2); 
	}
}

362 
	$TEST
(
SkTe¡
, 
CÚcu¼’t3
è{ 
	`RunCÚcu¼’t
(3); 
	}
}

363 
	$TEST
(
SkTe¡
, 
CÚcu¼’t4
è{ 
	`RunCÚcu¼’t
(4); 
	}
}

364 
	$TEST
(
SkTe¡
, 
CÚcu¼’t5
è{ 
	`RunCÚcu¼’t
(5); 
	}
}

368 
	$maš
(
¬gc
, ** 
¬gv
) {

369 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

370  
	`RUN_ALL_TESTS
();

371 
	}
}

	@snapshot.h

5 #iâdeà
STORAGE_LEVELDB_DB_SNAPSHOT_H_


6 
	#STORAGE_LEVELDB_DB_SNAPSHOT_H_


	)

8 
	~"db/dbfÜm©.h
"

9 
	~"Ëv–db/db.h
"

11 
Çme¥aû
 
	gËv–db
 {

13 
şass
 
	gSÇpshÙLi¡
;

17 şas 
	cSÇpshÙIm¶
 : 
public
 
SÇpshÙ
 {

18 
public
:

19 
SÇpshÙIm¶
(
Sequ’ûNumb”
 
£qu’û_numb”
)

20 : 
£qu’û_numb”_
(
£qu’û_numb”
) {}

22 
Sequ’ûNumb”
 
£qu’û_numb”
(ècÚ¡ {  
£qu’û_numb”_
; }

24 
	g´iv©e
:

25 
ä›nd
 
şass
 
SÇpshÙLi¡
;

29 
SÇpshÙIm¶
* 
	g´ev_
;

30 
SÇpshÙIm¶
* 
	gÃxt_
;

32 cÚ¡ 
Sequ’ûNumb”
 
	g£qu’û_numb”_
;

34 #ià!
defšed
(
NDEBUG
)

35 
SÇpshÙLi¡
* 
	gli¡_
 = 
nuÎ±r
;

39 şas 
	cSÇpshÙLi¡
 {

40 
	gpublic
:

41 
SÇpshÙLi¡
(è: 
h—d_
(0) {

42 
h—d_
.
´ev_
 = &head_;

43 
	gh—d_
.
	gÃxt_
 = &
h—d_
;

46 
boŞ
 
em±y
(ècÚ¡ {  
	gh—d_
.
	gÃxt_
 =ğ&
h—d_
; }

47 
SÇpshÙIm¶
* 
Şde¡
() const {

48 
as£¹
(!
em±y
());

49  
	gh—d_
.
	gÃxt_
;

51 
SÇpshÙIm¶
* 
Ãwe¡
() const {

52 
as£¹
(!
em±y
());

53  
	gh—d_
.
	g´ev_
;

57 
SÇpshÙIm¶
* 
New
(
Sequ’ûNumb”
 
£qu’û_numb”
) {

58 
as£¹
(
em±y
(è|| 
Ãwe¡
()->
£qu’û_numb”_
 <ğ
£qu’û_numb”
);

60 
SÇpshÙIm¶
* 
	g¢­shÙ
 = 
Ãw
 SÇpshÙIm¶(
£qu’û_numb”
);

62 #ià!
defšed
(
NDEBUG
)

63 
	g¢­shÙ
->
	gli¡_
 = 
this
;

65 
	g¢­shÙ
->
	gÃxt_
 = &
h—d_
;

66 
	g¢­shÙ
->
	g´ev_
 = 
h—d_
.
´ev_
;

67 
	g¢­shÙ
->
	g´ev_
->
	gÃxt_
 = 
¢­shÙ
;

68 
	g¢­shÙ
->
	gÃxt_
->
	g´ev_
 = 
¢­shÙ
;

69  
	g¢­shÙ
;

79 
D–‘e
(cÚ¡ 
SÇpshÙIm¶
* 
¢­shÙ
) {

80 #ià!
defšed
(
NDEBUG
)

81 
as£¹
(
¢­shÙ
->
li¡_
 =ğ
this
);

83 
	g¢­shÙ
->
	g´ev_
->
	gÃxt_
 = 
¢­shÙ
->
Ãxt_
;

84 
	g¢­shÙ
->
	gÃxt_
->
	g´ev_
 = 
¢­shÙ
->
´ev_
;

85 
d–‘e
 
	g¢­shÙ
;

88 
	g´iv©e
:

90 
SÇpshÙIm¶
 
h—d_
;

	@table_cache.cc

5 
	~"db/bË_ÿche.h
"

7 
	~"db/f’ame.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"Ëv–db/bË.h
"

10 
	~"ut/codšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
	sTabËAndFe
 {

15 
RªdomAcûssFe
* 
	gfe
;

16 
TabË
* 
	gbË
;

19 
D–‘eEÁry
(cÚ¡ 
Sliû
& 
key
, * 
v®ue
) {

20 
TabËAndFe
* 
	gtf
 = 
»š‹½»t_ÿ¡
<TabËAndFe*>(
v®ue
);

21 
d–‘e
 
	gtf
->
	gbË
;

22 
d–‘e
 
	gtf
->
	gfe
;

23 
d–‘e
 
	gtf
;

26 
UÄefEÁry
(* 
¬g1
, * 
¬g2
) {

27 
Cache
* 
	gÿche
 = 
»š‹½»t_ÿ¡
<Cache*>(
¬g1
);

28 
	gCache
::
HªdË
* 
h
 = 
»š‹½»t_ÿ¡
<
Cache
::HªdË*>(
¬g2
);

29 
	gÿche
->
R–—£
(
h
);

32 
	gTabËCache
::
TabËCache
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
,

33 
’Œ›s
)

34 : 
’v_
(
İtiÚs
.
’v
),

35 
dbÇme_
(
dbÇme
),

36 
İtiÚs_
(
İtiÚs
),

37 
ÿche_
(
NewLRUCache
(
’Œ›s
)) {}

39 
	gTabËCache
::~
TabËCache
(è{ 
d–‘e
 
ÿche_
; }

41 
Stus
 
	gTabËCache
::
FšdTabË
(
ušt64_t
 
fe_numb”
, ušt64_ˆ
fe_size
,

42 
Cache
::
HªdË
** 
hªdË
) {

43 
Stus
 
s
;

44 
	gbuf
[(
fe_numb”
)];

45 
EncodeFixed64
(
buf
, 
fe_numb”
);

46 
Sliû
 
key
(
buf
, (buf));

47 *
	ghªdË
 = 
ÿche_
->
Lookup
(
key
);

48 ià(*
	ghªdË
 =ğ
nuÎ±r
) {

49 
¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme_
, 
fe_numb”
);

50 
RªdomAcûssFe
* 
	gfe
 = 
nuÎ±r
;

51 
TabË
* 
	gbË
 = 
nuÎ±r
;

52 
	gs
 = 
’v_
->
NewRªdomAcûssFe
(
âame
, &
fe
);

53 ià(!
	gs
.
ok
()) {

54 
	g¡d
::
¡ršg
 
Şd_âame
 = 
SSTTabËFeName
(
dbÇme_
, 
fe_numb”
);

55 ià(
	g’v_
->
NewRªdomAcûssFe
(
Şd_âame
, &
fe
).
ok
()) {

56 
	gs
 = 
Stus
::
OK
();

59 ià(
	gs
.
ok
()) {

60 
	gs
 = 
TabË
::
O³n
(
İtiÚs_
, 
fe
, 
fe_size
, &
bË
);

63 ià(!
	gs
.
ok
()) {

64 
as£¹
(
bË
 =ğ
nuÎ±r
);

65 
d–‘e
 
	gfe
;

69 
TabËAndFe
* 
	gtf
 = 
Ãw
 TableAndFile;

70 
	gtf
->
	gfe
 = 
fe
;

71 
	gtf
->
	gbË
 = 
bË
;

72 *
	ghªdË
 = 
ÿche_
->
In£¹
(
key
, 
tf
, 1, &
D–‘eEÁry
);

75  
	gs
;

78 
I‹¿tÜ
* 
	gTabËCache
::
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

79 
ušt64_t
 
fe_numb”
, ušt64_ˆ
fe_size
,

80 
TabË
** 
bË±r
) {

81 ià(
	gbË±r
 !ğ
nuÎ±r
) {

82 *
bË±r
 = 
nuÎ±r
;

85 
	gCache
::
HªdË
* 
hªdË
 = 
nuÎ±r
;

86 
Stus
 
	gs
 = 
FšdTabË
(
fe_numb”
, 
fe_size
, &
hªdË
);

87 ià(!
	gs
.
ok
()) {

88  
NewE¼ÜI‹¿tÜ
(
s
);

91 
TabË
* 
	gbË
 = 
»š‹½»t_ÿ¡
<
TabËAndFe
*>(
ÿche_
->
V®ue
(
hªdË
))->
bË
;

92 
I‹¿tÜ
* 
	g»suÉ
 = 
bË
->
NewI‹¿tÜ
(
İtiÚs
);

93 
	g»suÉ
->
Regi¡”CËªup
(&
UÄefEÁry
, 
ÿche_
, 
hªdË
);

94 ià(
	gbË±r
 !ğ
nuÎ±r
) {

95 *
bË±r
 = 
bË
;

97  
	g»suÉ
;

100 
Stus
 
	gTabËCache
::
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, 
ušt64_t
 
fe_numb”
,

101 
ušt64_t
 
fe_size
, cÚ¡ 
Sliû
& 
k
, * 
¬g
,

102 (*
hªdË_»suÉ
)(*, cÚ¡ 
Sliû
&,

103 cÚ¡ 
Sliû
&)) {

104 
	gCache
::
HªdË
* 
hªdË
 = 
nuÎ±r
;

105 
Stus
 
	gs
 = 
FšdTabË
(
fe_numb”
, 
fe_size
, &
hªdË
);

106 ià(
	gs
.
ok
()) {

107 
TabË
* 
	gt
 = 
»š‹½»t_ÿ¡
<
TabËAndFe
*>(
ÿche_
->
V®ue
(
hªdË
))->
bË
;

108 
	gs
 = 
t
->
IÁ”ÇlG‘
(
İtiÚs
, 
k
, 
¬g
, 
hªdË_»suÉ
);

109 
	gÿche_
->
R–—£
(
hªdË
);

111  
	gs
;

114 
	gTabËCache
::
Eviù
(
ušt64_t
 
fe_numb”
) {

115 
buf
[(
fe_numb”
)];

116 
EncodeFixed64
(
buf
, 
fe_numb”
);

117 
	gÿche_
->
E¿£
(
Sliû
(
buf
, (buf)));

	@table_cache.h

7 #iâdeà
STORAGE_LEVELDB_DB_TABLE_CACHE_H_


8 
	#STORAGE_LEVELDB_DB_TABLE_CACHE_H_


	)

10 
	~<¡dšt.h
>

12 
	~<¡ršg
>

14 
	~"db/dbfÜm©.h
"

15 
	~"Ëv–db/ÿche.h
"

16 
	~"Ëv–db/bË.h
"

17 
	~"pÜt/pÜt.h
"

19 
Çme¥aû
 
	gËv–db
 {

21 
şass
 
	gEnv
;

23 şas 
	cTabËCache
 {

24 
	gpublic
:

25 
TabËCache
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
, 
’Œ›s
);

26 ~
TabËCache
();

35 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, 
ušt64_t
 
fe_numb”
,

36 
ušt64_t
 
fe_size
, 
TabË
** 
bË±r
 = 
nuÎ±r
);

40 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, 
ušt64_t
 
fe_numb”
,

41 
ušt64_t
 
fe_size
, cÚ¡ 
Sliû
& 
k
, * 
¬g
,

42 (*
hªdË_»suÉ
)(*, cÚ¡ 
Sliû
&, const Slice&));

45 
Eviù
(
ušt64_t
 
fe_numb”
);

47 
	g´iv©e
:

48 
Stus
 
FšdTabË
(
ušt64_t
 
fe_numb”
, ušt64_ˆ
fe_size
, 
Cache
::
HªdË
**);

50 
Env
* cÚ¡ 
	g’v_
;

51 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

52 cÚ¡ 
	gO±iÚs
& 
	gİtiÚs_
;

53 
Cache
* 
	gÿche_
;

	@version_edit.cc

5 
	~"db/v”siÚ_ed™.h
"

7 
	~"db/v”siÚ_£t.h
"

8 
	~"ut/codšg.h
"

10 
Çme¥aû
 
	gËv–db
 {

14 
	eTag
 {

15 
	gkCom·¿tÜ
 = 1,

16 
	gkLogNumb”
 = 2,

17 
	gkNextFeNumb”
 = 3,

18 
	gkLa¡Sequ’û
 = 4,

19 
	gkCom·ùPoš‹r
 = 5,

20 
	gkD–‘edFe
 = 6,

21 
	gkNewFe
 = 7,

23 
	gkP»vLogNumb”
 = 9

26 
	gV”siÚEd™
::
CË¬
() {

27 
com·¿tÜ_
.
ş—r
();

28 
	glog_numb”_
 = 0;

29 
	g´ev_log_numb”_
 = 0;

30 
	gÏ¡_£qu’û_
 = 0;

31 
	gÃxt_fe_numb”_
 = 0;

32 
	ghas_com·¿tÜ_
 = 
çl£
;

33 
	ghas_log_numb”_
 = 
çl£
;

34 
	ghas_´ev_log_numb”_
 = 
çl£
;

35 
	ghas_Ãxt_fe_numb”_
 = 
çl£
;

36 
	ghas_Ï¡_£qu’û_
 = 
çl£
;

37 
	gd–‘ed_fes_
.
ş—r
();

38 
	gÃw_fes_
.
ş—r
();

41 
	gV”siÚEd™
::
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const {

42 ià(
has_com·¿tÜ_
) {

43 
PutV¬št32
(
d¡
, 
kCom·¿tÜ
);

44 
PutL’gthP»fixedSliû
(
d¡
, 
com·¿tÜ_
);

46 ià(
	ghas_log_numb”_
) {

47 
PutV¬št32
(
d¡
, 
kLogNumb”
);

48 
PutV¬št64
(
d¡
, 
log_numb”_
);

50 ià(
	ghas_´ev_log_numb”_
) {

51 
PutV¬št32
(
d¡
, 
kP»vLogNumb”
);

52 
PutV¬št64
(
d¡
, 
´ev_log_numb”_
);

54 ià(
	ghas_Ãxt_fe_numb”_
) {

55 
PutV¬št32
(
d¡
, 
kNextFeNumb”
);

56 
PutV¬št64
(
d¡
, 
Ãxt_fe_numb”_
);

58 ià(
	ghas_Ï¡_£qu’û_
) {

59 
PutV¬št32
(
d¡
, 
kLa¡Sequ’û
);

60 
PutV¬št64
(
d¡
, 
Ï¡_£qu’û_
);

63 
size_t
 
	gi
 = 0; i < 
	gcom·ù_poš‹rs_
.
size
(); i++) {

64 
PutV¬št32
(
d¡
, 
kCom·ùPoš‹r
);

65 
PutV¬št32
(
d¡
, 
com·ù_poš‹rs_
[
i
].
fœ¡
);

66 
PutL’gthP»fixedSliû
(
d¡
, 
com·ù_poš‹rs_
[
i
].
£cÚd
.
Encode
());

69 cÚ¡‡uto& 
	gd–‘ed_fe_kvp
 : 
d–‘ed_fes_
) {

70 
PutV¬št32
(
d¡
, 
kD–‘edFe
);

71 
PutV¬št32
(
d¡
, 
d–‘ed_fe_kvp
.
fœ¡
);

72 
PutV¬št64
(
d¡
, 
d–‘ed_fe_kvp
.
£cÚd
);

75 
size_t
 
	gi
 = 0; i < 
	gÃw_fes_
.
size
(); i++) {

76 cÚ¡ 
	gFeM‘aD©a
& 
	gf
 = 
Ãw_fes_
[
i
].
£cÚd
;

77 
PutV¬št32
(
d¡
, 
kNewFe
);

78 
PutV¬št32
(
d¡
, 
Ãw_fes_
[
i
].
fœ¡
);

79 
PutV¬št64
(
d¡
, 
f
.
numb”
);

80 
PutV¬št64
(
d¡
, 
f
.
fe_size
);

81 
PutL’gthP»fixedSliû
(
d¡
, 
f
.
sm®Ë¡
.
Encode
());

82 
PutL’gthP»fixedSliû
(
d¡
, 
f
.
Ïrge¡
.
Encode
());

86 
boŞ
 
G‘IÁ”ÇlKey
(
Sliû
* 
šput
, 
IÁ”ÇlKey
* 
d¡
) {

87 
Sliû
 
	g¡r
;

88 ià(
G‘L’gthP»fixedSliû
(
šput
, &
¡r
)) {

89  
	gd¡
->
DecodeFrom
(
¡r
);

91  
	gçl£
;

95 
boŞ
 
G‘Lev–
(
Sliû
* 
šput
, * 
Ëv–
) {

96 
ušt32_t
 
	gv
;

97 ià(
G‘V¬št32
(
šput
, &
v
è&& 
	gv
 < 
	gcÚfig
::
kNumLev–s
) {

98 *
Ëv–
 = 
v
;

99  
	gŒue
;

101  
	gçl£
;

105 
Stus
 
	gV”siÚEd™
::
DecodeFrom
(cÚ¡ 
Sliû
& 
¤c
) {

106 
CË¬
();

107 
Sliû
 
	gšput
 = 
¤c
;

108 cÚ¡ * 
	gmsg
 = 
nuÎ±r
;

109 
ušt32_t
 
	gg
;

112 
	gËv–
;

113 
ušt64_t
 
	gnumb”
;

114 
FeM‘aD©a
 
	gf
;

115 
Sliû
 
	g¡r
;

116 
IÁ”ÇlKey
 
	gkey
;

118 
	gmsg
 =ğ
nuÎ±r
 && 
G‘V¬št32
(&
šput
, &
g
)) {

119 
	gg
) {

120 
	gkCom·¿tÜ
:

121 ià(
G‘L’gthP»fixedSliû
(&
šput
, &
¡r
)) {

122 
	gcom·¿tÜ_
 = 
¡r
.
ToSŒšg
();

123 
	ghas_com·¿tÜ_
 = 
Œue
;

125 
	gmsg
 = "comparator‚ame";

129 
	gkLogNumb”
:

130 ià(
G‘V¬št64
(&
šput
, &
log_numb”_
)) {

131 
	ghas_log_numb”_
 = 
Œue
;

133 
	gmsg
 = "log‚umber";

137 
	gkP»vLogNumb”
:

138 ià(
G‘V¬št64
(&
šput
, &
´ev_log_numb”_
)) {

139 
	ghas_´ev_log_numb”_
 = 
Œue
;

141 
	gmsg
 = "previous†og‚umber";

145 
	gkNextFeNumb”
:

146 ià(
G‘V¬št64
(&
šput
, &
Ãxt_fe_numb”_
)) {

147 
	ghas_Ãxt_fe_numb”_
 = 
Œue
;

149 
	gmsg
 = "next file‚umber";

153 
	gkLa¡Sequ’û
:

154 ià(
G‘V¬št64
(&
šput
, &
Ï¡_£qu’û_
)) {

155 
	ghas_Ï¡_£qu’û_
 = 
Œue
;

157 
	gmsg
 = "last sequence‚umber";

161 
	gkCom·ùPoš‹r
:

162 ià(
G‘Lev–
(&
šput
, &
Ëv–
è&& 
G‘IÁ”ÇlKey
(&šput, &
key
)) {

163 
	gcom·ù_poš‹rs_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
key
));

165 
	gmsg
 = "compaction…ointer";

169 
	gkD–‘edFe
:

170 ià(
G‘Lev–
(&
šput
, &
Ëv–
è&& 
G‘V¬št64
(&šput, &
numb”
)) {

171 
	gd–‘ed_fes_
.
š£¹
(
¡d
::
make_·œ
(
Ëv–
, 
numb”
));

173 
	gmsg
 = "deleted file";

177 
	gkNewFe
:

178 ià(
G‘Lev–
(&
šput
, &
Ëv–
è&& 
G‘V¬št64
(&šput, &
f
.
numb”
) &&

179 
G‘V¬št64
(&
šput
, &
f
.
fe_size
) &&

180 
G‘IÁ”ÇlKey
(&
šput
, &
f
.
sm®Ë¡
) &&

181 
G‘IÁ”ÇlKey
(&
šput
, &
f
.
Ïrge¡
)) {

182 
	gÃw_fes_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
f
));

184 
	gmsg
 = "new-fileƒntry";

189 
msg
 = "unknownag";

194 ià(
	gmsg
 =ğ
nuÎ±r
 && !
šput
.
em±y
()) {

195 
msg
 = "invalidag";

198 
Stus
 
	g»suÉ
;

199 ià(
	gmsg
 !ğ
nuÎ±r
) {

200 
»suÉ
 = 
Stus
::
CÜru±iÚ
("V”siÚEd™", 
msg
);

202  
	g»suÉ
;

205 
	g¡d
::
¡ršg
 
V”siÚEd™
::
DebugSŒšg
() const {

206 
¡d
::
¡ršg
 
r
;

207 
	gr
.
­³nd
("VersionEdit {");

208 ià(
	ghas_com·¿tÜ_
) {

209 
	gr
.
­³nd
("\n Comparator: ");

210 
	gr
.
­³nd
(
com·¿tÜ_
);

212 ià(
	ghas_log_numb”_
) {

213 
	gr
.
­³nd
("\n LogNumber: ");

214 
Aµ’dNumb”To
(&
r
, 
log_numb”_
);

216 ià(
	ghas_´ev_log_numb”_
) {

217 
	gr
.
­³nd
("\n PrevLogNumber: ");

218 
Aµ’dNumb”To
(&
r
, 
´ev_log_numb”_
);

220 ià(
	ghas_Ãxt_fe_numb”_
) {

221 
	gr
.
­³nd
("\n NextFile: ");

222 
Aµ’dNumb”To
(&
r
, 
Ãxt_fe_numb”_
);

224 ià(
	ghas_Ï¡_£qu’û_
) {

225 
	gr
.
­³nd
("\n LastSeq: ");

226 
Aµ’dNumb”To
(&
r
, 
Ï¡_£qu’û_
);

228 
size_t
 
	gi
 = 0; i < 
	gcom·ù_poš‹rs_
.
size
(); i++) {

229 
	gr
.
­³nd
("\n CompactPointer: ");

230 
Aµ’dNumb”To
(&
r
, 
com·ù_poš‹rs_
[
i
].
fœ¡
);

231 
	gr
.
­³nd
(" ");

232 
	gr
.
­³nd
(
com·ù_poš‹rs_
[
i
].
£cÚd
.
DebugSŒšg
());

234 cÚ¡‡uto& 
	gd–‘ed_fes_kvp
 : 
d–‘ed_fes_
) {

235 
r
.
­³nd
("\n RemoveFile: ");

236 
Aµ’dNumb”To
(&
r
, 
d–‘ed_fes_kvp
.
fœ¡
);

237 
	gr
.
­³nd
(" ");

238 
Aµ’dNumb”To
(&
r
, 
d–‘ed_fes_kvp
.
£cÚd
);

240 
size_t
 
	gi
 = 0; i < 
	gÃw_fes_
.
size
(); i++) {

241 cÚ¡ 
	gFeM‘aD©a
& 
	gf
 = 
Ãw_fes_
[
i
].
£cÚd
;

242 
	gr
.
­³nd
("\n AddFile: ");

243 
Aµ’dNumb”To
(&
r
, 
Ãw_fes_
[
i
].
fœ¡
);

244 
	gr
.
­³nd
(" ");

245 
Aµ’dNumb”To
(&
r
, 
f
.
numb”
);

246 
	gr
.
­³nd
(" ");

247 
Aµ’dNumb”To
(&
r
, 
f
.
fe_size
);

248 
	gr
.
­³nd
(" ");

249 
	gr
.
­³nd
(
f
.
sm®Ë¡
.
DebugSŒšg
());

250 
	gr
.
­³nd
(" .. ");

251 
	gr
.
­³nd
(
f
.
Ïrge¡
.
DebugSŒšg
());

253 
	gr
.
­³nd
("\n}\n");

254  
	gr
;

	@version_edit.h

5 #iâdeà
STORAGE_LEVELDB_DB_VERSION_EDIT_H_


6 
	#STORAGE_LEVELDB_DB_VERSION_EDIT_H_


	)

8 
	~<£t
>

9 
	~<ut™y
>

10 
	~<veùÜ
>

12 
	~"db/dbfÜm©.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
şass
 
	gV”siÚS‘
;

18 
	sFeM‘aD©a
 {

19 
FeM‘aD©a
(è: 
»fs
(0), 
®lowed_£eks
(1 << 30), 
fe_size
(0) {}

21 
	g»fs
;

22 
	g®lowed_£eks
;

23 
ušt64_t
 
	gnumb”
;

24 
ušt64_t
 
	gfe_size
;

25 
IÁ”ÇlKey
 
	gsm®Ë¡
;

26 
IÁ”ÇlKey
 
	gÏrge¡
;

29 şas 
	cV”siÚEd™
 {

30 
	gpublic
:

31 
V”siÚEd™
(è{ 
CË¬
(); }

32 ~
V”siÚEd™
() = ;

34 
CË¬
();

36 
S‘Com·¿tÜName
(cÚ¡ 
Sliû
& 
Çme
) {

37 
	ghas_com·¿tÜ_
 = 
Œue
;

38 
	gcom·¿tÜ_
 = 
Çme
.
ToSŒšg
();

40 
S‘LogNumb”
(
ušt64_t
 
num
) {

41 
	ghas_log_numb”_
 = 
Œue
;

42 
	glog_numb”_
 = 
num
;

44 
S‘P»vLogNumb”
(
ušt64_t
 
num
) {

45 
	ghas_´ev_log_numb”_
 = 
Œue
;

46 
	g´ev_log_numb”_
 = 
num
;

48 
S‘NextFe
(
ušt64_t
 
num
) {

49 
	ghas_Ãxt_fe_numb”_
 = 
Œue
;

50 
	gÃxt_fe_numb”_
 = 
num
;

52 
S‘La¡Sequ’û
(
Sequ’ûNumb”
 
£q
) {

53 
	ghas_Ï¡_£qu’û_
 = 
Œue
;

54 
	gÏ¡_£qu’û_
 = 
£q
;

56 
S‘Com·ùPoš‹r
(
Ëv–
, cÚ¡ 
IÁ”ÇlKey
& 
key
) {

57 
	gcom·ù_poš‹rs_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
key
));

64 
AddFe
(
Ëv–
, 
ušt64_t
 
fe
, ušt64_ˆ
fe_size
,

65 cÚ¡ 
IÁ”ÇlKey
& 
sm®Ë¡
, cÚ¡ IÁ”ÇlKey& 
Ïrge¡
) {

66 
FeM‘aD©a
 
	gf
;

67 
	gf
.
	gnumb”
 = 
fe
;

68 
	gf
.
	gfe_size
 = 
fe_size
;

69 
	gf
.
	gsm®Ë¡
 = 
sm®Ë¡
;

70 
	gf
.
	gÏrge¡
 = 
Ïrge¡
;

71 
	gÃw_fes_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
f
));

75 
RemoveFe
(
Ëv–
, 
ušt64_t
 
fe
) {

76 
	gd–‘ed_fes_
.
š£¹
(
¡d
::
make_·œ
(
Ëv–
, 
fe
));

79 
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const;

80 
Stus
 
DecodeFrom
(cÚ¡ 
Sliû
& 
¤c
);

82 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

84 
	g´iv©e
:

85 
ä›nd
 
şass
 
V”siÚS‘
;

87 
	g¡d
::
	t£t
<
	t¡d
::
	t·œ
<, 
	tušt64_t
>> 
	tD–‘edFeS‘
;

89 
	g¡d
::
¡ršg
 
com·¿tÜ_
;

90 
ušt64_t
 
	glog_numb”_
;

91 
ušt64_t
 
	g´ev_log_numb”_
;

92 
ušt64_t
 
	gÃxt_fe_numb”_
;

93 
Sequ’ûNumb”
 
	gÏ¡_£qu’û_
;

94 
boŞ
 
	ghas_com·¿tÜ_
;

95 
boŞ
 
	ghas_log_numb”_
;

96 
boŞ
 
	ghas_´ev_log_numb”_
;

97 
boŞ
 
	ghas_Ãxt_fe_numb”_
;

98 
boŞ
 
	ghas_Ï¡_£qu’û_
;

100 
	g¡d
::
veùÜ
<
¡d
::
·œ
<, 
	gIÁ”ÇlKey
>> 
	gcom·ù_poš‹rs_
;

101 
D–‘edFeS‘
 
	gd–‘ed_fes_
;

102 
	g¡d
::
veùÜ
<
¡d
::
·œ
<, 
	gFeM‘aD©a
>> 
	gÃw_fes_
;

	@version_edit_test.cc

5 
	~"db/v”siÚ_ed™.h
"

7 
	~"g‹¡/g‹¡.h
"

9 
Çme¥aû
 
	gËv–db
 {

11 
Te¡EncodeDecode
(cÚ¡ 
V”siÚEd™
& 
ed™
) {

12 
	g¡d
::
¡ršg
 
’coded
, 
	g’coded2
;

13 
	ged™
.
EncodeTo
(&
’coded
);

14 
V”siÚEd™
 
	g·r£d
;

15 
Stus
 
	gs
 = 
·r£d
.
DecodeFrom
(
’coded
);

16 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

17 
	g·r£d
.
EncodeTo
(&
’coded2
);

18 
ASSERT_EQ
(
’coded
, 
’coded2
);

21 
TEST
(
V”siÚEd™Te¡
, 
EncodeDecode
) {

22 cÚ¡ 
ušt64_t
 
	gkBig
 = 1ull << 50;

24 
V”siÚEd™
 
	ged™
;

25 
	gi
 = 0; i < 4; i++) {

26 
Te¡EncodeDecode
(
ed™
);

27 
	ged™
.
AddFe
(3, 
kBig
 + 300 + 
i
, kBig + 400 + i,

28 
IÁ”ÇlKey
("foo", 
kBig
 + 500 + 
i
, 
kTy³V®ue
),

29 
IÁ”ÇlKey
("zoo", 
kBig
 + 600 + 
i
, 
kTy³D–‘iÚ
));

30 
	ged™
.
RemoveFe
(4, 
kBig
 + 700 + 
i
);

31 
	ged™
.
S‘Com·ùPoš‹r
(
i
, 
IÁ”ÇlKey
("x", 
kBig
 + 900 + i, 
kTy³V®ue
));

34 
	ged™
.
S‘Com·¿tÜName
("foo");

35 
	ged™
.
S‘LogNumb”
(
kBig
 + 100);

36 
	ged™
.
S‘NextFe
(
kBig
 + 200);

37 
	ged™
.
S‘La¡Sequ’û
(
kBig
 + 1000);

38 
Te¡EncodeDecode
(
ed™
);

43 
	$maš
(
¬gc
, ** 
¬gv
) {

44 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

45  
	`RUN_ALL_TESTS
();

46 
	}
}

	@version_set.cc

5 
	~"db/v”siÚ_£t.h
"

7 
	~<¡dio.h
>

9 
	~<®gÜ™hm
>

11 
	~"db/f’ame.h
"

12 
	~"db/log_»ad”.h
"

13 
	~"db/log_wr™”.h
"

14 
	~"db/membË.h
"

15 
	~"db/bË_ÿche.h
"

16 
	~"Ëv–db/’v.h
"

17 
	~"Ëv–db/bË_bud”.h
"

18 
	~"bË/m”g”.h
"

19 
	~"bË/two_Ëv–_™”©Ü.h
"

20 
	~"ut/codšg.h
"

21 
	~"ut/loggšg.h
"

23 
Çme¥aû
 
	gËv–db
 {

25 
size_t
 
T¬g‘FeSize
(cÚ¡ 
O±iÚs
* 
İtiÚs
) {

26  
	gİtiÚs
->
	gmax_fe_size
;

31 
št64_t
 
MaxG¿ndP¬’tOv”ÏpBy‹s
(cÚ¡ 
O±iÚs
* 
İtiÚs
) {

32  10 * 
T¬g‘FeSize
(
İtiÚs
);

38 
št64_t
 
Ex·ndedCom·ùiÚBy‹SizeLim™
(cÚ¡ 
O±iÚs
* 
İtiÚs
) {

39  25 * 
T¬g‘FeSize
(
İtiÚs
);

42 
MaxBy‹sFÜLev–
(cÚ¡ 
O±iÚs
* 
İtiÚs
, 
Ëv–
) {

47 
	g»suÉ
 = 10. * 1048576.0;

48 
	gËv–
 > 1) {

49 
	g»suÉ
 *= 10;

50 
	gËv–
--;

52  
	g»suÉ
;

55 
ušt64_t
 
MaxFeSizeFÜLev–
(cÚ¡ 
O±iÚs
* 
İtiÚs
, 
Ëv–
) {

57  
T¬g‘FeSize
(
İtiÚs
);

60 
št64_t
 
TÙ®FeSize
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
) {

61 
št64_t
 
sum
 = 0;

62 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

63 
	gsum
 +ğ
fes
[
i
]->
fe_size
;

65  
	gsum
;

68 
	gV”siÚ
::~
V”siÚ
() {

69 
as£¹
(
»fs_
 == 0);

72 
	g´ev_
->
	gÃxt_
 = 
Ãxt_
;

73 
	gÃxt_
->
	g´ev_
 = 
´ev_
;

76 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

77 
size_t
 
	gi
 = 0; i < 
	gfes_
[
Ëv–
].
size
(); i++) {

78 
FeM‘aD©a
* 
	gf
 = 
fes_
[
Ëv–
][
i
];

79 
as£¹
(
f
->
»fs
 > 0);

80 
	gf
->
	g»fs
--;

81 ià(
	gf
->
	g»fs
 <= 0) {

82 
d–‘e
 
f
;

88 
FšdFe
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

89 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
, cÚ¡ 
Sliû
& 
key
) {

90 
ušt32_t
 
	gËá
 = 0;

91 
ušt32_t
 
	gright
 = 
fes
.
size
();

92 
	gËá
 < 
	gright
) {

93 
ušt32_t
 
	gmid
 = (
Ëá
 + 
right
) / 2;

94 cÚ¡ 
FeM‘aD©a
* 
	gf
 = 
fes
[
mid
];

95 ià(
	gicmp
.
	gIÁ”ÇlKeyCom·¿tÜ
::
Com·»
(
f
->
Ïrge¡
.
Encode
(), 
key
) < 0) {

98 
	gËá
 = 
mid
 + 1;

102 
	gright
 = 
mid
;

105  
	gright
;

108 
boŞ
 
Aá”Fe
(cÚ¡ 
Com·¿tÜ
* 
ucmp
, cÚ¡ 
Sliû
* 
u£r_key
,

109 cÚ¡ 
FeM‘aD©a
* 
f
) {

111  (
	gu£r_key
 !ğ
nuÎ±r
 &&

112 
ucmp
->
Com·»
(*
u£r_key
, 
f
->
Ïrge¡
.user_key()) > 0);

115 
boŞ
 
BefÜeFe
(cÚ¡ 
Com·¿tÜ
* 
ucmp
, cÚ¡ 
Sliû
* 
u£r_key
,

116 cÚ¡ 
FeM‘aD©a
* 
f
) {

118  (
	gu£r_key
 !ğ
nuÎ±r
 &&

119 
ucmp
->
Com·»
(*
u£r_key
, 
f
->
sm®Ë¡
.user_key()) < 0);

122 
boŞ
 
SomeFeOv”ÏpsRªge
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

123 
boŞ
 
disjošt_sÜ‹d_fes
,

124 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
,

125 cÚ¡ 
Sliû
* 
sm®Ë¡_u£r_key
,

126 cÚ¡ 
Sliû
* 
Ïrge¡_u£r_key
) {

127 cÚ¡ 
Com·¿tÜ
* 
	gucmp
 = 
icmp
.
u£r_com·¿tÜ
();

128 ià(!
	gdisjošt_sÜ‹d_fes
) {

130 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

131 cÚ¡ 
FeM‘aD©a
* 
	gf
 = 
fes
[
i
];

132 ià(
Aá”Fe
(
ucmp
, 
sm®Ë¡_u£r_key
, 
f
) ||

133 
BefÜeFe
(
ucmp
, 
Ïrge¡_u£r_key
, 
f
)) {

136  
	gŒue
;

139  
	gçl£
;

143 
ušt32_t
 
	gšdex
 = 0;

144 ià(
	gsm®Ë¡_u£r_key
 !ğ
nuÎ±r
) {

146 
IÁ”ÇlKey
 
sm®l_key
(*
sm®Ë¡_u£r_key
, 
kMaxSequ’ûNumb”
,

147 
kV®ueTy³FÜS“k
);

148 
	gšdex
 = 
FšdFe
(
icmp
, 
fes
, 
sm®l_key
.
Encode
());

151 ià(
	gšdex
 >ğ
fes
.
size
()) {

153  
çl£
;

156  !
BefÜeFe
(
ucmp
, 
Ïrge¡_u£r_key
, 
fes
[
šdex
]);

164 şas 
	cV”siÚ
::
Lev–FeNumI‹¿tÜ
 : 
public
 
I‹¿tÜ
 {

165 
public
:

166 
Lev–FeNumI‹¿tÜ
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

167 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
æi¡
)

168 : 
icmp_
(
icmp
), 
æi¡_
(
æi¡
), 
šdex_
(æi¡->
size
()) {

170 
boŞ
 
V®id
(ècÚ¡ 
	gov”ride
 {  
	gšdex_
 < 
	gæi¡_
->
size
(); }

171 
S“k
(cÚ¡ 
Sliû
& 
rg‘
è
	gov”ride
 {

172 
	gšdex_
 = 
FšdFe
(
icmp_
, *
æi¡_
, 
rg‘
);

174 
S“kToFœ¡
(è
	gov”ride
 { 
	gšdex_
 = 0; }

175 
S“kToLa¡
(è
	gov”ride
 {

176 
	gšdex_
 = 
æi¡_
->
em±y
(è? 0 : fli¡_->
size
() - 1;

178 
Next
(è
	gov”ride
 {

179 
as£¹
(
V®id
());

180 
	gšdex_
++;

182 
P»v
(è
	gov”ride
 {

183 
as£¹
(
V®id
());

184 ià(
	gšdex_
 == 0) {

185 
šdex_
 = 
æi¡_
->
size
();

187 
	gšdex_
--;

190 
Sliû
 
key
(ècÚ¡ 
	gov”ride
 {

191 
as£¹
(
V®id
());

192  (*
	gæi¡_
)[
šdex_
]->
	gÏrge¡
.
Encode
();

194 
Sliû
 
v®ue
(ècÚ¡ 
	gov”ride
 {

195 
as£¹
(
V®id
());

196 
EncodeFixed64
(
v®ue_buf_
, (*
æi¡_
)[
šdex_
]->
numb”
);

197 
EncodeFixed64
(
v®ue_buf_
 + 8, (*
æi¡_
)[
šdex_
]->
fe_size
);

198  
Sliû
(
v®ue_buf_
, (value_buf_));

200 
Stus
 
¡©us
(ècÚ¡ 
	gov”ride
 {  
	gStus
::
OK
(); }

202 
	g´iv©e
:

203 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
icmp_
;

204 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>* cÚ¡ 
æi¡_
;

205 
ušt32_t
 
	gšdex_
;

208 
mubË
 
	gv®ue_buf_
[16];

211 
I‹¿tÜ
* 
	$G‘FeI‹¿tÜ
(* 
¬g
, cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

212 cÚ¡ 
Sliû
& 
fe_v®ue
) {

213 
TabËCache
* 
ÿche
 = 
»š‹½»t_ÿ¡
<TabËCache*>(
¬g
);

214 ià(
fe_v®ue
.
	`size
() != 16) {

215  
	`NewE¼ÜI‹¿tÜ
(

216 
Stus
::
	`CÜru±iÚ
("FileReader invoked with unexpected value"));

218  
ÿche
->
	`NewI‹¿tÜ
(
İtiÚs
, 
	`DecodeFixed64
(
fe_v®ue
.
	`d©a
()),

219 
	`DecodeFixed64
(
fe_v®ue
.
	`d©a
() + 8));

221 
	}
}

223 
I‹¿tÜ
* 
	gV”siÚ
::
	$NewCÚÿ‹ÇtšgI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

224 
Ëv–
) const {

225  
	`NewTwoLev–I‹¿tÜ
(

226 
Ãw
 
	`Lev–FeNumI‹¿tÜ
(
v£t_
->
icmp_
, &
fes_
[
Ëv–
]), &
G‘FeI‹¿tÜ
,

227 
v£t_
->
bË_ÿche_
, 
İtiÚs
);

228 
	}
}

230 
	gV”siÚ
::
AddI‹¿tÜs
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

231 
¡d
::
veùÜ
<
I‹¿tÜ
*>* 
™”s
) {

233 
size_t
 
i
 = 0; 
	gi
 < 
	gfes_
[0].
size
(); i++) {

234 
	g™”s
->
push_back
(
v£t_
->
bË_ÿche_
->
NewI‹¿tÜ
(

235 
İtiÚs
, 
fes_
[0][
i
]->
numb”
, fes_[0][i]->
fe_size
));

241 
	gËv–
 = 1;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

242 ià(!
	gfes_
[
Ëv–
].
em±y
()) {

243 
	g™”s
->
push_back
(
NewCÚÿ‹ÇtšgI‹¿tÜ
(
İtiÚs
, 
Ëv–
));

249 
	gÇme¥aû
 {

250 
	eSav”S‹
 {

251 
	gkNÙFound
,

252 
	gkFound
,

253 
	gkD–‘ed
,

254 
	gkCÜru±
,

256 
	sSav”
 {

257 
Sav”S‹
 
	g¡©e
;

258 cÚ¡ 
Com·¿tÜ
* 
	gucmp
;

259 
Sliû
 
	gu£r_key
;

260 
	g¡d
::
¡ršg
* 
v®ue
;

263 
	$SaveV®ue
(* 
¬g
, cÚ¡ 
Sliû
& 
ikey
, cÚ¡ Sliû& 
v
) {

264 
Sav”
* 
s
 = 
»š‹½»t_ÿ¡
<Sav”*>(
¬g
);

265 
P¬£dIÁ”ÇlKey
 
·r£d_key
;

266 ià(!
	`P¬£IÁ”ÇlKey
(
ikey
, &
·r£d_key
)) {

267 
s
->
¡©e
 = 
kCÜru±
;

269 ià(
s
->
ucmp
->
	`Com·»
(
·r£d_key
.
u£r_key
, s->user_key) == 0) {

270 
s
->
¡©e
 = (
·r£d_key
.
ty³
 =ğ
kTy³V®ue
è? 
kFound
 : 
kD–‘ed
;

271 ià(
s
->
¡©e
 =ğ
kFound
) {

272 
s
->
v®ue
->
	`assign
(
v
.
	`d©a
(), v.
	`size
());

276 
	}
}

278 
boŞ
 
	$Newe¡Fœ¡
(
FeM‘aD©a
* 
a
, FeM‘aD©a* 
b
) {

279  
a
->
numb”
 > 
b
->number;

280 
	}
}

282 
	gV”siÚ
::
	$FÜEachOv”Ïµšg
(
Sliû
 
u£r_key
, Sliû 
š‹º®_key
, * 
¬g
,

283 
	$boŞ
 (*
func
)(*, , 
FeM‘aD©a
*)) {

284 cÚ¡ 
Com·¿tÜ
* 
ucmp
 = 
v£t_
->
icmp_
.
	`u£r_com·¿tÜ
();

287 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
tmp
;

288 
tmp
.
	`»£rve
(
fes_
[0].
	`size
());

289 
ušt32_t
 
i
 = 0; i < 
fes_
[0].
	`size
(); i++) {

290 
FeM‘aD©a
* 
f
 = 
fes_
[0][
i
];

291 ià(
ucmp
->
	`Com·»
(
u£r_key
, 
f
->
sm®Ë¡
.
	`u£r_key
()) >= 0 &&

292 
ucmp
->
	`Com·»
(
u£r_key
, 
f
->
Ïrge¡
.
	`u£r_key
()) <= 0) {

293 
tmp
.
	`push_back
(
f
);

296 ià(!
tmp
.
	`em±y
()) {

297 
¡d
::
	`sÜt
(
tmp
.
	`begš
(),mp.
	`’d
(), 
Newe¡Fœ¡
);

298 
ušt32_t
 
i
 = 0; i < 
tmp
.
	`size
(); i++) {

299 ià(!(*
func
)(
¬g
, 0, 
tmp
[
i
])) {

306 
Ëv–
 = 1;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

307 
size_t
 
num_fes
 = 
fes_
[
Ëv–
].
	`size
();

308 ià(
num_fes
 == 0) ;

311 
ušt32_t
 
šdex
 = 
	`FšdFe
(
v£t_
->
icmp_
, 
fes_
[
Ëv–
], 
š‹º®_key
);

312 ià(
šdex
 < 
num_fes
) {

313 
FeM‘aD©a
* 
f
 = 
fes_
[
Ëv–
][
šdex
];

314 ià(
ucmp
->
	`Com·»
(
u£r_key
, 
f
->
sm®Ë¡
.
	`u£r_key
()) < 0) {

317 ià(!(*
func
)(
¬g
, 
Ëv–
, 
f
)) {

323 
	}
}

325 
Stus
 
	gV”siÚ
::
	$G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
, cÚ¡ 
LookupKey
& 
k
,

326 
¡d
::
¡ršg
* 
v®ue
, 
G‘Sts
* 
¡©s
) {

327 
¡©s
->
£ek_fe
 = 
nuÎ±r
;

328 
¡©s
->
£ek_fe_Ëv–
 = -1;

330 
	sS‹
 {

331 
Sav”
 
§v”
;

332 
G‘Sts
* 
¡©s
;

333 cÚ¡ 
R—dO±iÚs
* 
İtiÚs
;

334 
Sliû
 
ikey
;

335 
FeM‘aD©a
* 
Ï¡_fe_»ad
;

336 
Ï¡_fe_»ad_Ëv–
;

338 
V”siÚS‘
* 
v£t
;

339 
Stus
 
s
;

340 
boŞ
 
found
;

342 
boŞ
 
	`M©ch
(* 
¬g
, 
Ëv–
, 
FeM‘aD©a
* 
f
) {

343 
S‹
* 
¡©e
 = 
»š‹½»t_ÿ¡
<S‹*>(
¬g
);

345 ià(
¡©e
->
¡©s
->
£ek_fe
 =ğ
nuÎ±r
 &&

346 
¡©e
->
Ï¡_fe_»ad
 !ğ
nuÎ±r
) {

348 
¡©e
->
¡©s
->
£ek_fe
 = s‹->
Ï¡_fe_»ad
;

349 
¡©e
->
¡©s
->
£ek_fe_Ëv–
 = s‹->
Ï¡_fe_»ad_Ëv–
;

352 
¡©e
->
Ï¡_fe_»ad
 = 
f
;

353 
¡©e
->
Ï¡_fe_»ad_Ëv–
 = 
Ëv–
;

355 
¡©e
->
s
 = s‹->
v£t
->
bË_ÿche_
->
	`G‘
(*¡©e->
İtiÚs
, 
f
->
numb”
,

356 
f
->
fe_size
, 
¡©e
->
ikey
,

357 &
¡©e
->
§v”
, 
SaveV®ue
);

358 ià(!
¡©e
->
s
.
	`ok
()) {

359 
¡©e
->
found
 = 
Œue
;

360  
çl£
;

362 
¡©e
->
§v”
.state) {

363 
kNÙFound
:

364  
Œue
;

365 
kFound
:

366 
¡©e
->
found
 = 
Œue
;

367  
çl£
;

368 
kD–‘ed
:

369  
çl£
;

370 
kCÜru±
:

371 
¡©e
->
s
 =

372 
Stus
::
	`CÜru±iÚ
("cÜru±ed key fÜ ", 
¡©e
->
§v”
.
u£r_key
);

373 
¡©e
->
found
 = 
Œue
;

374  
çl£
;

379  
çl£
;

383 
S‹
 
¡©e
;

384 
¡©e
.
found
 = 
çl£
;

385 
¡©e
.
¡©s
 = stats;

386 
¡©e
.
Ï¡_fe_»ad
 = 
nuÎ±r
;

387 
¡©e
.
Ï¡_fe_»ad_Ëv–
 = -1;

389 
¡©e
.
İtiÚs
 = &options;

390 
¡©e
.
ikey
 = 
k
.
	`š‹º®_key
();

391 
¡©e
.
v£t
 = 
v£t_
;

393 
¡©e
.
§v”
.¡©ğ
kNÙFound
;

394 
¡©e
.
§v”
.
ucmp
 = 
v£t_
->
icmp_
.
	`u£r_com·¿tÜ
();

395 
¡©e
.
§v”
.
u£r_key
 = 
k
.
	`u£r_key
();

396 
¡©e
.
§v”
.
v®ue
 = value;

398 
	`FÜEachOv”Ïµšg
(
¡©e
.
§v”
.
u£r_key
, s‹.
ikey
, &¡©e, &
S‹
::
M©ch
);

400  
¡©e
.
found
 ? s‹.
s
 : 
Stus
::
	`NÙFound
(
	`Sliû
());

401 
	}
}

403 
boŞ
 
	gV”siÚ
::
	$Upd©eSts
(cÚ¡ 
G‘Sts
& 
¡©s
) {

404 
FeM‘aD©a
* 
f
 = 
¡©s
.
£ek_fe
;

405 ià(
f
 !ğ
nuÎ±r
) {

406 
f
->
®lowed_£eks
--;

407 ià(
f
->
®lowed_£eks
 <ğ0 && 
fe_to_com·ù_
 =ğ
nuÎ±r
) {

408 
fe_to_com·ù_
 = 
f
;

409 
fe_to_com·ù_Ëv–_
 = 
¡©s
.
£ek_fe_Ëv–
;

410  
Œue
;

413  
çl£
;

414 
	}
}

416 
boŞ
 
	gV”siÚ
::
	$RecÜdR—dSam¶e
(
Sliû
 
š‹º®_key
) {

417 
P¬£dIÁ”ÇlKey
 
ikey
;

418 ià(!
	`P¬£IÁ”ÇlKey
(
š‹º®_key
, &
ikey
)) {

419  
çl£
;

422 
	sS‹
 {

423 
G‘Sts
 
¡©s
;

424 
m©ches
;

426 
boŞ
 
	`M©ch
(* 
¬g
, 
Ëv–
, 
FeM‘aD©a
* 
f
) {

427 
S‹
* 
¡©e
 = 
»š‹½»t_ÿ¡
<S‹*>(
¬g
);

428 
¡©e
->
m©ches
++;

429 ià(
¡©e
->
m©ches
 == 1) {

431 
¡©e
->
¡©s
.
£ek_fe
 = 
f
;

432 
¡©e
->
¡©s
.
£ek_fe_Ëv–
 = 
Ëv–
;

435  
¡©e
->
m©ches
 < 2;

439 
S‹
 
¡©e
;

440 
¡©e
.
m©ches
 = 0;

441 
	`FÜEachOv”Ïµšg
(
ikey
.
u£r_key
, 
š‹º®_key
, &
¡©e
, &
S‹
::
M©ch
);

447 ià(
¡©e
.
m©ches
 >= 2) {

449  
	`Upd©eSts
(
¡©e
.
¡©s
);

451  
çl£
;

452 
	}
}

454 
	gV”siÚ
::
	$Ref
(è{ ++
»fs_
; 
	}
}

456 
	gV”siÚ
::
	$UÄef
() {

457 
	`as£¹
(
this
 !ğ&
v£t_
->
dummy_v”siÚs_
);

458 
	`as£¹
(
»fs_
 >= 1);

459 --
»fs_
;

460 ià(
»fs_
 == 0) {

461 
d–‘e
 
this
;

463 
	}
}

465 
boŞ
 
	gV”siÚ
::
	$Ov”ÏpInLev–
(
Ëv–
, cÚ¡ 
Sliû
* 
sm®Ë¡_u£r_key
,

466 cÚ¡ 
Sliû
* 
Ïrge¡_u£r_key
) {

467  
	`SomeFeOv”ÏpsRªge
(
v£t_
->
icmp_
, (
Ëv–
 > 0), 
fes_
[level],

468 
sm®Ë¡_u£r_key
, 
Ïrge¡_u£r_key
);

469 
	}
}

471 
	gV”siÚ
::
	$PickLev–FÜMemTabËOuut
(cÚ¡ 
Sliû
& 
sm®Ë¡_u£r_key
,

472 cÚ¡ 
Sliû
& 
Ïrge¡_u£r_key
) {

473 
Ëv–
 = 0;

474 ià(!
	`Ov”ÏpInLev–
(0, &
sm®Ë¡_u£r_key
, &
Ïrge¡_u£r_key
)) {

477 
IÁ”ÇlKey
 
	`¡¬t
(
sm®Ë¡_u£r_key
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
);

478 
IÁ”ÇlKey
 
	`lim™
(
Ïrge¡_u£r_key
, 0, 
¡©ic_ÿ¡
<
V®ueTy³
>(0));

479 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ov”Ïps
;

480 
Ëv–
 < 
cÚfig
::
kMaxMemCom·ùLev–
) {

481 ià(
	`Ov”ÏpInLev–
(
Ëv–
 + 1, &
sm®Ë¡_u£r_key
, &
Ïrge¡_u£r_key
)) {

484 ià(
Ëv–
 + 2 < 
cÚfig
::
kNumLev–s
) {

486 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
 + 2, &
¡¬t
, &
lim™
, &
ov”Ïps
);

487 cÚ¡ 
št64_t
 
sum
 = 
	`TÙ®FeSize
(
ov”Ïps
);

488 ià(
sum
 > 
	`MaxG¿ndP¬’tOv”ÏpBy‹s
(
v£t_
->
İtiÚs_
)) {

492 
Ëv–
++;

495  
Ëv–
;

496 
	}
}

499 
	gV”siÚ
::
G‘Ov”ÏµšgIÅuts
(
Ëv–
, cÚ¡ 
IÁ”ÇlKey
* 
begš
,

500 cÚ¡ 
IÁ”ÇlKey
* 
’d
,

501 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
šputs
) {

502 
as£¹
(
Ëv–
 >= 0);

503 
as£¹
(
Ëv–
 < 
cÚfig
::
kNumLev–s
);

504 
	gšputs
->
ş—r
();

505 
Sliû
 
	gu£r_begš
, 
	gu£r_’d
;

506 ià(
	gbegš
 !ğ
nuÎ±r
) {

507 
u£r_begš
 = 
begš
->
u£r_key
();

509 ià(
	g’d
 !ğ
nuÎ±r
) {

510 
u£r_’d
 = 
’d
->
u£r_key
();

512 cÚ¡ 
Com·¿tÜ
* 
	gu£r_cmp
 = 
v£t_
->
icmp_
.
u£r_com·¿tÜ
();

513 
size_t
 
	gi
 = 0; i < 
	gfes_
[
Ëv–
].
size
();) {

514 
FeM‘aD©a
* 
	gf
 = 
fes_
[
Ëv–
][
i
++];

515 cÚ¡ 
Sliû
 
	gfe_¡¬t
 = 
f
->
sm®Ë¡
.
u£r_key
();

516 cÚ¡ 
Sliû
 
	gfe_lim™
 = 
f
->
Ïrge¡
.
u£r_key
();

517 ià(
	gbegš
 !ğ
nuÎ±r
 && 
u£r_cmp
->
Com·»
(
fe_lim™
, 
u£r_begš
) < 0) {

519 } ià(
	g’d
 !ğ
nuÎ±r
 && 
u£r_cmp
->
Com·»
(
fe_¡¬t
, 
u£r_’d
) > 0) {

522 
	gšputs
->
push_back
(
f
);

523 ià(
	gËv–
 == 0) {

526 ià(
begš
 !ğ
nuÎ±r
 && 
u£r_cmp
->
Com·»
(
fe_¡¬t
, 
u£r_begš
) < 0) {

527 
	gu£r_begš
 = 
fe_¡¬t
;

528 
	gšputs
->
ş—r
();

529 
	gi
 = 0;

530 } ià(
	g’d
 !ğ
nuÎ±r
 &&

531 
u£r_cmp
->
Com·»
(
fe_lim™
, 
u£r_’d
) > 0) {

532 
	gu£r_’d
 = 
fe_lim™
;

533 
	gšputs
->
ş—r
();

534 
	gi
 = 0;

541 
	g¡d
::
¡ršg
 
V”siÚ
::
	$DebugSŒšg
() const {

542 
¡d
::
¡ršg
 
r
;

543 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

548 
r
.
	`­³nd
("---†evel ");

549 
	`Aµ’dNumb”To
(&
r
, 
Ëv–
);

550 
r
.
	`­³nd
(" ---\n");

551 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
fes_
[
Ëv–
];

552 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

553 
r
.
	`push_back
(' ');

554 
	`Aµ’dNumb”To
(&
r
, 
fes
[
i
]->
numb”
);

555 
r
.
	`push_back
(':');

556 
	`Aµ’dNumb”To
(&
r
, 
fes
[
i
]->
fe_size
);

557 
r
.
	`­³nd
("[");

558 
r
.
	`­³nd
(
fes
[
i
]->
sm®Ë¡
.
	`DebugSŒšg
());

559 
r
.
	`­³nd
(" .. ");

560 
r
.
	`­³nd
(
fes
[
i
]->
Ïrge¡
.
	`DebugSŒšg
());

561 
r
.
	`­³nd
("]\n");

564  
r
;

565 
	}
}

570 şas 
	cV”siÚS‘
::
Bud”
 {

571 
´iv©e
:

573 
	sBySm®Ë¡Key
 {

574 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
š‹º®_com·¿tÜ
;

576 
boŞ
 
İ”©Ü
()(
FeM‘aD©a
* 
	gf1
, FeM‘aD©a* 
	gf2
) const {

577 
	gr
 = 
š‹º®_com·¿tÜ
->
Com·»
(
f1
->
sm®Ë¡
, 
f2
->smallest);

578 ià(
	gr
 != 0) {

579  (
r
 < 0);

582  (
	gf1
->
	gnumb”
 < 
	gf2
->number);

587 
	g¡d
::
	t£t
<
	tFeM‘aD©a
*, 
	tBySm®Ë¡Key
> 
	tFeS‘
;

588 
	sLev–S‹
 {

589 
	g¡d
::
£t
<
ušt64_t
> 
d–‘ed_fes
;

590 
FeS‘
* 
	gadded_fes
;

593 
V”siÚS‘
* 
	gv£t_
;

594 
V”siÚ
* 
	gba£_
;

595 
Lev–S‹
 
	gËv–s_
[
cÚfig
::
kNumLev–s
];

597 
	gpublic
:

599 
Bud”
(
V”siÚS‘
* 
v£t
, 
V”siÚ
* 
ba£
è: 
v£t_
(v£t), 
ba£_
(base) {

600 
	gba£_
->
Ref
();

601 
BySm®Ë¡Key
 
	gcmp
;

602 
	gcmp
.
	gš‹º®_com·¿tÜ
 = &
v£t_
->
icmp_
;

603 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

604 
	gËv–s_
[
Ëv–
].
	gadded_fes
 = 
Ãw
 
FeS‘
(
cmp
);

608 ~
Bud”
() {

609 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

610 cÚ¡ 
FeS‘
* 
	gadded
 = 
Ëv–s_
[
Ëv–
].
added_fes
;

611 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
to_uÄef
;

612 
	gto_uÄef
.
»£rve
(
added
->
size
());

613 
	gFeS‘
::
cÚ¡_™”©Ü
 
™
 = 
added
->
begš
(); 
	g™
 !ğadded->
’d
();

614 ++
	g™
) {

615 
	gto_uÄef
.
push_back
(*
™
);

617 
d–‘e
 
	gadded
;

618 
ušt32_t
 
	gi
 = 0; i < 
	gto_uÄef
.
size
(); i++) {

619 
FeM‘aD©a
* 
	gf
 = 
to_uÄef
[
i
];

620 
	gf
->
	g»fs
--;

621 ià(
	gf
->
	g»fs
 <= 0) {

622 
d–‘e
 
f
;

626 
	gba£_
->
UÄef
();

630 
Aµly
(
V”siÚEd™
* 
ed™
) {

632 
size_t
 
	gi
 = 0; i < 
	ged™
->
	gcom·ù_poš‹rs_
.
size
(); i++) {

633 cÚ¡ 
	gËv–
 = 
ed™
->
com·ù_poš‹rs_
[
i
].
fœ¡
;

634 
	gv£t_
->
	gcom·ù_poš‹r_
[
Ëv–
] =

635 
ed™
->
com·ù_poš‹rs_
[
i
].
£cÚd
.
Encode
().
ToSŒšg
();

639 cÚ¡‡uto& 
	gd–‘ed_fe_£t_kvp
 : 
ed™
->
d–‘ed_fes_
) {

640 cÚ¡ 
Ëv–
 = 
d–‘ed_fe_£t_kvp
.
fœ¡
;

641 cÚ¡ 
ušt64_t
 
	gnumb”
 = 
d–‘ed_fe_£t_kvp
.
£cÚd
;

642 
	gËv–s_
[
Ëv–
].
	gd–‘ed_fes
.
š£¹
(
numb”
);

646 
size_t
 
	gi
 = 0; i < 
	ged™
->
	gÃw_fes_
.
size
(); i++) {

647 cÚ¡ 
	gËv–
 = 
ed™
->
Ãw_fes_
[
i
].
fœ¡
;

648 
FeM‘aD©a
* 
	gf
 = 
Ãw
 FeM‘aD©a(
ed™
->
Ãw_fes_
[
i
].
£cÚd
);

649 
	gf
->
	g»fs
 = 1;

664 
	gf
->
	g®lowed_£eks
 = 
¡©ic_ÿ¡
<>((
f
->
fe_size
 / 16384U));

665 ià(
	gf
->
	g®lowed_£eks
 < 100) f->allowed_seeks = 100;

667 
	gËv–s_
[
Ëv–
].
	gd–‘ed_fes
.
”a£
(
f
->
numb”
);

668 
	gËv–s_
[
Ëv–
].
	gadded_fes
->
š£¹
(
f
);

673 
SaveTo
(
V”siÚ
* 
v
) {

674 
BySm®Ë¡Key
 
	gcmp
;

675 
	gcmp
.
	gš‹º®_com·¿tÜ
 = &
v£t_
->
icmp_
;

676 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

679 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>& 
ba£_fes
 = 
ba£_
->
fes_
[
Ëv–
];

680 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>::
cÚ¡_™”©Ü
 
ba£_™”
 = 
ba£_fes
.
begš
();

681 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>::
cÚ¡_™”©Ü
 
ba£_’d
 = 
ba£_fes
.
’d
();

682 cÚ¡ 
FeS‘
* 
	gadded_fes
 = 
Ëv–s_
[
Ëv–
].
added_fes
;

683 
	gv
->
	gfes_
[
Ëv–
].
»£rve
(
ba£_fes
.
size
(è+ 
added_fes
->size());

684 cÚ¡‡uto& 
	gadded_fe
 : *
added_fes
) {

686 
¡d
::
veùÜ
<
FeM‘aD©a
*>::
cÚ¡_™”©Ü
 
bpos
 =

687 
¡d
::
uµ”_bound
(
ba£_™”
, 
ba£_’d
, 
added_fe
, 
cmp
);

688 
	gba£_™”
 !ğ
bpos
; ++base_iter) {

689 
MaybeAddFe
(
v
, 
Ëv–
, *
ba£_™”
);

692 
MaybeAddFe
(
v
, 
Ëv–
, 
added_fe
);

696 ; 
	gba£_™”
 !ğ
ba£_’d
; ++base_iter) {

697 
MaybeAddFe
(
v
, 
Ëv–
, *
ba£_™”
);

700 #iâdeà
NDEBUG


702 ià(
	gËv–
 > 0) {

703 
ušt32_t
 
	gi
 = 1; i < 
	gv
->
	gfes_
[
Ëv–
].
size
(); i++) {

704 cÚ¡ 
	gIÁ”ÇlKey
& 
	g´ev_’d
 = 
v
->
fes_
[
Ëv–
][
i
 - 1]->
Ïrge¡
;

705 cÚ¡ 
	gIÁ”ÇlKey
& 
	gthis_begš
 = 
v
->
fes_
[
Ëv–
][
i
]->
sm®Ë¡
;

706 ià(
	gv£t_
->
	gicmp_
.
Com·»
(
´ev_’d
, 
this_begš
) >= 0) {

707 
årštf
(
¡d”r
, "overlapping„anges in same†evel %s vs. %s\n",

708 
´ev_’d
.
DebugSŒšg
().
c_¡r
(),

709 
this_begš
.
DebugSŒšg
().
c_¡r
());

710 
abÜt
();

718 
MaybeAddFe
(
V”siÚ
* 
v
, 
Ëv–
, 
FeM‘aD©a
* 
f
) {

719 ià(
	gËv–s_
[
Ëv–
].
	gd–‘ed_fes
.
couÁ
(
f
->
numb”
) > 0) {

722 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>* 
fes
 = &
v
->
fes_
[
Ëv–
];

723 ià(
	gËv–
 > 0 && !
	gfes
->
em±y
()) {

725 
as£¹
(
v£t_
->
icmp_
.
Com·»
((*
fes
)[fes->
size
(è- 1]->
Ïrge¡
,

726 
f
->
sm®Ë¡
) < 0);

728 
	gf
->
	g»fs
++;

729 
	gfes
->
push_back
(
f
);

734 
	gV”siÚS‘
::
	$V”siÚS‘
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
* 
İtiÚs
,

735 
TabËCache
* 
bË_ÿche
,

736 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
cmp
)

737 : 
	`’v_
(
İtiÚs
->
’v
),

738 
	`dbÇme_
(
dbÇme
),

739 
	`İtiÚs_
(
İtiÚs
),

740 
	`bË_ÿche_
(
bË_ÿche
),

741 
	`icmp_
(*
cmp
),

742 
	`Ãxt_fe_numb”_
(2),

743 
	`mªiã¡_fe_numb”_
(0),

744 
	`Ï¡_£qu’û_
(0),

745 
	`log_numb”_
(0),

746 
	`´ev_log_numb”_
(0),

747 
	`desütÜ_fe_
(
nuÎ±r
),

748 
	`desütÜ_log_
(
nuÎ±r
),

749 
	`dummy_v”siÚs_
(
this
),

750 
	$cu¼’t_
(
nuÎ±r
) {

751 
	`Aµ’dV”siÚ
(
Ãw
 
	`V”siÚ
(
this
));

752 
	}
}

754 
	gV”siÚS‘
::~
	$V”siÚS‘
() {

755 
cu¼’t_
->
	`UÄef
();

756 
	`as£¹
(
dummy_v”siÚs_
.
Ãxt_
 == &dummy_versions_);

757 
d–‘e
 
desütÜ_log_
;

758 
d–‘e
 
desütÜ_fe_
;

759 
	}
}

761 
	gV”siÚS‘
::
	$Aµ’dV”siÚ
(
V”siÚ
* 
v
) {

763 
	`as£¹
(
v
->
»fs_
 == 0);

764 
	`as£¹
(
v
 !ğ
cu¼’t_
);

765 ià(
cu¼’t_
 !ğ
nuÎ±r
) {

766 
cu¼’t_
->
	`UÄef
();

768 
cu¼’t_
 = 
v
;

769 
v
->
	`Ref
();

772 
v
->
´ev_
 = 
dummy_v”siÚs_
.prev_;

773 
v
->
Ãxt_
 = &
dummy_v”siÚs_
;

774 
v
->
´ev_
->
Ãxt_
 = v;

775 
v
->
Ãxt_
->
´ev_
 = v;

776 
	}
}

780 
Stus
 
	gV”siÚS‘
::
	$LogAndAµly
(
V”siÚEd™
* 
ed™
, 
pÜt
::
Mu‹x
* 
mu
) {

781 ià(
ed™
->
has_log_numb”_
) {

782 
	`as£¹
(
ed™
->
log_numb”_
 >=†og_number_);

783 
	`as£¹
(
ed™
->
log_numb”_
 < 
Ãxt_fe_numb”_
);

785 
ed™
->
	`S‘LogNumb”
(
log_numb”_
);

788 ià(!
ed™
->
has_´ev_log_numb”_
) {

789 
ed™
->
	`S‘P»vLogNumb”
(
´ev_log_numb”_
);

792 
ed™
->
	`S‘NextFe
(
Ãxt_fe_numb”_
);

793 
ed™
->
	`S‘La¡Sequ’û
(
Ï¡_£qu’û_
);

795 
V”siÚ
* 
v
 = 
Ãw
 
	`V”siÚ
(
this
);

797 
Bud”
 
	`bud”
(
this
, 
cu¼’t_
);

798 
bud”
.
	`Aµly
(
ed™
);

799 
bud”
.
	`SaveTo
(
v
);

801 
	`Fš®ize
(
v
);

805 
¡d
::
¡ršg
 
Ãw_mªiã¡_fe
;

806 
Stus
 
s
;

807 ià(
desütÜ_log_
 =ğ
nuÎ±r
) {

810 
	`as£¹
(
desütÜ_fe_
 =ğ
nuÎ±r
);

811 
Ãw_mªiã¡_fe
 = 
	`DesütÜFeName
(
dbÇme_
, 
mªiã¡_fe_numb”_
);

812 
ed™
->
	`S‘NextFe
(
Ãxt_fe_numb”_
);

814 
s
 = 
’v_
->
	`NewWr™abËFe
(
Ãw_mªiã¡_fe
, &
desütÜ_fe_
);

815 ià(
s
.
	`ok
()) {

816 
desütÜ_log_
 = 
Ãw
 
log
::
	`Wr™”
(
desütÜ_fe_
);

817 
s
 = 
	`Wr™eSÇpshÙ
(
desütÜ_log_
);

823 
mu
->
	`UÆock
();

826 ià(
s
.
	`ok
()) {

827 
¡d
::
¡ršg
 
»cÜd
;

829 
ed™
->
	`EncodeTo
(&
»cÜd
);

831 
s
 = 
desütÜ_log_
->
	`AddRecÜd
(
»cÜd
);

832 ià(
s
.
	`ok
()) {

834 
s
 = 
desütÜ_fe_
->
	`Sync
();

836 ià(!
s
.
	`ok
()) {

837 
	`Log
(
İtiÚs_
->
šfo_log
, "MANIFEST wr™e: %s\n", 
s
.
	`ToSŒšg
().
	`c_¡r
());

843 ià(
s
.
	`ok
(è&& !
Ãw_mªiã¡_fe
.
	`em±y
()) {

844 
s
 = 
	`S‘Cu¼’tFe
(
’v_
, 
dbÇme_
, 
mªiã¡_fe_numb”_
);

847 
mu
->
	`Lock
();

851 ià(
s
.
	`ok
()) {

852 
	`Aµ’dV”siÚ
(
v
);

853 
log_numb”_
 = 
ed™
->log_number_;

854 
´ev_log_numb”_
 = 
ed™
->prev_log_number_;

856 
d–‘e
 
v
;

857 ià(!
Ãw_mªiã¡_fe
.
	`em±y
()) {

858 
d–‘e
 
desütÜ_log_
;

859 
d–‘e
 
desütÜ_fe_
;

860 
desütÜ_log_
 = 
nuÎ±r
;

861 
desütÜ_fe_
 = 
nuÎ±r
;

862 
’v_
->
	`RemoveFe
(
Ãw_mªiã¡_fe
);

866  
s
;

867 
	}
}

869 
Stus
 
	gV”siÚS‘
::
	$Recov”
(
boŞ
* 
§ve_mªiã¡
) {

870 
LogR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

871 
Stus
* 
¡©us
;

872 
	`CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
s
è
ov”ride
 {

873 ià(
this
->
¡©us
->
	`ok
()è*this->¡©u ğ
s
;

878 
¡d
::
¡ršg
 
cu¼’t
;

879 
Stus
 
s
 = 
	`R—dFeToSŒšg
(
’v_
, 
	`Cu¼’tFeName
(
dbÇme_
), &
cu¼’t
);

880 ià(!
s
.
	`ok
()) {

881  
s
;

883 ià(
cu¼’t
.
	`em±y
(è|| cu¼’t[cu¼’t.
	`size
() - 1] != '\n') {

884  
Stus
::
	`CÜru±iÚ
("CURRENT file does‚otƒnd with‚ewline");

886 
cu¼’t
.
	`»size
(cu¼’t.
	`size
() - 1);

888 
¡d
::
¡ršg
 
dsúame
 = 
dbÇme_
 + "/" + 
cu¼’t
;

889 
Sequ’tŸlFe
* 
fe
;

890 
s
 = 
’v_
->
	`NewSequ’tŸlFe
(
dsúame
, &
fe
);

891 ià(!
s
.
	`ok
()) {

892 ià(
s
.
	`IsNÙFound
()) {

893  
Stus
::
	`CÜru±iÚ
("CURRENT…ointso‡‚on-existent file",

894 
s
.
	`ToSŒšg
());

896  
s
;

899 
boŞ
 
have_log_numb”
 = 
çl£
;

900 
boŞ
 
have_´ev_log_numb”
 = 
çl£
;

901 
boŞ
 
have_Ãxt_fe
 = 
çl£
;

902 
boŞ
 
have_Ï¡_£qu’û
 = 
çl£
;

903 
ušt64_t
 
Ãxt_fe
 = 0;

904 
ušt64_t
 
Ï¡_£qu’û
 = 0;

905 
ušt64_t
 
log_numb”
 = 0;

906 
ušt64_t
 
´ev_log_numb”
 = 0;

907 
Bud”
 
	`bud”
(
this
, 
cu¼’t_
);

910 
LogR•Ü‹r
 
»pÜ‹r
;

911 
»pÜ‹r
.
¡©us
 = &
s
;

912 
log
::
R—d”
 
	`»ad”
(
fe
, &
»pÜ‹r
, 
Œue
 ,

914 
Sliû
 
»cÜd
;

915 
¡d
::
¡ršg
 
sü©ch
;

916 
»ad”
.
	`R—dRecÜd
(&
»cÜd
, &
sü©ch
è&& 
s
.
	`ok
()) {

917 
V”siÚEd™
 
ed™
;

918 
s
 = 
ed™
.
	`DecodeFrom
(
»cÜd
);

919 ià(
s
.
	`ok
()) {

920 ià(
ed™
.
has_com·¿tÜ_
 &&

921 
ed™
.
com·¿tÜ_
 !ğ
icmp_
.
	`u£r_com·¿tÜ
()->
	`Name
()) {

922 
s
 = 
Stus
::
	`Inv®idArgum’t
(

923 
ed™
.
com·¿tÜ_
 + " does‚ot matchƒxisting comparator ",

924 
icmp_
.
	`u£r_com·¿tÜ
()->
	`Name
());

928 ià(
s
.
	`ok
()) {

929 
bud”
.
	`Aµly
(&
ed™
);

932 ià(
ed™
.
has_log_numb”_
) {

933 
log_numb”
 = 
ed™
.
log_numb”_
;

934 
have_log_numb”
 = 
Œue
;

937 ià(
ed™
.
has_´ev_log_numb”_
) {

938 
´ev_log_numb”
 = 
ed™
.
´ev_log_numb”_
;

939 
have_´ev_log_numb”
 = 
Œue
;

942 ià(
ed™
.
has_Ãxt_fe_numb”_
) {

943 
Ãxt_fe
 = 
ed™
.
Ãxt_fe_numb”_
;

944 
have_Ãxt_fe
 = 
Œue
;

947 ià(
ed™
.
has_Ï¡_£qu’û_
) {

948 
Ï¡_£qu’û
 = 
ed™
.
Ï¡_£qu’û_
;

949 
have_Ï¡_£qu’û
 = 
Œue
;

953 
d–‘e
 
fe
;

954 
fe
 = 
nuÎ±r
;

956 ià(
s
.
	`ok
()) {

957 ià(!
have_Ãxt_fe
) {

958 
s
 = 
Stus
::
	`CÜru±iÚ
("no meta-nextfileƒntry in descriptor");

959 } ià(!
have_log_numb”
) {

960 
s
 = 
Stus
::
	`CÜru±iÚ
("no meta-lognumberƒntry in descriptor");

961 } ià(!
have_Ï¡_£qu’û
) {

962 
s
 = 
Stus
::
	`CÜru±iÚ
("no†ast-sequence-numberƒntry in descriptor");

965 ià(!
have_´ev_log_numb”
) {

966 
´ev_log_numb”
 = 0;

969 
	`M¬kFeNumb”U£d
(
´ev_log_numb”
);

970 
	`M¬kFeNumb”U£d
(
log_numb”
);

973 ià(
s
.
	`ok
()) {

974 
V”siÚ
* 
v
 = 
Ãw
 
	`V”siÚ
(
this
);

975 
bud”
.
	`SaveTo
(
v
);

977 
	`Fš®ize
(
v
);

978 
	`Aµ’dV”siÚ
(
v
);

979 
mªiã¡_fe_numb”_
 = 
Ãxt_fe
;

980 
Ãxt_fe_numb”_
 = 
Ãxt_fe
 + 1;

981 
Ï¡_£qu’û_
 = 
Ï¡_£qu’û
;

982 
log_numb”_
 = 
log_numb”
;

983 
´ev_log_numb”_
 = 
´ev_log_numb”
;

986 ià(
	`Reu£Mªiã¡
(
dsúame
, 
cu¼’t
)) {

989 *
§ve_mªiã¡
 = 
Œue
;

993  
s
;

994 
	}
}

996 
boŞ
 
	gV”siÚS‘
::
	$Reu£Mªiã¡
(cÚ¡ 
¡d
::
¡ršg
& 
dsúame
,

997 cÚ¡ 
¡d
::
¡ršg
& 
dscba£
) {

998 ià(!
İtiÚs_
->
»u£_logs
) {

999  
çl£
;

1001 
FeTy³
 
mªiã¡_ty³
;

1002 
ušt64_t
 
mªiã¡_numb”
;

1003 
ušt64_t
 
mªiã¡_size
;

1004 ià(!
	`P¬£FeName
(
dscba£
, &
mªiã¡_numb”
, &
mªiã¡_ty³
) ||

1005 
mªiã¡_ty³
 !ğ
kDesütÜFe
 ||

1006 !
’v_
->
	`G‘FeSize
(
dsúame
, &
mªiã¡_size
).
	`ok
() ||

1008 
mªiã¡_size
 >ğ
	`T¬g‘FeSize
(
İtiÚs_
)) {

1009  
çl£
;

1012 
	`as£¹
(
desütÜ_fe_
 =ğ
nuÎ±r
);

1013 
	`as£¹
(
desütÜ_log_
 =ğ
nuÎ±r
);

1014 
Stus
 
r
 = 
’v_
->
	`NewAµ’dabËFe
(
dsúame
, &
desütÜ_fe_
);

1015 ià(!
r
.
	`ok
()) {

1016 
	`Log
(
İtiÚs_
->
šfo_log
, "Reu£ MANIFEST: %s\n", 
r
.
	`ToSŒšg
().
	`c_¡r
());

1017 
	`as£¹
(
desütÜ_fe_
 =ğ
nuÎ±r
);

1018  
çl£
;

1021 
	`Log
(
İtiÚs_
->
šfo_log
, "Reusšg MANIFEST %s\n", 
dsúame
.
	`c_¡r
());

1022 
desütÜ_log_
 = 
Ãw
 
log
::
	`Wr™”
(
desütÜ_fe_
, 
mªiã¡_size
);

1023 
mªiã¡_fe_numb”_
 = 
mªiã¡_numb”
;

1024  
Œue
;

1025 
	}
}

1027 
	gV”siÚS‘
::
	$M¬kFeNumb”U£d
(
ušt64_t
 
numb”
) {

1028 ià(
Ãxt_fe_numb”_
 <ğ
numb”
) {

1029 
Ãxt_fe_numb”_
 = 
numb”
 + 1;

1031 
	}
}

1033 
	gV”siÚS‘
::
	$Fš®ize
(
V”siÚ
* 
v
) {

1035 
be¡_Ëv–
 = -1;

1036 
be¡_scÜe
 = -1;

1039 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
 - 1;†evel++) {

1040 
scÜe
;

1041 ià(
Ëv–
 == 0) {

1053 
scÜe
 = 
v
->
fes_
[
Ëv–
].
	`size
() /

1054 
¡©ic_ÿ¡
<>(
cÚfig
::
kL0_Com·ùiÚTrigg”
);

1057 cÚ¡ 
ušt64_t
 
Ëv–_by‹s
 = 
	`TÙ®FeSize
(
v
->
fes_
[
Ëv–
]);

1058 
scÜe
 =

1059 
¡©ic_ÿ¡
<>(
Ëv–_by‹s
è/ 
	`MaxBy‹sFÜLev–
(
İtiÚs_
, 
Ëv–
);

1062 ià(
scÜe
 > 
be¡_scÜe
) {

1063 
be¡_Ëv–
 = 
Ëv–
;

1064 
be¡_scÜe
 = 
scÜe
;

1068 
v
->
com·ùiÚ_Ëv–_
 = 
be¡_Ëv–
;

1069 
v
->
com·ùiÚ_scÜe_
 = 
be¡_scÜe
;

1070 
	}
}

1074 
Stus
 
	gV”siÚS‘
::
	$Wr™eSÇpshÙ
(
log
::
Wr™”
*†og) {

1078 
V”siÚEd™
 
ed™
;

1079 
ed™
.
	`S‘Com·¿tÜName
(
icmp_
.
	`u£r_com·¿tÜ
()->
	`Name
());

1082 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

1083 ià(!
com·ù_poš‹r_
[
Ëv–
].
	`em±y
()) {

1084 
IÁ”ÇlKey
 
key
;

1085 
key
.
	`DecodeFrom
(
com·ù_poš‹r_
[
Ëv–
]);

1086 
ed™
.
	`S‘Com·ùPoš‹r
(
Ëv–
, 
key
);

1091 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

1092 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
cu¼’t_
->
fes_
[
Ëv–
];

1093 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

1094 cÚ¡ 
FeM‘aD©a
* 
f
 = 
fes
[
i
];

1095 
ed™
.
	`AddFe
(
Ëv–
, 
f
->
numb”
, f->
fe_size
, f->
sm®Ë¡
, f->
Ïrge¡
);

1099 
¡d
::
¡ršg
 
»cÜd
;

1100 
ed™
.
	`EncodeTo
(&
»cÜd
);

1101  
log
->
	`AddRecÜd
(
»cÜd
);

1102 
	}
}

1104 
	gV”siÚS‘
::
	$NumLev–Fes
(
Ëv–
) const {

1105 
	`as£¹
(
Ëv–
 >= 0);

1106 
	`as£¹
(
Ëv–
 < 
cÚfig
::
kNumLev–s
);

1107  
cu¼’t_
->
fes_
[
Ëv–
].
	`size
();

1108 
	}
}

1110 cÚ¡ * 
	gV”siÚS‘
::
	$Lev–Summ¬y
(
Lev–Summ¬yStÜage
* 
sü©ch
) const {

1112 
	`¡©ic_as£¹
(
cÚfig
::
kNumLev–s
 == 7, "");

1113 
	`¢´štf
(
sü©ch
->
bufãr
, (scratch->buffer),

1114 "fes[ %d %d %d %d %d %d %d ]", (
cu¼’t_
->
fes_
[0].
	`size
()),

1115 (
cu¼’t_
->
fes_
[1].
	`size
()), (current_->files_[2].size()),

1116 (
cu¼’t_
->
fes_
[3].
	`size
()), (current_->files_[4].size()),

1117 (
cu¼’t_
->
fes_
[5].
	`size
()), (current_->files_[6].size()));

1118  
sü©ch
->
bufãr
;

1119 
	}
}

1121 
ušt64_t
 
	gV”siÚS‘
::
	$Aµroxim©eOff£tOf
(
V”siÚ
* 
v
, cÚ¡ 
IÁ”ÇlKey
& 
ikey
) {

1122 
ušt64_t
 
»suÉ
 = 0;

1123 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

1124 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
v
->
fes_
[
Ëv–
];

1125 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

1126 ià(
icmp_
.
	`Com·»
(
fes
[
i
]->
Ïrge¡
, 
ikey
) <= 0) {

1128 
»suÉ
 +ğ
fes
[
i
]->
fe_size
;

1129 } ià(
icmp_
.
	`Com·»
(
fes
[
i
]->
sm®Ë¡
, 
ikey
) > 0) {

1131 ià(
Ëv–
 > 0) {

1140 
TabË
* 
bË±r
;

1141 
I‹¿tÜ
* 
™”
 = 
bË_ÿche_
->
	`NewI‹¿tÜ
(

1142 
	`R—dO±iÚs
(), 
fes
[
i
]->
numb”
, fes[i]->
fe_size
, &
bË±r
);

1143 ià(
bË±r
 !ğ
nuÎ±r
) {

1144 
»suÉ
 +ğ
bË±r
->
	`Aµroxim©eOff£tOf
(
ikey
.
	`Encode
());

1146 
d–‘e
 
™”
;

1150  
»suÉ
;

1151 
	}
}

1153 
	gV”siÚS‘
::
AddLiveFes
(
¡d
::
£t
<
ušt64_t
>* 
live
) {

1154 
V”siÚ
* 
v
 = 
dummy_v”siÚs_
.
Ãxt_
; 
	gv
 != &dummy_versions_;

1155 
	gv
 = 
v
->
Ãxt_
) {

1156 
Ëv–
 = 0; 
	gËv–
 < 
	gcÚfig
::
kNumLev–s
;†evel++) {

1157 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
v
->
fes_
[
Ëv–
];

1158 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

1159 
	glive
->
š£¹
(
fes
[
i
]->
numb”
);

1165 
št64_t
 
	gV”siÚS‘
::
	$NumLev–By‹s
(
Ëv–
) const {

1166 
	`as£¹
(
Ëv–
 >= 0);

1167 
	`as£¹
(
Ëv–
 < 
cÚfig
::
kNumLev–s
);

1168  
	`TÙ®FeSize
(
cu¼’t_
->
fes_
[
Ëv–
]);

1169 
	}
}

1171 
št64_t
 
	gV”siÚS‘
::
	$MaxNextLev–Ov”ÏµšgBy‹s
() {

1172 
št64_t
 
»suÉ
 = 0;

1173 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ov”Ïps
;

1174 
Ëv–
 = 1;†ev– < 
cÚfig
::
kNumLev–s
 - 1;†evel++) {

1175 
size_t
 
i
 = 0; i < 
cu¼’t_
->
fes_
[
Ëv–
].
	`size
(); i++) {

1176 cÚ¡ 
FeM‘aD©a
* 
f
 = 
cu¼’t_
->
fes_
[
Ëv–
][
i
];

1177 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
 + 1, &
f
->
sm®Ë¡
, &f->
Ïrge¡
,

1178 &
ov”Ïps
);

1179 cÚ¡ 
št64_t
 
sum
 = 
	`TÙ®FeSize
(
ov”Ïps
);

1180 ià(
sum
 > 
»suÉ
) {

1181 
»suÉ
 = 
sum
;

1185  
»suÉ
;

1186 
	}
}

1191 
	gV”siÚS‘
::
G‘Rªge
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs
,

1192 
IÁ”ÇlKey
* 
sm®Ë¡
, IÁ”ÇlKey* 
Ïrge¡
) {

1193 
as£¹
(!
šputs
.
em±y
());

1194 
	gsm®Ë¡
->
CË¬
();

1195 
	gÏrge¡
->
CË¬
();

1196 
size_t
 
	gi
 = 0; i < 
	gšputs
.
size
(); i++) {

1197 
FeM‘aD©a
* 
	gf
 = 
šputs
[
i
];

1198 ià(
	gi
 == 0) {

1199 *
sm®Ë¡
 = 
f
->smallest;

1200 *
	gÏrge¡
 = 
f
->
Ïrge¡
;

1202 ià(
	gicmp_
.
Com·»
(
f
->
sm®Ë¡
, *smallest) < 0) {

1203 *
	gsm®Ë¡
 = 
f
->
sm®Ë¡
;

1205 ià(
	gicmp_
.
Com·»
(
f
->
Ïrge¡
, *largest) > 0) {

1206 *
	gÏrge¡
 = 
f
->
Ïrge¡
;

1215 
	gV”siÚS‘
::
G‘Rªge2
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs1
,

1216 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs2
,

1217 
IÁ”ÇlKey
* 
sm®Ë¡
, IÁ”ÇlKey* 
Ïrge¡
) {

1218 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
®l
 = 
šputs1
;

1219 
	g®l
.
š£¹
(
®l
.
’d
(), 
šputs2
.
begš
(), inputs2.end());

1220 
G‘Rªge
(
®l
, 
sm®Ë¡
, 
Ïrge¡
);

1223 
I‹¿tÜ
* 
	gV”siÚS‘
::
	$MakeIÅutI‹¿tÜ
(
Com·ùiÚ
* 
c
) {

1224 
R—dO±iÚs
 
İtiÚs
;

1225 
İtiÚs
.
v”ify_checksums
 = 
İtiÚs_
->
·¿noid_checks
;

1226 
İtiÚs
.
fl_ÿche
 = 
çl£
;

1231 cÚ¡ 
¥aû
 = (
c
->
	`Ëv–
(è=ğ0 ? c->
šputs_
[0].
	`size
() + 1 : 2);

1232 
I‹¿tÜ
** 
li¡
 = 
Ãw
 I‹¿tÜ*[
¥aû
];

1233 
num
 = 0;

1234 
which
 = 0; which < 2; which++) {

1235 ià(!
c
->
šputs_
[
which
].
	`em±y
()) {

1236 ià(
c
->
	`Ëv–
(è+ 
which
 == 0) {

1237 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
c
->
šputs_
[
which
];

1238 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

1239 
li¡
[
num
++] = 
bË_ÿche_
->
	`NewI‹¿tÜ
(
İtiÚs
, 
fes
[
i
]->
numb”
,

1240 
fes
[
i
]->
fe_size
);

1244 
li¡
[
num
++] = 
	`NewTwoLev–I‹¿tÜ
(

1245 
Ãw
 
V”siÚ
::
	`Lev–FeNumI‹¿tÜ
(
icmp_
, &
c
->
šputs_
[
which
]),

1246 &
G‘FeI‹¿tÜ
, 
bË_ÿche_
, 
İtiÚs
);

1250 
	`as£¹
(
num
 <ğ
¥aû
);

1251 
I‹¿tÜ
* 
»suÉ
 = 
	`NewM”gšgI‹¿tÜ
(&
icmp_
, 
li¡
, 
num
);

1252 
d–‘e
[] 
li¡
;

1253  
»suÉ
;

1254 
	}
}

1256 
Com·ùiÚ
* 
	gV”siÚS‘
::
	$PickCom·ùiÚ
() {

1257 
Com·ùiÚ
* 
c
;

1258 
Ëv–
;

1262 cÚ¡ 
boŞ
 
size_com·ùiÚ
 = (
cu¼’t_
->
com·ùiÚ_scÜe_
 >= 1);

1263 cÚ¡ 
boŞ
 
£ek_com·ùiÚ
 = (
cu¼’t_
->
fe_to_com·ù_
 !ğ
nuÎ±r
);

1264 ià(
size_com·ùiÚ
) {

1265 
Ëv–
 = 
cu¼’t_
->
com·ùiÚ_Ëv–_
;

1266 
	`as£¹
(
Ëv–
 >= 0);

1267 
	`as£¹
(
Ëv–
 + 1 < 
cÚfig
::
kNumLev–s
);

1268 
c
 = 
Ãw
 
	`Com·ùiÚ
(
İtiÚs_
, 
Ëv–
);

1271 
size_t
 
i
 = 0; i < 
cu¼’t_
->
fes_
[
Ëv–
].
	`size
(); i++) {

1272 
FeM‘aD©a
* 
f
 = 
cu¼’t_
->
fes_
[
Ëv–
][
i
];

1273 ià(
com·ù_poš‹r_
[
Ëv–
].
	`em±y
() ||

1274 
icmp_
.
	`Com·»
(
f
->
Ïrge¡
.
	`Encode
(), 
com·ù_poš‹r_
[
Ëv–
]) > 0) {

1275 
c
->
šputs_
[0].
	`push_back
(
f
);

1279 ià(
c
->
šputs_
[0].
	`em±y
()) {

1281 
c
->
šputs_
[0].
	`push_back
(
cu¼’t_
->
fes_
[
Ëv–
][0]);

1283 } ià(
£ek_com·ùiÚ
) {

1284 
Ëv–
 = 
cu¼’t_
->
fe_to_com·ù_Ëv–_
;

1285 
c
 = 
Ãw
 
	`Com·ùiÚ
(
İtiÚs_
, 
Ëv–
);

1286 
c
->
šputs_
[0].
	`push_back
(
cu¼’t_
->
fe_to_com·ù_
);

1288  
nuÎ±r
;

1291 
c
->
šput_v”siÚ_
 = 
cu¼’t_
;

1292 
c
->
šput_v”siÚ_
->
	`Ref
();

1295 ià(
Ëv–
 == 0) {

1296 
IÁ”ÇlKey
 
sm®Ë¡
, 
Ïrge¡
;

1297 
	`G‘Rªge
(
c
->
šputs_
[0], &
sm®Ë¡
, &
Ïrge¡
);

1301 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(0, &
sm®Ë¡
, &
Ïrge¡
, &
c
->
šputs_
[0]);

1302 
	`as£¹
(!
c
->
šputs_
[0].
	`em±y
());

1305 
	`S‘upOth”IÅuts
(
c
);

1307  
c
;

1308 
	}
}

1312 
boŞ
 
FšdL¬ge¡Key
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

1313 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
,

1314 
IÁ”ÇlKey
* 
Ïrge¡_key
) {

1315 ià(
	gfes
.
em±y
()) {

1316  
	gçl£
;

1318 *
	gÏrge¡_key
 = 
fes
[0]->
Ïrge¡
;

1319 
size_t
 
	gi
 = 1; i < 
	gfes
.
size
(); ++i) {

1320 
FeM‘aD©a
* 
	gf
 = 
fes
[
i
];

1321 ià(
	gicmp
.
Com·»
(
f
->
Ïrge¡
, *
Ïrge¡_key
) > 0) {

1322 *
	gÏrge¡_key
 = 
f
->
Ïrge¡
;

1325  
	gŒue
;

1330 
FeM‘aD©a
* 
FšdSm®Ë¡Bound¬yFe
(

1331 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

1332 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
Ëv–_fes
,

1333 cÚ¡ 
IÁ”ÇlKey
& 
Ïrge¡_key
) {

1334 cÚ¡ 
Com·¿tÜ
* 
	gu£r_cmp
 = 
icmp
.
u£r_com·¿tÜ
();

1335 
FeM‘aD©a
* 
	gsm®Ë¡_bound¬y_fe
 = 
nuÎ±r
;

1336 
size_t
 
	gi
 = 0; i < 
	gËv–_fes
.
size
(); ++i) {

1337 
FeM‘aD©a
* 
	gf
 = 
Ëv–_fes
[
i
];

1338 ià(
	gicmp
.
Com·»
(
f
->
sm®Ë¡
, 
Ïrge¡_key
) > 0 &&

1339 
	gu£r_cmp
->
Com·»
(
f
->
sm®Ë¡
.
u£r_key
(), 
Ïrge¡_key
.user_key()) ==

1341 ià(
sm®Ë¡_bound¬y_fe
 =ğ
nuÎ±r
 ||

1342 
icmp
.
Com·»
(
f
->
sm®Ë¡
, 
sm®Ë¡_bound¬y_fe
->smallest) < 0) {

1343 
	gsm®Ë¡_bound¬y_fe
 = 
f
;

1347  
	gsm®Ë¡_bound¬y_fe
;

1364 
AddBound¬yIÅuts
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

1365 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
Ëv–_fes
,

1366 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
com·ùiÚ_fes
) {

1367 
IÁ”ÇlKey
 
Ïrge¡_key
;

1370 ià(!
FšdL¬ge¡Key
(
icmp
, *
com·ùiÚ_fes
, &
Ïrge¡_key
)) {

1374 
boŞ
 
	gcÚtšue_£¬chšg
 = 
Œue
;

1375 
	gcÚtšue_£¬chšg
) {

1376 
FeM‘aD©a
* 
	gsm®Ë¡_bound¬y_fe
 =

1377 
FšdSm®Ë¡Bound¬yFe
(
icmp
, 
Ëv–_fes
, 
Ïrge¡_key
);

1380 ià(
	gsm®Ë¡_bound¬y_fe
 !ğ
NULL
) {

1381 
com·ùiÚ_fes
->
push_back
(
sm®Ë¡_bound¬y_fe
);

1382 
	gÏrge¡_key
 = 
sm®Ë¡_bound¬y_fe
->
Ïrge¡
;

1384 
	gcÚtšue_£¬chšg
 = 
çl£
;

1389 
	gV”siÚS‘
::
	$S‘upOth”IÅuts
(
Com·ùiÚ
* 
c
) {

1390 cÚ¡ 
Ëv–
 = 
c
->
	`Ëv–
();

1391 
IÁ”ÇlKey
 
sm®Ë¡
, 
Ïrge¡
;

1393 
	`AddBound¬yIÅuts
(
icmp_
, 
cu¼’t_
->
fes_
[
Ëv–
], &
c
->
šputs_
[0]);

1394 
	`G‘Rªge
(
c
->
šputs_
[0], &
sm®Ë¡
, &
Ïrge¡
);

1396 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
 + 1, &
sm®Ë¡
, &
Ïrge¡
,

1397 &
c
->
šputs_
[1]);

1400 
IÁ”ÇlKey
 
®l_¡¬t
, 
®l_lim™
;

1401 
	`G‘Rªge2
(
c
->
šputs_
[0], c->šputs_[1], &
®l_¡¬t
, &
®l_lim™
);

1405 ià(!
c
->
šputs_
[1].
	`em±y
()) {

1406 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ex·nded0
;

1407 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
, &
®l_¡¬t
, &
®l_lim™
, &
ex·nded0
);

1408 
	`AddBound¬yIÅuts
(
icmp_
, 
cu¼’t_
->
fes_
[
Ëv–
], &
ex·nded0
);

1409 cÚ¡ 
št64_t
 
šputs0_size
 = 
	`TÙ®FeSize
(
c
->
šputs_
[0]);

1410 cÚ¡ 
št64_t
 
šputs1_size
 = 
	`TÙ®FeSize
(
c
->
šputs_
[1]);

1411 cÚ¡ 
št64_t
 
ex·nded0_size
 = 
	`TÙ®FeSize
(
ex·nded0
);

1412 ià(
ex·nded0
.
	`size
(è> 
c
->
šputs_
[0].size() &&

1413 
šputs1_size
 + 
ex·nded0_size
 <

1414 
	`Ex·ndedCom·ùiÚBy‹SizeLim™
(
İtiÚs_
)) {

1415 
IÁ”ÇlKey
 
Ãw_¡¬t
, 
Ãw_lim™
;

1416 
	`G‘Rªge
(
ex·nded0
, &
Ãw_¡¬t
, &
Ãw_lim™
);

1417 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ex·nded1
;

1418 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
 + 1, &
Ãw_¡¬t
, &
Ãw_lim™
,

1419 &
ex·nded1
);

1420 ià(
ex·nded1
.
	`size
(è=ğ
c
->
šputs_
[1].size()) {

1421 
	`Log
(
İtiÚs_
->
šfo_log
,

1423 
Ëv–
, (
c
->
šputs_
[0].
	`size
()), (c->inputs_[1].size()),

1424 (
šputs0_size
), (
šputs1_size
), (
ex·nded0
.
	`size
()),

1425 (
ex·nded1
.
	`size
()), (
ex·nded0_size
), (
šputs1_size
));

1426 
sm®Ë¡
 = 
Ãw_¡¬t
;

1427 
Ïrge¡
 = 
Ãw_lim™
;

1428 
c
->
šputs_
[0] = 
ex·nded0
;

1429 
c
->
šputs_
[1] = 
ex·nded1
;

1430 
	`G‘Rªge2
(
c
->
šputs_
[0], c->šputs_[1], &
®l_¡¬t
, &
®l_lim™
);

1437 ià(
Ëv–
 + 2 < 
cÚfig
::
kNumLev–s
) {

1438 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
 + 2, &
®l_¡¬t
, &
®l_lim™
,

1439 &
c
->
g¿nd·»Ás_
);

1446 
com·ù_poš‹r_
[
Ëv–
] = 
Ïrge¡
.
	`Encode
().
	`ToSŒšg
();

1447 
c
->
ed™_
.
	`S‘Com·ùPoš‹r
(
Ëv–
, 
Ïrge¡
);

1448 
	}
}

1450 
Com·ùiÚ
* 
	gV”siÚS‘
::
	$Com·ùRªge
(
Ëv–
, cÚ¡ 
IÁ”ÇlKey
* 
begš
,

1451 cÚ¡ 
IÁ”ÇlKey
* 
’d
) {

1452 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
šputs
;

1453 
cu¼’t_
->
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
, 
begš
, 
’d
, &
šputs
);

1454 ià(
šputs
.
	`em±y
()) {

1455  
nuÎ±r
;

1462 ià(
Ëv–
 > 0) {

1463 cÚ¡ 
ušt64_t
 
lim™
 = 
	`MaxFeSizeFÜLev–
(
İtiÚs_
, 
Ëv–
);

1464 
ušt64_t
 
tÙ®
 = 0;

1465 
size_t
 
i
 = 0; i < 
šputs
.
	`size
(); i++) {

1466 
ušt64_t
 
s
 = 
šputs
[
i
]->
fe_size
;

1467 
tÙ®
 +ğ
s
;

1468 ià(
tÙ®
 >ğ
lim™
) {

1469 
šputs
.
	`»size
(
i
 + 1);

1475 
Com·ùiÚ
* 
c
 = 
Ãw
 
	`Com·ùiÚ
(
İtiÚs_
, 
Ëv–
);

1476 
c
->
šput_v”siÚ_
 = 
cu¼’t_
;

1477 
c
->
šput_v”siÚ_
->
	`Ref
();

1478 
c
->
šputs_
[0] = 
šputs
;

1479 
	`S‘upOth”IÅuts
(
c
);

1480  
c
;

1481 
	}
}

1483 
	gCom·ùiÚ
::
	$Com·ùiÚ
(cÚ¡ 
O±iÚs
* 
İtiÚs
, 
Ëv–
)

1484 : 
	`Ëv–_
(
Ëv–
),

1485 
	`max_ouut_fe_size_
(
	`MaxFeSizeFÜLev–
(
İtiÚs
, 
Ëv–
)),

1486 
	`šput_v”siÚ_
(
nuÎ±r
),

1487 
	`g¿nd·»Á_šdex_
(0),

1488 
	`£’_key_
(
çl£
),

1489 
	$ov”Ïµed_by‹s_
(0) {

1490 
i
 = 0; i < 
cÚfig
::
kNumLev–s
; i++) {

1491 
Ëv–_±rs_
[
i
] = 0;

1493 
	}
}

1495 
	gCom·ùiÚ
::~
	$Com·ùiÚ
() {

1496 ià(
šput_v”siÚ_
 !ğ
nuÎ±r
) {

1497 
šput_v”siÚ_
->
	`UÄef
();

1499 
	}
}

1501 
boŞ
 
	gCom·ùiÚ
::
	$IsTrivŸlMove
() const {

1502 cÚ¡ 
V”siÚS‘
* 
v£t
 = 
šput_v”siÚ_
->
v£t_
;

1506  (
	`num_šput_fes
(0) == 1 &&‚um_input_files(1) == 0 &&

1507 
	`TÙ®FeSize
(
g¿nd·»Ás_
) <=

1508 
	`MaxG¿ndP¬’tOv”ÏpBy‹s
(
v£t
->
İtiÚs_
));

1509 
	}
}

1511 
	gCom·ùiÚ
::
	$AddIÅutD–‘iÚs
(
V”siÚEd™
* 
ed™
) {

1512 
which
 = 0; which < 2; which++) {

1513 
size_t
 
i
 = 0; i < 
šputs_
[
which
].
	`size
(); i++) {

1514 
ed™
->
	`RemoveFe
(
Ëv–_
 + 
which
, 
šputs_
[which][
i
]->
numb”
);

1517 
	}
}

1519 
boŞ
 
	gCom·ùiÚ
::
	$IsBa£Lev–FÜKey
(cÚ¡ 
Sliû
& 
u£r_key
) {

1521 cÚ¡ 
Com·¿tÜ
* 
u£r_cmp
 = 
šput_v”siÚ_
->
v£t_
->
icmp_
.
	`u£r_com·¿tÜ
();

1522 
lvl
 = 
Ëv–_
 + 2;†vÈ< 
cÚfig
::
kNumLev–s
;†vl++) {

1523 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
šput_v”siÚ_
->
fes_
[
lvl
];

1524 
Ëv–_±rs_
[
lvl
] < 
fes
.
	`size
()) {

1525 
FeM‘aD©a
* 
f
 = 
fes
[
Ëv–_±rs_
[
lvl
]];

1526 ià(
u£r_cmp
->
	`Com·»
(
u£r_key
, 
f
->
Ïrge¡
.
	`u£r_key
()) <= 0) {

1528 ià(
u£r_cmp
->
	`Com·»
(
u£r_key
, 
f
->
sm®Ë¡
.
	`u£r_key
()) >= 0) {

1530  
çl£
;

1534 
Ëv–_±rs_
[
lvl
]++;

1537  
Œue
;

1538 
	}
}

1540 
boŞ
 
	gCom·ùiÚ
::
	$ShouldStİBefÜe
(cÚ¡ 
Sliû
& 
š‹º®_key
) {

1541 cÚ¡ 
V”siÚS‘
* 
v£t
 = 
šput_v”siÚ_
->
v£t_
;

1543 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
icmp
 = &
v£t
->
icmp_
;

1544 
g¿nd·»Á_šdex_
 < 
g¿nd·»Ás_
.
	`size
() &&

1545 
icmp
->
	`Com·»
(
š‹º®_key
,

1546 
g¿nd·»Ás_
[
g¿nd·»Á_šdex_
]->
Ïrge¡
.
	`Encode
()) >

1548 ià(
£’_key_
) {

1549 
ov”Ïµed_by‹s_
 +ğ
g¿nd·»Ás_
[
g¿nd·»Á_šdex_
]->
fe_size
;

1551 
g¿nd·»Á_šdex_
++;

1553 
£’_key_
 = 
Œue
;

1555 ià(
ov”Ïµed_by‹s_
 > 
	`MaxG¿ndP¬’tOv”ÏpBy‹s
(
v£t
->
İtiÚs_
)) {

1557 
ov”Ïµed_by‹s_
 = 0;

1558  
Œue
;

1560  
çl£
;

1562 
	}
}

1564 
	gCom·ùiÚ
::
	$R–—£IÅuts
() {

1565 ià(
šput_v”siÚ_
 !ğ
nuÎ±r
) {

1566 
šput_v”siÚ_
->
	`UÄef
();

1567 
šput_v”siÚ_
 = 
nuÎ±r
;

1569 
	}
}

	@version_set.h

15 #iâdeà
STORAGE_LEVELDB_DB_VERSION_SET_H_


16 
	#STORAGE_LEVELDB_DB_VERSION_SET_H_


	)

18 
	~<m­
>

19 
	~<£t
>

20 
	~<veùÜ
>

22 
	~"db/dbfÜm©.h
"

23 
	~"db/v”siÚ_ed™.h
"

24 
	~"pÜt/pÜt.h
"

25 
	~"pÜt/th»ad_ªnÙ©iÚs.h
"

27 
Çme¥aû
 
	gËv–db
 {

29 
Çme¥aû
 
	glog
 {

30 
şass
 
	gWr™”
;

33 
şass
 
	gCom·ùiÚ
;

34 
şass
 
	gI‹¿tÜ
;

35 
şass
 
	gMemTabË
;

36 
şass
 
	gTabËBud”
;

37 
şass
 
	gTabËCache
;

38 
şass
 
	gV”siÚ
;

39 
şass
 
	gV”siÚS‘
;

40 
şass
 
	gWr™abËFe
;

45 
FšdFe
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

46 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
, cÚ¡ 
Sliû
& 
key
);

54 
boŞ
 
SomeFeOv”ÏpsRªge
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

55 
boŞ
 
disjošt_sÜ‹d_fes
,

56 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
,

57 cÚ¡ 
Sliû
* 
sm®Ë¡_u£r_key
,

58 cÚ¡ 
Sliû
* 
Ïrge¡_u£r_key
);

60 şas 
	cV”siÚ
 {

61 
	gpublic
:

65 
	sG‘Sts
 {

66 
FeM‘aD©a
* 
£ek_fe
;

67 
	g£ek_fe_Ëv–
;

73 
AddI‹¿tÜs
(cÚ¡ 
R—dO±iÚs
&, 
¡d
::
veùÜ
<
I‹¿tÜ
*>* 
™”s
);

75 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
&, cÚ¡ 
LookupKey
& 
key
, 
¡d
::
¡ršg
* 
v®
,

76 
G‘Sts
* 
¡©s
);

81 
boŞ
 
Upd©eSts
(cÚ¡ 
G‘Sts
& 
¡©s
);

87 
boŞ
 
RecÜdR—dSam¶e
(
Sliû
 
key
);

91 
Ref
();

92 
UÄef
();

94 
G‘Ov”ÏµšgIÅuts
(

95 
Ëv–
,

96 cÚ¡ 
IÁ”ÇlKey
* 
begš
,

97 cÚ¡ 
IÁ”ÇlKey
* 
’d
,

98 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
šputs
);

104 
boŞ
 
Ov”ÏpInLev–
(
Ëv–
, cÚ¡ 
Sliû
* 
sm®Ë¡_u£r_key
,

105 cÚ¡ 
Sliû
* 
Ïrge¡_u£r_key
);

109 
PickLev–FÜMemTabËOuut
(cÚ¡ 
Sliû
& 
sm®Ë¡_u£r_key
,

110 cÚ¡ 
Sliû
& 
Ïrge¡_u£r_key
);

112 
NumFes
(
Ëv–
ècÚ¡ {  
	gfes_
[Ëv–].
size
(); }

115 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

117 
	g´iv©e
:

118 
ä›nd
 
şass
 
Com·ùiÚ
;

119 
ä›nd
 
şass
 
	gV”siÚS‘
;

121 
şass
 
	gLev–FeNumI‹¿tÜ
;

123 
ex¶ic™
 
V”siÚ
(
V”siÚS‘
* 
v£t
)

124 : 
v£t_
(
v£t
),

125 
Ãxt_
(
this
),

126 
´ev_
(
this
),

127 
»fs_
(0),

128 
fe_to_com·ù_
(
nuÎ±r
),

129 
fe_to_com·ù_Ëv–_
(-1),

130 
com·ùiÚ_scÜe_
(-1),

131 
com·ùiÚ_Ëv–_
(-1) {}

133 
V”siÚ
(cÚ¡ V”siÚ&èğ
d–‘e
;

134 
	gV”siÚ
& 
	gİ”©Ü
=(cÚ¡ 
V”siÚ
&èğ
d–‘e
;

136 ~
V”siÚ
();

138 
I‹¿tÜ
* 
NewCÚÿ‹ÇtšgI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&, 
Ëv–
) const;

145 
FÜEachOv”Ïµšg
(
Sliû
 
u£r_key
, Sliû 
š‹º®_key
, * 
¬g
,

146 
boŞ
 (*
func
)(*, , 
FeM‘aD©a
*));

148 
V”siÚS‘
* 
	gv£t_
;

149 
V”siÚ
* 
	gÃxt_
;

150 
V”siÚ
* 
	g´ev_
;

151 
	g»fs_
;

154 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
fes_
[
cÚfig
::
kNumLev–s
];

157 
FeM‘aD©a
* 
	gfe_to_com·ù_
;

158 
	gfe_to_com·ù_Ëv–_
;

163 
	gcom·ùiÚ_scÜe_
;

164 
	gcom·ùiÚ_Ëv–_
;

167 şas 
	cV”siÚS‘
 {

168 
	gpublic
:

169 
V”siÚS‘
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
* 
İtiÚs
,

170 
TabËCache
* 
bË_ÿche
, cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
*);

171 
V”siÚS‘
(cÚ¡ V”siÚS‘&èğ
d–‘e
;

172 
	gV”siÚS‘
& 
	gİ”©Ü
=(cÚ¡ 
V”siÚS‘
&èğ
d–‘e
;

174 ~
V”siÚS‘
();

181 
Stus
 
LogAndAµly
(
V”siÚEd™
* 
ed™
, 
pÜt
::
Mu‹x
* 
mu
)

182 
EXCLUSIVE_LOCKS_REQUIRED
(
mu
);

185 
Stus
 
Recov”
(
boŞ
* 
§ve_mªiã¡
);

188 
V”siÚ
* 
cu¼’t
(ècÚ¡ {  
	gcu¼’t_
; }

191 
ušt64_t
 
Mªiã¡FeNumb”
(ècÚ¡ {  
	gmªiã¡_fe_numb”_
; }

194 
ušt64_t
 
NewFeNumb”
(è{  
	gÃxt_fe_numb”_
++; }

199 
Reu£FeNumb”
(
ušt64_t
 
fe_numb”
) {

200 ià(
	gÃxt_fe_numb”_
 =ğ
fe_numb”
 + 1) {

201 
Ãxt_fe_numb”_
 = 
fe_numb”
;

206 
NumLev–Fes
(
Ëv–
) const;

209 
št64_t
 
NumLev–By‹s
(
Ëv–
) const;

212 
ušt64_t
 
La¡Sequ’û
(ècÚ¡ {  
	gÏ¡_£qu’û_
; }

215 
S‘La¡Sequ’û
(
ušt64_t
 
s
) {

216 
as£¹
(
s
 >ğ
Ï¡_£qu’û_
);

217 
	gÏ¡_£qu’û_
 = 
s
;

221 
M¬kFeNumb”U£d
(
ušt64_t
 
numb”
);

224 
ušt64_t
 
LogNumb”
(ècÚ¡ {  
	glog_numb”_
; }

228 
ušt64_t
 
P»vLogNumb”
(ècÚ¡ {  
	g´ev_log_numb”_
; }

234 
Com·ùiÚ
* 
PickCom·ùiÚ
();

240 
Com·ùiÚ
* 
Com·ùRªge
(
Ëv–
, cÚ¡ 
IÁ”ÇlKey
* 
begš
,

241 cÚ¡ 
IÁ”ÇlKey
* 
’d
);

245 
št64_t
 
MaxNextLev–Ov”ÏµšgBy‹s
();

249 
I‹¿tÜ
* 
MakeIÅutI‹¿tÜ
(
Com·ùiÚ
* 
c
);

252 
boŞ
 
N“dsCom·ùiÚ
() const {

253 
V”siÚ
* 
	gv
 = 
cu¼’t_
;

254  (
	gv
->
	gcom·ùiÚ_scÜe_
 >ğ1è|| (
v
->
fe_to_com·ù_
 !ğ
nuÎ±r
);

259 
AddLiveFes
(
¡d
::
£t
<
ušt64_t
>* 
live
);

263 
ušt64_t
 
Aµroxim©eOff£tOf
(
V”siÚ
* 
v
, cÚ¡ 
IÁ”ÇlKey
& 
key
);

267 
	sLev–Summ¬yStÜage
 {

268 
	gbufãr
[100];

270 cÚ¡ * 
Lev–Summ¬y
(
Lev–Summ¬yStÜage
* 
sü©ch
) const;

272 
	g´iv©e
:

273 
şass
 
Bud”
;

275 
ä›nd
 
şass
 
	gCom·ùiÚ
;

276 
ä›nd
 
şass
 
	gV”siÚ
;

278 
boŞ
 
Reu£Mªiã¡
(cÚ¡ 
¡d
::
¡ršg
& 
dsúame
, cÚ¡ std::¡ršg& 
dscba£
);

280 
Fš®ize
(
V”siÚ
* 
v
);

282 
G‘Rªge
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs
, 
IÁ”ÇlKey
* 
sm®Ë¡
,

283 
IÁ”ÇlKey
* 
Ïrge¡
);

285 
G‘Rªge2
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs1
,

286 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs2
,

287 
IÁ”ÇlKey
* 
sm®Ë¡
, IÁ”ÇlKey* 
Ïrge¡
);

289 
S‘upOth”IÅuts
(
Com·ùiÚ
* 
c
);

292 
Stus
 
Wr™eSÇpshÙ
(
log
::
Wr™”
*†og);

294 
Aµ’dV”siÚ
(
V”siÚ
* 
v
);

296 
Env
* cÚ¡ 
	g’v_
;

297 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

298 cÚ¡ 
O±iÚs
* cÚ¡ 
	gİtiÚs_
;

299 
TabËCache
* cÚ¡ 
	gbË_ÿche_
;

300 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
	gicmp_
;

301 
ušt64_t
 
	gÃxt_fe_numb”_
;

302 
ušt64_t
 
	gmªiã¡_fe_numb”_
;

303 
ušt64_t
 
	gÏ¡_£qu’û_
;

304 
ušt64_t
 
	glog_numb”_
;

305 
ušt64_t
 
	g´ev_log_numb”_
;

308 
Wr™abËFe
* 
	gdesütÜ_fe_
;

309 
	glog
::
Wr™”
* 
desütÜ_log_
;

310 
V”siÚ
 
	gdummy_v”siÚs_
;

311 
V”siÚ
* 
	gcu¼’t_
;

315 
	g¡d
::
¡ršg
 
com·ù_poš‹r_
[
cÚfig
::
kNumLev–s
];

319 şas 
	cCom·ùiÚ
 {

320 
	gpublic
:

321 ~
Com·ùiÚ
();

325 
Ëv–
(ècÚ¡ {  
	gËv–_
; }

329 
V”siÚEd™
* 
ed™
(è{  &
	ged™_
; }

332 
num_šput_fes
(
which
ècÚ¡ {  
	gšputs_
[which].
size
(); }

335 
FeM‘aD©a
* 
šput
(
which
, 
i
ècÚ¡ {  
	gšputs_
[which][i]; }

338 
ušt64_t
 
MaxOuutFeSize
(ècÚ¡ {  
	gmax_ouut_fe_size_
; }

342 
boŞ
 
IsTrivŸlMove
() const;

345 
AddIÅutD–‘iÚs
(
V”siÚEd™
* 
ed™
);

350 
boŞ
 
IsBa£Lev–FÜKey
(cÚ¡ 
Sliû
& 
u£r_key
);

354 
boŞ
 
ShouldStİBefÜe
(cÚ¡ 
Sliû
& 
š‹º®_key
);

358 
R–—£IÅuts
();

360 
	g´iv©e
:

361 
ä›nd
 
şass
 
V”siÚ
;

362 
ä›nd
 
şass
 
	gV”siÚS‘
;

364 
Com·ùiÚ
(cÚ¡ 
O±iÚs
* 
İtiÚs
, 
Ëv–
);

366 
	gËv–_
;

367 
ušt64_t
 
	gmax_ouut_fe_size_
;

368 
V”siÚ
* 
	gšput_v”siÚ_
;

369 
V”siÚEd™
 
	ged™_
;

372 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
šputs_
[2];

376 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
g¿nd·»Ás_
;

377 
size_t
 
	gg¿nd·»Á_šdex_
;

378 
boŞ
 
	g£’_key_
;

379 
št64_t
 
	gov”Ïµed_by‹s_
;

388 
size_t
 
	gËv–_±rs_
[
cÚfig
::
kNumLev–s
];

	@version_set_test.cc

5 
	~"db/v”siÚ_£t.h
"

7 
	~"g‹¡/g‹¡.h
"

8 
	~"ut/loggšg.h
"

9 
	~"ut/‹¡ut.h
"

11 
Çme¥aû
 
	gËv–db
 {

13 şas 
	cFšdFeTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

14 
public
:

15 
FšdFeTe¡
(è: 
disjošt_sÜ‹d_fes_
(
Œue
) {}

17 ~
FšdFeTe¡
() {

18 
i
 = 0; 
	gi
 < 
	gfes_
.
size
(); i++) {

19 
d–‘e
 
	gfes_
[
i
];

23 
Add
(cÚ¡ * 
sm®Ë¡
, cÚ¡ * 
Ïrge¡
,

24 
Sequ’ûNumb”
 
sm®Ë¡_£q
 = 100,

25 
Sequ’ûNumb”
 
Ïrge¡_£q
 = 100) {

26 
FeM‘aD©a
* 
f
 = 
Ãw
 FileMetaData;

27 
	gf
->
	gnumb”
 = 
fes_
.
size
() + 1;

28 
	gf
->
	gsm®Ë¡
 = 
IÁ”ÇlKey
(
sm®Ë¡
, 
sm®Ë¡_£q
, 
kTy³V®ue
);

29 
	gf
->
	gÏrge¡
 = 
IÁ”ÇlKey
(
Ïrge¡
, 
Ïrge¡_£q
, 
kTy³V®ue
);

30 
	gfes_
.
push_back
(
f
);

33 
Fšd
(cÚ¡ * 
key
) {

34 
IÁ”ÇlKey
 
rg‘
(
key
, 100, 
kTy³V®ue
);

35 
IÁ”ÇlKeyCom·¿tÜ
 
cmp
(
By‹wi£Com·¿tÜ
());

36  
FšdFe
(
cmp
, 
fes_
, 
rg‘
.
Encode
());

39 
boŞ
 
Ov”Ïps
(cÚ¡ * 
sm®Ë¡
, cÚ¡ * 
Ïrge¡
) {

40 
IÁ”ÇlKeyCom·¿tÜ
 
cmp
(
By‹wi£Com·¿tÜ
());

41 
Sliû
 
s
(
sm®Ë¡
 !ğ
nuÎ±r
 ? smallest : "");

42 
Sliû
 
l
(
Ïrge¡
 !ğ
nuÎ±r
 ?†argest : "");

43  
SomeFeOv”ÏpsRªge
(
cmp
, 
disjošt_sÜ‹d_fes_
, 
fes_
,

44 (
sm®Ë¡
 !ğ
nuÎ±r
 ? &
s
 :‚ullptr),

45 (
Ïrge¡
 !ğ
nuÎ±r
 ? &
l
 :‚ullptr));

48 
boŞ
 
	gdisjošt_sÜ‹d_fes_
;

50 
	g´iv©e
:

51 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
fes_
;

54 
	$TEST_F
(
FšdFeTe¡
, 
Em±y
) {

55 
	`ASSERT_EQ
(0, 
	`Fšd
("foo"));

56 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("a", "z"));

57 
	`ASSERT_TRUE
(!
	`Ov”Ïps
(
nuÎ±r
, "z"));

58 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("a", 
nuÎ±r
));

59 
	`ASSERT_TRUE
(!
	`Ov”Ïps
(
nuÎ±r
,‚ullptr));

60 
	}
}

62 
	$TEST_F
(
FšdFeTe¡
, 
SšgË
) {

63 
	`Add
("p", "q");

64 
	`ASSERT_EQ
(0, 
	`Fšd
("a"));

65 
	`ASSERT_EQ
(0, 
	`Fšd
("p"));

66 
	`ASSERT_EQ
(0, 
	`Fšd
("p1"));

67 
	`ASSERT_EQ
(0, 
	`Fšd
("q"));

68 
	`ASSERT_EQ
(1, 
	`Fšd
("q1"));

69 
	`ASSERT_EQ
(1, 
	`Fšd
("z"));

71 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("a", "b"));

72 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("z1", "z2"));

73 
	`ASSERT_TRUE
(
	`Ov”Ïps
("a", "p"));

74 
	`ASSERT_TRUE
(
	`Ov”Ïps
("a", "q"));

75 
	`ASSERT_TRUE
(
	`Ov”Ïps
("a", "z"));

76 
	`ASSERT_TRUE
(
	`Ov”Ïps
("p", "p1"));

77 
	`ASSERT_TRUE
(
	`Ov”Ïps
("p", "q"));

78 
	`ASSERT_TRUE
(
	`Ov”Ïps
("p", "z"));

79 
	`ASSERT_TRUE
(
	`Ov”Ïps
("p1", "p2"));

80 
	`ASSERT_TRUE
(
	`Ov”Ïps
("p1", "z"));

81 
	`ASSERT_TRUE
(
	`Ov”Ïps
("q", "q"));

82 
	`ASSERT_TRUE
(
	`Ov”Ïps
("q", "q1"));

84 
	`ASSERT_TRUE
(!
	`Ov”Ïps
(
nuÎ±r
, "j"));

85 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("r", 
nuÎ±r
));

86 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "p"));

87 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "p1"));

88 
	`ASSERT_TRUE
(
	`Ov”Ïps
("q", 
nuÎ±r
));

89 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
,‚ullptr));

90 
	}
}

92 
	$TEST_F
(
FšdFeTe¡
, 
MuÉË
) {

93 
	`Add
("150", "200");

94 
	`Add
("200", "250");

95 
	`Add
("300", "350");

96 
	`Add
("400", "450");

97 
	`ASSERT_EQ
(0, 
	`Fšd
("100"));

98 
	`ASSERT_EQ
(0, 
	`Fšd
("150"));

99 
	`ASSERT_EQ
(0, 
	`Fšd
("151"));

100 
	`ASSERT_EQ
(0, 
	`Fšd
("199"));

101 
	`ASSERT_EQ
(0, 
	`Fšd
("200"));

102 
	`ASSERT_EQ
(1, 
	`Fšd
("201"));

103 
	`ASSERT_EQ
(1, 
	`Fšd
("249"));

104 
	`ASSERT_EQ
(1, 
	`Fšd
("250"));

105 
	`ASSERT_EQ
(2, 
	`Fšd
("251"));

106 
	`ASSERT_EQ
(2, 
	`Fšd
("299"));

107 
	`ASSERT_EQ
(2, 
	`Fšd
("300"));

108 
	`ASSERT_EQ
(2, 
	`Fšd
("349"));

109 
	`ASSERT_EQ
(2, 
	`Fšd
("350"));

110 
	`ASSERT_EQ
(3, 
	`Fšd
("351"));

111 
	`ASSERT_EQ
(3, 
	`Fšd
("400"));

112 
	`ASSERT_EQ
(3, 
	`Fšd
("450"));

113 
	`ASSERT_EQ
(4, 
	`Fšd
("451"));

115 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("100", "149"));

116 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("251", "299"));

117 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("451", "500"));

118 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("351", "399"));

120 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "150"));

121 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "200"));

122 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "300"));

123 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "400"));

124 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "500"));

125 
	`ASSERT_TRUE
(
	`Ov”Ïps
("375", "400"));

126 
	`ASSERT_TRUE
(
	`Ov”Ïps
("450", "450"));

127 
	`ASSERT_TRUE
(
	`Ov”Ïps
("450", "500"));

128 
	}
}

130 
	$TEST_F
(
FšdFeTe¡
, 
MuÉËNuÎBound¬›s
) {

131 
	`Add
("150", "200");

132 
	`Add
("200", "250");

133 
	`Add
("300", "350");

134 
	`Add
("400", "450");

135 
	`ASSERT_TRUE
(!
	`Ov”Ïps
(
nuÎ±r
, "149"));

136 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("451", 
nuÎ±r
));

137 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
,‚ullptr));

138 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "150"));

139 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "199"));

140 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "200"));

141 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "201"));

142 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "400"));

143 
	`ASSERT_TRUE
(
	`Ov”Ïps
(
nuÎ±r
, "800"));

144 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", 
nuÎ±r
));

145 
	`ASSERT_TRUE
(
	`Ov”Ïps
("200", 
nuÎ±r
));

146 
	`ASSERT_TRUE
(
	`Ov”Ïps
("449", 
nuÎ±r
));

147 
	`ASSERT_TRUE
(
	`Ov”Ïps
("450", 
nuÎ±r
));

148 
	}
}

150 
	$TEST_F
(
FšdFeTe¡
, 
Ov”ÏpSequ’ûChecks
) {

151 
	`Add
("200", "200", 5000, 3000);

152 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("199", "199"));

153 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("201", "300"));

154 
	`ASSERT_TRUE
(
	`Ov”Ïps
("200", "200"));

155 
	`ASSERT_TRUE
(
	`Ov”Ïps
("190", "200"));

156 
	`ASSERT_TRUE
(
	`Ov”Ïps
("200", "210"));

157 
	}
}

159 
	$TEST_F
(
FšdFeTe¡
, 
Ov”ÏµšgFes
) {

160 
	`Add
("150", "600");

161 
	`Add
("400", "500");

162 
disjošt_sÜ‹d_fes_
 = 
çl£
;

163 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("100", "149"));

164 
	`ASSERT_TRUE
(!
	`Ov”Ïps
("601", "700"));

165 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "150"));

166 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "200"));

167 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "300"));

168 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "400"));

169 
	`ASSERT_TRUE
(
	`Ov”Ïps
("100", "500"));

170 
	`ASSERT_TRUE
(
	`Ov”Ïps
("375", "400"));

171 
	`ASSERT_TRUE
(
	`Ov”Ïps
("450", "450"));

172 
	`ASSERT_TRUE
(
	`Ov”Ïps
("450", "500"));

173 
	`ASSERT_TRUE
(
	`Ov”Ïps
("450", "700"));

174 
	`ASSERT_TRUE
(
	`Ov”Ïps
("600", "700"));

175 
	}
}

177 
AddBound¬yIÅuts
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
icmp
,

178 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
Ëv–_fes
,

179 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
com·ùiÚ_fes
);

181 şas 
	cAddBound¬yIÅutsTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

182 
public
:

183 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
Ëv–_fes_
;

184 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
com·ùiÚ_fes_
;

185 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
®l_fes_
;

186 
IÁ”ÇlKeyCom·¿tÜ
 
	gicmp_
;

188 
AddBound¬yIÅutsTe¡
(è: 
icmp_
(
By‹wi£Com·¿tÜ
()) {}

190 ~
AddBound¬yIÅutsTe¡
() {

191 
size_t
 
i
 = 0; 
	gi
 < 
	g®l_fes_
.
size
(); ++i) {

192 
d–‘e
 
	g®l_fes_
[
i
];

194 
	g®l_fes_
.
ş—r
();

197 
FeM‘aD©a
* 
C»©eFeM‘aD©a
(
ušt64_t
 
numb”
, 
IÁ”ÇlKey
 
sm®Ë¡
,

198 
IÁ”ÇlKey
 
Ïrge¡
) {

199 
FeM‘aD©a
* 
	gf
 = 
Ãw
 FileMetaData();

200 
	gf
->
	gnumb”
 = 
numb”
;

201 
	gf
->
	gsm®Ë¡
 = 
sm®Ë¡
;

202 
	gf
->
	gÏrge¡
 = 
Ïrge¡
;

203 
	g®l_fes_
.
push_back
(
f
);

204  
	gf
;

208 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡Em±yFeS‘s
) {

209 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

210 
	`ASSERT_TRUE
(
com·ùiÚ_fes_
.
	`em±y
());

211 
	`ASSERT_TRUE
(
Ëv–_fes_
.
	`em±y
());

212 
	}
}

214 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡Em±yLev–Fes
) {

215 
FeM‘aD©a
* 
f1
 =

216 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 2, 
kTy³V®ue
),

217 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 1, 
kTy³V®ue
)));

218 
com·ùiÚ_fes_
.
	`push_back
(
f1
);

220 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

221 
	`ASSERT_EQ
(1, 
com·ùiÚ_fes_
.
	`size
());

222 
	`ASSERT_EQ
(
f1
, 
com·ùiÚ_fes_
[0]);

223 
	`ASSERT_TRUE
(
Ëv–_fes_
.
	`em±y
());

224 
	}
}

226 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡Em±yCom·ùiÚFes
) {

227 
FeM‘aD©a
* 
f1
 =

228 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 2, 
kTy³V®ue
),

229 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 1, 
kTy³V®ue
)));

230 
Ëv–_fes_
.
	`push_back
(
f1
);

232 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

233 
	`ASSERT_TRUE
(
com·ùiÚ_fes_
.
	`em±y
());

234 
	`ASSERT_EQ
(1, 
Ëv–_fes_
.
	`size
());

235 
	`ASSERT_EQ
(
f1
, 
Ëv–_fes_
[0]);

236 
	}
}

238 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡NoBound¬yFes
) {

239 
FeM‘aD©a
* 
f1
 =

240 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 2, 
kTy³V®ue
),

241 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 1, 
kTy³V®ue
)));

242 
FeM‘aD©a
* 
f2
 =

243 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("200", 2, 
kTy³V®ue
),

244 
	`IÁ”ÇlKey
(IÁ”ÇlKey("200", 1, 
kTy³V®ue
)));

245 
FeM‘aD©a
* 
f3
 =

246 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("300", 2, 
kTy³V®ue
),

247 
	`IÁ”ÇlKey
(IÁ”ÇlKey("300", 1, 
kTy³V®ue
)));

249 
Ëv–_fes_
.
	`push_back
(
f3
);

250 
Ëv–_fes_
.
	`push_back
(
f2
);

251 
Ëv–_fes_
.
	`push_back
(
f1
);

252 
com·ùiÚ_fes_
.
	`push_back
(
f2
);

253 
com·ùiÚ_fes_
.
	`push_back
(
f3
);

255 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

256 
	`ASSERT_EQ
(2, 
com·ùiÚ_fes_
.
	`size
());

257 
	}
}

259 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡OÃBound¬yFes
) {

260 
FeM‘aD©a
* 
f1
 =

261 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 3, 
kTy³V®ue
),

262 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 2, 
kTy³V®ue
)));

263 
FeM‘aD©a
* 
f2
 =

264 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 1, 
kTy³V®ue
),

265 
	`IÁ”ÇlKey
(IÁ”ÇlKey("200", 3, 
kTy³V®ue
)));

266 
FeM‘aD©a
* 
f3
 =

267 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("300", 2, 
kTy³V®ue
),

268 
	`IÁ”ÇlKey
(IÁ”ÇlKey("300", 1, 
kTy³V®ue
)));

270 
Ëv–_fes_
.
	`push_back
(
f3
);

271 
Ëv–_fes_
.
	`push_back
(
f2
);

272 
Ëv–_fes_
.
	`push_back
(
f1
);

273 
com·ùiÚ_fes_
.
	`push_back
(
f1
);

275 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

276 
	`ASSERT_EQ
(2, 
com·ùiÚ_fes_
.
	`size
());

277 
	`ASSERT_EQ
(
f1
, 
com·ùiÚ_fes_
[0]);

278 
	`ASSERT_EQ
(
f2
, 
com·ùiÚ_fes_
[1]);

279 
	}
}

281 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡TwoBound¬yFes
) {

282 
FeM‘aD©a
* 
f1
 =

283 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 6, 
kTy³V®ue
),

284 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 5, 
kTy³V®ue
)));

285 
FeM‘aD©a
* 
f2
 =

286 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 2, 
kTy³V®ue
),

287 
	`IÁ”ÇlKey
(IÁ”ÇlKey("300", 1, 
kTy³V®ue
)));

288 
FeM‘aD©a
* 
f3
 =

289 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 4, 
kTy³V®ue
),

290 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 3, 
kTy³V®ue
)));

292 
Ëv–_fes_
.
	`push_back
(
f2
);

293 
Ëv–_fes_
.
	`push_back
(
f3
);

294 
Ëv–_fes_
.
	`push_back
(
f1
);

295 
com·ùiÚ_fes_
.
	`push_back
(
f1
);

297 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

298 
	`ASSERT_EQ
(3, 
com·ùiÚ_fes_
.
	`size
());

299 
	`ASSERT_EQ
(
f1
, 
com·ùiÚ_fes_
[0]);

300 
	`ASSERT_EQ
(
f3
, 
com·ùiÚ_fes_
[1]);

301 
	`ASSERT_EQ
(
f2
, 
com·ùiÚ_fes_
[2]);

302 
	}
}

304 
	$TEST_F
(
AddBound¬yIÅutsTe¡
, 
Te¡DisjošFePoš‹rs
) {

305 
FeM‘aD©a
* 
f1
 =

306 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 6, 
kTy³V®ue
),

307 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 5, 
kTy³V®ue
)));

308 
FeM‘aD©a
* 
f2
 =

309 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 6, 
kTy³V®ue
),

310 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 5, 
kTy³V®ue
)));

311 
FeM‘aD©a
* 
f3
 =

312 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 2, 
kTy³V®ue
),

313 
	`IÁ”ÇlKey
(IÁ”ÇlKey("300", 1, 
kTy³V®ue
)));

314 
FeM‘aD©a
* 
f4
 =

315 
	`C»©eFeM‘aD©a
(1, 
	`IÁ”ÇlKey
("100", 4, 
kTy³V®ue
),

316 
	`IÁ”ÇlKey
(IÁ”ÇlKey("100", 3, 
kTy³V®ue
)));

318 
Ëv–_fes_
.
	`push_back
(
f2
);

319 
Ëv–_fes_
.
	`push_back
(
f3
);

320 
Ëv–_fes_
.
	`push_back
(
f4
);

322 
com·ùiÚ_fes_
.
	`push_back
(
f1
);

324 
	`AddBound¬yIÅuts
(
icmp_
, 
Ëv–_fes_
, &
com·ùiÚ_fes_
);

325 
	`ASSERT_EQ
(3, 
com·ùiÚ_fes_
.
	`size
());

326 
	`ASSERT_EQ
(
f1
, 
com·ùiÚ_fes_
[0]);

327 
	`ASSERT_EQ
(
f4
, 
com·ùiÚ_fes_
[1]);

328 
	`ASSERT_EQ
(
f3
, 
com·ùiÚ_fes_
[2]);

329 
	}
}

333 
	$maš
(
¬gc
, ** 
¬gv
) {

334 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

335  
	`RUN_ALL_TESTS
();

336 
	}
}

	@write_batch.cc

16 
	~"Ëv–db/wr™e_b©ch.h
"

18 
	~"db/dbfÜm©.h
"

19 
	~"db/membË.h
"

20 
	~"db/wr™e_b©ch_š‹º®.h
"

21 
	~"Ëv–db/db.h
"

22 
	~"ut/codšg.h
"

24 
Çme¥aû
 
	gËv–db
 {

27 cÚ¡ 
size_t
 
	gkH—d”
 = 12;

29 
	gWr™eB©ch
::
Wr™eB©ch
(è{ 
CË¬
(); }

31 
	gWr™eB©ch
::~
Wr™eB©ch
() = ;

33 
	gWr™eB©ch
::
HªdËr
::~Handler() = ;

35 
	gWr™eB©ch
::
CË¬
() {

36 
»p_
.
ş—r
();

37 
	g»p_
.
»size
(
kH—d”
);

40 
size_t
 
	gWr™eB©ch
::
Aµroxim©eSize
(ècÚ¡ {  
»p_
.
size
(); }

42 
Stus
 
	gWr™eB©ch
::
I‹¿‹
(
HªdËr
* 
hªdËr
) const {

43 
Sliû
 
šput
(
»p_
);

44 ià(
	gšput
.
size
(è< 
	gkH—d”
) {

45  
	gStus
::
CÜru±iÚ
("malformed WriteBatch (too small)");

48 
	gšput
.
»move_´efix
(
kH—d”
);

49 
Sliû
 
	gkey
, 
	gv®ue
;

50 
	gfound
 = 0;

51 !
	gšput
.
em±y
()) {

52 
	gfound
++;

53 
	gg
 = 
šput
[0];

54 
	gšput
.
»move_´efix
(1);

55 
	gg
) {

56 
	gkTy³V®ue
:

57 ià(
G‘L’gthP»fixedSliû
(&
šput
, &
key
) &&

58 
G‘L’gthP»fixedSliû
(&
šput
, &
v®ue
)) {

59 
	ghªdËr
->
Put
(
key
, 
v®ue
);

61  
	gStus
::
CÜru±iÚ
("bad WriteBatch Put");

64 
	gkTy³D–‘iÚ
:

65 ià(
G‘L’gthP»fixedSliû
(&
šput
, &
key
)) {

66 
	ghªdËr
->
D–‘e
(
key
);

68  
	gStus
::
CÜru±iÚ
("bad WriteBatch Delete");

72  
Stus
::
CÜru±iÚ
("unknown WriteBatchag");

75 ià(
	gfound
 !ğ
Wr™eB©chIÁ”Çl
::
CouÁ
(
this
)) {

76  
Stus
::
CÜru±iÚ
("WriteBatch has wrong count");

78  
	gStus
::
OK
();

82 
	gWr™eB©chIÁ”Çl
::
CouÁ
(cÚ¡ 
Wr™eB©ch
* 
b
) {

83  
DecodeFixed32
(
b
->
»p_
.
d©a
() + 8);

86 
	gWr™eB©chIÁ”Çl
::
S‘CouÁ
(
Wr™eB©ch
* 
b
, 
n
) {

87 
EncodeFixed32
(&
b
->
»p_
[8], 
n
);

90 
Sequ’ûNumb”
 
	gWr™eB©chIÁ”Çl
::
Sequ’û
(cÚ¡ 
Wr™eB©ch
* 
b
) {

91  
Sequ’ûNumb”
(
DecodeFixed64
(
b
->
»p_
.
d©a
()));

94 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(
Wr™eB©ch
* 
b
, 
Sequ’ûNumb”
 
£q
) {

95 
EncodeFixed64
(&
b
->
»p_
[0], 
£q
);

98 
	gWr™eB©ch
::
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
) {

99 
	gWr™eB©chIÁ”Çl
::
S‘CouÁ
(
this
, 
Wr™eB©chIÁ”Çl
::
CouÁ
(this) + 1);

100 
	g»p_
.
push_back
(
¡©ic_ÿ¡
<>(
kTy³V®ue
));

101 
PutL’gthP»fixedSliû
(&
»p_
, 
key
);

102 
PutL’gthP»fixedSliû
(&
»p_
, 
v®ue
);

105 
	gWr™eB©ch
::
D–‘e
(cÚ¡ 
Sliû
& 
key
) {

106 
Wr™eB©chIÁ”Çl
::
S‘CouÁ
(
this
, Wr™eB©chIÁ”Çl::
CouÁ
(this) + 1);

107 
	g»p_
.
push_back
(
¡©ic_ÿ¡
<>(
kTy³D–‘iÚ
));

108 
PutL’gthP»fixedSliû
(&
»p_
, 
key
);

111 
	gWr™eB©ch
::
Aµ’d
(cÚ¡ 
Wr™eB©ch
& 
sourû
) {

112 
Wr™eB©chIÁ”Çl
::
Aµ’d
(
this
, &
sourû
);

115 
	gÇme¥aû
 {

116 şas 
	cMemTabËIn£¹”
 : 
public
 
Wr™eB©ch
::
HªdËr
 {

117 
public
:

118 
Sequ’ûNumb”
 
£qu’û_
;

119 
MemTabË
* 
	gmem_
;

121 
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
è
	gov”ride
 {

122 
	gmem_
->
Add
(
£qu’û_
, 
kTy³V®ue
, 
key
, 
v®ue
);

123 
	g£qu’û_
++;

125 
D–‘e
(cÚ¡ 
Sliû
& 
key
è
	gov”ride
 {

126 
	gmem_
->
Add
(
£qu’û_
, 
kTy³D–‘iÚ
, 
key
, 
Sliû
());

127 
	g£qu’û_
++;

132 
Stus
 
	gWr™eB©chIÁ”Çl
::
	$In£¹IÁo
(cÚ¡ 
Wr™eB©ch
* 
b
, 
MemTabË
* 
membË
) {

133 
MemTabËIn£¹”
 
š£¹”
;

134 
š£¹”
.
£qu’û_
 = 
Wr™eB©chIÁ”Çl
::
	`Sequ’û
(
b
);

135 
š£¹”
.
mem_
 = 
membË
;

136  
b
->
	`I‹¿‹
(&
š£¹”
);

137 
	}
}

139 
	gWr™eB©chIÁ”Çl
::
	$S‘CÚ‹Ás
(
Wr™eB©ch
* 
b
, cÚ¡ 
Sliû
& 
cÚ‹Ás
) {

140 
	`as£¹
(
cÚ‹Ás
.
	`size
(è>ğ
kH—d”
);

141 
b
->
»p_
.
	`assign
(
cÚ‹Ás
.
	`d©a
(), cÚ‹Ás.
	`size
());

142 
	}
}

144 
	gWr™eB©chIÁ”Çl
::
	$Aµ’d
(
Wr™eB©ch
* 
d¡
, cÚ¡ Wr™eB©ch* 
¤c
) {

145 
	`S‘CouÁ
(
d¡
, 
	`CouÁ
(d¡è+ CouÁ(
¤c
));

146 
	`as£¹
(
¤c
->
»p_
.
	`size
(è>ğ
kH—d”
);

147 
d¡
->
»p_
.
	`­³nd
(
¤c
->»p_.
	`d©a
(è+ 
kH—d”
, src->»p_.
	`size
() - kHeader);

148 
	}
}

	@write_batch_internal.h

5 #iâdeà
STORAGE_LEVELDB_DB_WRITE_BATCH_INTERNAL_H_


6 
	#STORAGE_LEVELDB_DB_WRITE_BATCH_INTERNAL_H_


	)

8 
	~"db/dbfÜm©.h
"

9 
	~"Ëv–db/wr™e_b©ch.h
"

11 
Çme¥aû
 
	gËv–db
 {

13 
şass
 
	gMemTabË
;

17 şas 
	cWr™eB©chIÁ”Çl
 {

18 
	gpublic
:

20 
CouÁ
(cÚ¡ 
Wr™eB©ch
* 
b©ch
);

23 
S‘CouÁ
(
Wr™eB©ch
* 
b©ch
, 
n
);

26 
Sequ’ûNumb”
 
Sequ’û
(cÚ¡ 
Wr™eB©ch
* 
b©ch
);

30 
S‘Sequ’û
(
Wr™eB©ch
* 
b©ch
, 
Sequ’ûNumb”
 
£q
);

32 
Sliû
 
CÚ‹Ás
(cÚ¡ 
Wr™eB©ch
* 
b©ch
è{  Sliû(b©ch->
»p_
); }

34 
size_t
 
By‹Size
(cÚ¡ 
Wr™eB©ch
* 
b©ch
è{  
	gb©ch
->
	g»p_
.
size
(); }

36 
S‘CÚ‹Ás
(
Wr™eB©ch
* 
b©ch
, cÚ¡ 
Sliû
& 
cÚ‹Ás
);

38 
Stus
 
In£¹IÁo
(cÚ¡ 
Wr™eB©ch
* 
b©ch
, 
MemTabË
* 
membË
);

40 
Aµ’d
(
Wr™eB©ch
* 
d¡
, cÚ¡ Wr™eB©ch* 
¤c
);

	@write_batch_test.cc

5 
	~"g‹¡/g‹¡.h
"

6 
	~"db/membË.h
"

7 
	~"db/wr™e_b©ch_š‹º®.h
"

8 
	~"Ëv–db/db.h
"

9 
	~"Ëv–db/’v.h
"

10 
	~"ut/loggšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
	g¡d
::
¡ršg
 
PrštCÚ‹Ás
(
Wr™eB©ch
* 
b
) {

15 
IÁ”ÇlKeyCom·¿tÜ
 
cmp
(
By‹wi£Com·¿tÜ
());

16 
MemTabË
* 
	gmem
 = 
Ãw
 MemTabË(
cmp
);

17 
	gmem
->
Ref
();

18 
	g¡d
::
¡ršg
 
¡©e
;

19 
Stus
 
	gs
 = 
Wr™eB©chIÁ”Çl
::
In£¹IÁo
(
b
, 
mem
);

20 
	gcouÁ
 = 0;

21 
I‹¿tÜ
* 
	g™”
 = 
mem
->
NewI‹¿tÜ
();

22 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

23 
P¬£dIÁ”ÇlKey
 
	gikey
;

24 
EXPECT_TRUE
(
P¬£IÁ”ÇlKey
(
™”
->
key
(), &
ikey
));

25 
	gikey
.
	gty³
) {

26 
	gkTy³V®ue
:

27 
¡©e
.
­³nd
("Put(");

28 
	g¡©e
.
­³nd
(
ikey
.
u£r_key
.
ToSŒšg
());

29 
	g¡©e
.
­³nd
(", ");

30 
	g¡©e
.
­³nd
(
™”
->
v®ue
().
ToSŒšg
());

31 
	g¡©e
.
­³nd
(")");

32 
	gcouÁ
++;

34 
	gkTy³D–‘iÚ
:

35 
¡©e
.
­³nd
("Delete(");

36 
	g¡©e
.
­³nd
(
ikey
.
u£r_key
.
ToSŒšg
());

37 
	g¡©e
.
­³nd
(")");

38 
	gcouÁ
++;

41 
	g¡©e
.
­³nd
("@");

42 
	g¡©e
.
­³nd
(
Numb”ToSŒšg
(
ikey
.
£qu’û
));

44 
d–‘e
 
	g™”
;

45 ià(!
	gs
.
ok
()) {

46 
	g¡©e
.
­³nd
("ParseError()");

47 } ià(
	gcouÁ
 !ğ
Wr™eB©chIÁ”Çl
::
CouÁ
(
b
)) {

48 
¡©e
.
­³nd
("CountMismatch()");

50 
	gmem
->
UÄef
();

51  
	g¡©e
;

54 
TEST
(
Wr™eB©chTe¡
, 
Em±y
) {

55 
Wr™eB©ch
 
	gb©ch
;

56 
ASSERT_EQ
("", 
PrštCÚ‹Ás
(&
b©ch
));

57 
ASSERT_EQ
(0, 
Wr™eB©chIÁ”Çl
::
CouÁ
(&
b©ch
));

60 
TEST
(
Wr™eB©chTe¡
, 
MuÉË
) {

61 
Wr™eB©ch
 
	gb©ch
;

62 
	gb©ch
.
Put
(
Sliû
("foo"), Slice("bar"));

63 
	gb©ch
.
D–‘e
(
Sliû
("box"));

64 
	gb©ch
.
Put
(
Sliû
("baz"), Slice("boo"));

65 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(&
b©ch
, 100);

66 
ASSERT_EQ
(100, 
Wr™eB©chIÁ”Çl
::
Sequ’û
(&
b©ch
));

67 
ASSERT_EQ
(3, 
Wr™eB©chIÁ”Çl
::
CouÁ
(&
b©ch
));

68 
ASSERT_EQ
(

72 
PrštCÚ‹Ás
(&
b©ch
));

75 
TEST
(
Wr™eB©chTe¡
, 
CÜru±iÚ
) {

76 
Wr™eB©ch
 
	gb©ch
;

77 
	gb©ch
.
Put
(
Sliû
("foo"), Slice("bar"));

78 
	gb©ch
.
D–‘e
(
Sliû
("box"));

79 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(&
b©ch
, 200);

80 
Sliû
 
	gcÚ‹Ás
 = 
Wr™eB©chIÁ”Çl
::
CÚ‹Ás
(&
b©ch
);

81 
	gWr™eB©chIÁ”Çl
::
S‘CÚ‹Ás
(&
b©ch
,

82 
Sliû
(
cÚ‹Ás
.
d©a
(), cÚ‹Ás.
size
() - 1));

83 
ASSERT_EQ
(

86 
PrštCÚ‹Ás
(&
b©ch
));

89 
TEST
(
Wr™eB©chTe¡
, 
Aµ’d
) {

90 
Wr™eB©ch
 
	gb1
, 
	gb2
;

91 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(&
b1
, 200);

92 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(&
b2
, 300);

93 
	gb1
.
Aµ’d
(
b2
);

94 
ASSERT_EQ
("", 
PrštCÚ‹Ás
(&
b1
));

95 
	gb2
.
Put
("a", "va");

96 
	gb1
.
Aµ’d
(
b2
);

97 
ASSERT_EQ
("Put×, va)@200", 
PrštCÚ‹Ás
(&
b1
));

98 
	gb2
.
CË¬
();

99 
	gb2
.
Put
("b", "vb");

100 
	gb1
.
Aµ’d
(
b2
);

101 
ASSERT_EQ
(

104 
PrštCÚ‹Ás
(&
b1
));

105 
	gb2
.
D–‘e
("foo");

106 
	gb1
.
Aµ’d
(
b2
);

107 
ASSERT_EQ
(

112 
PrštCÚ‹Ás
(&
b1
));

115 
TEST
(
Wr™eB©chTe¡
, 
Aµroxim©eSize
) {

116 
Wr™eB©ch
 
	gb©ch
;

117 
size_t
 
	gem±y_size
 = 
b©ch
.
Aµroxim©eSize
();

119 
	gb©ch
.
Put
(
Sliû
("foo"), Slice("bar"));

120 
size_t
 
	gÚe_key_size
 = 
b©ch
.
Aµroxim©eSize
();

121 
ASSERT_LT
(
em±y_size
, 
Úe_key_size
);

123 
	gb©ch
.
Put
(
Sliû
("baz"), Slice("boo"));

124 
size_t
 
	gtwo_keys_size
 = 
b©ch
.
Aµroxim©eSize
();

125 
ASSERT_LT
(
Úe_key_size
, 
two_keys_size
);

127 
	gb©ch
.
D–‘e
(
Sliû
("box"));

128 
size_t
 
	gpo¡_d–‘e_size
 = 
b©ch
.
Aµroxim©eSize
();

129 
ASSERT_LT
(
two_keys_size
, 
po¡_d–‘e_size
);

134 
	$maš
(
¬gc
, ** 
¬gv
) {

135 
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

136  
	`RUN_ALL_TESTS
();

137 
	}
}

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ifdeà
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ifdeà
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 #ifdeà
__WORDSIZE32_SIZE_ULONG


264 
	#SIZE_MAX
 (4294967295UL)

	)

266 
	#SIZE_MAX
 (4294967295U)

	)

271 #iâdeà
WCHAR_MIN


273 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

274 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

278 
	#WINT_MIN
 (0u)

	)

279 
	#WINT_MAX
 (4294967295u)

	)

282 
	#INT8_C
(
c
è
	)
c

283 
	#INT16_C
(
c
è
	)
c

284 
	#INT32_C
(
c
è
	)
c

285 #ià
__WORDSIZE
 == 64

286 
	#INT64_C
(
c
èø## 
L


	)

288 
	#INT64_C
(
c
èø## 
LL


	)

292 
	#UINT8_C
(
c
è
	)
c

293 
	#UINT16_C
(
c
è
	)
c

294 
	#UINT32_C
(
c
èø## 
U


	)

295 #ià
__WORDSIZE
 == 64

296 
	#UINT64_C
(
c
èø## 
UL


	)

298 
	#UINT64_C
(
c
èø## 
ULL


	)

302 #ià
__WORDSIZE
 == 64

303 
	#INTMAX_C
(
c
èø## 
L


	)

304 
	#UINTMAX_C
(
c
èø## 
UL


	)

306 
	#INTMAX_C
(
c
èø## 
LL


	)

307 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_MISC


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ifdeà
__USE_POSIX


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ifdeà
__USE_POSIX


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ifdeà
__USE_POSIX2


872 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

878 
	`pşo£
 (
FILE
 *
__¡»am
);

882 #ifdef 
__USE_POSIX


884 *
	$ù”mid
 (*
__s
è
__THROW
;

888 #ifdeà
__USE_XOPEN


890 *
	`cu£rid
 (*
__s
);

894 #ifdef 
__USE_GNU


895 
ob¡ack
;

898 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

899 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

900 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

901 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

902 cÚ¡ *
__»¡riù
 
__fÜm©
,

903 
_G_va_li¡
 
__¬gs
)

904 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

908 #ifdeà
__USE_POSIX


912 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

916 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

919 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

922 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


926 
	#__Ãed_g‘İt


	)

927 
	~<g‘İt.h
>

932 #ifdeà
__USE_EXTERN_INLINES


933 
	~<b™s/¡dio.h
>

935 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


936 
	~<b™s/¡dio2.h
>

938 #ifdeà
__LDBL_COMPAT


939 
	~<b™s/¡dio-ldbl.h
>

942 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_MISC


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ifdeà
__USE_ISOC99


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_MISC


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ifdeà
__USE_ISOC99


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ifdeà
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ifdeà
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_MISC


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ifdeà
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


618 #iâdeà
__USE_FILE_OFFSET64


619 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

621 #ifdeà
__REDIRECT


622 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

623 
	`__nÚnuÎ
 ((1)è
__wur
;

625 
	#mk¡emp
 
mk¡emp64


	)

628 #ifdeà
__USE_LARGEFILE64


629 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

633 #ifdeà
__USE_MISC


640 #iâdeà
__USE_FILE_OFFSET64


641 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

643 #ifdeà
__REDIRECT


644 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

645 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

647 
	#mk¡emps
 
mk¡emps64


	)

650 #ifdeà
__USE_LARGEFILE64


651 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

652 
	`__nÚnuÎ
 ((1)è
__wur
;

656 #ifdeà
__USE_XOPEN2K8


662 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

665 #ifdeà
__USE_GNU


672 #iâdeà
__USE_FILE_OFFSET64


673 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

675 #ifdeà
__REDIRECT


676 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

677 
	`__nÚnuÎ
 ((1)è
__wur
;

679 
	#mko¡emp
 
mko¡emp64


	)

682 #ifdeà
__USE_LARGEFILE64


683 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

692 #iâdeà
__USE_FILE_OFFSET64


693 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

694 
	`__nÚnuÎ
 ((1)è
__wur
;

696 #ifdeà
__REDIRECT


697 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

698 
__æags
), 
mko¡emps64
)

699 
	`__nÚnuÎ
 ((1)è
__wur
;

701 
	#mko¡emps
 
mko¡emps64


	)

704 #ifdeà
__USE_LARGEFILE64


705 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

706 
	`__nÚnuÎ
 ((1)è
__wur
;

711 
__BEGIN_NAMESPACE_STD


716 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

717 
__END_NAMESPACE_STD


720 #ifdef 
__USE_GNU


723 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

724 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

727 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


733 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

734 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

739 #iâdeà
__COMPAR_FN_T


740 
	#__COMPAR_FN_T


	)

741 (*
	t__com·r_â_t
) (const *, const *);

743 #ifdef 
__USE_GNU


744 
__com·r_â_t
 
	tcom·risÚ_â_t
;

747 #ifdeà
__USE_GNU


748 (*
	t__com·r_d_â_t
) (const *, const *, *);

751 
__BEGIN_NAMESPACE_STD


754 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

755 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

756 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

758 #ifdeà
__USE_EXTERN_INLINES


759 
	~<b™s/¡dlib-b£¬ch.h
>

764 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

766 #ifdeà
__USE_GNU


767 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

768 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

769 
	`__nÚnuÎ
 ((1, 4));

774 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

775 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
__END_NAMESPACE_STD


778 #ifdeà
__USE_ISOC99


779 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

780 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

784 
__BEGIN_NAMESPACE_STD


788 
div_t
 
	$div
 (
__num”
, 
__d’om
)

789 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

790 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

791 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

792 
__END_NAMESPACE_STD


794 #ifdeà
__USE_ISOC99


795 
__BEGIN_NAMESPACE_C99


796 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

797 
__d’om
)

798 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

799 
__END_NAMESPACE_C99


803 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

804 || 
defšed
 
__USE_MISC


811 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

812 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

817 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

818 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

823 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

824 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

827 #ifdeà
__USE_MISC


829 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

833 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

834 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

835 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

836 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

841 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

844 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

845 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

846 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

848 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

849 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

850 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

851 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

852 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

853 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

854 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

855 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

859 
__BEGIN_NAMESPACE_STD


862 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

865 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

866 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

869 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

873 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

874 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

876 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

877 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

878 
__THROW
;

879 
__END_NAMESPACE_STD


882 #ifdeà
__USE_MISC


887 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


898 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

899 *cÚ¡ *
__»¡riù
 
__tok’s
,

900 **
__»¡riù
 
__v®u•
)

901 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

905 #ifdeà
__USE_XOPEN


907 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

913 #ifdeà
__USE_XOPEN2KXSI


915 
	$posix_İ’±
 (
__oæag
è
__wur
;

918 #ifdeà
__USE_XOPEN


923 
	$g¿Á±
 (
__fd
è
__THROW
;

927 
	$uÆock±
 (
__fd
è
__THROW
;

932 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

935 #ifdeà
__USE_GNU


939 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

940 
__THROW
 
	`__nÚnuÎ
 ((2));

943 
	`g‘±
 ();

946 #ifdeà
__USE_MISC


950 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	~<b™s/¡dlib-æßt.h
>

957 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


958 
	~<b™s/¡dlib.h
>

960 #ifdeà
__LDBL_COMPAT


961 
	~<b™s/¡dlib-ldbl.h
>

965 #undeà
__Ãed_m®loc_ªd_ÿÎoc


967 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Şd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

190 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

191 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Şd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__butš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__butš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__butš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__butš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__butš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__butš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__f’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempıy


643 #undeà
mempıy


644 #undeà
__mempıy


645 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

646 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempıy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memıy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


150 
	t_IO_lock_t
;

156 
	s_IO_m¬k”
 {

157 
_IO_m¬k”
 *
	m_Ãxt
;

158 
_IO_FILE
 *
	m_sbuf
;

162 
	m_pos
;

164 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

165 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

166 
	mpublic
:

167 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

168 ~
¡»amm¬k”
();

169 
§všg
(è{  
	m_¥os
 == -2; }

170 
d–
(
¡»amm¬k”
&);

171 
d–
();

176 
	e__codecvt_»suÉ


178 
	m__codecvt_ok
,

179 
	m__codecvt_·¹Ÿl
,

180 
	m__codecvt_”rÜ
,

181 
	m__codecvt_nocÚv


184 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


187 
	s_IO_codecvt


189 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

190 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

191 
	m__mb¡©e_t
 *,

192 cÚ¡ 
	mwch¬_t
 *,

193 cÚ¡ 
	mwch¬_t
 *,

194 cÚ¡ 
	mwch¬_t
 **, *,

196 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

197 
	m__mb¡©e_t
 *, *,

199 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

200 
	m__mb¡©e_t
 *,

202 cÚ¡ **, 
	mwch¬_t
 *,

203 
	mwch¬_t
 *, wchar_t **);

204 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

205 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

206 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

207 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

208 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

210 
_IO_icÚv_t
 
	m__cd_š
;

211 
_IO_icÚv_t
 
	m__cd_out
;

215 
	s_IO_wide_d©a


217 
wch¬_t
 *
	m_IO_»ad_±r
;

218 
wch¬_t
 *
	m_IO_»ad_’d
;

219 
wch¬_t
 *
	m_IO_»ad_ba£
;

220 
wch¬_t
 *
	m_IO_wr™e_ba£
;

221 
wch¬_t
 *
	m_IO_wr™e_±r
;

222 
wch¬_t
 *
	m_IO_wr™e_’d
;

223 
wch¬_t
 *
	m_IO_buf_ba£
;

224 
wch¬_t
 *
	m_IO_buf_’d
;

226 
wch¬_t
 *
	m_IO_§ve_ba£
;

227 
wch¬_t
 *
	m_IO_backup_ba£
;

229 
wch¬_t
 *
	m_IO_§ve_’d
;

231 
__mb¡©e_t
 
	m_IO_¡©e
;

232 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

233 
_IO_codecvt
 
	m_codecvt
;

235 
wch¬_t
 
	m_shÜtbuf
[1];

237 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

241 
	s_IO_FILE
 {

242 
	m_æags
;

243 
	#_IO_fe_æags
 
_æags


	)

247 * 
	m_IO_»ad_±r
;

248 * 
	m_IO_»ad_’d
;

249 * 
	m_IO_»ad_ba£
;

250 * 
	m_IO_wr™e_ba£
;

251 * 
	m_IO_wr™e_±r
;

252 * 
	m_IO_wr™e_’d
;

253 * 
	m_IO_buf_ba£
;

254 * 
	m_IO_buf_’d
;

256 *
	m_IO_§ve_ba£
;

257 *
	m_IO_backup_ba£
;

258 *
	m_IO_§ve_’d
;

260 
_IO_m¬k”
 *
	m_m¬k”s
;

262 
_IO_FILE
 *
	m_chaš
;

264 
	m_f’o
;

266 
	m_blksize
;

268 
	m_æags2
;

270 
_IO_off_t
 
	m_Şd_off£t
;

272 
	#__HAVE_COLUMN


	)

274 
	m_cur_cŞumn
;

275 sigÃd 
	m_vbË_off£t
;

276 
	m_shÜtbuf
[1];

280 
_IO_lock_t
 *
	m_lock
;

281 #ifdeà
_IO_USE_OLD_IO_FILE


284 
	s_IO_FILE_com¶‘e


286 
_IO_FILE
 
	m_fe
;

288 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

289 
_IO_off64_t
 
	m_off£t
;

290 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


292 
_IO_codecvt
 *
	m_codecvt
;

293 
_IO_wide_d©a
 *
	m_wide_d©a
;

294 
_IO_FILE
 *
	m_ä“»s_li¡
;

295 *
	m_ä“»s_buf
;

297 *
	m__·d1
;

298 *
	m__·d2
;

299 *
	m__·d3
;

300 *
	m__·d4
;

302 
size_t
 
	m__·d5
;

303 
	m_mode
;

305 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

309 #iâdeà
__ılu¥lus


310 
_IO_FILE
 
	t_IO_FILE
;

313 
	g_IO_FILE_¶us
;

315 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

316 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

317 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

318 #iâdeà
_LIBC


319 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

320 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

321 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

323 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

324 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

325 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

333 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

341 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

342 
	tsize_t
 
	t__n
);

350 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

353 
	t__io_şo£_â
 (*
	t__cook›
);

356 #ifdeà
_GNU_SOURCE


358 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

359 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

360 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

361 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

366 
__io_»ad_â
 *
	m»ad
;

367 
__io_wr™e_â
 *
	mwr™e
;

368 
__io_£ek_â
 *
	m£ek
;

369 
__io_şo£_â
 *
	mşo£
;

370 } 
	t_IO_cook›_io_funùiÚs_t
;

371 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

373 
	g_IO_cook›_fe
;

376 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

377 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

381 #ifdeà
__ılu¥lus


385 
__und”æow
 (
_IO_FILE
 *);

386 
__uæow
 (
_IO_FILE
 *);

387 
__ov”æow
 (
_IO_FILE
 *, );

388 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


389 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

390 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

391 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

394 #ià 
__GNUC__
 >= 3

395 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

397 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

400 
	#_IO_g‘c_uÆocked
(
_å
) \

401 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

402 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

403 
	#_IO_³ekc_uÆocked
(
_å
) \

404 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

405 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

406 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

407 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

408 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

409 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

410 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

412 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


413 
	#_IO_g‘wc_uÆocked
(
_å
) \

414 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

415 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

416 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

417 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

418 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

422 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

423 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

426 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

427 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

429 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

430 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

431 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

432 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

434 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

437 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

438 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

440 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

441 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

442 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

444 #ifdeà
_IO_MTSAFE_IO


445 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

446 
	#_IO_æockfe
(
_å
) \

447 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

448 
	#_IO_fuÆockfe
(
_å
) \

449 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

451 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

452 
	#_IO_æockfe
(
_å
è

	)

453 
	#_IO_fuÆockfe
(
_å
è

	)

454 
	#_IO_árylockfe
(
_å
è

	)

455 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

456 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

459 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

460 
_IO_va_li¡
, *
__»¡riù
);

461 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

462 
_IO_va_li¡
);

463 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

464 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

466 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

467 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

469 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

471 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


472 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

473 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

474 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

475 #ià
__GNUC__
 >= 2

478 #ià
defšed
 
_LIBC
 && defšed 
SHARED


479 
	~<shlib-com·t.h
>

480 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

481 
	#_IO_fwide_maybe_šcom·tibË
 \

482 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

483 cÚ¡ 
_IO_¡dš_u£d
;

484 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

487 #iâdeà
_IO_fwide_maybe_šcom·tibË


488 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

492 
	#_IO_fwide
(
__å
, 
__mode
) \

493 ({ 
__»suÉ
 = (
__mode
); \

494 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

496 ià((
__å
)->
_mode
 == 0) \

498 (
__å
)->
_mode
 = -1; \

499 
__»suÉ
 = (
__å
)->
_mode
; \

501 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

502 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

504 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

505 
__»suÉ
; })

	)

508 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

509 
_IO_va_li¡
, *
__»¡riù
);

510 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

511 
_IO_va_li¡
);

512 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

513 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

516 #ifdeà
__LDBL_COMPAT


517 
	~<b™s/libio-ldbl.h
>

520 #ifdeà
__ılu¥lus


	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004,

60 
	m__GCONV_TRANSLIT
 = 0x0008

65 
	g__gcÚv_¡•
;

66 
	g__gcÚv_¡•_d©a
;

67 
	g__gcÚv_lßded_objeù
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 
	s__gcÚv_¡•


86 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

87 cÚ¡ *
__modÇme
;

89 
__couÁ”
;

91 *
__äom_Çme
;

92 *
__to_Çme
;

94 
__gcÚv_fù
 
__fù
;

95 
__gcÚv_btowc_fù
 
__btowc_fù
;

96 
__gcÚv_š™_fù
 
__š™_fù
;

97 
__gcÚv_’d_fù
 
__’d_fù
;

101 
__mš_Ãeded_äom
;

102 
__max_Ãeded_äom
;

103 
__mš_Ãeded_to
;

104 
__max_Ãeded_to
;

107 
__¡©eful
;

109 *
__d©a
;

114 
	s__gcÚv_¡•_d©a


116 *
__outbuf
;

117 *
__outbuãnd
;

121 
__æags
;

125 
__švoÿtiÚ_couÁ”
;

129 
__š‹º®_u£
;

131 
__mb¡©e_t
 *
__¡©•
;

132 
__mb¡©e_t
 
__¡©e
;

138 
	s__gcÚv_šfo


140 
size_t
 
__n¡•s
;

141 
__gcÚv_¡•
 *
__¡•s
;

142 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

143 } *
	t__gcÚv_t
;

146 
	`__gcÚv_Œª¦™”©e
 (
__gcÚv_¡•
 *
¡•
,

147 
__gcÚv_¡•_d©a
 *
¡•_d©a
,

148 cÚ¡ *
šbuf¡¬t
,

149 cÚ¡ **
šbuå
,

150 cÚ¡ *
šbuãnd
,

151 **
outbuf¡¬t
,

152 
size_t
 *
œ»v”sibË
);

	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

149 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

154 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

157 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

158 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

159 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

161 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

162 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

163 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

166 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

169 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

170 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

171 
__END_NAMESPACE_STD


173 #ifdeà
__USE_XOPEN2K8


175 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

178 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

179 
size_t
 
__n
è
__THROW
;

183 
	~<xloÿË.h
>

185 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
__loÿË_t
 
__loc
è
__THROW
;

188 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

189 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

192 
__BEGIN_NAMESPACE_STD


195 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

199 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

200 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

201 
__END_NAMESPACE_STD


203 #ifdeà
__USE_XOPEN2K8


209 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

210 
__loÿË_t
 
__loc
è
__THROW
;

215 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

216 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

219 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

222 
__BEGIN_NAMESPACE_STD


224 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


225 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

226 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

230 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

231 
__THROW
 
__©Œibu‹_pu»__
;

234 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


235 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

236 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

240 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

241 
__THROW
 
__©Œibu‹_pu»__
;

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_GNU


248 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

249 
__THROW
 
__©Œibu‹_pu»__
;

252 
__BEGIN_NAMESPACE_STD


255 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

256 
__THROW
 
__©Œibu‹_pu»__
;

259 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

260 
__THROW
 
__©Œibu‹_pu»__
;

262 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


263 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

265 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

266 cÚ¡ 
wch¬_t
 *
__acû±
)

267 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

269 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

270 
__THROW
 
__©Œibu‹_pu»__
;

273 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


274 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

276 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

277 cÚ¡ 
wch¬_t
 *
__ÃedË
)

278 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

280 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

281 
__THROW
 
__©Œibu‹_pu»__
;

285 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

286 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

287 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

290 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

291 
__END_NAMESPACE_STD


293 #ifdeà
__USE_XOPEN


295 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


296 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

298 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

299 cÚ¡ 
wch¬_t
 *
__ÃedË
)

300 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

302 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

303 
__THROW
 
__©Œibu‹_pu»__
;

307 #ifdeà
__USE_XOPEN2K8


309 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

310 
__THROW
 
__©Œibu‹_pu»__
;

314 
__BEGIN_NAMESPACE_STD


316 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


317 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

319 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

320 
size_t
 
__n
)

321 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

323 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

328 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

329 
__THROW
 
__©Œibu‹_pu»__
;

332 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

333 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

337 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

338 
__THROW
;

341 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

342 
__END_NAMESPACE_STD


344 #ifdeà
__USE_GNU


347 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

348 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

349 
__THROW
;

353 
__BEGIN_NAMESPACE_STD


356 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

360 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

364 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

368 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

369 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

370 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

373 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

374 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

377 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

378 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

379 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

380 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

381 
__END_NAMESPACE_STD


383 #ifdeà
__USE_EXTERN_INLINES


389 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

390 
__ex‹º_šlše
 
wšt_t


391 
	`__NTH
 (
	$btowc
 (
__c
))

392 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

393 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

395 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

396 
__ex‹º_šlše
 

397 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

398 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

399 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

401 
__ex‹º_šlše
 
size_t


402 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

403 
mb¡©e_t
 *
__»¡riù
 
__ps
))

404 {  (
__ps
 !ğ
NULL


405 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

408 
__BEGIN_NAMESPACE_STD


411 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

412 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

413 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

418 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

419 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

420 
__END_NAMESPACE_STD


423 #ifdef 
__USE_XOPEN2K8


426 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

427 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

428 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

432 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

433 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

434 
size_t
 
__nwc
, size_ˆ
__Ën
,

435 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

440 #ifdeà
__USE_XOPEN


442 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

446 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

450 
__BEGIN_NAMESPACE_STD


453 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

454 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

455 
__END_NAMESPACE_STD


457 #ifdeà
__USE_ISOC99


458 
__BEGIN_NAMESPACE_C99


460 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

461 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

462 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

463 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

464 
__END_NAMESPACE_C99


468 
__BEGIN_NAMESPACE_STD


471 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

476 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

477 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

478 
__THROW
;

479 
__END_NAMESPACE_STD


481 #ifdeà
__USE_ISOC99


482 
__BEGIN_NAMESPACE_C99


485 
__ex‹nsiÚ__


486 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

487 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

488 
__THROW
;

492 
__ex‹nsiÚ__


493 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

494 
wch¬_t
 **
__»¡riù
 
__’d±r
,

495 
__ba£
è
__THROW
;

496 
__END_NAMESPACE_C99


499 #ifdeà
__USE_GNU


502 
__ex‹nsiÚ__


503 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

504 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

505 
__THROW
;

509 
__ex‹nsiÚ__


510 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

511 
wch¬_t
 **
__»¡riù
 
__’d±r
,

512 
__ba£
è
__THROW
;

515 #ifdeà
__USE_GNU


529 
	~<xloÿË.h
>

533 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

534 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

535 
__loÿË_t
 
__loc
è
__THROW
;

537 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

546 
__ex‹nsiÚ__


547 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
,

549 
__ba£
, 
__loÿË_t
 
__loc
)

550 
__THROW
;

552 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

553 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

554 
__THROW
;

556 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

557 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

558 
__THROW
;

560 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

561 
wch¬_t
 **
__»¡riù
 
__’d±r
,

562 
__loÿË_t
 
__loc
è
__THROW
;

566 #ifdeà
__USE_XOPEN2K8


569 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

570 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

574 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

575 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
;

583 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

586 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


587 
__BEGIN_NAMESPACE_STD


590 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

597 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

598 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

607 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

608 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

609 
__THROW
 ;

615 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

616 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

617 
__gnuc_va_li¡
 
__¬g
)

623 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

624 
__gnuc_va_li¡
 
__¬g
)

628 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

629 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

630 
__gnuc_va_li¡
 
__¬g
)

631 
__THROW
 ;

638 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

639 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

648 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

649 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

650 
__THROW
 ;

652 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

653 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

654 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

655 #ifdeà
__REDIRECT


659 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

660 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_fwsÿnf
)

663 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

664 
__isoc99_wsÿnf
)

666 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

667 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

668 ...), 
__isoc99_swsÿnf
)

671 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

673 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

674 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

675 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

676 
__THROW
;

677 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

678 
	#wsÿnf
 
__isoc99_wsÿnf


	)

679 
	#swsÿnf
 
__isoc99_swsÿnf


	)

683 
__END_NAMESPACE_STD


686 #ifdeà
__USE_ISOC99


687 
__BEGIN_NAMESPACE_C99


692 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

693 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

694 
__gnuc_va_li¡
 
__¬g
)

700 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

704 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

705 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

706 
__gnuc_va_li¡
 
__¬g
)

707 
__THROW
 ;

709 #ià!
defšed
 
__USE_GNU
 \

710 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

711 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

712 #ifdeà
__REDIRECT


713 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

714 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

717 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

718 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

720 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

721 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

725 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

726 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
);

728 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
);

730 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

731 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

732 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

733 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

734 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

735 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

739 
__END_NAMESPACE_C99


743 
__BEGIN_NAMESPACE_STD


748 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

749 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

755 
wšt_t
 
	`g‘wch¬
 ();

762 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

763 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

769 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

777 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

778 
__FILE
 *
__»¡riù
 
__¡»am
);

784 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

785 
__FILE
 *
__»¡riù
 
__¡»am
);

792 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

793 
__END_NAMESPACE_STD


796 #ifdeà
__USE_GNU


804 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

805 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

813 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

821 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

830 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

831 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

840 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

841 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

850 
__FILE
 *
__»¡riù
 
__¡»am
);

854 
__BEGIN_NAMESPACE_C99


858 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

859 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

860 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

861 
__END_NAMESPACE_C99


863 #ifdeà
__USE_GNU


864 
	~<xloÿË.h
>

868 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

869 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

870 cÚ¡ 
tm
 *
__»¡riù
 
__
,

871 
__loÿË_t
 
__loc
è
__THROW
;

880 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


881 
	#__Ãed_iswxxx


	)

882 
	~<wùy³.h
>

886 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


887 
	~<b™s/wch¬2.h
>

890 #ifdeà
__LDBL_COMPAT


891 
	~<b™s/wch¬-ldbl.h
>

894 
__END_DECLS


902 #undeà
__Ãed_mb¡©e_t


903 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@
1
.
1
/usr/include
60
972
autocompact_test.cc
builder.cc
builder.h
c.cc
c_test.c
corruption_test.cc
db_impl.cc
db_impl.h
db_iter.cc
db_iter.h
db_test.cc
dbformat.cc
dbformat.h
dbformat_test.cc
dumpfile.cc
fault_injection_test.cc
filename.cc
filename.h
filename_test.cc
leveldbutil.cc
log_format.h
log_reader.cc
log_reader.h
log_test.cc
log_writer.cc
log_writer.h
memtable.cc
memtable.h
recovery_test.cc
repair.cc
skiplist.h
skiplist_test.cc
snapshot.h
table_cache.cc
table_cache.h
version_edit.cc
version_edit.h
version_edit_test.cc
version_set.cc
version_set.h
version_set_test.cc
write_batch.cc
write_batch_internal.h
write_batch_test.cc
/usr/include/ctype.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/alloca.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/stdc-predef.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
